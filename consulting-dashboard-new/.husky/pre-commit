#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# æ—¢å­˜ã®ãƒã‚§ãƒƒã‚¯
npm run type-check && npm run lint

# TypeScript strict mode ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
echo "ğŸ” TypeScript strict mode compliance check..."

# 1. implicit anyã‚¿ã‚¤ãƒ—ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
echo "Checking for implicit any types in map functions..."
IMPLICIT_ANY_COUNT=$(grep -r "\.map(async (" app/actions/ --include="*.ts" | grep -v ": any)" | grep -v "//" | wc -l)
if [ $IMPLICIT_ANY_COUNT -gt 0 ]; then
    echo "âŒ Implicit any types detected: $IMPLICIT_ANY_COUNT locations"
    echo "Please add explicit type annotations like: .map(async (item: any) =>"
    grep -r "\.map(async (" app/actions/ --include="*.ts" | grep -v ": any)" | grep -v "//"
    exit 1
fi

# 2. authDbå‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³æŠœã‘ãƒã‚§ãƒƒã‚¯  
echo "Checking for missing database type assertions..."
MISSING_AUTH_ASSERTIONS=$(grep -r "authDb\." app/actions/ --include="*.ts" | grep -v "as any" | wc -l)

if [ $MISSING_AUTH_ASSERTIONS -gt 0 ]; then
    echo "âŒ Missing authDb type assertions: $MISSING_AUTH_ASSERTIONS locations"
    echo "Please add '(authDb as any)' for database access"
    exit 1
fi

# 3. ZodError.errorsã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯ï¼ˆå»ƒæ­¢ã•ã‚ŒãŸAPIï¼‰
echo "Checking for deprecated ZodError.errors usage..."
if grep -r "error\.errors" app/ --include="*.ts" | grep -q "."; then
    echo "âŒ Deprecated ZodError.errors usage detected. Use .issues instead."
    exit 1
fi

echo "âœ… TypeScript strict mode compliance check passed!"
