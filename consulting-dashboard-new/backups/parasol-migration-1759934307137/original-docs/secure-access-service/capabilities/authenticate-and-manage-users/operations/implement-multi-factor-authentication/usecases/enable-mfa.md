# ユースケース: MFAを有効化する

## 基本情報
- **ユースケースID**: UC-SEC-001
- **アクター**: ユーザー, システム管理者
- **概要**: ユーザーがアカウントのセキュリティを強化するために多要素認証（MFA）を設定し有効化する

## 事前条件
- ユーザーがシステムにログインしている
- ユーザーアカウントが有効で認証済みである
- 認証アプリ（Google Authenticator、Authy等）がスマートフォンまたはタブレットに利用可能
- MFA設定機能が有効になっている

## 事後条件
### 成功時
- ユーザーアカウントでMFAが有効化される
- QRコードまたは秘密鍵が正常に認証アプリに登録される
- バックアップコード（10個）が生成・表示される
- MFA有効化完了通知が送信される
- 次回ログイン時からMFA認証が必須となる

### 失敗時
- MFA設定が未完了のまま保持される
- エラーメッセージが表示される
- 従来のパスワード認証のみが継続される

## 基本フロー
1. ユーザーがセキュリティ設定画面でMFA有効化を選択する
2. システムがユーザーの認証状態を確認する
3. システムがMFA設定手順説明を表示する
4. システムが秘密鍵を生成しQRコードを表示する
5. ユーザーが認証アプリでQRコードをスキャンする
6. システムが6桁確認コードの入力を要求する
7. ユーザーが認証アプリから確認コードを入力する
8. システムがコードの正当性を検証する
9. システムがバックアップコード10個を生成・表示する
10. ユーザーがバックアップコードを安全な場所に保存する
11. システムがMFA有効化を完了し成功メッセージを表示する

## 代替フロー
### 代替フロー1: QRコード読み取り失敗
- 5a. QRコードがスキャンできない場合
  - 5a1. システムが手動入力オプションを表示する
  - 5a2. ユーザーが秘密鍵を手動で認証アプリに入力する
  - 5a3. 基本フロー6に戻る

### 代替フロー2: 確認コード入力エラー
- 7a. 入力したコードが間違っている場合
  - 7a1. システムがエラーメッセージを表示する
  - 7a2. システムが再入力を促す（最大3回まで）
  - 7a3. 基本フロー7に戻る

### 代替フロー3: 制限回数超過
- 7b. 確認コード入力が3回連続で失敗した場合
  - 7b1. システムが設定プロセスを一時停止する
  - 7b2. システムが5分間の待機時間を設定する
  - 7b3. 待機時間経過後、基本フロー4に戻る

## 例外フロー
### 例外1: システムエラー
- *a. システムエラーが発生した場合
  - *a1. システムがエラーメッセージを表示する
  - *a2. システムが設定プロセスを中断する
  - *a3. 管理者にエラー通知を送信する
  - *a4. ユーザーに後で再試行するよう案内する

### 例外2: MFA強制ポリシー違反
- *b. ユーザーのロールがMFA必須の場合
  - *b1. システムが強制設定モードを有効化する
  - *b2. ユーザーによる設定キャンセルを無効化する
  - *b3. 設定完了まで他機能アクセスを制限する

## 特別要件
- **セキュリティ**: 秘密鍵とQRコードは一度のみ表示し、設定完了後は削除
- **可用性**: 認証アプリが利用できない場合の代替手段（バックアップコード）を提供
- **パフォーマンス**: QRコード生成は3秒以内で完了すること
- **法的要求**: バックアップコードは30日間で期限切れ、定期的な再生成を促す

## 関連ユースケース
- **包含**: なし
- **拡張**: 「認証コードを入力する」（ログイン時のMFA認証）
- **汎化**: なし