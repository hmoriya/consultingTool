# ページ定義：アカウント承認・作成

## 画面の目的
管理者がアカウント申請を審査し、承認または却下を判断する画面。申請内容を確認し、組織のセキュリティポリシーに従って適切なアクセス権限を付与してアカウントを作成する。

## 利用者
- **システム管理者**: アカウント管理権限を持つ管理者
- **人事担当者**: 新規メンバーの受け入れを担当する人事部門
- **セキュリティ担当者**: セキュリティポリシーに基づくアクセス制御を行う担当者

## 画面構成

### ヘッダー部
- 画面タイトル「アカウント申請管理」
- 申請件数バッジ（未承認件数を表示）
- フィルター切り替えタブ
  - 「未承認」（デフォルト選択、バッジ付き）
  - 「承認済み」
  - 「却下済み」
  - 「すべて」

### 申請一覧部

#### 一覧テーブル
各行に以下の情報を表示：

| カラム | 表示内容 | ソート可能 |
|--------|---------|-----------|
| 申請日時 | YYYY/MM/DD HH:MM形式 | ○ |
| 申請者名 | 姓名（フリガナ） | ○ |
| メールアドレス | 申請メールアドレス | ○ |
| 申請種別 | 正社員/派遣/業務委託/クライアント等 | △（フィルタ） |
| 所属組織 | 所属部署またはクライアント企業名 | △（フィルタ） |
| ステータス | 未承認/承認済み/却下済み | △（フィルタ） |
| アクション | 詳細ボタン | - |

#### 検索・フィルタ機能
- **検索ボックス**: 申請者名、メールアドレスで部分一致検索
- **申請種別フィルタ**: ドロップダウンで種別を選択
- **期間フィルタ**: 申請日の範囲指定（カレンダーピッカー）
- **ソート機能**: 各カラムのヘッダークリックで昇順・降順切り替え

#### ページネーション
- 1ページあたり20件表示
- ページ番号選択
- 「前へ」「次へ」ボタン
- 表示件数変更（10件/20件/50件/100件）

### 申請詳細・審査部（モーダルまたはサイドパネル）

#### 申請者情報表示
- **基本情報**
  - 氏名（姓・名、フリガナ）
  - メールアドレス
  - 申請日時
  - 申請番号（自動採番）

- **組織情報**
  - 申請種別
  - 所属組織
  - 役職・役割

- **連絡先情報**
  - 電話番号
  - 緊急連絡先（名前・電話番号）

- **申請理由**
  - テキストボックスで申請理由全文を表示

#### アカウント設定セクション（承認時）
- **ユーザーID**（自動生成）
  - メールアドレスのローカル部分を基に生成
  - 手動編集可能（20文字以内、英数字とハイフン）

- **ロール選択**（ドロップダウン、複数選択可）
  - Executive（経営層）
  - PM（プロジェクトマネージャー）
  - Consultant（コンサルタント）
  - Client（クライアント）
  - Admin（管理者）

- **所属組織選択**
  - 組織ツリーから選織選択
  - 申請種別に応じてデフォルト値を設定

- **初期パスワード設定方式**（ラジオボタン）
  - 自動生成してメール送信（推奨）
  - 管理者が手動設定

- **アカウント有効期限**（任意）
  - 日付ピッカーで選択
  - 業務委託やクライアントの場合に設定を推奨

- **備考・管理メモ**（任意）
  - 管理者用のメモ（500文字以内）
  - 申請者には非公開

#### 審査アクション部
- **承認ボタン**（プライマリボタン、緑）
  - クリックで承認確認ダイアログ表示
  - 必須項目（ロール、所属組織）が未入力の場合は無効

- **却下ボタン**（デンジャーボタン、赤）
  - クリックで却下理由入力ダイアログ表示
  - 却下理由（必須、500文字以内）を入力

- **保留ボタン**（セカンダリボタン）
  - 審査を一時保留し、後で再度審査
  - 保留理由（任意）を入力可能

- **キャンセルボタン**
  - 詳細画面を閉じて一覧に戻る

### 通知・アクション履歴部（下部または別タブ）
- **アクション履歴**
  - 申請に対するすべての操作履歴を時系列表示
  - 例：「2024/01/15 10:30 - 管理者A：保留（理由：追加確認が必要）」
  - 例：「2024/01/16 14:20 - 管理者B：承認（ロール：Consultant）」

## データ表示

### 一覧画面初期表示
- 未承認の申請を申請日時降順で表示
- 申請件数バッジに未承認件数を表示
- 申請がない場合：「現在、未承認の申請はありません」メッセージ

### 詳細画面表示
- 選択した申請の全情報を表示
- 承認済みまたは却下済みの場合：
  - アクションボタンを非活性化
  - 承認・却下情報（実行者、日時、理由）を表示

### リアルタイム更新
- 新規申請があった場合、通知バナー表示
- 「新しい申請が1件あります」→クリックで一覧を更新
- 他の管理者が承認・却下した場合、ステータスを自動更新

## 入力項目

### アカウント設定（承認時）
| 項目 | 形式 | 必須 | バリデーション |
|------|------|------|---------------|
| ユーザーID | テキスト | ○ | 20文字以内、英数字とハイフン、重複不可 |
| ロール | ドロップダウン（複数選択） | ○ | 1つ以上選択必須 |
| 所属組織 | 組織ツリー | ○ | 1つ選択必須 |
| 初期パスワード | ラジオボタン | ○ | いずれか選択 |
| 有効期限 | 日付ピッカー | × | 今日以降の日付 |
| 備考 | テキストエリア | × | 500文字以内 |

### 却下時
| 項目 | 形式 | 必須 | バリデーション |
|------|------|------|---------------|
| 却下理由 | テキストエリア | ○ | 500文字以内、20文字以上 |

## 画面の振る舞い

### 申請一覧の操作
- **行クリック**: 詳細画面を開く（モーダルまたはサイドパネル）
- **ステータスバッジ**: 未承認（黄）、承認済み（緑）、却下済み（赤）で色分け
- **ソート**: カラムヘッダークリックで昇順・降順切り替え（矢印アイコン表示）
- **検索**: 入力後、即座にフィルタリング（デバウンス500ms）

### 承認処理フロー
1. **承認ボタンクリック**
   - 必須項目（ユーザーID、ロール、所属組織）の入力チェック
   - 未入力があればエラーメッセージ表示

2. **承認確認ダイアログ表示**
   - 「以下の内容でアカウントを作成しますか？」
   - 設定内容のサマリー表示（ユーザーID、ロール、所属組織）
   - 「承認する」「キャンセル」ボタン

3. **アカウント作成処理**
   - ローディング表示（ボタン無効化、スピナー）
   - バックエンドでアカウント作成
   - 初期パスワードをメール送信（自動生成の場合）
   - 成功：「アカウントを作成しました」成功メッセージ
   - 詳細画面を閉じて一覧画面に戻る
   - 一覧から承認済み申請を除外（未承認フィルタの場合）

4. **エラー処理**
   - ユーザーID重複：「このユーザーIDは既に使用されています」
   - メール送信失敗：「アカウントは作成されましたが、メール送信に失敗しました」
   - システムエラー：「アカウント作成に失敗しました」

### 却下処理フロー
1. **却下ボタンクリック**
   - 却下理由入力ダイアログ表示

2. **却下理由入力**
   - テキストエリア（500文字以内、20文字以上必須）
   - リアルタイム文字数カウンター表示
   - 「却下する」「キャンセル」ボタン

3. **却下確認ダイアログ**
   - 「この申請を却下しますか？」
   - 入力した却下理由を表示
   - 「確定」「戻る」ボタン

4. **却下処理実行**
   - ローディング表示
   - バックエンドで却下処理
   - 申請者にメール通知（却下理由を含む）
   - 成功：「申請を却下しました」成功メッセージ
   - 一覧画面に戻る

### 保留処理
- 保留理由（任意）を入力
- 申請ステータスを「保留中」に変更
- 一覧では未承認として表示継続
- アクション履歴に保留記録を追加

## 画面遷移

### 遷移元画面
- **ダッシュボード**: 「未承認申請あり」通知からのリンク
- **管理メニュー**: 「アカウント管理」→「申請管理」
- **通知**: 新規申請の通知メールからのリンク

### 遷移先画面
- **アカウント一覧画面**: 承認後、作成したアカウントの確認
- **監査ログ画面**: アクション履歴の詳細確認
- **ダッシュボード**: 「戻る」ボタンで管理画面に戻る

## エラーハンドリング

### バリデーションエラー
- **ユーザーID重複**: 「このユーザーIDは既に使用されています。別のIDを指定してください」
- **必須項目未入力**: 各フィールドの下に赤字でエラー表示

### システムエラー
- **データベースエラー**: 「アカウント作成に失敗しました。システム管理者に連絡してください」
- **メール送信エラー**: 「アカウントは作成されましたが、通知メールの送信に失敗しました」
- **権限エラー**: 「この操作を実行する権限がありません」

### ネットワークエラー
- 「通信エラーが発生しました。もう一度お試しください」
- 再試行ボタン表示

## アクセシビリティ要件

### キーボード操作
- Tabキーで全ての操作要素を順次移動
- Enterキーでボタンクリック、リンク選択
- Escキーでモーダル・ダイアログを閉じる
- 矢印キーでドロップダウンを操作

### スクリーンリーダー対応
- テーブルに適切な見出し構造（th、caption）
- ボタンの役割をaria-labelで明示
- エラーメッセージはaria-liveで即座に読み上げ
- モーダル表示時にフォーカスをモーダル内に移動

### 色覚対応
- ステータスは色だけでなくアイコンとテキストで表現
- 未承認：⏱️ + 黄背景
- 承認済み：✅ + 緑背景
- 却下済み：❌ + 赤背景

## レスポンシブ対応

### デスクトップ（1024px以上）
- 一覧テーブル：全カラム表示
- 詳細画面：サイドパネル形式（画面右側にスライド表示）
- 検索・フィルタ：ヘッダー部に横並び配置

### タブレット（768px〜1023px）
- 一覧テーブル：重要カラムのみ表示（申請者名、メールアドレス、ステータス、アクション）
- 詳細画面：フルスクリーンモーダル
- 検索・フィルタ：2段レイアウト

### モバイル（767px以下）
- 一覧：カード形式表示（テーブルではなくカードUI）
- 各カードに申請者名、ステータス、申請日時、詳細ボタンを表示
- 詳細画面：フルスクリーンモーダル
- 検索・フィルタ：ドロワー形式（ハンバーガーメニューで開閉）

## セキュリティ要件
- **権限チェック**: ページアクセス時に管理者権限を確認、権限がない場合は403エラー
- **操作ログ**: 全ての承認・却下操作を監査ログに記録（実行者、日時、対象、理由）
- **CSRF対策**: 全ての操作にCSRFトークンを含める
- **XSS対策**: 申請理由や却下理由の表示時にHTMLエスケープ
- **セッション管理**: 操作中にセッションタイムアウトした場合は警告表示とログイン画面へ遷移
