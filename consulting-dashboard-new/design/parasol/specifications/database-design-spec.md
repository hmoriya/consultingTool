# データベース設計仕様書

**作成日**: 2025-01-26  
**更新日**: 2025-01-26  
**バージョン**: 1.0.0

## 1. 概要

データベース設計は、パラソルドメイン言語で定義されたエンティティを永続化するための構造を定義します。パラソル設計では特定のデータベース製品（MySQL、PostgreSQL等）に依存せず、ビジネス視点でのデータ構造と関係性を自然言語で記述します。

### 1.1 位置づけ

```
パラソルドメイン言語（ビジネスモデル）
    ↓
【データベース設計】← ここ（永続化構造）
    ↓
物理データベース（具体的なテーブル定義）
```

### 1.2 目的
- ドメインモデルの永続化設計
- データの整合性保証
- ビジネスルールの実装
- 実装非依存のデータ構造

### 1.3 パラソル設計原則
- **ドメインモデル準拠**: パラソルドメイン言語との一貫性
- **ビジネス用語使用**: テーブル名・カラム名は日本語併記
- **実装非依存**: 特定のDBMS機能に依存しない
- **正規化とパフォーマンスのバランス**: ビジネス要求を優先

## 2. 3要素記法の適用

データベース要素も3要素記法を使用します：

```
日本語名 [英語名] [SYSTEM_NAME]
```

例：
```
プロジェクトテーブル [ProjectTable] [PROJECT_TABLE]
タスク一覧ビュー [TaskListView] [TASK_LIST_VIEW]
プロジェクト番号インデックス [ProjectNumberIndex] [PROJECT_NUMBER_INDEX]
```

## 3. 文書構造

### 3.1 必須セクション

```markdown
# データベース設計: [サービス名]

## 設計概要
### 対象ドメイン
### 設計方針
### 前提条件

## テーブル設計
### [テーブル名]

## リレーション設計
### テーブル間の関係
### 参照整合性

## インデックス設計
### パフォーマンス要件
### インデックス定義

## ビジネスルール実装
### 制約
### トリガー相当の処理

## データ移行・初期化
### 初期データ
### 移行方針
```

## 4. テーブル設計

### 4.1 テーブル定義形式
```markdown
### [テーブル名] [[TableName]] [[TABLE_NAME]]
**対応エンティティ**: [エンティティ名] [[Entity]] [[ENTITY]]

| カラム名 | 型 | 必須 | 説明 | 制約 |
|---------|-----|------|------|------|
| ID | 識別子 | ○ | 主キー | 一意 |
| [カラム名] | [論理型] | ○/- | [説明] | [制約] |

**ビジネスキー**: [ビジネス上の一意識別子]
**監査項目**: 作成日時、作成者、更新日時、更新者
**論理削除**: 削除フラグ使用
```

### 4.2 論理データ型
```markdown
識別子: 一意識別子（UUID推奨）
文字列(N): 最大N文字の文字列
テキスト: 長文テキスト
整数: 整数値
小数: 小数値
金額: 通貨金額
日付: 年月日
日時: 年月日時分秒
真偽値: はい/いいえ
列挙型: 限定された選択肢
JSON: 構造化データ
```

## 5. リレーション設計

### 5.1 関係の種類
```markdown
## リレーション設計

### 1対多の関係
- 親テーブル → 子テーブル
- 親: [テーブルA] - 子: [テーブルB]
- 外部キー: [テーブルB].[テーブルA]_ID
- 削除時: カスケード削除/制限

### 多対多の関係
- [テーブルA] ←→ [テーブルB]
- 中間テーブル: [テーブルAB関連]
- 複合主キー: [テーブルA]_ID, [テーブルB]_ID
```

### 5.2 参照整合性
```markdown
### 参照整合性
- **必須参照**: 親が必ず存在
- **任意参照**: 親は任意（NULL許可）
- **カスケード**: 親削除時に子も削除
- **制限**: 子が存在する親は削除不可
```

## 6. インデックス設計

### 6.1 インデックス定義
```markdown
### [インデックス名] [[IndexName]] [[INDEX_NAME]]
- **対象テーブル**: [テーブル名]
- **対象カラム**: [カラム1], [カラム2]
- **種類**: 一意/非一意
- **目的**: [検索性能向上/一意性保証]
- **使用場面**: [どんな検索で使われるか]
```

## 7. ビジネスルール実装

### 7.1 制約の定義
```markdown
### テーブルレベル制約
- **[制約名]**: [制約の内容]
  - 実装方法: CHECK制約相当
  - エラー時: [エラーメッセージ]

### カラムレベル制約
- **[カラム名]の制約**: [制約内容]
  - 許可値: [値の範囲や条件]
  - デフォルト値: [省略時の値]
```

### 7.2 ビジネスロジック
```markdown
### 自動処理
- **[処理名]**: [自動実行される処理]
  - タイミング: 登録時/更新時/削除時
  - 処理内容: [何を行うか]
  - 実装注記: アプリケーション層で実装
```

## 8. 品質基準

### 8.1 正規化レベル
- 第3正規形を基本とする
- パフォーマンスのため意図的な非正規化を許可
- 非正規化の理由を明記

### 8.2 命名規則
- テーブル名: [エンティティ名]_TABLE
- カラム名: スネークケース（例: PROJECT_NAME）
- インデックス名: IDX_[テーブル名]_[カラム名]
- 外部キー名: FK_[子テーブル]_[親テーブル]

### 8.3 データ整合性
- 主キーは必須
- 外部キーで参照整合性を保証
- ビジネスルールは制約で実装

## 9. 設計パターン

### 9.1 共通カラム
すべてのテーブルに含める標準カラム：
```markdown
| カラム名 | 型 | 説明 |
|---------|-----|------|
| ID | 識別子 | 主キー |
| CREATED_AT | 日時 | 作成日時 |
| CREATED_BY | 文字列(100) | 作成者 |
| UPDATED_AT | 日時 | 更新日時 |
| UPDATED_BY | 文字列(100) | 更新者 |
| IS_DELETED | 真偽値 | 論理削除フラグ |
```

### 9.2 履歴管理パターン
```markdown
### 履歴テーブル
- 元テーブル名_HISTORY
- 元テーブルの全カラム＋履歴管理カラム
- トリガー相当でデータをコピー
```

### 9.3 マスタデータパターン
```markdown
### マスタテーブル
- コード（主キー）
- 名称
- 表示順
- 有効開始日・終了日
- 更新頻度: 低
```

## 10. アンチパターン

### 10.1 避けるべき設計
- ❌ 1つのカラムに複数の値（カンマ区切り等）
- ❌ 汎用的すぎるテーブル（EAV パターン）
- ❌ 循環参照
- ❌ 過度な非正規化

### 10.2 よくある間違い
- 物理的な実装詳細を含める
- 特定DBMS固有の機能を前提とする
- パフォーマンスチューニングの詳細
- バックアップ・リカバリ手順

## 11. データ移行・初期化

### 11.1 初期データ
```markdown
### マスタデータ
- [マスタ種別]: [件数]件
  - 内容: [どんなデータか]
  - 更新頻度: [どのくらいの頻度で変更されるか]

### サンプルデータ
- [データ種別]: [件数]件
  - 用途: [開発・テスト用]
  - 生成方法: [どう作成するか]
```

### 11.2 移行方針
```markdown
### 既存システムからの移行
- 移行元: [既存システム名]
- 移行対象: [どのデータを移行するか]
- 変換ルール: [データ変換の概要]
- 移行タイミング: [いつ実施するか]
```

## 12. セキュリティ考慮

### 12.1 機密データ
```markdown
### 機密情報の扱い
- 個人情報: [該当カラム]
- 暗号化対象: [暗号化が必要なカラム]
- アクセス制御: [誰がアクセスできるか]
```

### 12.2 監査要件
```markdown
### 監査ログ
- 更新履歴の保持
- アクセスログの記録
- 保存期間: [どのくらい保持するか]
```

## 13. パフォーマンス考慮

### 13.1 データ量予測
```markdown
### テーブル別データ量
| テーブル名 | 初期 | 1年後 | 3年後 |
|-----------|------|--------|--------|
| [テーブルA] | 1千件 | 1万件 | 5万件 |
| [テーブルB] | 1万件 | 10万件 | 50万件 |
```

### 13.2 アクセスパターン
```markdown
### 主要なアクセスパターン
1. [パターン名]: [どんな検索/更新か]
   - 頻度: [1日何回程度]
   - 対象データ: [どのテーブルのどんなデータ]
   - 必要な応答時間: [何秒以内]
```

## 14. 拡張性考慮

### 14.1 将来の拡張ポイント
- 新しい属性の追加
- 新しいエンティティの追加
- 関係性の変更

### 14.2 スキーマ進化
- カラム追加は容易
- NULL許可で後方互換性維持
- 削除より論理削除を優先

## 15. ドキュメント管理

### 15.1 更新履歴
- 変更内容を記録
- 変更理由を明記
- 影響範囲を記載

### 15.2 レビュー記録
- レビュー日時
- レビュアー
- 指摘事項と対応