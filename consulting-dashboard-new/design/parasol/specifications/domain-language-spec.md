# パラソルドメイン言語仕様書

**作成日**: 2025-01-26  
**更新日**: 2025-01-29  
**バージョン**: 1.2.0

## 1. 概要

パラソルドメイン言語は、**ユビキタス言語と実装ドメインモデルの中間**に位置する、ビジネス中心の形式言語です。ビジネスステークホルダーと開発者の両方が理解でき、かつ実装への変換が明確な、バランスの取れた抽象度を持ちます。

### 1.1 位置づけ

```
ビジネス会話（自然言語）
    ↓
ユビキタス言語（共通語彙）
    ↓
【パラソルドメイン言語】← ここ
    ↓
実装ドメインモデル（コード）
```

### 1.2 目的
- ビジネスドメインの正確な表現
- 実装非依存の中間言語として機能
- 自動コード生成の基盤
- ドメインエキスパートと開発者の共通理解

### 1.3 設計原則
- **完全性**: DDDの主要概念をすべて表現可能
- **可読性**: ビジネス関係者にも理解可能
- **厳密性**: 曖昧さを排除した定義
- **拡張性**: 将来の拡張に対応
- **アーキテクチャ非依存**: 特定の技術に依存しない

## 2. 3要素記法

パラソルドメイン言語の中核となる記法で、すべての概念を以下の形式で記述します：

```
日本語名 [英語名] [SYSTEM_NAME]
```

### 2.1 記法の意味
- **日本語名**: ビジネス側の理解を促進
- **英語名**: 国際標準への対応、開発者向け
- **SYSTEM_NAME**: 実装時の識別子（大文字スネークケース）

### 2.2 記法例
```
顧客 [Customer] [CUSTOMER]
瞬間体験 [InstantExperience] [INSTANT_EXPERIENCE]
満足度スコア [SatisfactionScore] [SATISFACTION_SCORE]
注文明細 [OrderItem] [ORDER_ITEM]
メールアドレス [EmailAddress] [EMAIL_ADDRESS]
```

## 3. アーキテクチャ非依存原則

### 3.1 禁止事項
以下の要素は使用してはいけません：

- **特定の実装技術**: Java、Python、React、Spring Boot等
- **物理的なデータ型**: int、varchar、timestamp、Long、String等
- **インフラ詳細**: Docker、AWS、PostgreSQL、Redis等
- **通信プロトコル**: HTTP、gRPC、REST、GraphQL等
- **フレームワーク固有の概念**: @Entity、@Repository等のアノテーション

### 3.2 推奨表現
```
❌ 悪い例：
class Customer {
  private String customerId;
  private LocalDateTime createdAt;
}

✅ 良い例：
顧客 [Customer] [CUSTOMER]
├─ 顧客ID [CustomerID] [CUSTOMER_ID]
├─ 登録日時 [RegisteredAt] [REGISTERED_AT]
└─ 状態 [Status] [STATUS]
```

## 4. 文書構造

### 4.1 全体構成
パラソルドメイン言語文書は以下の順序で構成されます：

```markdown
# [パラソルドメイン名]（[Parasol Domain Name]）

## パラソルドメイン概要

## ユビキタス言語定義
### 基本型定義

## エンティティ（Entities）

## 値オブジェクト（Value Objects）

## 集約（Aggregates）

## ドメインサービス

## ドメインイベント

## ビジネスルール

## リポジトリインターフェース
```

### 4.2 必須セクション
すべてのセクションは必須です。該当する要素がない場合は「なし」と明記します。

## 5. 基本型定義

### 5.1 標準基本型
以下の基本型は標準で定義され、すべてのドメインで使用可能です：

| 型名 | 説明 | 制約 |
|------|------|------|
| UUID | 一意識別子 | 36文字、UUID v4形式 |
| STRING_N | N文字制限の文字列 | N=20,50,100,255,500 |
| TEXT | 長文テキスト | 制限なし |
| MARKDOWN | Markdown形式テキスト | CommonMark準拠 |
| EMAIL | メールアドレス | RFC5322準拠 |
| URL | URL | RFC3986準拠 |
| DATE | 日付 | YYYY-MM-DD形式 |
| TIMESTAMP | 日時 | ISO8601形式 |
| INTEGER | 整数 | -2^31 〜 2^31-1 |
| DECIMAL | 小数 | 精度指定可能 |
| BOOLEAN | 真偽値 | true/false |
| JSON | JSON形式データ | 有効なJSON |
| ENUM | 列挙型 | 定義された値のみ |
| PERCENTAGE | パーセンテージ | 0-100 |
| MONEY | 金額 | 通貨単位付き |

### 5.2 カスタム型定義
パラソルドメイン固有の型は基本型定義セクションで定義します。

## 6. パラソルエンティティ仕様

### 6.1 定義形式（基本）
エンティティは以下の形式で定義します：

```markdown
### [エンティティ名]（[Entity Name]）
[エンティティの説明]

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| [属性名] | [型] | ○/- | [属性の説明] |

#### ビジネスルール
- [ルール1]
- [ルール2]

#### パラソルドメインイベント
- [イベント名]（[EventName]）：[発生タイミング]

#### 集約ルート
[集約における役割の説明]
```

### 6.2 定義形式（構造的表現）

より構造的な表現を行う場合は、以下の形式を使用します：

```markdown
### 注文 [Order] [ORDER]
説明: 顧客の商品購入情報を管理するエンティティ

属性:
- 注文ID [OrderID] [ORDER_ID]
  - 型: UUID [UUID] [UUID_FORMAT]
  - 説明: 注文の一意識別子
- 顧客ID [CustomerID] [CUSTOMER_ID]
  - 型: 顧客ID [CustomerID] [CUSTOMER_ID]（参照）
  - 説明: 注文を行った顧客
  - 関連: 顧客 [Customer] → 注文 [Order]（1..*）
- 注文日時 [OrderedAt] [ORDERED_AT]
  - 型: 日時 [DateTime] [DATETIME]
  - 説明: 注文が確定した日時
- 合計金額 [TotalAmount] [TOTAL_AMOUNT]
  - 型: 金額 [Money] [MONEY]（値オブジェクト）
  - 説明: 注文の合計金額
- 配送先住所 [ShippingAddress] [SHIPPING_ADDRESS]
  - 型: 住所 [Address] [ADDRESS]（値オブジェクト）
  - 説明: 商品の配送先
- 注文明細 [OrderItems] [ORDER_ITEMS]
  - 型: 注文明細の配列 [OrderItem[]] [ORDER_ITEM_ARRAY]（1..*）
  - 説明: 注文に含まれる商品明細
  - 関連: 注文 [Order] *→ 注文明細 [OrderItem]（集約内包含）

不変条件:
- 合計金額は0円以上である
- 注文明細は1件以上存在する

振る舞い:
- 注文確定 [ConfirmOrder] [CONFIRM_ORDER]
  - 目的: 注文の状態を「確定」に遷移させる
  - 入力: なし
  - 出力: 状態変更結果
  - 事前条件: 注文が未確定である
  - 事後条件: 状態=確定済み、確定日時が設定される
```

### 6.3 記述規則
- エンティティ名は日本語と英語の両方を記載
- 必須属性は「○」、任意属性は「-」で表記
- 少なくとも1つの識別子属性（通常はID）が必要
- ビジネスルールは箇条書きで記述
- パラソルドメインイベントは発生タイミングを明記

## 7. 値オブジェクト仕様

### 7.1 定義形式（基本）
```markdown
### [値オブジェクト名]（[ValueObject Name]）
[値オブジェクトの説明]

#### 属性
- [属性名]: [型] - [説明]

#### 制約
- [制約1]
- [制約2]

#### メソッド（任意）
- [メソッド名]（[引数]）: [戻り値] - [説明]
```

### 7.2 定義形式（構造的表現）

```markdown
金額 [Money] [MONEY]
- 定義: ビジネス上の金銭価値を表現
- 属性:
  - 値 [amount] [AMOUNT]: DECIMAL
  - 通貨 [currency] [CURRENCY]: ENUM（JPY, USD, EUR）
- 制約: 0以上の数値、小数点以下2桁まで
- 使用エンティティ: 注文 [Order]、請求書 [Invoice]、支払い [Payment]
- 例: 1,000円、$25.50

メールアドレス [EmailAddress] [EMAIL_ADDRESS]
- 定義: 連絡先となる電子メールアドレス
- 属性:
  - 値 [value] [VALUE]: STRING_255
- 制約: RFC5322準拠の形式
- 使用エンティティ: ユーザー [User]、顧客 [Customer]、連絡先 [Contact]
- 例: user@example.com

住所 [Address] [ADDRESS]
- 定義: 物理的な所在地を表現
- 属性:
  - 郵便番号 [postalCode] [POSTAL_CODE]: STRING_20
  - 都道府県 [prefecture] [PREFECTURE]: STRING_50
  - 市区町村 [city] [CITY]: STRING_100
  - 番地 [street] [STREET]: STRING_255
  - 建物名 [building] [BUILDING]: STRING_100（任意）
- 制約: 必須項目がすべて入力されていること
- 使用エンティティ: 注文 [Order]、顧客 [Customer]、組織 [Organization]
```

### 7.3 記述規則
- 不変性を前提とした設計
- ビジネス上の制約を明確に記述
- 等価性の判定基準を明確にする

## 8. 集約仕様

### 8.1 定義形式
```markdown
### [集約名]（[Aggregate Name]）
- **集約ルート**: [エンティティ名]
- **含まれるエンティティ**: 
  - [エンティティ1]：[ルートとの関係]
  - [エンティティ2]：[ルートとの関係]
- **含まれる値オブジェクト**:
  - [値オブジェクト1]：[使用場所]
  - [値オブジェクト2]：[使用場所]
- **トランザクション境界**: [境界の説明]
- **不変条件**: 
  - [条件1]
  - [条件2]
- **外部参照ルール**:
  - 集約外からは[ルート]のIDのみで参照
  - 集約内のエンティティへの直接参照は禁止
```

### 8.2 記述規則
- 集約ルートを必ず指定
- トランザクション境界を明確に定義
- 集約全体で保証すべき不変条件を記述
- 集約に含まれる値オブジェクトを明記
- 外部からの参照方法を明確化

### 8.3 集約定義の例

```markdown
### 注文集約 [OrderAggregate] [ORDER_AGGREGATE]
- **集約ルート**: 注文 [Order]
- **含まれるエンティティ**: 
  - 注文明細 [OrderItem]：注文に含まれる商品（1..*）
  - 支払い [Payment]：注文に対する支払い（0..1）
- **含まれる値オブジェクト**:
  - 金額 [Money]：合計金額、明細金額で使用
  - 住所 [Address]：配送先住所で使用
  - 商品ID [ProductId]：注文明細の商品参照で使用
- **トランザクション境界**: 注文と注文明細は同一トランザクションで処理
- **不変条件**: 
  - 注文の合計金額は明細の合計と一致
  - 注文明細は1件以上必要
  - キャンセル済み注文は変更不可
- **外部参照ルール**:
  - 集約外からは注文IDのみで参照
  - 注文明細への直接アクセスは禁止
```

## 9. パラソルドメインサービス仕様

### 9.1 定義形式
```markdown
### [サービス名]（[Service Name]）
[サービスの説明]

#### 提供機能
- [機能名]（[メソッド名]）：[機能の説明]
```

### 9.2 オペレーションパターン

ドメインサービスの操作やエンティティの振る舞いは、以下のパターンで記述します：

```markdown
在庫引当 [AllocateStock] [ALLOCATE_STOCK]
- 目的: 受注に対して在庫を確保
- 入力: 商品ID、数量
- 出力: 引当結果
- 制約: 在庫数以内
```

### 9.3 記述規則
- 複数のエンティティに跨る処理を定義
- ステートレスな設計を前提
- ビジネスロジックの責務を明確化

## 10. パラソルドメインイベント仕様

### 10.1 定義形式
```markdown
### [イベント名]（[Event Name]）
- **発生タイミング**: [いつ発生するか]
- **ペイロード**: 
  - [属性名]: [型]
```

### 10.2 記述規則
- 過去形で命名（〜済み、〜された）
- 発生タイミングを明確に記述
- イベントに含まれるデータを明記

## 11. ビジネスルール仕様

### 11.1 定義形式
```markdown
### [カテゴリ名]ルール
1. **[ルール名]**: [ルールの内容]
2. **[ルール名]**: [ルールの内容]
```

### 11.2 ビジネスルール中心の原則

実装方法ではなく、ビジネスの制約を記述します：

```
ビジネスルール:
1. 注文は24時間以内にキャンセル可能
2. 合計金額は0円以上
3. 配送先は国内のみ
```

### 11.3 記述規則
- カテゴリ別に整理
- 優先順位がある場合は番号付け
- 具体的な条件と結果を記述

## 12. リポジトリインターフェース仕様

### 12.1 定義形式
```markdown
### [リポジトリ名]（[Repository Name]）
- findById(id: UUID): [戻り値]
- save([引数]): void
```

### 12.2 記述規則
- CRUDおよび検索メソッドを定義
- 引数と戻り値の型を明記
- パラソルドメイン層の観点で記述（実装詳細は含めない）

## 13. 状態遷移の表現

シンプルな矢印記法で状態遷移を表現します：

```
未確定 → 確定済み → 配送中 → 配送完了
         ↓
      キャンセル
```

## 14. エラーパターン

エラーコードは以下のXYZZ形式で定義します：

```
- 1xxx: ドメインエラー（ビジネスルール違反）
- 2xxx: アプリケーションエラー（入力検証等）
- 3xxx: システムエラー（外部要因）
```

例：
- 1001: 在庫不足エラー
- 2001: 必須項目未入力エラー
- 3001: 外部システム接続エラー

## 15. 記法ガイドライン

### 15.1 命名規則
- **日本語名**: ビジネス用語をそのまま使用
- **英語名**: PascalCaseまたはcamelCase
- **一貫性**: 同じ概念には同じ名前を使用

### 15.2 表記統一
- 必須/任意: ○/- で統一
- 日時表記: ISO標準に準拠
- 列挙値: 英語で記述、日本語説明を併記

### 15.3 禁止事項
- 実装技術への言及（Java、C#など）
- フレームワーク固有の概念
- UI/画面に関する記述
- SQLなどの具体的なクエリ

## 16. 簡潔性の原則

### 16.1 必要最小限の記述
- 中核となるエンティティに集中
- 主要な属性のみ（5-7個程度）
- 重要なビジネスルール（3-5個）
- 基本的な状態遷移

### 16.2 段階的詳細化
```
Phase 4: 基本定義（50-100行）
  └─ 中核概念のみ
Phase 5: 詳細展開（実装時に必要に応じて拡張）
  └─ 実装固有の詳細追加
```

## 17. 品質基準

### 17.1 完全性
- すべての必須セクションが記述されている
- エンティティの全属性が定義されている
- ビジネスルールに漏れがない

### 17.2 一貫性
- 用語の使用が統一されている
- 記法が仕様に準拠している
- 参照関係に矛盾がない

### 17.3 理解可能性
- ビジネス関係者が理解できる言葉で記述
- 専門用語には説明を付与
- 具体例を適切に使用

## 18. バージョン管理

### 18.1 バージョン番号
- メジャー.マイナー.パッチ形式
- 互換性のない変更: メジャー
- 機能追加: マイナー
- バグ修正: パッチ

### 18.2 変更履歴
文書冒頭に更新日とバージョンを記載

## 19. 検証ルール

### 19.1 構文検証
- Markdown形式の妥当性
- テーブル構造の正確性
- 必須項目の存在確認

### 19.2 意味検証
- 型定義の妥当性
- 参照整合性
- ビジネスルールの無矛盾性

## 20. リレーションシップ記法

### 20.1 関連の種類

| 記号 | 意味 | 説明 |
|------|------|------|
| → | 参照 | エンティティ間の参照関係 |
| *→ | 包含 | 集約内の強い所有関係 |
| ⇒ | 依存 | 処理の依存関係 |
| ↔ | 相互参照 | 双方向の参照関係 |

### 20.2 多重度記法

| 記法 | 意味 |
|------|------|
| 1 | 必ず1つ |
| 0..1 | 0または1つ |
| * | 0以上 |
| 1..* | 1以上 |
| n..m | n以上m以下 |

### 20.3 関連の記述例

```markdown
# エンティティの属性での記述
- 顧客ID [CustomerId] [CUSTOMER_ID]
  - 型: 顧客ID [CustomerId] [CUSTOMER_ID]（参照）
  - 関連: 顧客 [Customer] → 注文 [Order]（1..*）

# 集約での記述
- 含まれるエンティティ:
  - 注文明細 [OrderItem]：注文 [Order] *→ 注文明細 [OrderItem]（1..*）

# 値オブジェクトの使用
- 配送先住所 [ShippingAddress] [SHIPPING_ADDRESS]
  - 型: 住所 [Address] [ADDRESS]（値オブジェクト）
  - 説明: 商品の配送先
```

## 21. 拡張ポイント

### 21.1 カスタム型
基本型定義セクションで独自型を定義可能

### 21.2 追加セクション
標準セクション以外に、パラソルドメイン固有のセクションを追加可能（ただし標準セクションの後に配置）

### 21.3 アノテーション
将来の拡張のため、`@`記号によるアノテーションを予約