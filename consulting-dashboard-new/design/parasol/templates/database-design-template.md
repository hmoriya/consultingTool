# データベース設計: [サービス名] [[Service Name]] [[SERVICE_NAME]]

## 設計概要

### 対象ドメイン
- **ドメイン名**: [パラソルドメイン名] [[Domain]] [[DOMAIN]]
- **主要エンティティ**: [エンティティ1]、[エンティティ2]、[エンティティ3]
- **ビジネス目的**: [このデータベースが支えるビジネス機能]

### 設計方針
- **正規化レベル**: 第3正規形を基本とし、パフォーマンス要件により部分的に非正規化
- **スケーラビリティ**: [想定される成長率と対応方針]
- **可用性要件**: [どの程度の可用性が必要か]
- **整合性要件**: [トランザクション境界と整合性レベル]

### 前提条件
- **利用者数**: [想定される同時接続数]
- **データ量**: [初期データ量と成長予測]
- **アクセスパターン**: [読み取り中心/書き込み中心/バランス型]
- **保存期間**: [データの保持期間]

## テーブル設計

### プロジェクトテーブル [ProjectTable] [PROJECT_TABLE]
**対応エンティティ**: プロジェクト [Project] [PROJECT]

| カラム名 | 型 | 必須 | 説明 | 制約 |
|---------|-----|------|------|------|
| ID | 識別子 | ○ | プロジェクトID（主キー） | UUID形式、一意 |
| PROJECT_NUMBER | 文字列(20) | ○ | プロジェクト番号 | 一意、形式：PRJ-YYYY-9999 |
| PROJECT_NAME | 文字列(100) | ○ | プロジェクト名 | - |
| DESCRIPTION | テキスト | - | プロジェクト説明 | - |
| CLIENT_ID | 識別子 | ○ | クライアントID（外部キー） | クライアントテーブル参照 |
| STATUS | 列挙型 | ○ | 状態 | PLANNING/ACTIVE/COMPLETED/CANCELLED |
| START_DATE | 日付 | ○ | 開始日 | - |
| END_DATE | 日付 | ○ | 終了日 | START_DATE以降 |
| BUDGET_AMOUNT | 金額 | - | 予算金額 | 0以上 |
| CREATED_AT | 日時 | ○ | 作成日時 | 自動設定 |
| CREATED_BY | 文字列(100) | ○ | 作成者 | - |
| UPDATED_AT | 日時 | ○ | 更新日時 | 自動更新 |
| UPDATED_BY | 文字列(100) | ○ | 更新者 | - |
| IS_DELETED | 真偽値 | ○ | 削除フラグ | デフォルト: false |

**ビジネスキー**: PROJECT_NUMBER
**インデックス**: 
- 主キー: ID
- 一意キー: PROJECT_NUMBER
- 検索用: CLIENT_ID, STATUS, START_DATE

### タスクテーブル [TaskTable] [TASK_TABLE]
**対応エンティティ**: タスク [Task] [TASK]

| カラム名 | 型 | 必須 | 説明 | 制約 |
|---------|-----|------|------|------|
| ID | 識別子 | ○ | タスクID（主キー） | UUID形式、一意 |
| PROJECT_ID | 識別子 | ○ | プロジェクトID（外部キー） | プロジェクトテーブル参照 |
| TASK_NUMBER | 文字列(20) | ○ | タスク番号 | プロジェクト内で一意 |
| TASK_NAME | 文字列(200) | ○ | タスク名 | - |
| DESCRIPTION | テキスト | - | タスク説明 | - |
| ASSIGNEE_ID | 識別子 | - | 担当者ID（外部キー） | ユーザーテーブル参照 |
| STATUS | 列挙型 | ○ | 状態 | TODO/IN_PROGRESS/REVIEW/DONE |
| PRIORITY | 列挙型 | ○ | 優先度 | HIGH/MEDIUM/LOW |
| DUE_DATE | 日付 | - | 期限日 | - |
| ESTIMATED_HOURS | 小数 | - | 見積時間 | 0以上 |
| ACTUAL_HOURS | 小数 | - | 実績時間 | 0以上 |
| PARENT_TASK_ID | 識別子 | - | 親タスクID（自己参照） | タスクテーブル参照 |
| CREATED_AT | 日時 | ○ | 作成日時 | 自動設定 |
| CREATED_BY | 文字列(100) | ○ | 作成者 | - |
| UPDATED_AT | 日時 | ○ | 更新日時 | 自動更新 |
| UPDATED_BY | 文字列(100) | ○ | 更新者 | - |
| IS_DELETED | 真偽値 | ○ | 削除フラグ | デフォルト: false |

**ビジネスキー**: PROJECT_ID + TASK_NUMBER
**インデックス**:
- 主キー: ID
- 複合一意キー: PROJECT_ID, TASK_NUMBER
- 検索用: PROJECT_ID, ASSIGNEE_ID, STATUS, DUE_DATE

### プロジェクトメンバーテーブル [ProjectMemberTable] [PROJECT_MEMBER_TABLE]
**対応エンティティ**: プロジェクトメンバー（関連テーブル）

| カラム名 | 型 | 必須 | 説明 | 制約 |
|---------|-----|------|------|------|
| PROJECT_ID | 識別子 | ○ | プロジェクトID | プロジェクトテーブル参照 |
| USER_ID | 識別子 | ○ | ユーザーID | ユーザーテーブル参照 |
| ROLE | 列挙型 | ○ | 役割 | PM/MEMBER/REVIEWER/OBSERVER |
| JOIN_DATE | 日付 | ○ | 参加日 | - |
| LEAVE_DATE | 日付 | - | 離脱日 | JOIN_DATE以降 |
| ALLOCATION_RATE | 整数 | ○ | 稼働率（%） | 0-100 |
| CREATED_AT | 日時 | ○ | 作成日時 | 自動設定 |
| CREATED_BY | 文字列(100) | ○ | 作成者 | - |

**主キー**: PROJECT_ID, USER_ID（複合主キー）
**インデックス**:
- 主キー: PROJECT_ID, USER_ID
- 検索用: USER_ID, ROLE

## リレーション設計

### テーブル間の関係

```
プロジェクト (1) ---- (*) タスク
    |
    +------ (*) プロジェクトメンバー (*) ------ (1) ユーザー
    |
    +------ (1) クライアント
```

### 参照整合性

1. **プロジェクト → クライアント**
   - 外部キー: PROJECT_TABLE.CLIENT_ID → CLIENT_TABLE.ID
   - 削除時: 制限（クライアントが使用中は削除不可）
   - NULL許可: 不可

2. **タスク → プロジェクト**
   - 外部キー: TASK_TABLE.PROJECT_ID → PROJECT_TABLE.ID
   - 削除時: カスケード（プロジェクト削除時にタスクも削除）
   - NULL許可: 不可

3. **タスク → ユーザー（担当者）**
   - 外部キー: TASK_TABLE.ASSIGNEE_ID → USER_TABLE.ID
   - 削除時: NULL設定（ユーザー削除時は未割当に）
   - NULL許可: 可

4. **タスク → タスク（親子関係）**
   - 外部キー: TASK_TABLE.PARENT_TASK_ID → TASK_TABLE.ID
   - 削除時: 制限（子タスクがある親は削除不可）
   - NULL許可: 可

5. **プロジェクトメンバー → プロジェクト/ユーザー**
   - 外部キー: PROJECT_ID → PROJECT_TABLE.ID
   - 外部キー: USER_ID → USER_TABLE.ID
   - 削除時: カスケード（どちらか削除時に関連も削除）

## インデックス設計

### パフォーマンス要件
- **検索応答時間**: 1秒以内（通常時）、3秒以内（ピーク時）
- **同時接続数**: 最大100ユーザー
- **主要な検索パターン**:
  1. プロジェクト一覧（状態、期間でフィルタ）
  2. タスク一覧（プロジェクト、担当者、状態でフィルタ）
  3. ユーザー別タスク一覧

### インデックス定義

#### プロジェクトステータスインデックス [ProjectStatusIndex] [PROJECT_STATUS_INDEX]
- **対象テーブル**: PROJECT_TABLE
- **対象カラム**: STATUS, START_DATE
- **種類**: 非一意
- **目的**: ステータス別プロジェクト一覧の高速化
- **使用場面**: ダッシュボード表示、プロジェクト一覧画面

#### タスク担当者インデックス [TaskAssigneeIndex] [TASK_ASSIGNEE_INDEX]
- **対象テーブル**: TASK_TABLE
- **対象カラム**: ASSIGNEE_ID, STATUS, DUE_DATE
- **種類**: 非一意
- **目的**: 担当者別タスク一覧の高速化
- **使用場面**: 個人のタスク一覧、ワークロード確認

## ビジネスルール実装

### 制約

#### テーブルレベル制約
- **プロジェクト期間制約**: END_DATE >= START_DATE
  - エラー時: "終了日は開始日以降に設定してください"
  
- **タスク見積制約**: ACTUAL_HOURS >= 0 AND ESTIMATED_HOURS >= 0
  - エラー時: "時間は0以上で入力してください"

- **稼働率制約**: ALLOCATION_RATE BETWEEN 0 AND 100
  - エラー時: "稼働率は0%から100%の間で設定してください"

#### カラムレベル制約
- **プロジェクト番号形式**: 正規表現 ^PRJ-[0-9]{4}-[0-9]{4}$
  - 許可値: PRJ-2024-0001 形式
  - デフォルト値: なし（アプリケーションで生成）

- **ステータス遷移制約**:
  - プロジェクト: PLANNING → ACTIVE → COMPLETED
  - タスク: TODO → IN_PROGRESS → REVIEW → DONE
  - 逆行不可（アプリケーション層で実装）

### 自動処理

#### 監査情報の自動更新
- **作成時**: CREATED_AT, CREATED_BY を自動設定
- **更新時**: UPDATED_AT, UPDATED_BY を自動更新
- **実装注記**: アプリケーション層またはトリガーで実装

#### プロジェクト番号の自動採番
- **タイミング**: プロジェクト作成時
- **処理内容**: 年度と連番で自動生成
- **形式**: PRJ-YYYY-9999（YYYYは年度、9999は連番）

## データ移行・初期化

### 初期データ

#### マスタデータ
- **ステータスマスタ**: 10件
  - 内容: プロジェクトとタスクの状態定義
  - 更新頻度: 年1回程度

- **ロールマスタ**: 5件
  - 内容: プロジェクトメンバーの役割定義
  - 更新頻度: 変更なし

#### サンプルデータ
- **プロジェクト**: 20件
  - 用途: 開発・デモ用
  - 生成方法: 過去2年分の架空プロジェクト

- **タスク**: 200件
  - 用途: 開発・デモ用
  - 生成方法: 各プロジェクトに10件程度

### 移行方針

#### 既存システムからの移行
- **移行元**: 旧プロジェクト管理Excel
- **移行対象**: 
  - アクティブなプロジェクト（約50件）
  - 過去1年分の完了プロジェクト（約100件）
- **変換ルール**:
  - Excelの行 → プロジェクトレコード
  - タスクシート → タスクレコード
- **移行タイミング**: 新システム稼働前の週末

## セキュリティ・監査

### 機密情報の扱い
- **個人情報**: USER_TABLE の EMAIL, PHONE
- **機密プロジェクト**: PROJECT_TABLE に機密フラグ追加検討
- **アクセス制御**: アプリケーション層で実装
- **暗号化**: パスワードはハッシュ化、他は平文

### 監査要件
- **更新履歴**: 全テーブルで作成者・更新者・日時を記録
- **削除履歴**: 論理削除により履歴保持
- **アクセスログ**: アプリケーション層で記録
- **保存期間**: 3年間（法令要件に準拠）

## 拡張性・将来対応

### 想定される拡張
- **多言語対応**: 名称系カラムの多言語化
- **ファイル添付**: ドキュメント管理テーブルの追加
- **ワークフロー**: 承認プロセステーブルの追加
- **外部連携**: 他システムとの連携用ID追加

### スキーマ進化方針
- **後方互換性**: 既存カラムは削除せず、非推奨とする
- **カラム追加**: NULL許可で追加し、段階的に必須化
- **テーブル追加**: 既存構造に影響しない形で追加
- **命名規則維持**: 新規追加時も同じ規則を適用