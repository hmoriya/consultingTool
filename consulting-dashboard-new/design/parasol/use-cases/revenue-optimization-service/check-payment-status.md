# ユースケース: 入金状況を確認する [Check Payment Status] [CHECK_PAYMENT_STATUS]

## ユースケース概要

### 目的
送付済み請求書に対する入金状況を定期的に確認し、支払遅延の早期検知と適切な売掛金管理を実現することで、キャッシュフローの健全性を維持する。

### アクター
- **主アクター**: 経理担当者 [Accounting Staff] [ACCOUNTING_STAFF]
  - 説明: 日次の入金確認と売掛金管理を担当する
- **副アクター**: 財務マネージャー [Finance Manager] [FINANCE_MANAGER]
  - 説明: 入金遅延状況の監視と対応方針の決定を行う
- **副アクター**: 銀行システム [Bank System] [BANK_SYSTEM]
  - 説明: 入金データの自動連携と残高情報の提供を行う

### 事前条件
1. 請求書が送付済みで、入金期限が設定されている
2. 銀行システムとの連携が正常に動作している
3. 入金消込のための照合ルールが設定されている
4. 経理担当者が入金確認権限を持っている

### 事後条件
1. 全ての入金が正確に確認・記録されている
2. 支払遅延案件が特定され、適切に分類されている
3. 入金状況レポートが作成され、関係者に共有されている
4. 必要に応じて督促プロセスが開始されている

### トリガー
- **種別**: 時間駆動
- **詳細**: 日次の入金確認バッチ処理、または経理担当者による手動実行

## 基本フロー

1. 経理担当者が入金確認プロセスを開始し、確認対象期間を指定する
2. システムが銀行システムから入金データを自動取得する
3. システムが取得した入金データと送付済み請求書を自動照合する
4. 経理担当者が照合結果を確認し、不一致項目をチェックする
5. システムが入金状況を分類（正常入金、遅延、部分入金、未入金）する
6. 経理担当者が支払遅延案件の詳細を確認・分析する
7. システムが入金状況レポートを生成し、財務マネージャーに送信する
8. システムが必要に応じて督促プロセスの開始を提案する

## 代替フロー

### 代替フロー1: 手動入金の登録
- **分岐点**: 基本フロー ステップ3
- **条件**: 現金払いや他行振込等で自動照合できない入金がある場合
1. 経理担当者が手動入金の情報（金額、入金日、入金者等）を入力する
2. システムが入力情報と請求書の照合候補を表示する
3. 経理担当者が適切な請求書を選択し、照合を確定する
4. 基本フロー ステップ5に進む

### 代替フロー2: 部分入金の処理
- **分岐点**: 基本フロー ステップ5
- **条件**: 請求額より少ない金額の入金があった場合
1. システムが部分入金の金額と請求残額を計算する
2. 経理担当者が部分入金の理由を確認（分割払い、割引等）
3. システムが残額の支払期限を設定し、新たな督促対象として登録する
4. 基本フロー ステップ6に進む

## 例外フロー

### 例外フロー1: 銀行システム接続エラー
- **発生点**: 基本フロー ステップ2
- **条件**: 銀行システムとの接続でエラーが発生した場合
1. システムがエラー内容と発生時刻を記録する
2. システムが自動リトライを実行（最大3回、10分間隔）
3. リトライ失敗時はシステム管理者に障害通知を送信する
4. 手動での入金データ取得に切り替えて処理を継続する

### 例外フロー2: 照合不可能な入金
- **発生点**: 基本フロー ステップ3
- **条件**: 入金データに対応する請求書が特定できない場合
1. システムが照合不可能な入金を「保留入金」として分類する
2. 経理担当者が入金者情報と過去の取引履歴を調査する
3. プロジェクトマネージャーにクライアントへの確認を依頼する
4. 照合先が判明次第、手動で照合処理を実行する

### 例外フロー3: 過剰入金の発生
- **発生点**: 基本フロー ステップ5
- **条件**: 請求額を超える金額の入金があった場合
1. システムが過剰入金の金額を計算し、経理担当者に通知する
2. 経理担当者が過剰入金の理由を調査（次月分前払い、誤送金等）
3. クライアントに過剰入金の確認と処理方法を問い合わせる
4. 返金または将来請求への充当処理を実行する

## ビジネスルール

1. **日次確認ルール**: 入金状況は営業日毎に必ず確認する
   - 適用タイミング: 基本フロー ステップ1
   - 例: 平日9:00に自動実行、休日明けは前営業日分もまとめて確認

2. **自動照合優先ルール**: 可能な限り自動照合を使用し、手動処理は最小限にする
   - 適用タイミング: 基本フロー ステップ3
   - 例: 請求書番号、金額、入金日の3つが一致すれば自動照合

3. **遅延分類ルール**: 支払期限超過の日数により遅延レベルを分類する
   - 適用タイミング: 基本フロー ステップ5
   - 例: 1-7日遅延：注意、8-30日：警告、31日以上：重要

## 入出力情報

### 入力情報
- 銀行入金データ [Bank Payment Data] [BANK_PAYMENT_DATA]
  - 内容: 入金日、入金額、入金者名、振込人コード、摘要
  - 形式: 銀行API経由またはCSVファイル
  - 必須/任意: 必須
  - 検証ルール: 入金額は正数、入金日は過去30日以内

- 送付済み請求書データ [Sent Invoice Data] [SENT_INVOICE_DATA]
  - 内容: 請求書番号、請求額、支払期限、クライアント情報
  - 形式: システム内部データ
  - 必須/任意: 必須
  - 検証ルール: 送付済み状態、支払期限が設定済み

### 出力情報
- 入金状況レポート [Payment Status Report] [PAYMENT_STATUS_REPORT]
  - 内容: 入金件数、金額、遅延件数、未回収額、前日比較
  - 用途: 財務状況の把握とキャッシュフロー管理
  - 保存期間: 3年間

- 売掛金残高表 [Accounts Receivable Balance] [AR_BALANCE]
  - 内容: クライアント別・期間別の未回収額、遅延日数
  - 用途: 与信管理と督促優先度の決定
  - 形式: Excel形式のレポート

## 非機能要件

- **応答性**:
  - 日次処理: 通常10分以内、大量データ時30分以内
  - 手動確認: リアルタイム（5秒以内）

- **利用可能性**:
  - 利用時間: 24時間365日（入金は時間外も発生するため）
  - 計画停止: 銀行システムメンテナンス時のみ

- **セキュリティ**:
  - 暗号化: 銀行データ連携時は必須
  - アクセス制御: 経理担当者以上の権限が必要
  - 監査ログ: 全ての入金確認操作を記録

- **精度**:
  - 自動照合精度: 95%以上
  - 誤照合率: 1%以下

## 関連ユースケース

- <<include>> 銀行データを取得する [Retrieve Bank Data] [RETRIEVE_BANK_DATA]
  - 説明: 入金確認開始時に必ず実行される

- <<extend>> 督促を実施する [Execute Collection] [EXECUTE_COLLECTION]
  - 説明: 支払遅延が検知された場合のみ実行される

- 先行: 請求書を送付する [Send Invoice] [SEND_INVOICE]
  - 説明: このユースケースの前に完了している必要がある

- 後続: 消込処理を行う [Perform Payment Matching] [PERFORM_PAYMENT_MATCHING]
  - 説明: 入金確認後に通常実行される

## ページ遷移概要

```
[入金管理ダッシュボード] → [入金データ取得ページ] → [照合結果ページ] → [入金状況分析ページ] → [レポート生成ページ]
        ↓                   ↓                      ↓                ↓
   [売掛金一覧ページ]    [手動入金登録ページ]    [遅延分析ページ]  [督促準備ページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 標準的な日次入金確認を最初から最後まで完全実行
   - 自動照合と手動照合の両方で正常動作を確認
   - 入金状況レポートの正確性を確認

2. **代替系テスト**:
   - 手動入金登録と部分入金処理を個別に実行
   - 各代替フローの正常動作を確認

3. **例外系テスト**:
   - 銀行システムエラー、照合不可能入金、過剰入金を意図的に発生
   - エラーハンドリングと例外処理を確認

4. **パフォーマンステスト**:
   - 大量入金データ（1000件）での処理性能を確認
   - ピーク時間帯での応答性能を確認

5. **精度テスト**:
   - 自動照合の精度と誤照合率を測定
   - 複雑な照合パターンでの正確性を確認