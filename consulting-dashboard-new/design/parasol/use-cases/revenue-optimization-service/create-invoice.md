# ユースケース: 請求書を作成する [Create Invoice] [CREATE_INVOICE]

## ユースケース概要

### 目的
認識済みの収益に基づいて適切な請求書を作成し、クライアントに対する請求処理の基礎となる正確な請求データを生成する。

### アクター
- **主アクター**: 財務マネージャー [Finance Manager] [FINANCE_MANAGER]
  - 説明: 請求書の内容確認と承認を担当する
- **副アクター**: 経理担当者 [Accounting Staff] [ACCOUNTING_STAFF]
  - 説明: 請求書の作成処理と関連データの準備を行う
- **副アクター**: プロジェクトマネージャー [Project Manager] [PROJECT_MANAGER]
  - 説明: 請求根拠となる成果物情報と作業内容の提供を行う

### 事前条件
1. 請求対象となる収益が適切に認識・計上されている
2. クライアントの請求先情報が最新に更新されている
3. 契約で定められた請求条件（サイクル、支払期限等）が明確である
4. 請求書テンプレートと必要な情報が準備されている

### 事後条件
1. 正確な請求書が作成され、送付可能な状態で保存されている
2. 請求データが売掛金管理システムに登録されている
3. 請求書作成の監査証跡が記録されている
4. 関係者に請求書作成完了が通知されている

### トリガー
- **種別**: 時間駆動 + 要求駆動
- **詳細**: 月次請求処理タイミング、またはマイルストーン達成による個別請求要求

## 基本フロー

1. 経理担当者が請求書作成プロセスを開始し、請求対象期間を指定する
2. システムが指定期間の認識済み収益データを収集・集計する
3. システムが契約別・クライアント別に請求額を計算し、請求書データを生成する
4. 経理担当者が請求書の内容（金額、明細、宛先等）を確認・検証する
5. システムがプロジェクトマネージャーに作業内容の確認を依頼する
6. プロジェクトマネージャーが請求内容の妥当性を確認・承認する
7. 財務マネージャーが最終的な請求書内容を確認し、発行を承認する
8. システムが正式な請求書を生成し、送付準備完了状態で保存する

## 代替フロー

### 代替フロー1: 請求書の分割作成
- **分岐点**: 基本フロー ステップ3
- **条件**: 1つの契約で複数プロジェクトがあり、分割請求が必要な場合
1. 経理担当者が分割請求の単位（プロジェクト別、部門別等）を指定する
2. システムが指定された単位で請求額を分割計算する
3. 経理担当者が分割後の請求書構成を確認・調整する
4. 基本フロー ステップ4に進む

### 代替フロー2: 請求書の統合作成
- **分岐点**: 基本フロー ステップ3
- **条件**: 同一クライアントの複数契約を1つの請求書にまとめる場合
1. 経理担当者が統合対象となる契約を選択する
2. システムが選択された契約の請求額を合算計算する
3. システムが統合請求書の明細構成を作成する
4. 基本フロー ステップ4に進む

## 例外フロー

### 例外フロー1: 収益データの不整合
- **発生点**: 基本フロー ステップ2
- **条件**: 収益認識データに矛盾や欠損が発見された場合
1. システムが不整合の詳細（金額相違、期間ずれ等）を特定する
2. システムが影響範囲と修正の必要性を経理担当者に通知する
3. 経理担当者が財務マネージャーに確認し、修正方針を決定する
4. 収益データ修正完了後、基本フロー ステップ2から再開する

### 例外フロー2: クライアント情報の不備
- **発生点**: 基本フロー ステップ4
- **条件**: 請求先住所や担当者情報が不正確または不足している場合
1. システムが不足している情報項目を特定・表示する
2. 経理担当者がクライアント管理システムから最新情報を取得する
3. プロジェクトマネージャーにクライアント情報の確認を依頼する
4. 情報更新完了後、基本フロー ステップ4から再開する

### 例外フロー3: 請求承認の却下
- **発生点**: 基本フロー ステップ7
- **条件**: 財務マネージャーが請求書内容を却下した場合
1. システムが却下理由と修正要求をプロジェクトマネージャーと経理担当者に通知する
2. 経理担当者が修正要求に基づき請求書内容を調整する
3. 必要に応じて収益認識の確認や契約条件の再確認を実施する
4. 修正完了後、基本フロー ステップ4から再開する

## ビジネスルール

1. **請求タイミングルール**: 請求書は収益認識完了後、契約で定められたサイクルで作成する
   - 適用タイミング: 基本フロー ステップ1
   - 例: 月末締め翌月10日請求、マイルストーン達成から5営業日以内

2. **請求額検証ルール**: 請求額は認識済み収益額と完全に一致しなければならない
   - 適用タイミング: 基本フロー ステップ3-4
   - 例: 収益認識額500万円に対し請求額も必ず500万円

3. **承認権限ルール**: 一定額以上の請求書は複数段階の承認が必要
   - 適用タイミング: 基本フロー ステップ6-7
   - 例: 1000万円以上は役員承認、100万円以上は部門長承認

## 入出力情報

### 入力情報
- 認識済み収益データ [Recognized Revenue Data] [RECOGNIZED_REVENUE_DATA]
  - 内容: 収益ID、認識額、認識日、契約参照、作業内容
  - 形式: 構造化データ（JSON）
  - 必須/任意: 必須
  - 検証ルール: 認識済み状態の収益のみ、金額は正数

- 契約請求条件 [Contract Billing Terms] [CONTRACT_BILLING_TERMS]
  - 内容: 請求サイクル、支払期限、請求方法、特別条件
  - 形式: 契約管理システムから取得
  - 必須/任意: 必須
  - 検証ルール: 有効期間内の契約、請求条件が明確

### 出力情報
- 請求書データ [Invoice Data] [INVOICE_DATA]
  - 内容: 請求書番号、請求額、明細、支払期限、請求先情報
  - 用途: 請求書送付と売掛金管理の基礎データ
  - 保存期間: 7年間（法的要件）

- 請求書PDF [Invoice PDF] [INVOICE_PDF]
  - 内容: 正式な請求書フォーマット、会社印、電子署名
  - 用途: クライアントへの送付用正式文書
  - 形式: PDF形式、改ざん防止機能付き

## 非機能要件

- **応答性**:
  - 通常時: 請求書作成は1分以内
  - 大量処理: 月次一括作成は30分以内

- **利用可能性**:
  - 利用時間: 平日8:00-20:00（必須）、その他（ベストエフォート）
  - 計画停止: 月次処理完了後のメンテナンス時のみ

- **セキュリティ**:
  - 認証: ログイン必須
  - 認可: 経理担当者以上の権限が必要
  - 暗号化: 請求書PDFは暗号化保存

- **使いやすさ**:
  - プレビュー機能: 作成前に請求書イメージを確認可能
  - 一括処理: 複数請求書の同時作成に対応

## 関連ユースケース

- <<include>> 収益データを検証する [Validate Revenue Data] [VALIDATE_REVENUE_DATA]
  - 説明: 請求書作成前に必ず実行される

- <<extend>> 請求書を修正する [Modify Invoice] [MODIFY_INVOICE]
  - 説明: 作成後に修正が必要な場合のみ実行

- 先行: 収益を認識する [Recognize Revenue] [RECOGNIZE_REVENUE]
  - 説明: このユースケースの前に完了している必要がある

- 後続: 請求書を送付する [Send Invoice] [SEND_INVOICE]
  - 説明: このユースケースの後に通常実行される

## ページ遷移概要

```
[請求管理ダッシュボード] → [請求対象選択ページ] → [請求書作成ページ] → [内容確認ページ] → [承認依頼ページ] → [作成完了ページ]
        ↓                   ↓                    ↓                ↓
   [収益詳細ページ]      [分割・統合設定ページ]   [プレビューページ]  [承認状況ページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 標準的な月次請求書作成を最初から最後まで完全実行
   - 単一契約と複数契約での請求書作成を確認
   - 請求書PDFの正確性と整合性を確認

2. **代替系テスト**:
   - 分割請求と統合請求を個別に実行
   - 各代替フローの正常動作を確認

3. **例外系テスト**:
   - データ不整合、情報不備、承認却下を意図的に発生
   - エラーハンドリングと修正プロセスを確認

4. **境界値テスト**:
   - 最小・最大請求額での正常処理を確認
   - 承認権限の境界値での動作を確認

5. **セキュリティテスト**:
   - 請求書データの機密性確保を確認
   - 不正な修正操作の拒否を確認