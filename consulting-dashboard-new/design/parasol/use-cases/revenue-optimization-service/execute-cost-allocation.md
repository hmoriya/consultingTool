# ユースケース: コスト配分を実行する [Execute Cost Allocation] [EXECUTE_COST_ALLOCATION]

## ユースケース概要

### 目的
承認されたコスト配分計画に基づいて実際のコスト配分処理を実行し、各プロジェクトや部門への予算配分を確定させることで、組織の財務統制を実現する。

### アクター
- **主アクター**: 経理担当者 [Accounting Staff] [ACCOUNTING_STAFF]
  - 説明: 承認済み配分計画に基づく実際の会計処理実行を担当する
- **副アクター**: 財務マネージャー [Finance Manager] [FINANCE_MANAGER]
  - 説明: 配分実行の監督と例外事項の判断を行う
- **副アクター**: システム管理者 [System Administrator] [SYSTEM_ADMINISTRATOR]
  - 説明: 配分処理の技術的な監視と障害対応を行う

### 事前条件
1. コスト配分計画が全ての必要な承認者により承認されている
2. 配分対象のプロジェクト・部門のマスタデータが最新に更新されている
3. 会計システムとの連携が正常に動作している
4. 経理担当者が配分実行権限を持っている

### 事後条件
1. 全ての配分対象に対してコストが正確に配分されている
2. 配分実行結果が会計システムに反映されている
3. 配分処理のログと監査証跡が完全に記録されている
4. 関係者に配分完了通知が送信されている

### トリガー
- **種別**: 要求駆動 + 時間駆動
- **詳細**: 承認完了時の手動実行、または設定されたスケジュール時間での自動実行

## 基本フロー

1. 経理担当者が配分実行画面にアクセスし、承認済み配分計画を確認する
2. システムが実行対象の配分計画詳細と影響範囲を表示する
3. 経理担当者が配分実行前の最終確認（配分額、対象、実行タイミング）を行う
4. システムが会計システムとの接続状況と配分可能性を事前チェックする
5. 経理担当者が配分実行を指示する
6. システムが各プロジェクト・部門に対して順次コスト配分処理を実行する
7. システムが配分結果を検証し、計画との一致性を確認する
8. システムが配分完了を記録し、関係者に通知を送信する

## 代替フロー

### 代替フロー1: 段階的実行
- **分岐点**: 基本フロー ステップ5
- **条件**: 大量の配分対象があり、段階的に実行したい場合
1. 経理担当者が「段階実行」オプションを選択する
2. システムが配分対象をグループ別（部門単位、金額順等）に分割表示する
3. 経理担当者が実行順序とグループを指定する
4. システムが指定されたグループから順次配分を実行する
5. 基本フロー ステップ7に進む

### 代替フロー2: 試行実行
- **分岐点**: 基本フロー ステップ3
- **条件**: 本実行前に配分処理をテストしたい場合
1. 経理担当者が「試行実行」を選択する
2. システムが本番データに影響しない模擬配分処理を実行する
3. システムが試行結果とエラー・警告の有無を表示する
4. 経理担当者が結果を確認し、本実行するかを決定する
5. 本実行の場合は基本フロー ステップ5に戻る

## 例外フロー

### 例外フロー1: 配分処理エラー
- **発生点**: 基本フロー ステップ6
- **条件**: 個別の配分処理でエラーが発生した場合
1. システムがエラー内容と影響範囲を詳細に記録する
2. システムが正常処理分は継続し、エラー分は別途処理する
3. システムがエラー詳細と対処方法を経理担当者に通知する
4. 経理担当者がエラー対応方法（スキップ・修正・中断）を選択する
5. 選択に応じて適切な処理を継続

### 例外フロー2: 会計システム接続障害
- **発生点**: 基本フロー ステップ4
- **条件**: 会計システムとの接続に問題がある場合
1. システムが接続障害の詳細を診断し記録する
2. システムが自動復旧を試行する（3回まで）
3. 自動復旧失敗時はシステム管理者に障害通知を送信する
4. 一時的な問題の場合は待機、深刻な場合は処理中断

### 例外フロー3: 権限期限切れ
- **発生点**: 基本フロー ステップ1
- **条件**: ユーザーの配分実行権限が期限切れの場合
1. システムが権限状況を確認し、期限切れを検出する
2. システムが権限更新手続きと承認者情報を案内する
3. 緊急時の場合は財務マネージャーへの代理実行依頼を提案
4. ユースケース一時停止

## ビジネスルール

1. **配分一意性ルール**: 同一期間・同一コスト項目の配分は重複実行を禁止する
   - 適用タイミング: 基本フロー ステップ4
   - 例: 2024年1月の人件費配分は1回のみ実行可能

2. **配分完全性ルール**: 配分実行中の中断時は全てロールバックまたは完全実行のみ許可
   - 適用タイミング: 全プロセスを通して適用
   - 例: 部分的な配分状態での処理停止は不可

3. **監査ログ必須ルール**: 全ての配分操作は詳細なログ記録が必須
   - 適用タイミング: 全操作で適用
   - 例: 誰が、いつ、何を、どのように配分したかを完全記録

## 入出力情報

### 入力情報
- 配分実行指示 [Allocation Execution Instruction] [ALLOCATION_EXECUTION_INSTRUCTION]
  - 内容: 実行タイミング、実行方式（一括・段階・試行）
  - 形式: 選択肢（ラジオボタン）+ 日時指定
  - 必須/任意: 必須
  - 検証ルール: 承認済み計画のみ実行可能

- 実行オプション [Execution Options] [EXECUTION_OPTIONS]
  - 内容: エラー処理方針、通知設定、実行順序
  - 形式: チェックボックス + 設定値
  - 必須/任意: 任意
  - 初期値: システム標準設定

### 出力情報
- 配分実行結果報告書 [Allocation Execution Report] [ALLOCATION_EXECUTION_REPORT]
  - 内容: 実行サマリ、成功・失敗件数、エラー詳細、処理時間
  - 用途: 財務マネージャーによる結果確認と監査対応
  - 保存期間: 7年間（法的要件）

- 会計仕訳データ [Accounting Journal Data] [ACCOUNTING_JOURNAL_DATA]
  - 内容: 借方・貸方の仕訳エントリ、配分コード、摘要
  - 用途: 会計システムでの正式な帳簿記録
  - 形式: CSV形式での会計システム連携

## 非機能要件

- **応答性**:
  - 通常時: 配分実行は対象数×100ms以内
  - ピーク時: 通常時の2倍以内

- **利用可能性**:
  - 利用時間: 24時間365日（月次締め処理のため）
  - 計画停止: 年1回のメンテナンス時のみ

- **セキュリティ**:
  - 認証: 多要素認証必須
  - 認可: 経理担当者以上の権限が必要
  - 監査: 全操作を改ざん不可能な形で記録

- **使いやすさ**:
  - 操作手順: 確認画面を含め最大3ステップ
  - プログレス表示: 処理進捗を%表示

## 関連ユースケース

- <<include>> 多要素認証を実行する [Execute Multi-Factor Authentication] [EXECUTE_MULTI_FACTOR_AUTHENTICATION]
  - 説明: 配分実行前に必ず実行される

- <<extend>> 配分結果詳細分析を実行する [Execute Detailed Allocation Analysis] [EXECUTE_DETAILED_ALLOCATION_ANALYSIS]
  - 説明: 実行後に財務マネージャーが要求した場合のみ実行

- 先行: コスト配分計画を立案する [Plan Cost Allocation] [PLAN_COST_ALLOCATION]
  - 説明: このユースケースの前に完了している必要がある

- 後続: 配分結果を確認する [Verify Allocation Results] [VERIFY_ALLOCATION_RESULTS]
  - 説明: このユースケースの後に通常実行される

## ページ遷移概要

```
[配分実行ページ] → [実行確認ページ] → [処理進捗ページ] → [実行完了ページ]
        ↓               ↓                ↓
   [試行実行ページ]   [オプション設定ページ]  [エラー対応ページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 標準的な配分実行を最初から最後まで完全実行
   - 全ての配分対象が正常に処理されることを確認
   - 会計システムへの正確な反映を確認

2. **代替系テスト**:
   - 段階的実行と試行実行を個別に実行
   - 各代替フローの正常動作を確認

3. **異常系テスト**:
   - 配分処理エラー、接続障害、権限期限切れを意図的に発生
   - エラーハンドリングと復旧機能を確認

4. **境界値テスト**:
   - 最大配分対象数での性能確認
   - 最大金額での正常処理確認

5. **セキュリティテスト**:
   - 権限別のアクセス制御確認
   - 監査ログの完全性確認