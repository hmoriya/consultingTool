# ユースケース: 消込処理を行う [Perform Payment Matching] [PERFORM_PAYMENT_MATCHING]

## ユースケース概要

### 目的
確認済みの入金と対応する請求書を正確に照合・消込することで、売掛金残高を適切に管理し、正確な債権管理と財務報告を実現する。

### アクター
- **主アクター**: 経理担当者 [Accounting Staff] [ACCOUNTING_STAFF]
  - 説明: 消込処理の実行と結果確認を担当する
- **副アクター**: 財務マネージャー [Finance Manager] [FINANCE_MANAGER]
  - 説明: 複雑な消込案件の承認と例外処理の判断を行う
- **副アクター**: システム管理者 [System Administrator] [SYSTEM_ADMINISTRATOR]
  - 説明: 消込処理の技術的な監視とエラー対応を行う

### 事前条件
1. 入金が確認済みで、照合対象の請求書が特定されている
2. 消込ルールと例外処理基準が設定されている
3. 会計システムとの連携が正常に動作している
4. 経理担当者が消込処理権限を持っている

### 事後条件
1. 入金と請求書が正確に照合・消込されている
2. 売掛金残高が正しく更新されている
3. 消込処理の詳細が監査可能な形で記録されている
4. 必要に応じて会計仕訳が生成・計上されている

### トリガー
- **種別**: 要求駆動
- **詳細**: 入金確認完了通知、または経理担当者による手動消込指示

## 基本フロー

1. 経理担当者が消込待ちの入金・請求書一覧を確認し、処理対象を選択する
2. システムが選択された入金と請求書の詳細情報を表示する
3. 経理担当者が照合内容（金額、日付、摘要等）を確認・検証する
4. システムが消込可能性を判定し、推奨消込方法を提示する
5. 経理担当者が消込方法を確定し、消込処理を実行する
6. システムが消込仕訳を生成し、会計システムに送信する
7. システムが売掛金残高を更新し、消込完了を記録する
8. システムが消込結果を関係者に通知し、監査証跡を保存する

## 代替フロー

### 代替フロー1: 部分消込の処理
- **分岐点**: 基本フロー ステップ4
- **条件**: 入金額が請求額より少ない場合
1. システムが部分消込の金額と残額を計算・表示する
2. 経理担当者が部分消込の理由を確認・入力する
3. システムが残額の管理方法（新規請求書作成、督促継続等）を提案する
4. 経理担当者が残額処理方法を選択・実行する
5. 基本フロー ステップ6に進む

### 代替フロー2: 複数請求書への振分消込
- **分岐点**: 基本フロー ステップ4
- **条件**: 1つの入金で複数の請求書を消込する場合
1. 経理担当者が振分対象の請求書を選択する
2. システムが各請求書への配分額を計算・提案する
3. 経理担当者が配分額を確認・調整する
4. システムが各請求書に対して個別の消込処理を実行する
5. 基本フロー ステップ7に進む

## 例外フロー

### 例外フロー1: 金額不一致
- **発生点**: 基本フロー ステップ3
- **条件**: 入金額と請求額が一致しない場合
1. システムが差額と差異率を計算・表示する
2. 経理担当者が差異の原因を調査（手数料、税額調整、振込ミス等）
3. 原因に応じて調整仕訳の生成または差額の処理方法を決定する
4. 財務マネージャーが例外処理を承認する
5. 承認後、調整を含めた消込処理を実行する

### 例外フロー2: 会計システム連携エラー
- **発生点**: 基本フロー ステップ6
- **条件**: 消込仕訳の会計システム送信でエラーが発生した場合
1. システムがエラー詳細と処理状況を記録する
2. システムが自動リトライを実行（最大3回）
3. リトライ失敗時はシステム管理者に障害通知を送信する
4. 手動での会計システム連携に切り替えて処理を継続する

### 例外フロー3: 重複消込の検出
- **発生点**: 基本フロー ステップ5
- **条件**: 既に消込済みの請求書に対して重複消込が実行された場合
1. システムが重複消込を検出し、処理を自動停止する
2. システムが既存の消込履歴と今回の処理内容を比較表示する
3. 経理担当者が重複の原因を調査・確認する
4. 必要に応じて既存消込の取消または新規処理の中止を実行する

## ビジネスルール

1. **完全照合優先ルール**: 金額・日付が完全一致する消込を優先実行する
   - 適用タイミング: 基本フロー ステップ4
   - 例: 100万円の請求に対し100万円の入金は自動消込対象

2. **例外承認ルール**: 一定額以上の差額や例外処理は上位承認が必要
   - 適用タイミング: 例外フロー1
   - 例: 1万円以上の差額は財務マネージャー承認必須

3. **消込期限ルール**: 入金確認後一定期間内に消込処理を完了する
   - 適用タイミング: 基本フロー ステップ1
   - 例: 入金確認から3営業日以内に消込完了

## 入出力情報

### 入力情報
- 確認済み入金データ [Confirmed Payment Data] [CONFIRMED_PAYMENT_DATA]
  - 内容: 入金ID、入金額、入金日、入金者、振込先口座
  - 形式: システム内部データ
  - 必須/任意: 必須
  - 検証ルール: 入金確認済み状態、正の金額

- 対象請求書データ [Target Invoice Data] [TARGET_INVOICE_DATA]
  - 内容: 請求書番号、請求額、支払期限、クライアント情報
  - 形式: システム内部データ
  - 必須/任意: 必須
  - 検証ルール: 送付済み状態、未消込残高が存在

### 出力情報
- 消込レコード [Matching Record] [MATCHING_RECORD]
  - 内容: 消込ID、入金参照、請求書参照、消込額、消込日、処理者
  - 用途: 売掛金管理と監査対応
  - 保存期間: 7年間（法的要件）

- 消込仕訳データ [Matching Journal Data] [MATCHING_JOURNAL_DATA]
  - 内容: 借方・貸方の仕訳エントリ、科目コード、摘要
  - 用途: 会計システムでの正式な帳簿記録
  - 形式: 標準仕訳データ形式（CSV/XML）

## 非機能要件

- **応答性**:
  - 単一消込: 30秒以内
  - 一括消込: 100件まで10分以内

- **利用可能性**:
  - 利用時間: 平日8:00-20:00（必須）、その他（ベストエフォート）
  - 計画停止: 月次締め処理時のみ

- **セキュリティ**:
  - 認証: ログイン必須
  - 認可: 経理担当者以上の権限が必要
  - 監査: 全ての消込操作を改ざん不可能な形で記録

- **精度**:
  - 消込精度: 99.9%以上
  - 差額許容範囲: 設定可能（デフォルト1円以下）

## 関連ユースケース

- <<include>> 消込対象を照合する [Match Payment Targets] [MATCH_PAYMENT_TARGETS]
  - 説明: 消込処理前に必ず実行される

- <<extend>> 消込取消を行う [Cancel Payment Matching] [CANCEL_PAYMENT_MATCHING]
  - 説明: 誤消込が発覚した場合のみ実行される

- 先行: 入金状況を確認する [Check Payment Status] [CHECK_PAYMENT_STATUS]
  - 説明: このユースケースの前に完了している必要がある

- 後続: 売掛金残高を更新する [Update AR Balance] [UPDATE_AR_BALANCE]
  - 説明: このユースケースの後に自動実行される

## ページ遷移概要

```
[消込管理ダッシュボード] → [消込対象選択ページ] → [照合確認ページ] → [消込方法選択ページ] → [消込実行ページ] → [完了確認ページ]
        ↓                   ↓                    ↓                ↓
   [入金詳細ページ]      [請求書詳細ページ]    [差異分析ページ]   [例外処理ページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 標準的な1対1消込を最初から最後まで完全実行
   - 金額完全一致での自動消込を確認
   - 会計システムへの正確な仕訳データ送信を確認

2. **代替系テスト**:
   - 部分消込と複数請求書振分消込を個別に実行
   - 各代替フローの正常動作を確認

3. **例外系テスト**:
   - 金額不一致、システムエラー、重複消込を意図的に発生
   - エラーハンドリングと例外処理を確認

4. **精度テスト**:
   - 複雑な照合パターンでの消込精度を測定
   - 差額処理の正確性を確認

5. **パフォーマンステスト**:
   - 大量消込処理（1000件）での性能を確認
   - 月末集中処理時の応答性能を確認