# ユースケース: 収益認識の調整処理を行う [Perform Revenue Recognition Adjustment] [PERFORM_REVENUE_ADJUSTMENT]

## ユースケース概要

### 目的
既に認識済みの収益について、契約変更、誤認識、会計基準の変更等により調整が必要な場合に、適切な調整処理を実行して収益データの正確性を維持する。

### アクター
- **主アクター**: 財務マネージャー [Finance Manager] [FINANCE_MANAGER]
  - 説明: 調整の必要性判定と調整処理の実行を担当する
- **副アクター**: 経理責任者 [Accounting Manager] [ACCOUNTING_MANAGER]
  - 説明: 会計基準の適用確認と調整仕訳の承認を行う
- **副アクター**: プロジェクトマネージャー [Project Manager] [PROJECT_MANAGER]
  - 説明: 調整理由の説明と影響評価の提供を行う

### 事前条件
1. 調整対象となる収益レコードが既に認識・計上されている
2. 調整理由が明確であり、正当な根拠がある
3. 調整に必要な承認権限を持つ担当者が特定されている
4. 会計システムとの連携が正常に動作している

### 事後条件
1. 収益の調整処理が適切に実行され、正確な収益額に修正されている
2. 調整仕訳が会計システムに正しく反映されている
3. 調整の理由と根拠が監査可能な形で記録されている
4. 影響を受ける関係者に調整内容が通知されている

### トリガー
- **種別**: 要求駆動
- **詳細**: 契約変更通知、会計監査指摘、収益認識誤りの発見、四半期レビュー時の調整要求

## 基本フロー

1. 財務マネージャーが調整の必要性を認識し、調整対象の収益を特定する
2. システムが調整対象の収益レコードと関連情報を取得・表示する
3. 財務マネージャーが調整理由、調整額、調整方法を入力する
4. システムが調整内容の妥当性を検証し、会計基準との適合性を確認する
5. 経理責任者が調整内容を確認し、承認の可否を判定する
6. システムが調整仕訳を生成し、会計システムに送信する
7. システムが調整完了を記録し、元の収益レコードとの関連付けを行う
8. システムが調整結果を関係者に通知し、監査証跡を保存する

## 代替フロー

### 代替フロー1: 複数期間にわたる調整
- **分岐点**: 基本フロー ステップ3
- **条件**: 調整が複数の会計期間にまたがる場合
1. 財務マネージャーが期間別の調整額配分を指定する
2. システムが各期間の調整仕訳を個別に生成する
3. 経理責任者が期間別の調整内容を確認・承認する
4. システムが期間ごとに順次調整処理を実行する
5. 基本フロー ステップ7に進む

### 代替フロー2: 段階的調整承認
- **分岐点**: 基本フロー ステップ5
- **条件**: 調整額が一定額以上で複数段階の承認が必要な場合
1. システムが調整額に基づき必要な承認レベルを判定する
2. システムが段階的承認のワークフローを開始する
3. 各段階の承認者が順次内容を確認・承認する
4. 最終承認が完了したら基本フロー ステップ6に進む

## 例外フロー

### 例外フロー1: 調整承認の却下
- **発生点**: 基本フロー ステップ5
- **条件**: 経理責任者が調整内容を却下した場合
1. システムが却下理由とコメントを財務マネージャーに通知する
2. 財務マネージャーが却下理由を分析し、調整内容を再検討する
3. 修正が可能な場合は調整内容を修正し、基本フロー ステップ3に戻る
4. 修正困難な場合は上位管理者に判断を仰ぐ

### 例外フロー2: 会計システム連携エラー
- **発生点**: 基本フロー ステップ6
- **条件**: 調整仕訳の会計システム送信でエラーが発生した場合
1. システムがエラー詳細と送信データを保存する
2. システムが自動リトライを実行（最大3回）
3. リトライ失敗時は手動処理モードに切り替える
4. 経理責任者が手動で会計システムに調整仕訳を入力する

### 例外フロー3: 調整期限超過
- **発生点**: 基本フロー ステップ1
- **条件**: 四半期決算等の期限までに調整が完了しない場合
1. システムが期限超過アラートを発行する
2. 財務マネージャーが緊急調整プロセスの適用を検討する
3. エグゼクティブ承認により期限後調整を実行する
4. 遅延理由と影響を監査報告書に記載する

## ビジネスルール

1. **調整根拠明確化ルール**: 全ての収益調整には明確な根拠と証跡が必要
   - 適用タイミング: 基本フロー ステップ3
   - 例: 契約変更書、監査指摘事項、会計基準変更通知等の証憑

2. **二重調整防止ルール**: 同一の収益レコードに対する重複調整を防止する
   - 適用タイミング: 基本フロー ステップ2
   - 例: 既に調整済みの収益は追加調整時に警告表示

3. **調整承認権限ルール**: 調整額に応じて必要な承認レベルを設定する
   - 適用タイミング: 基本フロー ステップ5、代替フロー2
   - 例: 100万円未満：経理責任者、100万円以上：役員承認

## 入出力情報

### 入力情報
- 調整要求情報 [Adjustment Request Information] [ADJUSTMENT_REQUEST_INFORMATION]
  - 内容: 調整理由、調整額、調整方法、根拠資料
  - 形式: 調整申請書（PDF）+ システム入力
  - 必須/任意: 必須
  - 検証ルール: 調整理由は具体的記載、調整額は正当性のある金額

- 元収益レコード [Original Revenue Record] [ORIGINAL_REVENUE_RECORD]
  - 内容: 調整対象の収益ID、認識額、認識日、関連契約
  - 形式: システム内部データ
  - 必須/任意: 必須
  - 検証ルール: 有効な収益レコード、調整可能な状態

### 出力情報
- 調整済み収益レコード [Adjusted Revenue Record] [ADJUSTED_REVENUE_RECORD]
  - 内容: 調整後収益額、調整理由、調整日、承認者情報
  - 用途: 正確な財務報告と監査対応
  - 保存期間: 7年間（法的要件）

- 調整仕訳データ [Adjustment Journal Data] [ADJUSTMENT_JOURNAL_DATA]
  - 内容: 調整仕訳の借方・貸方、科目、調整額、摘要
  - 用途: 会計システムでの正式な帳簿修正
  - 形式: 標準仕訳データ形式（CSV/XML）

## 非機能要件

- **応答性**:
  - 通常時: 調整処理は2分以内
  - 緊急時: 優先処理で30秒以内

- **利用可能性**:
  - 利用時間: 24時間365日（決算期等の緊急調整に対応）
  - 計画停止: 年次メンテナンス時のみ

- **セキュリティ**:
  - 認証: 多要素認証必須（重要な財務データ変更のため）
  - 認可: 経理責任者以上の権限が必要
  - 監査: 調整操作の完全な証跡記録

- **使いやすさ**:
  - 操作画面: 調整前後の比較表示
  - 承認プロセス: 進捗状況の可視化

## 関連ユースケース

- <<include>> 調整権限を確認する [Verify Adjustment Authority] [VERIFY_ADJUSTMENT_AUTHORITY]
  - 説明: 調整処理開始前に必ず実行される

- <<extend>> 調整影響分析を行う [Perform Adjustment Impact Analysis] [PERFORM_ADJUSTMENT_IMPACT_ANALYSIS]
  - 説明: 大規模調整時のみ実行される

- 先行: 収益を認識する [Recognize Revenue] [RECOGNIZE_REVENUE]
  - 説明: このユースケースの前に完了している必要がある

- 後続: 調整後レポートを作成する [Create Post-Adjustment Report] [CREATE_POST_ADJUSTMENT_REPORT]
  - 説明: このユースケースの後に通常実行される

## ページ遷移概要

```
[収益管理ダッシュボード] → [調整対象選択ページ] → [調整内容入力ページ] → [承認依頼ページ] → [調整実行ページ] → [完了確認ページ]
        ↓                   ↓                    ↓                  ↓
   [収益詳細ページ]      [過去調整履歴ページ]   [影響分析ページ]    [承認状況ページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 標準的な収益調整を最初から最後まで完全実行
   - 単純調整と複雑調整（複数期間、複数承認）を実行
   - 会計システムへの正確な調整仕訳送信を確認

2. **代替系テスト**:
   - 複数期間調整と段階的承認を個別に実行
   - 各代替フローの正常動作を確認

3. **例外系テスト**:
   - 承認却下、システムエラー、期限超過を意図的に発生
   - エラーハンドリングと緊急対応プロセスを確認

4. **権限テスト**:
   - 各調整額レベルでの承認権限制御を確認
   - 不正な調整操作の拒否を確認

5. **監査テスト**:
   - 調整操作の完全な証跡記録を確認
   - 監査要件への適合性を確認