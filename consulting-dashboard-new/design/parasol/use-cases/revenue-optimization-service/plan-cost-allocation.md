# ユースケース: コスト配分計画を立案する [Plan Cost Allocation] [PLAN_COST_ALLOCATION]

## ユースケース概要

### 目的
財務マネージャーが、プロジェクトや部門に対するコスト配分計画を策定し、各ステークホルダーの承認を得ることで、透明性が高く公正な組織運営を実現する。

### アクター
- **主アクター**: 財務マネージャー [Finance Manager] [FINANCE_MANAGER]
  - 説明: コスト配分計画の策定責任者として、配分ルールの決定と計画の最終化を行う
- **副アクター**: プロジェクトマネージャー [Project Manager] [PROJECT_MANAGER]
  - 説明: プロジェクト予算の妥当性確認と配分計画への意見提供を行う
- **副アクター**: 経理担当者 [Accounting Staff] [ACCOUNTING_STAFF]
  - 説明: 配分計算の検証と会計処理の実行可能性を確認する

### 事前条件
1. 総予算額とコスト項目が財務部門により確定されている
2. 配分対象となるプロジェクトや部門の一覧が最新に更新されている
3. 過去の配分実績データがシステムに保存されている
4. 財務マネージャーがコスト配分権限を持っている

### 事後条件
1. コスト配分計画が承認待ち状態で保存されている
2. 各プロジェクト・部門への配分額と配分根拠が明確に記録されている
3. 配分計算プロセスと適用ルールが監査証跡として保存されている
4. 関係するステークホルダーに承認依頼通知が送信されている

### トリガー
- **種別**: 要求駆動
- **詳細**: 財務マネージャーが月次または四半期の予算配分作業を開始する時

## 基本フロー

1. 財務マネージャーがコスト配分計画画面にアクセスする
2. システムが配分可能なコスト項目・総額・配分対象一覧を表示する
3. 財務マネージャーが配分期間と配分ルール（売上比例、工数比例、均等配分等）を選択する
4. システムが選択されたルールに基づいて自動配分案を計算し提示する
5. 財務マネージャーが配分案を確認し、必要に応じて手動調整を行う
6. システムが配分額の妥当性（100%配分、最小・最大制約等）を検証する
7. 財務マネージャーが配分計画の確定と承認依頼を実行する
8. システムが配分計画を保存し、関係者に承認依頼通知を送信する

## 代替フロー

### 代替フロー1: カスタム配分ルール使用
- **分岐点**: 基本フロー ステップ3
- **条件**: 標準的な配分ルールが適用できない場合
1. 財務マネージャーが「カスタム配分」を選択する
2. システムが各プロジェクト・部門別の配分比率入力フォームを表示する
3. 財務マネージャーが各項目の配分比率を手動入力する
4. 基本フロー ステップ4に戻る

### 代替フロー2: 過去実績ベース配分
- **分岐点**: 基本フロー ステップ3
- **条件**: 過去の配分実績を参考にする場合
1. 財務マネージャーが「過去実績ベース」を選択する
2. システムが過去の配分実績一覧を表示する
3. 財務マネージャーが参考にする期間・パターンを選択する
4. システムが選択された実績を基に配分案を計算する
5. 基本フロー ステップ5に進む

## 例外フロー

### 例外フロー1: 配分合計不一致
- **発生点**: 基本フロー ステップ6
- **条件**: 配分額の合計が総額と一致しない場合
1. システムが配分合計エラーを通知し、差額を明示する
2. システムが自動調整オプション（比例調整・端数処理）を提示する
3. 財務マネージャーが調整方法を選択する
4. 基本フロー ステップ5に戻る

### 例外フロー2: 権限不足
- **発生点**: 基本フロー ステップ1
- **条件**: アクセスユーザーにコスト配分権限がない場合
1. システムが権限不足エラーを表示する
2. システムが権限申請方法と承認プロセスを案内する
3. ユースケース終了

### 例外フロー3: データ不整合
- **発生点**: 基本フロー ステップ2
- **条件**: 配分対象データや予算データに不整合がある場合
1. システムが具体的なデータ不整合内容を通知する
2. システムがデータ修正が必要な項目と担当部門を案内する
3. 財務マネージャーがデータ修正依頼を実行する
4. ユースケース一時停止

## ビジネスルール

1. **配分完全性ルール**: コスト配分の合計は必ず総予算額と100%一致しなければならない
   - 適用タイミング: 基本フロー ステップ6
   - 例: 総予算1000万円の場合、配分合計も必ず1000万円になる

2. **最小配分制約**: 各プロジェクト・部門への配分額は設定された最小額以上でなければならない
   - 適用タイミング: 基本フロー ステップ5-6
   - 例: プロジェクトAは最低50万円の予算が必要

3. **承認権限ルール**: 一定額以上の配分変更には上位管理者の承認が必要
   - 適用タイミング: 基本フロー ステップ7-8
   - 例: 前回比20%以上の変更は部長承認が必要

## 入出力情報

### 入力情報
- 配分ルール設定 [Allocation Rule Settings] [ALLOCATION_RULE_SETTINGS]
  - 内容: 配分方式、配分比率、適用期間
  - 形式: 選択肢（プルダウン）+ 数値入力
  - 必須/任意: 必須
  - 検証ルール: 配分比率の合計が100%

- 手動調整値 [Manual Adjustment Values] [MANUAL_ADJUSTMENT_VALUES]
  - 内容: プロジェクト別・部門別の調整額
  - 形式: 数値（通貨単位）
  - 必須/任意: 任意
  - 初期値: 自動計算値

### 出力情報
- コスト配分計画書 [Cost Allocation Plan] [COST_ALLOCATION_PLAN]
  - 内容: 配分対象一覧、配分額、配分根拠、適用ルール
  - 用途: 承認者による計画レビューと意思決定
  - 保存期間: 5年間（監査要件）

- 承認依頼通知 [Approval Request Notification] [APPROVAL_REQUEST_NOTIFICATION]
  - 内容: 計画概要、承認期限、承認手順
  - 用途: 関係者への承認依頼と進捗管理
  - 形式: メール通知 + システム内通知

## 非機能要件

- **応答性**:
  - 通常時: 配分計算は5秒以内に完了
  - ピーク時: 10秒以内に応答

- **利用可能性**:
  - 利用時間: 平日8:00-20:00（必須）、土日（ベストエフォート）
  - 計画停止: 月末メンテナンス時のみ

- **セキュリティ**:
  - 認証: ログイン必須
  - 認可: 財務管理者以上の権限が必要
  - 監査: すべての配分操作を記録

- **使いやすさ**:
  - 操作手順: 最大5ステップ以内で完了
  - エラー復旧: ワンクリックで前の状態に戻れる

## 関連ユースケース

- <<include>> システム認証を行う [Perform System Authentication] [PERFORM_SYSTEM_AUTHENTICATION]
  - 説明: ユースケース開始時に必ず実行

- <<extend>> 詳細配分分析を実行する [Execute Detailed Allocation Analysis] [EXECUTE_DETAILED_ALLOCATION_ANALYSIS]
  - 説明: 財務マネージャーが詳細分析を要求した場合のみ実行

- 先行: 予算策定を完了する [Complete Budget Planning] [COMPLETE_BUDGET_PLANNING]
  - 説明: このユースケースの前に完了している必要がある

- 後続: 配分承認を実行する [Execute Allocation Approval] [EXECUTE_ALLOCATION_APPROVAL]
  - 説明: このユースケースの後に通常実行される

## ページ遷移概要

```
[配分一覧ページ] → [配分設定ページ] → [配分確認ページ] → [承認依頼完了ページ]
         ↓                ↓                 ↓
   [過去実績参照ページ]  [手動調整ページ]   [修正ページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 標準的な配分ルールで計画策定を最初から最後まで実行
   - すべての必須項目を正しく入力し、承認依頼まで完了
   - 期待される配分計画書と承認依頼が生成されることを確認

2. **代替系テスト**:
   - カスタム配分ルールとpast績ベース配分を個別に実行
   - 各代替フローから基本フローへの復帰を確認

3. **異常系テスト**:
   - 配分合計不一致、権限不足、データ不整合を意図的に発生させる
   - エラーメッセージの適切性と復旧手順を確認

4. **境界値テスト**:
   - 最小配分額/最大配分額での動作確認
   - 配分比率0%・100%での正常動作確認

5. **権限テスト**:
   - 財務マネージャー、一般ユーザーでのアクセス可否確認
   - 権限不足時の適切なエラー表示確認