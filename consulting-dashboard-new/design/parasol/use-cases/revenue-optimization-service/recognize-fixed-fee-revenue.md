# ユースケース: 固定報酬型の収益を認識する [Recognize Fixed Fee Revenue] [RECOGNIZE_FIXED_FEE_REVENUE]

## ユースケース概要

### 目的
固定報酬型契約において、契約条件に基づき適切なタイミングで収益を認識し、会計システムに計上することで、適正な財務報告を実現する。

### アクター
- **主アクター**: 財務マネージャー [Finance Manager] [FINANCE_MANAGER]
  - 説明: 収益認識基準の適用と会計処理の実行を担当する
- **副アクター**: プロジェクトマネージャー [Project Manager] [PROJECT_MANAGER]
  - 説明: プロジェクト完了情報と納品確認情報を提供する
- **副アクター**: エグゼクティブ [Executive] [EXECUTIVE]
  - 説明: 収益認識方針の承認と例外処理の判断を行う

### 事前条件
1. 固定報酬型の契約が締結され、契約情報がシステムに登録されている
2. 収益認識基準（成果物納品型）が契約に適用されている
3. 財務マネージャーが収益認識権限を持っている
4. 会計システムとの連携が正常に動作している

### 事後条件
1. 固定報酬収益が会計基準に準拠して適切に認識されている
2. 収益レコードが会計システムに正確に計上されている
3. 収益認識の根拠となる証跡（納品確認書等）が保存されている
4. 関係者に収益認識完了の通知が送信されている

### トリガー
- **種別**: イベント駆動
- **詳細**: プロジェクトの成果物納品完了、またはマイルストーン達成時

## 基本フロー

1. プロジェクトマネージャーが成果物の納品完了をシステムに登録する
2. システムが契約条件と納品状況を照合し、収益認識の条件を確認する
3. 財務マネージャーが収益認識対象の契約を確認し、認識タイミングを判定する
4. システムが固定報酬額と認識日に基づき収益計算を実行する
5. 財務マネージャーが収益認識内容を確認し、承認する
6. システムが会計仕訳データを生成し、会計システムに連携する
7. システムが収益認識完了を記録し、関係者に通知を送信する

## 代替フロー

### 代替フロー1: 部分納品による段階的認識
- **分岐点**: 基本フロー ステップ2
- **条件**: 契約が複数の成果物で構成されており、一部のみ納品完了の場合
1. システムが納品完了した成果物の契約金額を計算する
2. システムが当該成果物に対応する収益額を按分計算する
3. 財務マネージャーが按分計算結果を確認し、認識額を確定する
4. 基本フロー ステップ5に進む

### 代替フロー2: 契約変更による認識額調整
- **分岐点**: 基本フロー ステップ4
- **条件**: 契約変更により固定報酬額が変更されている場合
1. システムが最新の契約変更情報を取得する
2. システムが変更後の契約金額に基づき収益額を再計算する
3. 財務マネージャーが変更理由と認識額を確認する
4. 基本フロー ステップ5に進む

## 例外フロー

### 例外フロー1: 納品確認の遅延
- **発生点**: 基本フロー ステップ1
- **条件**: 成果物は完成しているが、クライアントからの確認が遅延している場合
1. システムが納品予定日からの経過日数をチェックする
2. システムが一定期間（5営業日）経過した場合、財務マネージャーに通知する
3. 財務マネージャーがクライアントへの確認依頼を実施する
4. 確認取得後、基本フロー ステップ2に進む

### 例外フロー2: 会計システム連携エラー
- **発生点**: 基本フロー ステップ6
- **条件**: 会計システムへの仕訳データ送信でエラーが発生した場合
1. システムがエラー内容と送信データを詳細ログに記録する
2. システムが自動リトライを3回実行する
3. リトライ失敗時は財務マネージャーに緊急通知を送信する
4. 財務マネージャーが手動での仕訳処理を実行する

### 例外フロー3: 収益認識基準違反
- **発生点**: 基本フロー ステップ3
- **条件**: 納品が未完了にも関わらず収益認識が要求された場合
1. システムが収益認識基準違反を検出し、警告を表示する
2. システムが違反内容と契約条件を財務マネージャーに提示する
3. 財務マネージャーがエグゼクティブに例外承認を依頼する
4. 承認取得後は基本フロー ステップ4に進む、却下時はユースケース中断

## ビジネスルール

1. **成果物完了ルール**: 固定報酬型契約の収益は成果物の完全納品時に一括認識する
   - 適用タイミング: 基本フロー ステップ2-3
   - 例: システム構築契約では本番稼働開始時に全額認識

2. **契約変更反映ルール**: 契約変更は変更合意日以降の収益認識に反映する
   - 適用タイミング: 代替フロー2 全体
   - 例: 追加開発で契約金額が増額された場合、増額分も含めて認識

3. **確認取得期限ルール**: 納品から5営業日以内にクライアント確認を取得する
   - 適用タイミング: 例外フロー1
   - 例: 確認遅延時は積極的な催促と状況報告を実施

## 入出力情報

### 入力情報
- 契約情報 [Contract Information] [CONTRACT_INFORMATION]
  - 内容: 契約ID、固定報酬額、納品条件、支払条件
  - 形式: 構造化データ（JSON）
  - 必須/任意: 必須
  - 検証ルール: 契約金額は正数、納品条件は具体的に記載

- 納品完了情報 [Delivery Completion Information] [DELIVERY_COMPLETION_INFORMATION]
  - 内容: 成果物ID、納品日、確認者、確認日
  - 形式: 確認書類（PDF）+ システム登録
  - 必須/任意: 必須
  - 検証ルール: 納品日は契約期間内、確認者は正当な権限者

### 出力情報
- 収益レコード [Revenue Record] [REVENUE_RECORD]
  - 内容: 収益ID、認識額、認識日、契約参照、根拠情報
  - 用途: 財務報告とプロジェクト収益性分析
  - 保存期間: 7年間（法的要件）

- 会計仕訳データ [Accounting Journal Data] [ACCOUNTING_JOURNAL_DATA]
  - 内容: 借方・貸方の仕訳エントリ、科目コード、摘要
  - 用途: 会計システムでの正式な帳簿記録
  - 形式: 標準仕訳データ形式（CSV/XML）

## 非機能要件

- **応答性**:
  - 通常時: 収益認識処理は30秒以内
  - ピーク時: 月末集中時でも60秒以内

- **利用可能性**:
  - 利用時間: 平日8:00-20:00（必須）、その他（ベストエフォート）
  - 計画停止: 月次処理完了後のメンテナンス時のみ

- **セキュリティ**:
  - 認証: ログイン必須
  - 認可: 財務マネージャー以上の権限が必要
  - 監査: 全ての収益認識操作を記録

- **使いやすさ**:
  - 操作手順: 直感的なワークフロー画面
  - エラー表示: 具体的な対処方法を含む

## 関連ユースケース

- <<include>> システム認証を行う [Perform System Authentication] [PERFORM_SYSTEM_AUTHENTICATION]
  - 説明: ユースケース開始時に必ず実行

- <<extend>> 収益認識の調整処理を行う [Perform Revenue Recognition Adjustment] [PERFORM_REVENUE_RECOGNITION_ADJUSTMENT]
  - 説明: 認識後に修正が必要な場合のみ実行

- 先行: 契約を締結する [Execute Contract] [EXECUTE_CONTRACT]
  - 説明: このユースケースの前に完了している必要がある

- 後続: 請求書を作成する [Create Invoice] [CREATE_INVOICE]
  - 説明: このユースケースの後に通常実行される

## ページ遷移概要

```
[収益認識ダッシュボード] → [納品確認ページ] → [収益計算ページ] → [認識承認ページ] → [完了確認ページ]
        ↓                  ↓                ↓                 ↓
   [契約詳細ページ]     [契約変更履歴ページ]  [仕訳プレビューページ] [エラー対応ページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 標準的な固定報酬型契約で納品完了から収益認識までを完全実行
   - 会計システムへの正確な仕訳データ送信を確認
   - 関係者への適切な通知送信を確認

2. **代替系テスト**:
   - 部分納品による段階的認識と契約変更による調整を個別に実行
   - 各代替フローの正常動作を確認

3. **例外系テスト**:
   - 納品確認遅延、会計システムエラー、基準違反を意図的に発生
   - エラーハンドリングと例外処理の動作を確認

4. **境界値テスト**:
   - 最小・最大契約金額での正常処理を確認
   - 確認期限ギリギリでの処理を確認

5. **セキュリティテスト**:
   - 権限のないユーザーでのアクセス拒否を確認
   - 監査ログの完全性を確認