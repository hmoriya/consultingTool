# ユースケース: マイルストーン型の収益を認識する [Recognize Milestone Revenue] [RECOGNIZE_MILESTONE_REVENUE]

## ユースケース概要

### 目的
マイルストーン型契約において、各マイルストーンの達成に応じて段階的に収益を認識し、プロジェクトの進捗と連動した適切な収益計上を実現する。

### アクター
- **主アクター**: 財務マネージャー [Finance Manager] [FINANCE_MANAGER]
  - 説明: マイルストーン達成の確認と収益認識処理の実行を担当する
- **副アクター**: プロジェクトマネージャー [Project Manager] [PROJECT_MANAGER]
  - 説明: マイルストーン達成の報告とクライアント承認の取得を行う
- **副アクター**: クライアント [Client] [CLIENT]
  - 説明: マイルストーン成果物の確認と達成承認を行う

### 事前条件
1. マイルストーン型の契約が締結され、各マイルストーンの条件と金額が明確に定義されている
2. プロジェクト計画でマイルストーンの達成条件が具体的に設定されている
3. マイルストーン成果物が完成し、品質確認が完了している
4. 財務マネージャーが収益認識権限を持っている

### 事後条件
1. 達成されたマイルストーンに対応する収益が適切に認識されている
2. マイルストーン達成の証跡とクライアント承認記録が保存されている
3. 残りマイルストーンの予定と収益見通しが更新されている
4. 関係者にマイルストーン達成と収益認識の結果が通知されている

### トリガー
- **種別**: イベント駆動
- **詳細**: プロジェクトマネージャーからのマイルストーン達成報告、またはクライアントからの承認通知

## 基本フロー

1. プロジェクトマネージャーがマイルストーン達成をシステムに報告する
2. システムが達成されたマイルストーンの条件と成果物を確認する
3. 財務マネージャーがマイルストーン達成の妥当性を検証する
4. システムがクライアントに承認依頼を送信し、承認を待機する
5. クライアントがマイルストーン成果物を確認し、達成を承認する
6. システムが契約で定義された収益額を計算し、認識処理を実行する
7. システムが会計仕訳データを生成し、会計システムに連携する
8. システムが収益認識完了を記録し、関係者に結果を通知する

## 代替フロー

### 代替フロー1: 部分達成による比例認識
- **分岐点**: 基本フロー ステップ3
- **条件**: マイルストーンが完全ではなく部分的に達成された場合
1. 財務マネージャーが部分達成の程度（達成率）を評価する
2. システムが契約条件に基づき比例計算での収益認識可否を判定する
3. 比例認識可能な場合、達成率に応じた収益額を計算する
4. クライアントに部分達成での収益認識について承認を求める
5. 承認取得後、基本フロー ステップ6に進む

### 代替フロー2: マイルストーン変更による調整
- **分岐点**: 基本フロー ステップ2
- **条件**: プロジェクト実行中にマイルストーン条件が変更された場合
1. システムが最新の契約変更情報とマイルストーン定義を取得する
2. 財務マネージャーが変更後の条件と報告内容の適合性を確認する
3. システムが変更後の条件に基づき収益額を再計算する
4. 基本フロー ステップ4に進む

## 例外フロー

### 例外フロー1: クライアント承認の遅延
- **発生点**: 基本フロー ステップ5
- **条件**: クライアントからの承認が期限内に得られない場合
1. システムが承認期限（10営業日）の超過を検出する
2. システムがクライアントに督促通知を自動送信する
3. プロジェクトマネージャーが直接クライアントに確認・催促を実施する
4. 承認が大幅に遅延する場合は暫定認識の適用を検討する

### 例外フロー2: マイルストーン達成の争議
- **発生点**: 基本フロー ステップ5
- **条件**: クライアントがマイルストーン達成を認めない場合
1. システムが却下理由とコメントをプロジェクトマネージャーに通知する
2. プロジェクトマネージャーが争議内容を分析し、対応策を検討する
3. 成果物の修正が必要な場合は修正完了後に再度承認を求める
4. 解釈相違の場合は契約書に基づく協議プロセスを開始する

### 例外フロー3: システム障害による処理中断
- **発生点**: 基本フロー ステップ6-7
- **条件**: 収益認識処理中にシステム障害が発生した場合
1. システムが処理中断時点の状態を自動保存する
2. システムが復旧後、中断時点から処理を再開する
3. データ整合性に問題がある場合は財務マネージャーに手動処理を依頼する
4. 処理完了後、関係者に遅延報告と結果通知を送信する

## ビジネスルール

1. **段階的認識ルール**: マイルストーン型契約の収益は各マイルストーン達成時に該当額を認識する
   - 適用タイミング: 基本フロー ステップ6
   - 例: 5段階マイルストーンの第3段階達成時に対応する収益額を認識

2. **承認必須ルール**: マイルストーン達成にはクライアントの明示的な承認が必要
   - 適用タイミング: 基本フロー ステップ4-5
   - 例: 口頭確認のみでは収益認識せず、書面またはシステム上の承認が必要

3. **比例認識制限ルール**: 部分達成による比例認識は契約で明示的に認められた場合のみ適用
   - 適用タイミング: 代替フロー1
   - 例: 80%達成でも契約に比例条項がなければ収益認識不可

## 入出力情報

### 入力情報
- マイルストーン達成報告 [Milestone Achievement Report] [MILESTONE_ACHIEVEMENT_REPORT]
  - 内容: マイルストーンID、達成日、成果物、達成条件クリア状況
  - 形式: 構造化レポート（PDF）+ システム登録
  - 必須/任意: 必須
  - 検証ルール: 達成日は計画期間内、成果物は契約仕様に適合

- 契約マイルストーン定義 [Contract Milestone Definition] [CONTRACT_MILESTONE_DEFINITION]
  - 内容: マイルストーンID、達成条件、対応収益額、前提条件
  - 形式: 構造化データ（JSON）
  - 必須/任意: 必須
  - 検証ルール: 収益額の合計は契約総額と一致

### 出力情報
- マイルストーン収益レコード [Milestone Revenue Record] [MILESTONE_REVENUE_RECORD]
  - 内容: 収益ID、マイルストーン参照、認識額、承認者、承認日
  - 用途: プロジェクト進捗と収益の対応関係管理
  - 保存期間: 7年間（法的要件）

- マイルストーン達成証明書 [Milestone Achievement Certificate] [MILESTONE_ACHIEVEMENT_CERTIFICATE]
  - 内容: 達成マイルストーン、成果物一覧、クライアント承認、収益認識額
  - 用途: 監査対応とプロジェクト完了報告
  - 形式: 正式な証明書形式（PDF）

## 非機能要件

- **応答性**:
  - 通常時: マイルストーン処理は60秒以内
  - 承認待ち: リアルタイムでの状況更新

- **利用可能性**:
  - 利用時間: 24時間365日（マイルストーン達成は予測困難なため）
  - 計画停止: 重要マイルストーン期間中は停止回避

- **セキュリティ**:
  - 認証: クライアント承認時は電子署名対応
  - 認可: 財務マネージャー以上の権限が必要
  - 監査: マイルストーン達成から収益認識まで完全な証跡記録

- **使いやすさ**:
  - 進捗表示: マイルストーン全体での進捗状況を可視化
  - 通知機能: 承認依頼・完了通知の自動送信

## 関連ユースケース

- <<include>> マイルストーン達成を確認する [Confirm Milestone Achievement] [CONFIRM_MILESTONE_ACHIEVEMENT]
  - 説明: 収益認識前に必ず実行される

- <<extend>> マイルストーン収益の調整処理を行う [Perform Milestone Revenue Adjustment] [PERFORM_MILESTONE_REVENUE_ADJUSTMENT]
  - 説明: 認識後に修正が必要な場合のみ実行

- 先行: マイルストーンを達成する [Achieve Milestone] [ACHIEVE_MILESTONE]
  - 説明: このユースケースの前に完了している必要がある

- 後続: 次期マイルストーンを計画する [Plan Next Milestone] [PLAN_NEXT_MILESTONE]
  - 説明: このユースケースの後に通常実行される

## ページ遷移概要

```
[マイルストーン管理ダッシュボード] → [達成確認ページ] → [承認依頼ページ] → [収益認識ページ] → [完了報告ページ]
        ↓                       ↓              ↓               ↓
   [進捗詳細ページ]         [成果物確認ページ]  [承認状況ページ]   [調整処理ページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 標準的なマイルストーン型契約で達成から収益認識までを完全実行
   - 複数マイルストーンの段階的な収益認識を確認
   - クライアント承認プロセスの正常動作を確認

2. **代替系テスト**:
   - 部分達成による比例認識とマイルストーン変更対応を個別に実行
   - 各代替フローの正常動作を確認

3. **例外系テスト**:
   - 承認遅延、達成争議、システム障害を意図的に発生
   - エラーハンドリングと争議解決プロセスを確認

4. **統合テスト**:
   - プロジェクト管理システムとの連携動作を確認
   - 会計システムへの正確な仕訳データ送信を確認

5. **ユーザビリティテスト**:
   - クライアントの承認操作の使いやすさを確認
   - マイルストーン進捗の可視化の分かりやすさを確認