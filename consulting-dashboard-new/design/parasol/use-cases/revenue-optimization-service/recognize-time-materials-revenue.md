# ユースケース: 工数精算型の収益を認識する [Recognize Time and Materials Revenue] [RECOGNIZE_TIME_MATERIALS_REVENUE]

## ユースケース概要

### 目的
工数精算型契約において、実際に投入された工数と材料費に基づき収益を月次で認識し、会計システムに計上することで、適正なタイミングでの収益計上を実現する。

### アクター
- **主アクター**: 財務マネージャー [Finance Manager] [FINANCE_MANAGER]
  - 説明: 工数データの検証と収益認識処理の実行を担当する
- **副アクター**: プロジェクトマネージャー [Project Manager] [PROJECT_MANAGER]
  - 説明: 工数データの承認と材料費情報の提供を行う
- **副アクター**: コンサルタント [Consultant] [CONSULTANT]
  - 説明: 日次の工数入力と材料費申請を行う

### 事前条件
1. 工数精算型の契約が締結され、単価情報がシステムに登録されている
2. 月次の工数データが承認済みでシステムに蓄積されている
3. 材料費・経費データが承認され、コスト計上が完了している
4. 財務マネージャーが収益認識権限を持っている

### 事後条件
1. 月次の工数精算型収益が適切に認識されている
2. 収益レコードが工数・材料費の詳細と紐づけられている
3. 収益認識の根拠となる工数・経費データが保存されている
4. プロジェクトマネージャーと関係者に収益認識結果が通知されている

### トリガー
- **種別**: 時間駆動
- **詳細**: 月次の工数締め処理完了後、または月末の収益認識バッチ処理

## 基本フロー

1. 財務マネージャーが月次収益認識プロセスを開始する
2. システムが承認済み工数データと材料費データを収集する
3. システムが契約別・単価別に収益計算を実行する
4. 財務マネージャーが計算結果を確認し、異常値をチェックする
5. システムがプロジェクトマネージャーに収益内容の確認を依頼する
6. プロジェクトマネージャーが工数・収益の妥当性を確認・承認する
7. システムが会計仕訳データを生成し、会計システムに連携する
8. システムが収益認識完了を記録し、関係者に結果を通知する

## 代替フロー

### 代替フロー1: 契約単価の適用ルール変更
- **分岐点**: 基本フロー ステップ3
- **条件**: 月中に契約変更があり、単価や適用条件が変更された場合
1. システムが契約変更の有効日を確認する
2. システムが変更前後の期間で工数を分離し、それぞれに適切な単価を適用する
3. 財務マネージャーが分離計算結果を確認し、適正性を判定する
4. 基本フロー ステップ4に進む

### 代替フロー2: 超過工数の承認処理
- **分岐点**: 基本フロー ステップ4
- **条件**: 計画工数を大幅に超過している場合
1. システムが超過工数の金額と超過率を算出する
2. システムが超過理由と承認状況を確認する
3. 財務マネージャーがクライアント承認の有無を確認する
4. 未承認の場合は収益認識を保留し、承認取得プロセスを開始する
5. 承認取得後、基本フロー ステップ5に進む

## 例外フロー

### 例外フロー1: 工数データの不整合
- **発生点**: 基本フロー ステップ2
- **条件**: 承認済み工数データに矛盾や欠損がある場合
1. システムがデータ不整合の詳細（欠損日、重複、異常値）を特定する
2. システムが影響範囲と修正方法を財務マネージャーに提示する
3. 財務マネージャーが関連するプロジェクトマネージャーに修正を依頼する
4. データ修正完了後、基本フロー ステップ2から再開する

### 例外フロー2: 計算エラー
- **発生点**: 基本フロー ステップ3
- **条件**: 単価適用や計算処理でシステムエラーが発生した場合
1. システムがエラー内容と対象データを詳細ログに記録する
2. システムが自動修復を試行し、修復不可能な場合は手動モードに切り替える
3. 財務マネージャーが手動で計算を実行し、結果を検証する
4. 計算完了後、基本フロー ステップ4に進む

### 例外フロー3: 承認タイムアウト
- **発生点**: 基本フロー ステップ6
- **条件**: プロジェクトマネージャーからの承認が期限内に得られない場合
1. システムが承認期限（3営業日）の超過を検出する
2. システムが上位管理者（部門長）に代理承認を依頼する
3. 代理承認が得られた場合は基本フロー ステップ7に進む
4. 代理承認も得られない場合は収益認識を翌月に繰り延べる

## ビジネスルール

1. **月次認識ルール**: 工数精算型契約の収益は月次で工数実績に基づき認識する
   - 適用タイミング: 基本フロー ステップ1-3
   - 例: 4月分の工数は4月末締めで4月度収益として認識

2. **単価適用ルール**: 工数発生日時点で有効な契約単価を適用する
   - 適用タイミング: 基本フロー ステップ3、代替フロー1
   - 例: 月中の単価変更は変更日以降の工数にのみ新単価を適用

3. **超過承認ルール**: 計画比120%を超える工数はクライアント事前承認が必要
   - 適用タイミング: 代替フロー2
   - 例: 月間100時間計画に対し120時間超過時は追加承認必須

## 入出力情報

### 入力情報
- 承認済み工数データ [Approved Timesheet Data] [APPROVED_TIMESHEET_DATA]
  - 内容: プロジェクトID、従業員ID、作業日、工数、作業内容
  - 形式: CSV形式の工数集計データ
  - 必須/任意: 必須
  - 検証ルール: 工数は0.25時間単位、作業日は平日のみ

- 契約単価情報 [Contract Rate Information] [CONTRACT_RATE_INFORMATION]
  - 内容: 契約ID、役職・スキル別単価、適用期間、特別条件
  - 形式: 構造化データ（JSON）
  - 必須/任意: 必須
  - 検証ルール: 単価は正数、適用期間は重複なし

### 出力情報
- 工数精算収益レコード [Time and Materials Revenue Record] [TM_REVENUE_RECORD]
  - 内容: 収益ID、契約参照、工数詳細、材料費詳細、認識額
  - 用途: プロジェクト収益性分析と請求書作成の基礎データ
  - 保存期間: 7年間（法的要件）

- 工数精算明細書 [Time and Materials Detail Report] [TM_DETAIL_REPORT]
  - 内容: 従業員別・日別の工数、単価、小計、合計
  - 用途: クライアントへの工数精算報告とプロジェクト管理
  - 形式: PDF形式のレポート

## 非機能要件

- **応答性**:
  - 通常時: 月次処理は5分以内
  - 大規模プロジェクト: 最大30分以内

- **利用可能性**:
  - 利用時間: 月末月初の集中処理時間帯は24時間対応
  - 計画停止: 年次メンテナンス時のみ

- **セキュリティ**:
  - 認証: 多要素認証必須（機密性の高い工数データのため）
  - 認可: 財務マネージャー以上の権限が必要
  - 監査: 工数・収益の詳細な操作ログを記録

- **使いやすさ**:
  - バッチ処理: 処理進捗を%表示
  - エラー処理: 具体的なエラー内容と対処手順を表示

## 関連ユースケース

- <<include>> 工数データを検証する [Validate Timesheet Data] [VALIDATE_TIMESHEET_DATA]
  - 説明: 収益認識前に必ず実行される

- <<extend>> 工数精算の調整処理を行う [Perform Time Materials Adjustment] [PERFORM_TM_ADJUSTMENT]
  - 説明: 認識後に修正が必要な場合のみ実行

- 先行: 工数を承認する [Approve Timesheet] [APPROVE_TIMESHEET]
  - 説明: このユースケースの前に完了している必要がある

- 後続: 工数精算請求書を作成する [Create Time Materials Invoice] [CREATE_TM_INVOICE]
  - 説明: このユースケースの後に通常実行される

## ページ遷移概要

```
[工数精算ダッシュボード] → [データ確認ページ] → [計算実行ページ] → [承認依頼ページ] → [結果確認ページ]
        ↓                   ↓                ↓                 ↓
   [工数詳細ページ]      [異常値調査ページ]  [手動計算ページ]   [エラー解決ページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 標準的な工数精算型契約で月次収益認識を完全実行
   - 複数プロジェクト・複数単価での一括処理を確認
   - 工数明細と収益レコードの整合性を確認

2. **代替系テスト**:
   - 月中契約変更と超過工数承認の処理を個別に実行
   - 各代替フローの正常動作を確認

3. **例外系テスト**:
   - データ不整合、計算エラー、承認タイムアウトを意図的に発生
   - エラーハンドリングと復旧機能を確認

4. **パフォーマンステスト**:
   - 大量工数データ（10万時間分）での処理性能を確認
   - 月末集中処理時の応答時間を確認

5. **セキュリティテスト**:
   - 工数データの改ざん検知機能を確認
   - 権限のない修正操作の拒否を確認