# ユースケース: 請求書を送付する [Send Invoice] [SEND_INVOICE]

## ユースケース概要

### 目的
作成済みの請求書を適切な方法でクライアントに送付し、確実な受領確認を取得することで、入金回収プロセスの確実な開始を実現する。

### アクター
- **主アクター**: 経理担当者 [Accounting Staff] [ACCOUNTING_STAFF]
  - 説明: 請求書の送付処理と受領確認の管理を担当する
- **副アクター**: 財務マネージャー [Finance Manager] [FINANCE_MANAGER]
  - 説明: 送付方法の承認と送付状況の監視を行う
- **副アクター**: クライアント [Client] [CLIENT]
  - 説明: 請求書の受領と受領確認の返信を行う

### 事前条件
1. 請求書が作成済みで、承認された状態で保存されている
2. クライアントの送付先情報（メール、郵送先等）が最新に更新されている
3. 送付方法（電子送付、郵送、手渡し等）が契約で指定されている
4. 経理担当者が請求書送付権限を持っている

### 事後条件
1. 請求書がクライアントに正常に送付されている
2. 送付記録と送付方法が監査可能な形で記録されている
3. クライアントから受領確認が取得されている
4. 入金期限の管理プロセスが開始されている

### トリガー
- **種別**: 要求駆動
- **詳細**: 請求書作成完了通知、または定期送付スケジュールの到達

## 基本フロー

1. 経理担当者が送付待ちの請求書一覧を確認し、送付対象を選択する
2. システムが請求書の送付先情報と送付方法を表示・確認する
3. 経理担当者が送付方法を最終確認し、送付処理を実行する
4. システムが指定された方法で請求書を送付する（メール、郵送等）
5. システムが送付完了を記録し、送付証跡を保存する
6. システムがクライアントに受領確認を依頼する
7. クライアントが請求書を受領し、受領確認を返信する
8. システムが受領確認を記録し、入金期限管理を開始する

## 代替フロー

### 代替フロー1: 複数送付方法の併用
- **分岐点**: 基本フロー ステップ3
- **条件**: 契約で複数の送付方法が指定されている場合
1. 経理担当者が主送付方法と副送付方法を確認する
2. システムが主送付方法で最初の送付を実行する
3. システムが一定時間後（24時間後等）に受領確認状況をチェックする
4. 受領確認がない場合、副送付方法で再送付を実行する
5. 基本フロー ステップ5に進む

### 代替フロー2: 緊急送付処理
- **分岐点**: 基本フロー ステップ3
- **条件**: 支払期限が迫っており緊急送付が必要な場合
1. 経理担当者が緊急送付フラグを設定する
2. システムが最速の送付方法（メール + 電話確認等）を選択する
3. システムが緊急送付の旨を明記した送付を実行する
4. 経理担当者がクライアントに直接電話で送付を通知する
5. 基本フロー ステップ5に進む

## 例外フロー

### 例外フロー1: 送付エラー
- **発生点**: 基本フロー ステップ4
- **条件**: メール送信失敗、郵送先不明等の送付エラーが発生した場合
1. システムがエラー内容と原因を詳細に記録する
2. システムが代替送付方法の利用可能性を確認する
3. 経理担当者がクライアントに連絡し、正しい送付先情報を確認する
4. 送付先情報を更新後、基本フロー ステップ4から再実行する

### 例外フロー2: 受領確認の長期未返信
- **発生点**: 基本フロー ステップ7
- **条件**: クライアントからの受領確認が期限内に返信されない場合
1. システムが受領確認期限（3営業日）の超過を検出する
2. システムが自動で受領確認の催促メールを送信する
3. 経理担当者がクライアントに直接電話で受領確認を依頼する
4. 受領確認取得後、基本フロー ステップ8に進む

### 例外フロー3: 請求書内容への異議申し立て
- **発生点**: 基本フロー ステップ7
- **条件**: クライアントから請求書内容に対する異議が申し立てられた場合
1. システムが異議内容をプロジェクトマネージャーと財務マネージャーに通知する
2. 経理担当者が異議内容を確認し、対応方針を検討する
3. 内容修正が必要な場合は修正請求書を作成・再送付する
4. 異議が不当な場合は根拠を示してクライアントに説明する

## ビジネスルール

1. **送付方法遵守ルール**: 契約で指定された送付方法を必ず遵守する
   - 適用タイミング: 基本フロー ステップ3-4
   - 例: 電子送付指定の契約では紙媒体送付は不可

2. **受領確認必須ルール**: 全ての請求書について受領確認を取得する
   - 適用タイミング: 基本フロー ステップ6-7
   - 例: メール送付時は受領確認付きメール、郵送時は受領証

3. **送付期限ルール**: 請求書は作成後2営業日以内に送付する
   - 適用タイミング: 基本フロー ステップ1
   - 例: 月末作成の請求書は翌月2営業日以内に送付

## 入出力情報

### 入力情報
- 請求書データ [Invoice Data] [INVOICE_DATA]
  - 内容: 請求書番号、請求額、明細、支払期限、請求先情報
  - 形式: システム内部データ + PDF
  - 必須/任意: 必須
  - 検証ルール: 承認済み状態、送付先情報が完全

- 送付方法指定 [Delivery Method Specification] [DELIVERY_METHOD_SPECIFICATION]
  - 内容: 送付方法、送付先、送付タイミング、特別指示
  - 形式: 契約条件から取得
  - 必須/任意: 必須
  - 検証ルール: 契約で有効な送付方法

### 出力情報
- 送付記録 [Delivery Record] [DELIVERY_RECORD]
  - 内容: 送付日時、送付方法、送付先、送付者、確認状況
  - 用途: 入金管理と監査対応
  - 保存期間: 7年間（法的要件）

- 受領確認書 [Receipt Confirmation] [RECEIPT_CONFIRMATION]
  - 内容: 受領日時、受領者、受領方法、備考
  - 用途: 支払遅延時の証跡と法的根拠
  - 形式: 電子確認またはスキャンした受領証

## 非機能要件

- **応答性**:
  - 電子送付: 送付処理は30秒以内
  - 一括送付: 100件まで5分以内

- **利用可能性**:
  - 利用時間: 平日8:00-18:00（必須）、その他（ベストエフォート）
  - 計画停止: 週末メンテナンス時のみ

- **セキュリティ**:
  - 暗号化: 電子送付時はメール暗号化
  - 認証: 送付者の電子署名
  - 追跡: 送付プロセスの完全なログ記録

- **使いやすさ**:
  - 一括処理: 複数請求書の同時送付
  - 進捗表示: 送付状況のリアルタイム更新

## 関連ユースケース

- <<include>> 送付先情報を確認する [Verify Delivery Information] [VERIFY_DELIVERY_INFORMATION]
  - 説明: 送付処理前に必ず実行される

- <<extend>> 送付エラーを解決する [Resolve Delivery Error] [RESOLVE_DELIVERY_ERROR]
  - 説明: 送付エラー発生時のみ実行される

- 先行: 請求書を作成する [Create Invoice] [CREATE_INVOICE]
  - 説明: このユースケースの前に完了している必要がある

- 後続: 入金状況を確認する [Check Payment Status] [CHECK_PAYMENT_STATUS]
  - 説明: このユースケースの後に通常実行される

## ページ遷移概要

```
[請求書管理ダッシュボード] → [送付対象選択ページ] → [送付方法確認ページ] → [送付実行ページ] → [送付完了ページ]
        ↓                   ↓                    ↓                  ↓
   [送付履歴ページ]      [送付先情報確認ページ]   [送付状況監視ページ] [受領確認ページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 標準的な電子送付を最初から最後まで完全実行
   - 郵送、手渡し等の異なる送付方法を個別にテスト
   - 受領確認の正常取得を確認

2. **代替系テスト**:
   - 複数送付方法の併用と緊急送付処理を個別に実行
   - 各代替フローの正常動作を確認

3. **例外系テスト**:
   - 送付エラー、受領確認未返信、異議申し立てを意図的に発生
   - エラーハンドリングと回復プロセスを確認

4. **セキュリティテスト**:
   - 電子送付時の暗号化と電子署名を確認
   - 不正な送付操作の拒否を確認

5. **パフォーマンステスト**:
   - 大量請求書（100件）の一括送付性能を確認
   - ピーク時間帯での応答性能を確認