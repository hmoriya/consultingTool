# マイクロサービス設計構造

**更新日: 2025-01-13**

## 概要

本プロジェクトは、ビジネスケーパビリティに基づいてマイクロサービスアーキテクチャを採用しています。現在は単一アプリケーション内で論理的に分離されていますが、将来的に個別のマイクロサービスとして分離可能な設計となっています。

## サービス一覧

### 1. auth-service（認証サービス）
- **責務**: 認証、認可、セッション管理
- **主要機能**: ログイン、ログアウト、権限管理、監査ログ

### 2. project-service（プロジェクト管理サービス）
- **責務**: プロジェクト、タスク、マイルストーン、成果物の管理
- **主要機能**: プロジェクト管理、タスク管理、進捗追跡

### 3. resource-service（リソース管理サービス）
- **責務**: ユーザー、チーム、スキル、アサインメントの管理
- **主要機能**: 人材管理、スキルマッチング、稼働管理

### 4. finance-service（財務管理サービス）
- **責務**: 収益、コスト、請求、予算の管理
- **主要機能**: 財務管理、請求処理、予実管理

### 5. timesheet-service（工数管理サービス）
- **責務**: 工数入力、承認、稼働率の管理
- **主要機能**: 工数記録、承認ワークフロー、稼働分析

### 6. notification-service（通知・コミュニケーションサービス）
- **責務**: 通知、コメント、承認フロー、会議の管理
- **主要機能**: 通知配信、コミュニケーション、会議管理

### 7. knowledge-service（知識管理サービス）
- **責務**: ナレッジ記事、テンプレート、FAQ、エキスパート情報の管理
- **主要機能**: ナレッジ共有、検索、エキスパート検索

### 8. risk-service（リスク管理サービス）
- **責務**: リスク、イシュー、対応計画、教訓の管理
- **主要機能**: リスク評価、イシュー管理、教訓管理

### 9. common（共通）
- **責務**: クロスサービス機能、共有リソース
- **主要機能**: ダッシュボード、レポート、共通UI

## ディレクトリ構造

```
design/services/
├── {service-name}/
│   ├── api/          # API設計書
│   ├── db/           # データベース設計
│   ├── domain/       # ドメインモデル
│   ├── use-cases/    # ユースケース
│   └── tests/        # テスト設計
└── common/           # 共通設計
```

## 設計原則

### 1. ドメイン駆動設計（DDD）
- 各サービスは独自のドメインモデルを持つ
- 集約ルートを明確に定義
- 値オブジェクトの活用

### 2. データ分離
- 各サービスは独自のデータベース（スキーマ）を持つ
- サービス間のデータ共有は最小限に
- 外部参照はIDのみ

### 3. API設計
- RESTfulまたはGraphQLで統一
- 明確なバージョニング戦略
- 後方互換性の維持

### 4. イベント駆動
- サービス間の疎結合
- 結果整合性の採用
- イベントソーシングの準備

## 移行戦略

### Phase 1: 論理的分離（現在）
- 単一アプリケーション内でのモジュール分離
- 個別のPrismaスキーマ
- サービス層での分離

### Phase 2: API分離
- 内部APIの明確化
- APIゲートウェイの導入
- サービス間通信の標準化

### Phase 3: 物理的分離
- 個別のデプロイメント単位
- 独立したデータベース
- コンテナ化

### Phase 4: 完全なマイクロサービス
- Kubernetes環境での運用
- サービスメッシュの導入
- 分散トレーシング

## 開発ガイドライン

### 新機能追加時
1. どのサービスに属するか判断
2. ドメインモデルの更新
3. ユースケースの追加
4. API設計の更新
5. DB設計の更新

### サービス間連携
1. 直接的なDB参照は禁止
2. APIまたはイベント経由での連携
3. トランザクションは単一サービス内で完結
4. 補償トランザクションの実装

### 命名規則
- サービス名: `{domain}-service`
- API: `/api/{service-name}/{version}/{resource}`
- イベント: `{service}.{entity}.{action}`

## 注意事項

1. **循環依存の回避**: サービス間の依存関係は単方向に
2. **共有ライブラリの最小化**: 過度な共有は避ける
3. **バージョン管理**: 破壊的変更は新バージョンで
4. **モニタリング**: 各サービスの健全性を監視

## 関連ドキュメント

- [プロジェクト定義](../project-definition.md)
- [ビジネスケーパビリティ](../business-capabilities.md)
- [ドメインモデル](./common/domain/shared-value-objects.md)