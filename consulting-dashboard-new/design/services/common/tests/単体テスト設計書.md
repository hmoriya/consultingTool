# 単体テスト設計書

## 概要
本ドキュメントは、コンサルティングダッシュボードアプリケーションのサーバーアクションに対する単体テストの設計を定義します。

## テスト方針

### 基本方針
- すべてのサーバーアクションに対して単体テストを実装
- 正常系・異常系・境界値のテストケースを網羅
- モックを使用して外部依存を排除
- テストカバレッジ80%以上を目標

### テスト対象
1. 認証アクション（auth.ts）
2. クライアント管理アクション（clients.ts）
3. ダッシュボードアクション（dashboard.ts）
4. タスク管理アクション（tasks.ts）
5. チーム管理アクション（team.ts）
6. マイルストーンアクション（milestones.ts）
7. プロジェクトチームアクション（project-team.ts）
8. プロジェクト管理アクション（projects.ts）

## テストケース設計

### 1. 認証アクション（auth.ts）✅ 実装済み

#### login
- ✅ 正常系：正しい認証情報でログイン成功
- ✅ 異常系：無効なメールアドレス
- ✅ 異常系：無効なパスワード
- ✅ 異常系：存在しないユーザー
- ✅ 異常系：非アクティブユーザー

#### logout
- ✅ 正常系：正常にログアウト
- ✅ 境界値：セッションがない場合

#### getCurrentUser
- ✅ 正常系：有効なセッションでユーザー情報取得
- ✅ 異常系：セッションがない場合
- ✅ 異常系：期限切れセッション

### 2. クライアント管理アクション（clients.ts）

#### getClients
- 正常系：クライアント一覧取得
- 正常系：検索条件でフィルタリング
- 異常系：認証エラー

#### createClient
- 正常系：クライアント作成成功
- 異常系：必須フィールド欠落
- 異常系：権限エラー（PMとエグゼクティブ以外）
- 異常系：重複するクライアント名

#### updateClient
- 正常系：クライアント更新成功
- 異常系：存在しないクライアント
- 異常系：権限エラー
- 異常系：無効なデータ

#### deleteClient
- 正常系：クライアント削除成功
- 異常系：プロジェクトが紐付いているクライアント
- 異常系：権限エラー（エグゼクティブ以外）

### 3. ダッシュボードアクション（dashboard.ts）

#### getExecutiveDashboard
- 正常系：エグゼクティブダッシュボードデータ取得
- 異常系：権限エラー（エグゼクティブ以外）
- 境界値：データが存在しない場合

#### getConsultantDashboard
- 正常系：コンサルタントダッシュボードデータ取得
- 異常系：権限エラー（コンサルタント以外）
- 境界値：アサインされたタスクがない場合

#### getKPISummary
- 正常系：KPIサマリー取得
- 異常系：権限エラー
- 境界値：プロジェクトがない場合

### 4. タスク管理アクション（tasks.ts）

#### getTasks
- 正常系：タスク一覧取得
- 正常系：プロジェクトIDでフィルタリング
- 正常系：ステータスでフィルタリング
- 異常系：権限エラー

#### createTask
- 正常系：タスク作成成功
- 異常系：必須フィールド欠落
- 異常系：無効な担当者
- 異常系：終了日が開始日より前
- 異常系：権限エラー

#### updateTask
- 正常系：タスク更新成功
- 正常系：ステータス変更
- 正常系：担当者変更
- 異常系：存在しないタスク
- 異常系：権限エラー

#### deleteTask
- 正常系：タスク削除成功
- 異常系：完了済みタスクの削除
- 異常系：権限エラー

#### updateTaskStatus
- 正常系：ステータス更新成功
- 正常系：完了時の進捗率100%設定
- 異常系：無効なステータス遷移
- 異常系：権限エラー

### 5. チーム管理アクション（team.ts）

#### getTeamMembers
- 正常系：チームメンバー一覧取得
- 正常系：スキルでフィルタリング
- 正常系：稼働率でフィルタリング
- 異常系：権限エラー

#### createTeamMember
- 正常系：チームメンバー作成成功
- 異常系：既存のメールアドレス
- 異常系：無効なロール
- 異常系：権限エラー

#### updateTeamMember
- 正常系：チームメンバー更新成功
- 正常系：スキル追加・削除
- 異常系：存在しないメンバー
- 異常系：権限エラー

#### getTeamStatistics
- 正常系：チーム統計取得
- 正常系：期間指定での統計
- 異常系：権限エラー

### 6. マイルストーンアクション（milestones.ts）

#### getMilestones
- 正常系：マイルストーン一覧取得
- 正常系：プロジェクトIDでフィルタリング
- 異常系：権限エラー

#### createMilestone
- 正常系：マイルストーン作成成功
- 異常系：重複する名前
- 異常系：無効な日付
- 異常系：権限エラー

#### updateMilestone
- 正常系：マイルストーン更新成功
- 正常系：ステータス変更
- 異常系：完了済みマイルストーンの変更
- 異常系：権限エラー

#### deleteMilestone
- 正常系：マイルストーン削除成功
- 異常系：関連タスクがある場合
- 異常系：権限エラー

### 7. プロジェクトチームアクション（project-team.ts）

#### getProjectTeamMembers
- 正常系：プロジェクトチームメンバー取得
- 異常系：存在しないプロジェクト
- 異常系：権限エラー

#### addProjectMember
- 正常系：メンバー追加成功
- 異常系：既にアサイン済み
- 異常系：稼働率超過
- 異常系：権限エラー

#### updateProjectMember
- 正常系：メンバー情報更新成功
- 正常系：稼働率変更
- 異常系：稼働率超過
- 異常系：権限エラー

#### removeProjectMember
- 正常系：メンバー削除成功
- 異常系：PMの削除
- 異常系：アクティブタスクがある場合
- 異常系：権限エラー

### 8. プロジェクト管理アクション（projects.ts）✅ 一部実装済み

#### getProjects ✅
- ✅ 正常系：エグゼクティブは全プロジェクト取得
- ✅ 正常系：PMは自分のプロジェクトのみ取得
- ✅ 異常系：未認証

#### createProject ✅
- ✅ 正常系：プロジェクト作成成功
- ✅ 異常系：権限エラー
- ✅ 境界値：プロジェクトコード重複時の再生成

#### updateProjectStatus ✅
- ✅ 正常系：ステータス更新成功
- ✅ 異常系：権限エラー
- ✅ 正常系：エグゼクティブは任意のプロジェクト更新可能

#### getProjectDetails
- 正常系：プロジェクト詳細取得
- 異常系：存在しないプロジェクト
- 異常系：権限エラー

## モック戦略

### Prismaクライアントのモック
- jest-mock-extendedを使用
- 各テストケースで必要なデータを返すよう設定

### 認証のモック
- getCurrentUser関数をモック化
- テストケースごとに異なるユーザー情報を返す

### 日付のモック
- 必要に応じてjest.useFakeTimersを使用
- 固定の日時でテストを実行

## テスト実行環境

### 必要なパッケージ
- jest
- @testing-library/react
- @testing-library/jest-dom
- jest-mock-extended
- ts-jest

### テストコマンド
```bash
# 全テスト実行
npm test

# カバレッジ付き実行
npm run test:coverage

# ウォッチモード
npm run test:watch
```

## カバレッジ目標

| ファイル | 目標カバレッジ | 現在のカバレッジ |
|---------|--------------|----------------|
| auth.ts | 90% | 92.3% ✅ |
| projects.ts | 80% | 72.91% |
| clients.ts | 80% | 0% |
| dashboard.ts | 80% | 0% |
| tasks.ts | 80% | 0% |
| team.ts | 80% | 0% |
| milestones.ts | 80% | 0% |
| project-team.ts | 80% | 0% |