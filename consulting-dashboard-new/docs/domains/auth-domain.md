# 認証ドメイン（Auth Domain）

## ドメイン概要
認証ドメインは、ユーザーの認証・認可・セッション管理を担当する境界づけられたコンテキスト（Bounded Context）です。

## ユビキタス言語定義

### 基本型定義
```
UUID: 一意識別子（36文字）
STRING_20: 最大20文字の文字列
STRING_50: 最大50文字の文字列
STRING_100: 最大100文字の文字列
STRING_255: 最大255文字の文字列
STRING_500: 最大500文字の文字列
EMAIL: メールアドレス形式（RFC5322準拠）
PASSWORD_HASH: ハッシュ化されたパスワード（60文字）
TIMESTAMP: 日時（ISO8601形式）
BOOLEAN: 真偽値（true/false）
INTEGER: 整数
ENUM: 列挙型
```

## エンティティ（Entities）

### ユーザー（User）
システムを利用する人を表現する中核エンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| ユーザーID | UUID | ○ | ユーザーの一意識別子 |
| メールアドレス | EMAIL | ○ | ログイン用メールアドレス |
| パスワード | PASSWORD_HASH | ○ | ハッシュ化されたパスワード |
| 氏名 | STRING_100 | ○ | ユーザーの表示名 |
| ロール | ユーザーロール | ○ | システム内での役割 |
| アクティブ状態 | BOOLEAN | ○ | アカウントの有効/無効 |
| 作成日時 | TIMESTAMP | ○ | アカウント作成日時 |
| 更新日時 | TIMESTAMP | ○ | 最終更新日時 |

#### ビジネスルール
- パスワード変更（changePassword）：新しいパスワードを設定する
- アクティベート（activate）：アカウントを有効化する
- ディアクティベート（deactivate）：アカウントを無効化する
- 権限確認（hasPermission）：特定の権限を持つか確認する

### セッション（Session）
ユーザーのログイン状態を管理するエンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| セッションID | UUID | ○ | セッションの一意識別子 |
| ユーザーID | UUID | ○ | セッションを保持するユーザー |
| トークン | セッショントークン | ○ | 認証トークン |
| 有効期限 | TIMESTAMP | ○ | セッションの有効期限 |
| 作成日時 | TIMESTAMP | ○ | セッション開始日時 |

#### ビジネスルール
- 有効期限確認（isExpired）：セッションが期限切れか判定
- 延長（extend）：有効期限を延長する
- 無効化（revoke）：セッションを強制終了する

### 権限（Permission）
システムの操作権限を定義するエンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| 権限ID | UUID | ○ | 権限の一意識別子 |
| 権限名 | STRING_100 | ○ | 権限の名称 |
| リソース | STRING_100 | ○ | 対象リソース名 |
| アクション | アクション種別 | ○ | 許可される操作 |
| 作成日時 | TIMESTAMP | ○ | 権限定義日時 |

#### ビジネスルール
- 権限マッチング（matches）：リソースとアクションが一致するか判定

## 値オブジェクト（Value Objects）

### ユーザーロール（UserRole）
```
列挙型：
- Executive: エグゼクティブ
- PM: プロジェクトマネージャー
- Consultant: コンサルタント
- Client: クライアント
- Admin: システム管理者
```

### アクション種別（ActionType）
```
列挙型：
- Read: 参照
- Write: 作成・更新
- Delete: 削除
- Execute: 実行
- Approve: 承認
```

### セッショントークン（SessionToken）
| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| トークン値 | STRING_500 | ○ | JWT形式のトークン文字列 |
| ペイロード | JSON | ○ | トークンに含まれる情報 |

### メールアドレス（EmailAddress）
| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| アドレス値 | EMAIL | ○ | RFC5322準拠のメールアドレス |

#### 制約
- @マークを含む
- ドメイン部分が存在する
- 最大255文字

### ハッシュ化パスワード（HashedPassword）
| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| ハッシュ値 | PASSWORD_HASH | ○ | bcryptでハッシュ化された値 |

## 集約（Aggregates）

### ユーザー集約（UserAggregate）
- **集約ルート**: ユーザー
- **含まれるエンティティ**: ユーザー、権限
- **含まれる値オブジェクト**: メールアドレス、ハッシュ化パスワード、ユーザーロール

### セッション集約（SessionAggregate）
- **集約ルート**: セッション
- **含まれるエンティティ**: セッション
- **含まれる値オブジェクト**: セッショントークン

## ドメインサービス

### 認証サービス（AuthenticationService）
ユーザーの認証処理を担当

**提供機能**:
- 認証（authenticate）: メールアドレスとパスワードでユーザーを認証
- ログアウト（logout）: セッションを終了
- パスワードリセット（resetPassword）: パスワードをリセット

### 認可サービス（AuthorizationService）
ユーザーの権限確認を担当

**提供機能**:
- 権限確認（authorize）: ユーザーが特定の操作を実行できるか判定
- 権限付与（grantPermission）: ユーザーに権限を付与
- 権限剥奪（revokePermission）: ユーザーから権限を削除

## ドメインイベント

### ユーザー作成イベント（UserCreated）
| 属性名 | 型 | 説明 |
|--------|-----|------|
| ユーザーID | UUID | 作成されたユーザーのID |
| メールアドレス | EMAIL | ユーザーのメールアドレス |
| ロール | ユーザーロール | ユーザーのロール |
| 発生日時 | TIMESTAMP | イベント発生日時 |

### ログインイベント（UserLoggedIn）
| 属性名 | 型 | 説明 |
|--------|-----|------|
| ユーザーID | UUID | ログインしたユーザーのID |
| セッションID | UUID | 作成されたセッションのID |
| IPアドレス | STRING_50 | ログイン元IPアドレス |
| 発生日時 | TIMESTAMP | イベント発生日時 |

### セッション期限切れイベント（SessionExpired）
| 属性名 | 型 | 説明 |
|--------|-----|------|
| セッションID | UUID | 期限切れセッションのID |
| ユーザーID | UUID | セッション保持ユーザーのID |
| 発生日時 | TIMESTAMP | イベント発生日時 |

## ビジネスルール

### ユーザー管理ルール
1. **メールアドレス一意性**: 同一メールアドレスでの複数アカウント作成は不可
2. **パスワードポリシー**:
   - 最小8文字、最大100文字
   - 英大文字、英小文字、数字、記号をそれぞれ1文字以上含む
   - 過去3回のパスワードは再利用不可
3. **アカウントロック**: ログイン失敗5回で30分間ロック
4. **初回ログイン**: 初回ログイン時はパスワード変更必須
5. **アカウント無効化**: 90日間未ログインで自動無効化

### セッション管理ルール
1. **セッション有効期限**: デフォルト2時間、最大24時間
2. **同時セッション数**: 1ユーザーあたり最大3セッション
3. **セッション延長**: アクティブな操作で自動延長（最大30分延長）
4. **強制ログアウト**: 管理者による強制ログアウト可能
5. **セッション破棄**: ログアウト時に即座に破棄

### 権限管理ルール
1. **ロール階層**: Admin > Executive > PM > Consultant > Client
2. **権限継承**: 上位ロールは下位ロールの全権限を継承
3. **権限委譲**: PMは自プロジェクトメンバーに限定的な権限委譲可能
4. **監査ログ**: すべての権限変更は監査ログに記録
5. **権限有効期限**: 一時的な権限付与は最大30日間

### セキュリティルール
1. **多要素認証**: Executiveロール以上は必須
2. **IPアドレス制限**: 管理者アカウントは特定IPからのみアクセス可能
3. **セッションハイジャック対策**: User-Agent変更で自動ログアウト
4. **ブルートフォース対策**: IPアドレスごとに5回/分のレート制限
5. **パスワード暗号化**: bcryptでコスト係数10以上

## リポジトリインターフェース

### ユーザーリポジトリ（UserRepository）
**必須メソッド**:
- IDで検索（findById）: UUID → ユーザー
- メールアドレスで検索（findByEmail）: EMAIL → ユーザー
- 保存（save）: ユーザー → 成功/失敗
- 削除（delete）: UUID → 成功/失敗
- 一覧取得（findAll）: 条件 → ユーザーリスト

### セッションリポジトリ（SessionRepository）
**必須メソッド**:
- IDで検索（findById）: UUID → セッション
- トークンで検索（findByToken）: STRING_500 → セッション
- ユーザーIDで検索（findByUserId）: UUID → セッションリスト
- 保存（save）: セッション → 成功/失敗
- 期限切れ削除（deleteExpired）: → 削除件数

### 権限リポジトリ（PermissionRepository）
**必須メソッド**:
- IDで検索（findById）: UUID → 権限
- ユーザーIDで検索（findByUserId）: UUID → 権限リスト
- 権限付与（grant）: ユーザーID、権限ID → 成功/失敗
- 権限剥奪（revoke）: ユーザーID、権限ID → 成功/失敗
- 権限確認（hasPermission）: ユーザーID、リソース、アクション → 真偽値