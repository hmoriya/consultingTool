# 通知ドメイン（Notification Domain）

## ドメイン概要
通知ドメインは、システム内の通知、メッセージ送受信、アラート管理を担当する境界づけられたコンテキストです。

## ユビキタス言語定義

### 基本型定義
```
UUID: 一意識別子（36文字）
STRING_20: 最大20文字の文字列
STRING_50: 最大50文字の文字列
STRING_100: 最大100文字の文字列
STRING_255: 最大255文字の文字列
TEXT: 長文テキスト（制限なし）
URL: URL形式（RFC3986準拠）
EMAIL: メールアドレス形式（RFC5322準拠）
DATE: 日付（YYYY-MM-DD形式）
TIMESTAMP: 日時（ISO8601形式）
BOOLEAN: 真偽値（true/false）
JSON: JSON形式のデータ
ENUM: 列挙型
```

## エンティティ（Entities）

### 通知（Notification）
システムからユーザーへの通知を表現するエンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| 通知ID | UUID | ○ | 通知の一意識別子 |
| 受信者ID | UUID | ○ | 通知を受けるユーザー |
| 通知種別 | 通知タイプ | ○ | 通知の種類 |
| タイトル | STRING_100 | ○ | 通知のタイトル |
| 本文 | TEXT | ○ | 通知の内容 |
| リンクURL | URL | - | 関連リンク |
| 関連エンティティID | UUID | - | 関連するエンティティ |
| 関連エンティティ種別 | STRING_50 | - | エンティティの種類 |
| 優先度 | 優先度レベル | ○ | 通知の重要度 |
| 既読 | BOOLEAN | ○ | 既読フラグ |
| 既読日時 | TIMESTAMP | - | 既読にした日時 |
| 有効期限 | TIMESTAMP | - | 通知の有効期限 |
| 作成日時 | TIMESTAMP | ○ | レコード作成日時 |

#### ビジネスルール
- 既読マーク（markAsRead）：通知を既読にする
- アーカイブ（archive）：通知をアーカイブする
- 有効期限確認（isExpired）：有効期限切れか確認

### メッセージ（Message）
ユーザー間のメッセージ交換を表現するエンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| メッセージID | UUID | ○ | メッセージの一意識別子 |
| チャンネルID | UUID | ○ | 所属チャンネル |
| 送信者ID | UUID | ○ | メッセージ送信者 |
| メッセージ種別 | メッセージタイプ | ○ | メッセージの種類 |
| 本文 | TEXT | ○ | メッセージ内容 |
| 添付ファイル | JSON | - | 添付ファイル情報 |
| メンション | JSON | - | メンションされたユーザー |
| 返信元ID | UUID | - | 返信元メッセージ |
| 編集済 | BOOLEAN | ○ | 編集フラグ |
| 編集日時 | TIMESTAMP | - | 最終編集日時 |
| 削除済 | BOOLEAN | ○ | 削除フラグ |
| 作成日時 | TIMESTAMP | ○ | レコード作成日時 |

### チャンネル（Channel）
メッセージ交換の場を表現するエンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| チャンネルID | UUID | ○ | チャンネルの一意識別子 |
| チャンネル名 | STRING_100 | ○ | チャンネルの名称 |
| チャンネル種別 | チャンネルタイプ | ○ | チャンネルの種類 |
| 説明 | TEXT | - | チャンネルの説明 |
| オーナーID | UUID | ○ | チャンネル管理者 |
| プロジェクトID | UUID | - | 関連プロジェクト |
| プライベート | BOOLEAN | ○ | 非公開フラグ |
| アーカイブ済 | BOOLEAN | ○ | アーカイブフラグ |
| 最終活動日時 | TIMESTAMP | ○ | 最後の投稿日時 |
| 作成日時 | TIMESTAMP | ○ | レコード作成日時 |

### チャンネルメンバー（ChannelMember）
チャンネル参加者を表現するエンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| メンバーID | UUID | ○ | メンバーの一意識別子 |
| チャンネルID | UUID | ○ | 所属チャンネル |
| ユーザーID | UUID | ○ | メンバーのユーザーID |
| 役割 | メンバー役割 | ○ | チャンネル内の役割 |
| 通知設定 | 通知設定 | ○ | 通知の受け取り設定 |
| 最終既読日時 | TIMESTAMP | - | 最後に既読にした日時 |
| 参加日時 | TIMESTAMP | ○ | チャンネル参加日時 |
| 退出日時 | TIMESTAMP | - | チャンネル退出日時 |

### 通知設定（NotificationPreference）
ユーザーの通知設定を管理するエンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| 設定ID | UUID | ○ | 設定の一意識別子 |
| ユーザーID | UUID | ○ | 設定所有者 |
| 通知種別 | 通知タイプ | ○ | 通知の種類 |
| メール通知 | BOOLEAN | ○ | メール通知の有無 |
| アプリ通知 | BOOLEAN | ○ | アプリ内通知の有無 |
| プッシュ通知 | BOOLEAN | ○ | プッシュ通知の有無 |
| 静音時間開始 | TIME | - | 通知を止める開始時刻 |
| 静音時間終了 | TIME | - | 通知を再開する時刻 |
| 更新日時 | TIMESTAMP | ○ | 最終更新日時 |

## 値オブジェクト（Value Objects）

### 通知タイプ（NotificationType）
```
列挙型：
- TaskAssigned: タスク割当
- TaskCompleted: タスク完了
- ProjectUpdate: プロジェクト更新
- Mention: メンション
- Approval: 承認依頼
- ApprovalResult: 承認結果
- Deadline: 期限通知
- SystemAlert: システムアラート
- Message: メッセージ
- Announcement: お知らせ
```

### 優先度レベル（PriorityLevel）
```
列挙型：
- Critical: 緊急
- High: 高
- Medium: 中
- Low: 低
- Info: 情報
```

### メッセージタイプ（MessageType）
```
列挙型：
- Text: テキスト
- File: ファイル
- Image: 画像
- System: システム
- Reply: 返信
- Edit: 編集済
```

### チャンネルタイプ（ChannelType）
```
列挙型：
- Public: パブリック
- Private: プライベート
- Direct: ダイレクトメッセージ
- Project: プロジェクトチャンネル
- System: システムチャンネル
```

### メンバー役割（MemberRole）
```
列挙型：
- Owner: オーナー
- Admin: 管理者
- Member: メンバー
- Guest: ゲスト
```

### 通知設定（NotificationSetting）
```
列挙型：
- All: 全ての通知
- Mentions: メンションのみ
- Nothing: 通知なし
- Custom: カスタム設定
```

### 通知ペイロード（NotificationPayload）
| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| アクション | STRING_50 | - | 実行すべきアクション |
| データ | JSON | - | 追加データ |
| メタデータ | JSON | - | メタ情報 |

## 集約（Aggregates）

### 通知集約（NotificationAggregate）
- **集約ルート**: 通知
- **含まれるエンティティ**: 通知
- **含まれる値オブジェクト**: 通知タイプ、優先度レベル、通知ペイロード

### チャンネル集約（ChannelAggregate）
- **集約ルート**: チャンネル
- **含まれるエンティティ**: チャンネル、チャンネルメンバー
- **含まれる値オブジェクト**: チャンネルタイプ、メンバー役割

### メッセージ集約（MessageAggregate）
- **集約ルート**: メッセージ
- **含まれるエンティティ**: メッセージ
- **含まれる値オブジェクト**: メッセージタイプ

## ドメインサービス

### 通知送信サービス（NotificationDeliveryService）
通知の配信を管理

**提供機能**:
- 通知送信（sendNotification）：通知を送信
- 一括送信（broadcastNotification）：複数ユーザーへ送信
- スケジュール送信（scheduleNotification）：時間指定送信
- 配信ルート決定（determineRoute）：配信経路を決定

### メッセージングサービス（MessagingService）
メッセージの送受信を管理

**提供機能**:
- メッセージ送信（sendMessage）：メッセージを送信
- メッセージ編集（editMessage）：メッセージを編集
- メッセージ削除（deleteMessage）：メッセージを削除
- メンション処理（processMentions）：メンションを処理

### チャンネル管理サービス（ChannelManagementService）
チャンネルの作成・管理

**提供機能**:
- チャンネル作成（createChannel）：新規チャンネル作成
- メンバー追加（addMember）：メンバーを追加
- メンバー削除（removeMember）：メンバーを削除
- アーカイブ（archiveChannel）：チャンネルをアーカイブ

### 通知設定サービス（PreferenceService）
ユーザーの通知設定を管理

**提供機能**:
- 設定更新（updatePreference）：通知設定を更新
- 設定取得（getPreference）：通知設定を取得
- 静音時間確認（isQuietHours）：静音時間か確認
- 配信可否判定（shouldDeliver）：通知すべきか判定

## ドメインイベント

### 通知送信イベント（NotificationSent）
| 属性名 | 型 | 説明 |
|--------|-----|------|
| 通知ID | UUID | 送信された通知 |
| 受信者ID | UUID | 通知受信者 |
| 通知種別 | 通知タイプ | 通知の種類 |
| 配信チャンネル | STRING_50 | 配信経路 |
| 発生日時 | TIMESTAMP | イベント発生日時 |

### メッセージ投稿イベント（MessagePosted）
| 属性名 | 型 | 説明 |
|--------|-----|------|
| メッセージID | UUID | 投稿されたメッセージ |
| チャンネルID | UUID | 投稿先チャンネル |
| 送信者ID | UUID | メッセージ送信者 |
| メンション | UUID[] | メンションされたユーザー |
| 発生日時 | TIMESTAMP | イベント発生日時 |

### チャンネル作成イベント（ChannelCreated）
| 属性名 | 型 | 説明 |
|--------|-----|------|
| チャンネルID | UUID | 作成されたチャンネル |
| チャンネル名 | STRING_100 | チャンネルの名称 |
| 作成者ID | UUID | チャンネル作成者 |
| 発生日時 | TIMESTAMP | イベント発生日時 |

## ビジネスルール

### 通知管理ルール
1. **保持期間**: 通知は90日間保持
2. **未読上限**: ユーザーあたり最大100件
3. **重複防止**: 同一内容の通知は5分間送信しない
4. **バッチ送信**: 1分間に最大10件まで
5. **優先度処理**: Criticalは即座に送信

### メッセージ管理ルール
1. **文字数制限**: 1メッセージ最大5000文字
2. **添付ファイル**: 最大10MB、最大5ファイル
3. **編集期限**: 投稿後24時間以内
4. **削除権限**: 送信者または管理者のみ
5. **メンション上限**: 1メッセージで20人まで

### チャンネル管理ルール
1. **名称一意性**: チャンネル名は一意
2. **メンバー上限**: 1チャンネル最大100人
3. **アーカイブ条件**: 90日間活動がない場合
4. **権限管理**: オーナーのみ削除可能
5. **プライベート制限**: 招待制で参加

### 通知設定ルール
1. **デフォルト設定**: メンションのみ通知
2. **静音時間**: デフォルト22:00-8:00
3. **オプトアウト**: いつでも変更可能
4. **通知種別**: 種別ごとに設定可能
5. **強制通知**: Criticalは設定を無視

## リポジトリインターフェース

### 通知リポジトリ（NotificationRepository）
**必須メソッド**:
- IDで検索（findById）: UUID → 通知
- ユーザーで検索（findByUserId）: UUID → 通知リスト
- 未読検索（findUnread）: UUID → 通知リスト
- 保存（save）: 通知 → 成功/失敗
- 削除（delete）: UUID → 成功/失敗

### メッセージリポジトリ（MessageRepository）
**必須メソッド**:
- IDで検索（findById）: UUID → メッセージ
- チャンネルで検索（findByChannelId）: UUID → メッセージリスト
- 検索（search）: 検索条件 → メッセージリスト
- 保存（save）: メッセージ → 成功/失敗
- 削除（delete）: UUID → 成功/失敗