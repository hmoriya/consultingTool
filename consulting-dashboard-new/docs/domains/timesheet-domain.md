# タイムシートドメイン（Timesheet Domain）

## ドメイン概要
タイムシートドメインは、コンサルタントの作業時間記録、承認フロー、稼働率管理を担当する境界づけられたコンテキストです。

## ユビキタス言語定義

### 基本型定義
```
UUID: 一意識別子（36文字）
STRING_20: 最大20文字の文字列
STRING_50: 最大50文字の文字列
STRING_100: 最大100文字の文字列
STRING_255: 最大255文字の文字列
TEXT: 長文テキスト（制限なし）
DATE: 日付（YYYY-MM-DD形式）
TIMESTAMP: 日時（ISO8601形式）
TIME: 時刻（HH:MM形式）
DECIMAL: 小数点数値
INTEGER: 整数
BOOLEAN: 真偽値（true/false）
ENUM: 列挙型
```

## エンティティ（Entities）

### タイムシート（Timesheet）
週単位の工数記録シートを表現するエンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| タイムシートID | UUID | ○ | タイムシートの一意識別子 |
| ユーザーID | UUID | ○ | 作成者 |
| 週開始日 | DATE | ○ | 週の開始日（月曜日） |
| 週終了日 | DATE | ○ | 週の終了日（日曜日） |
| ステータス | タイムシートステータス | ○ | 承認状態 |
| 総工数 | DECIMAL | ○ | 週の総作業時間 |
| 提出日時 | TIMESTAMP | - | 承認申請日時 |
| 承認者ID | UUID | - | 承認者 |
| 承認日時 | TIMESTAMP | - | 承認された日時 |
| コメント | TEXT | - | 備考・コメント |
| 作成日時 | TIMESTAMP | ○ | レコード作成日時 |
| 更新日時 | TIMESTAMP | ○ | 最終更新日時 |

#### ビジネスルール
- 提出（submit）：タイムシートを承認申請
- 承認（approve）：タイムシートを承認
- 差戻（reject）：修正を要求
- 工数計算（calculateTotal）：総工数を計算

### 工数エントリ（TimeEntry）
日次の工数記録を表現するエンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| エントリID | UUID | ○ | エントリの一意識別子 |
| タイムシートID | UUID | ○ | 所属タイムシート |
| 日付 | DATE | ○ | 作業日 |
| プロジェクトID | UUID | ○ | 作業対象プロジェクト |
| タスクID | UUID | - | 作業対象タスク |
| 開始時刻 | TIME | - | 作業開始時刻 |
| 終了時刻 | TIME | - | 作業終了時刻 |
| 工数 | DECIMAL | ○ | 作業時間（時間） |
| 作業種別 | 作業種別 | ○ | 作業の種類 |
| 作業内容 | TEXT | ○ | 作業内容の説明 |
| 場所 | 作業場所 | ○ | 作業場所 |
| 請求可能 | BOOLEAN | ○ | 請求対象フラグ |

### 承認履歴（ApprovalHistory）
承認アクションの履歴を記録するエンティティ

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| 履歴ID | UUID | ○ | 履歴の一意識別子 |
| タイムシートID | UUID | ○ | 対象タイムシート |
| アクション | 承認アクション | ○ | 実行されたアクション |
| 実行者ID | UUID | ○ | アクション実行者 |
| 実行日時 | TIMESTAMP | ○ | 実行日時 |
| コメント | TEXT | - | アクションへのコメント |
| 前ステータス | タイムシートステータス | ○ | 変更前の状態 |
| 後ステータス | タイムシートステータス | ○ | 変更後の状態 |

### 工数集計（TimeSummary）
期間別・プロジェクト別の工数集計

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| 集計ID | UUID | ○ | 集計の一意識別子 |
| ユーザーID | UUID | ○ | 対象ユーザー |
| プロジェクトID | UUID | - | 対象プロジェクト |
| 期間開始日 | DATE | ○ | 集計期間開始 |
| 期間終了日 | DATE | ○ | 集計期間終了 |
| 総工数 | DECIMAL | ○ | 期間内総工数 |
| 請求可能工数 | DECIMAL | ○ | 請求可能な工数 |
| 承認済工数 | DECIMAL | ○ | 承認済みの工数 |
| 稼働率 | DECIMAL | ○ | 稼働率（％） |

## 値オブジェクト（Value Objects）

### タイムシートステータス（TimesheetStatus）
```
列挙型：
- Draft: 下書き
- Submitted: 提出済
- Approved: 承認済
- Rejected: 差戻
- Locked: ロック済
```

### 作業種別（WorkType）
```
列挙型：
- Analysis: 分析・調査
- Design: 設計
- Development: 開発・実装
- Testing: テスト
- Meeting: 会議
- Documentation: ドキュメント作成
- Review: レビュー
- Support: サポート
- Training: 研修・教育
- Travel: 移動
- Admin: 管理業務
- Other: その他
```

### 作業場所（WorkLocation）
```
列挙型：
- Office: オフィス
- ClientSite: クライアント先
- Home: 在宅
- Remote: リモート
- Other: その他
```

### 承認アクション（ApprovalAction）
```
列挙型：
- Submit: 提出
- Approve: 承認
- Reject: 差戻
- Recall: 取下げ
- Comment: コメント
```

### 週期間（WeekPeriod）
| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| 週開始日 | DATE | ○ | 月曜日 |
| 週終了日 | DATE | ○ | 日曜日 |
| 週番号 | INTEGER | ○ | 年内の週番号 |

#### 制約
- 週は月曜日から日曜日の7日間
- 週番号は1-53の範囲

## 集約（Aggregates）

### タイムシート集約（TimesheetAggregate）
- **集約ルート**: タイムシート
- **含まれるエンティティ**: タイムシート、工数エントリ
- **含まれる値オブジェクト**: タイムシートステータス、週期間

### 承認履歴集約（ApprovalHistoryAggregate）
- **集約ルート**: 承認履歴
- **含まれるエンティティ**: 承認履歴
- **含まれる値オブジェクト**: 承認アクション

## ドメインサービス

### 工数管理サービス（TimeManagementService）
工数の記録と集計を管理

**提供機能**:
- 工数記録（recordTime）：工数を記録
- 工数集計（aggregateTime）：期間別に集計
- 稼働率計算（calculateUtilization）：稼働率を算出
- 超過勤務チェック（checkOvertime）：超過勤務を検出

### 承認ワークフローサービス（ApprovalWorkflowService）
タイムシートの承認プロセスを管理

**提供機能**:
- 承認申請（submitForApproval）：承認を申請
- 承認処理（processApproval）：承認/差戻を処理
- 承認ルート決定（determineApprover）：承認者を決定
- エスカレーション（escalate）：上位承認者へエスカレート

### 工数分析サービス（TimeAnalysisService）
工数データの分析とレポート生成

**提供機能**:
- プロジェクト別分析（analyzeByProject）：プロジェクト別工数分析
- リソース別分析（analyzeByResource）：リソース別稼働分析
- トレンド分析（analyzeTrends）：工数トレンドを分析
- 異常検知（detectAnomalies）：異常な工数パターンを検出

## ドメインイベント

### タイムシート提出イベント（TimesheetSubmitted）
| 属性名 | 型 | 説明 |
|--------|-----|------|
| タイムシートID | UUID | 提出されたタイムシート |
| ユーザーID | UUID | 提出者 |
| 週開始日 | DATE | 対象週 |
| 総工数 | DECIMAL | 週の総工数 |
| 発生日時 | TIMESTAMP | イベント発生日時 |

### タイムシート承認イベント（TimesheetApproved）
| 属性名 | 型 | 説明 |
|--------|-----|------|
| タイムシートID | UUID | 承認されたタイムシート |
| 承認者ID | UUID | 承認者 |
| 承認日時 | TIMESTAMP | 承認日時 |
| 発生日時 | TIMESTAMP | イベント発生日時 |

### 工数警告イベント（TimeWarning）
| 属性名 | 型 | 説明 |
|--------|-----|------|
| ユーザーID | UUID | 対象ユーザー |
| 警告種別 | STRING_50 | 警告の種類 |
| 閾値 | DECIMAL | 超過した閾値 |
| 実績値 | DECIMAL | 実際の値 |
| 発生日時 | TIMESTAMP | イベント発生日時 |

## ビジネスルール

### タイムシート管理ルール
1. **提出期限**: 週終了後3営業日以内に提出
2. **修正可能期間**: 承認前のみ修正可能
3. **最小記録単位**: 0.25時間（15分）単位
4. **最大工数**: 1日12時間まで
5. **週最大工数**: 週60時間まで

### 承認ルール
1. **承認者決定**: プロジェクトPMが承認
2. **自動エスカレーション**: 3日以内に承認されない場合上位へ
3. **差戻理由必須**: 差戻時は理由コメント必須
4. **再提出制限**: 差戻は2回まで
5. **ロック期間**: 承認後30日でロック

### 工数記録ルール
1. **日次入力推奨**: 当日中の入力を推奨
2. **遡及入力制限**: 2週間前まで入力可能
3. **プロジェクト必須**: 全工数はプロジェクトに紐付け
4. **作業内容必須**: 50文字以上の説明必須
5. **休日勤務**: 事前申請が必要

### 稼働率ルール
1. **目標稼働率**: 80-85%を目標
2. **警告閾値**: 90%超で警告
3. **最低稼働**: 60%未満で要確認
4. **請求可能率**: 70%以上を維持
5. **月次レビュー**: 毎月稼働率をレビュー

## リポジトリインターフェース

### タイムシートリポジトリ（TimesheetRepository）
**必須メソッド**:
- IDで検索（findById）: UUID → タイムシート
- ユーザーと週で検索（findByUserAndWeek）: UUID, DATE → タイムシート
- ステータスで検索（findByStatus）: タイムシートステータス → タイムシートリスト
- 保存（save）: タイムシート → 成功/失敗
- 削除（delete）: UUID → 成功/失敗

### 工数エントリリポジトリ（TimeEntryRepository）
**必須メソッド**:
- IDで検索（findById）: UUID → 工数エントリ
- タイムシートIDで検索（findByTimesheetId）: UUID → 工数エントリリスト
- 期間で検索（findByPeriod）: DATE, DATE → 工数エントリリスト
- 保存（save）: 工数エントリ → 成功/失敗
- 一括保存（bulkSave）: 工数エントリリスト → 成功/失敗