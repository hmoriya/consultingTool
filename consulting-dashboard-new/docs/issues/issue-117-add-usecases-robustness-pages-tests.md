# Issue #117: ユースケース・ロバストネス図・ページ定義・テスト定義の追加

## 概要
セキュアアクセスサービスの「ユーザーを登録し認証する」オペレーションに対して、以下の設計ドキュメントを作成しました：
- ユースケース定義（4件）
- ロバストネス図（4件）
- ページ定義（4件）
- テスト定義（4件）

## 対象オペレーション
**サービス**: セキュアアクセスサービス（secure-access-service）
**ケーパビリティ**: ユーザーを認証・管理する能力（authenticate-and-manage-users）
**オペレーション**: ユーザーを登録し認証する（register-and-authenticate-users）

## 作成したファイル

### 1. ユースケース定義（4件）
すべて既存のMDファイルを使用（既にデータベースにインポート済み）：
- `login-and-authenticate.md` - ログインして認証する
- `request-user-account.md` - ユーザーアカウントを申請する
- `approve-and-create-account.md` - アカウントを承認・作成する
- `logout.md` - ログアウトする

### 2. ロバストネス図（4件）
BCE（Boundary-Control-Entity）パターンに基づく分析図：

#### `login-and-authenticate-robustness.md`
- **アクター**: 組織メンバー、クライアント
- **境界要素**: ログイン画面、MFA認証画面、パスワード変更画面、ダッシュボード画面
- **制御要素**: 認証コントローラー、セッション生成サービス、MFA検証サービス
- **実体要素**: ユーザーアカウント、セッション、監査ログ、MFA設定

#### `request-user-account-robustness.md`
- **アクター**: 新規メンバー、新規クライアント
- **境界要素**: アカウント申請フォーム、申請完了画面、確認メール
- **制御要素**: 申請受付コントローラー、バリデーションサービス、メール送信サービス
- **実体要素**: アカウント申請、申請者情報、申請履歴

#### `approve-and-create-account-robustness.md`
- **アクター**: 管理者、システム、申請者
- **境界要素**: 申請一覧画面、申請詳細・審査画面、承認確認ダイアログ、却下理由入力ダイアログ
- **制御要素**: 申請審査コントローラー、アカウント作成サービス、権限設定サービス、通知サービス
- **実体要素**: アカウント申請、ユーザーアカウント、ロール、組織、通知

#### `logout-robustness.md`
- **アクター**: 組織メンバー、セキュリティ監査システム
- **境界要素**: ログアウト確認ダイアログ、ログアウト完了画面、セッションタイムアウト警告
- **制御要素**: ログアウトコントローラー、セッション無効化サービス、監査ログ記録サービス
- **実体要素**: セッション、監査ログ、ユーザーアカウント

### 3. ページ定義（4件）
実装非依存の自然言語で記述：

#### `request-user-account-page.md`
- 画面の目的、利用者、画面構成を定義
- 申請フォーム部（申請者情報、組織情報、連絡先情報、利用規約同意）
- バリデーション表示、エラーハンドリング
- レスポンシブ対応（デスクトップ/タブレット/モバイル）
- セキュリティ要件（CSRF対策、入力サニタイゼーション、レート制限）

#### `approve-and-create-account-page.md`
- 管理者向けアカウント承認・作成画面
- 申請一覧部（検索・フィルタ・ソート・ページネーション機能）
- 申請詳細・審査部（アカウント設定、ロール選択、所属組織選択）
- 承認/却下/保留処理フロー
- アクション履歴表示

#### `login-and-authenticate-page.md`
- ログイン・認証画面の詳細設計
- メインフォーム（メールアドレス、パスワード、ログイン状態保持）
- 初回ログイン時のパスワード変更フロー
- MFA（多要素認証）フロー
- ログイン試行制限、CAPTCHA表示
- セキュリティ要件（HTTPS必須、CSRF対策、セッション管理、監査ログ）

#### `logout-page.md`
- ログアウト画面の詳細設計
- ログアウト確認画面、処理中画面、完了画面
- セッション無効化処理フロー
- 自動ログアウト（セッションタイムアウト）
- セキュリティ要件（セッション完全無効化、トークンブラックリスト、Cookie削除）

### 4. テスト定義（4件）
包括的なテストケースを定義：

#### `request-user-account-test.md`
- **テストケース数**: 10件（正常系2件、異常系6件、境界値1件、ネットワークエラー1件）
- **主要テスト**:
  - 新規メンバー/クライアントの申請成功
  - 必須項目未入力、メールアドレス形式不正、重複メールアドレス
  - 文字数制限超過、利用規約未同意
  - XSS対策、CSRF対策、レート制限
- **性能テスト**: 同時申請50件、レスポンス時間3秒以内
- **自動化対象**: 正常系・異常系・境界値（8件）

#### `approve-and-create-account-test.md`
- **テストケース数**: 10件（正常系3件、異常系5件、UI/UX2件）
- **主要テスト**:
  - アカウント承認成功、アカウント却下、保留処理
  - 必須項目未入力、ユーザーID重複、却下理由未入力
  - 検索・フィルタ機能、ソート機能、ページネーション
- **セキュリティテスト**: 権限チェック、操作ログ、CSRF対策
- **自動化対象**: 正常系・異常系（7件）

#### `login-and-authenticate-test.md`
- **テストケース数**: 13件（正常系5件、異常系7件、UI/UX1件）
- **主要テスト**:
  - Executive/PMユーザーのログイン成功
  - 初回ログイン時のパスワード変更、MFA認証フロー、ログイン状態保持
  - 誤ったパスワード、存在しないメールアドレス
  - 連続ログイン失敗（アカウントロック）、クライアント側ログイン試行制限
  - CAPTCHA表示、パスワード表示/非表示切り替え
- **性能テスト**: 同時ログイン100件、レスポンス時間1秒以内
- **セキュリティテスト**: パスワードハッシュ検証、セッション管理、CSRF対策、ブルートフォース攻撃対策
- **自動化対象**: 正常系・異常系（7件）

#### `logout-test.md`
- **テストケース数**: 13件（正常系5件、異常系3件、セキュリティ3件、UI/UX2件）
- **主要テスト**:
  - 通常ログアウト成功、確認なしログアウト
  - ログアウト後の再アクセス防止
  - セッションタイムアウトによる自動ログアウト、セッション延長
  - セッション既に無効、ネットワークエラー時のログアウト
  - 多重ログアウト防止、全デバイスログアウト、強制ログアウト（管理者機能）
- **性能テスト**: ログアウト処理500ms以内、同時ログアウト50件
- **セキュリティテスト**: セッション無効化確認、トークンブラックリスト確認、Cookie削除確認
- **自動化対象**: 正常系・異常系（9件）

## データベースインポート
`scripts/import-usecases-robustness.mjs` スクリプトを使用して、ユースケースとロバストネス図をデータベースにインポート済み：
- 4件のユースケース定義をUseCaseテーブルに登録
- 4件のロバストネス図をRobustnessDiagramテーブルに登録
- 各ロバストネス図はuseCaseIdで対応するユースケースと紐付け

## UI改善（2024-01-XX追加）

### ユースケース詳細画面のタブ化
ユースケースノード選択時に、以下の3タブを表示するよう改善：

#### 1. ユースケース定義タブ（デフォルト）
- ユースケースMD（definition）を表示・編集
- アクター、事前/事後条件、基本フロー等を記述

#### 2. ロバストネス図タブ
- ロバストネス図MD（robustnessDiagram.content）を表示・編集
- Boundary-Control-Entityパターンの分析図
- Mermaidダイアグラムも表示可能（将来実装）

#### 3. テスト定義タブ
- 紐付けられたテスト定義の一覧を表示
- 各テストのMD（testDefinitions[].description）を表示・編集
- テストケース、期待結果を記述
- テストが未登録の場合は警告を表示

### 修正ファイル
- `/app/components/parasol/ParasolSettingsPage2.tsx` (633-718行目)
  - `case 'useCase':`セクションをタブ形式に変更
  - Tabsコンポーネントで3つのタブを実装
  - 各タブにUnifiedMDEditorを配置

### 表示されるデータ構造
```typescript
selectedNode.metadata = {
  definition: string,                    // ユースケース定義MD
  robustnessDiagram: {
    content: string                       // ロバストネス図MD
  },
  testDefinitions: Array<{
    id: string,
    name: string,
    displayName: string,
    testType: string,
    description: string                   // テスト定義MD
  }>
}
```

## 今後の作業

### ページ定義とテスト定義のデータベース登録
現在、ページ定義とテスト定義はMDファイルのみ作成済み。以下の作業が必要：

1. **PageDefinitionテーブルへのインポート**
   - `request-user-account-page.md` → PageDefinitionレコード
   - `approve-and-create-account-page.md` → PageDefinitionレコード
   - `login-and-authenticate-page.md` → PageDefinitionレコード
   - `logout-page.md` → PageDefinitionレコード

2. **TestDefinitionテーブルへのインポート**
   - `request-user-account-test.md` → TestDefinitionレコード
   - `approve-and-create-account-test.md` → TestDefinitionレコード
   - `login-and-authenticate-test.md` → TestDefinitionレコード
   - `logout-test.md` → TestDefinitionレコード

3. **インポートスクリプトの拡張**
   - `import-usecases-robustness.mjs`を拡張して、ページ定義とテスト定義もインポートできるようにする
   - または、別スクリプト`import-pages-tests.mjs`を作成

4. **tree-utilsの更新**
   - `buildTreeFromParasolData`関数で、ページ定義とテスト定義をツリーに含める
   - 現在はuseCaseModels配下のpageDefinitions/testDefinitionsを参照しているが、実際のデータ構造と一致させる

### 他のサービスへの展開
セキュアアクセスサービスで確立した手法を、他の6サービスにも適用：
1. プロジェクト成功支援サービス
2. タレント最適化サービス
3. 生産性可視化サービス
4. ナレッジ共創サービス
5. 収益最適化サービス
6. コラボレーション促進サービス

## 参考情報
- パラソルドメイン言語テンプレート: `/templates/parasol-domain-language-v2.md`
- ビジネスオペレーション設計ガイド: CLAUDE.md
- ロバストネス図の記述方法: BCE（Boundary-Control-Entity）パターン
