# BC-004: ãƒ‡ãƒ¼ã‚¿å±¤è¨­è¨ˆ

**BC**: Organizational Structure & Governance [çµ„ç¹”æ§‹é€ ã¨ã‚¬ãƒãƒŠãƒ³ã‚¹] [BC_004]
**ä½œæˆæ—¥**: 2025-10-31
**æœ€çµ‚æ›´æ–°**: 2025-11-03
**V2ç§»è¡Œå…ƒ**: services/secure-access-service/database-design.mdï¼ˆçµ„ç¹”ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿ï¼‰

---

## ç›®æ¬¡

1. [æ¦‚è¦](#overview)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#architecture)
3. [ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§](#table-list)
4. [ERå›³](#er-diagram)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#data-flows)
6. [BCé–“é€£æº](#bc-integration)
7. [è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](#detailed-docs)

---

## æ¦‚è¦ {#overview}

BC-004ã®ãƒ‡ãƒ¼ã‚¿å±¤ã¯ã€çµ„ç¹”æ§‹é€ ã€ãƒãƒ¼ãƒ ç®¡ç†ã€ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒãƒªã‚·ãƒ¼ã®æ°¸ç¶šåŒ–ã‚’æ‹…å½“ã—ã¾ã™ã€‚

### ä¸»è¦æ©Ÿèƒ½

- **çµ„ç¹”ç®¡ç†**: çµ„ç¹”ã¨çµ„ç¹”å˜ä½ã®éšå±¤æ§‹é€ ç®¡ç†ï¼ˆæœ€å¤§10éšå±¤ï¼‰
- **ãƒãƒ¼ãƒ ç®¡ç†**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ¼ãƒ ã€å¸¸è¨­ãƒãƒ¼ãƒ ã€ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ¼ã‚¹ã®ç®¡ç†
- **ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†**: çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ã¨ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®æ‰€å±ç®¡ç†
- **ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†**: ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒãƒ¼ãƒ å‚åŠ ç‡ç®¡ç†ï¼ˆæœ€å¤§200%ï¼‰
- **ã‚¬ãƒãƒŠãƒ³ã‚¹ç®¡ç†**: ãƒãƒªã‚·ãƒ¼ã€ãƒ«ãƒ¼ãƒ«ã€é©ç”¨ç¯„å›²ã€é•åæ¤œçŸ¥

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **DBMS**: PostgreSQL 14+
- **ä¸»è¦æ©Ÿèƒ½**:
  - é–‰åŒ…ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆClosure Tableï¼‰ã«ã‚ˆã‚‹é«˜é€Ÿéšå±¤ã‚¯ã‚¨ãƒª
  - ãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚‹éšå±¤æ•´åˆæ€§ä¿è¨¼
  - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚‹å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ç®¡ç†
  - ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ã«ã‚ˆã‚‹çµ±è¨ˆé›†è¨ˆ
  - CHECKåˆ¶ç´„ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿è¨¼

---

## ğŸ”„ Parasolå‹ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©

ã“ã®BCã§ä½¿ç”¨ã™ã‚‹Parasol Domain Languageå‹ã¨PostgreSQLå‹ã®å¯¾å¿œè¡¨ã€‚

### åŸºæœ¬å‹ãƒãƒƒãƒ”ãƒ³ã‚°

| Parasolå‹ | PostgreSQLå‹ | åˆ¶ç´„ä¾‹ | èª¬æ˜ |
|-----------|-------------|--------|------|
| UUID | UUID | PRIMARY KEY, NOT NULL | UUID v4å½¢å¼ã®ä¸€æ„è­˜åˆ¥å­ |
| STRING_20 | VARCHAR(20) | NOT NULL, CHECK(length(...) <= 20) | æœ€å¤§20æ–‡å­—ã®æ–‡å­—åˆ— |
| STRING_50 | VARCHAR(50) | NOT NULL, CHECK(length(...) <= 50) | æœ€å¤§50æ–‡å­—ã®æ–‡å­—åˆ— |
| STRING_100 | VARCHAR(100) | NOT NULL, CHECK(length(...) <= 100) | æœ€å¤§100æ–‡å­—ã®æ–‡å­—åˆ— |
| STRING_200 | VARCHAR(200) | NOT NULL, CHECK(length(...) <= 200) | æœ€å¤§200æ–‡å­—ã®æ–‡å­—åˆ— |
| STRING_255 | VARCHAR(255) | NOT NULL, CHECK(length(...) <= 255) | æœ€å¤§255æ–‡å­—ã®æ–‡å­—åˆ— |
| TEXT | TEXT | - | é•·æ–‡ï¼ˆåˆ¶é™ãªã—ï¼‰ |
| INTEGER | INTEGER | CHECK(value > 0) | æ•´æ•° |
| DECIMAL | NUMERIC | CHECK(value >= 0) | å°æ•°ï¼ˆé‡‘é¡ã€å·¥æ•°ç­‰ï¼‰ |
| PERCENTAGE | NUMERIC(5,2) | CHECK(value BETWEEN 0 AND 100) | ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼ˆ0-100ï¼‰ |
| BOOLEAN | BOOLEAN | NOT NULL DEFAULT false | çœŸå½å€¤ |
| DATE | DATE | NOT NULL | YYYY-MM-DDå½¢å¼ã®æ—¥ä»˜ |
| TIMESTAMP | TIMESTAMP WITH TIME ZONE | NOT NULL DEFAULT CURRENT_TIMESTAMP | ISO8601å½¢å¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— |
| EMAIL | VARCHAR(255) | CHECK(email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z\|a-z]{2,}$') | RFC5322æº–æ‹ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| URL | TEXT | CHECK(url ~* '^https?://') | RFC3986æº–æ‹ URL |
| MONEY | JSONB or (NUMERIC + VARCHAR(3)) | CHECK(amount >= 0), CHECK(currency ~ '^[A-Z]{3}$') | é‡‘é¡ï¼ˆé€šè²¨ä»˜ãï¼‰ |
| JSON | JSONB | - | JSONå½¢å¼ãƒ‡ãƒ¼ã‚¿ |
| BINARY | BYTEA | - | ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ |

### å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

1. **NOT NULLåˆ¶ç´„**: Parasolå‹ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯`NOT NULL`åˆ¶ç´„ã‚’ä»˜ä¸
2. **CHECKåˆ¶ç´„**: é•·ã•åˆ¶ç´„ã€ç¯„å›²åˆ¶ç´„ã‚’`CHECK`ã§å®Ÿè£…
3. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: æ¤œç´¢é »åº¦ã®é«˜ã„ã‚«ãƒ©ãƒ ã«ã¯é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
4. **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤**: `TIMESTAMP`ã¯`DEFAULT CURRENT_TIMESTAMP`ã‚’æ¨å¥¨
5. **åˆ—æŒ™å‹**: Parasolå‹ã®`STRING_XX` (enumå€¤) ã¯`VARCHAR + CHECK`ã¾ãŸã¯`ENUM`å‹ã§å®Ÿè£…

### BCå›ºæœ‰ã®å‹å®šç¾©

**éšå±¤æ§‹é€ å‹**:
- `HIERARCHY_LEVEL`: çµ„ç¹”éšå±¤ãƒ¬ãƒ™ãƒ« â†’ `INTEGER CHECK (hierarchy_level BETWEEN 0 AND 10)`
- `PATH`: éšå±¤ãƒ‘ã‚¹ â†’ `VARCHAR(1000)` (ä¾‹: /root/dept1/team1)
- `DEPTH`: éšå±¤æ·±åº¦ â†’ `INTEGER CHECK (depth >= 0)`

**ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‹**:
- `ALLOCATION_RATE`: ãƒãƒ¼ãƒ å‚åŠ ç‡ â†’ `NUMERIC(3,2) CHECK (allocation_rate BETWEEN 0.0 AND 2.0)` (æœ€å¤§200%)

**ãƒãƒªã‚·ãƒ¼å‹**:
- `POLICY_CONDITION`: ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ«ãƒ¼ãƒ«æ¡ä»¶å¼ â†’ `TEXT` (è©•ä¾¡å¼)
- `SEVERITY_LEVEL`: é•åé‡å¤§åº¦ â†’ `VARCHAR(20) CHECK (severity IN ('low', 'medium', 'high', 'critical'))`

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ {#architecture}

### ãƒ‡ãƒ¼ã‚¿ã‚°ãƒ«ãƒ¼ãƒ—

BC-004ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä»¥ä¸‹ã®4ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†é¡ã•ã‚Œã¾ã™:

```
BC-004 Data Layer
â”œâ”€â”€ çµ„ç¹”ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ4ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
â”‚   â”œâ”€â”€ organizationsï¼ˆçµ„ç¹”ãƒã‚¹ã‚¿ï¼‰
â”‚   â”œâ”€â”€ organization_unitsï¼ˆçµ„ç¹”å˜ä½ï¼‰
â”‚   â”œâ”€â”€ organization_hierarchiesï¼ˆéšå±¤é–‰åŒ…ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
â”‚   â””â”€â”€ organization_membersï¼ˆçµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ï¼‰
â”‚
â”œâ”€â”€ ãƒãƒ¼ãƒ ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ3ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
â”‚   â”œâ”€â”€ teamsï¼ˆãƒãƒ¼ãƒ ãƒã‚¹ã‚¿ï¼‰
â”‚   â”œâ”€â”€ team_membersï¼ˆãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ãƒ»ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â””â”€â”€ team_leadersï¼ˆãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ï¼‰
â”‚
â”œâ”€â”€ ã‚¬ãƒãƒŠãƒ³ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ4ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
â”‚   â”œâ”€â”€ governance_policiesï¼ˆãƒãƒªã‚·ãƒ¼ãƒã‚¹ã‚¿ï¼‰
â”‚   â”œâ”€â”€ governance_rulesï¼ˆãƒãƒªã‚·ãƒ¼ãƒ«ãƒ¼ãƒ«ï¼‰
â”‚   â”œâ”€â”€ policy_scopesï¼ˆé©ç”¨ç¯„å›²ï¼‰
â”‚   â””â”€â”€ policy_violationsï¼ˆé•åè¨˜éŒ²ï¼‰
â”‚
â””â”€â”€ çµ±è¨ˆãƒ“ãƒ¥ãƒ¼ï¼ˆ3ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ï¼‰
    â”œâ”€â”€ mv_user_allocation_summaryï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³é›†è¨ˆï¼‰
    â”œâ”€â”€ mv_team_statisticsï¼ˆãƒãƒ¼ãƒ çµ±è¨ˆï¼‰
    â””â”€â”€ mv_unit_statisticsï¼ˆçµ„ç¹”å˜ä½çµ±è¨ˆï¼‰
```

### BC-003ã¨ã®é€£æº

BC-004ã¯BC-003ï¼ˆAccess Control & Securityï¼‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ã«ä¾å­˜ã—ã¾ã™:

```
BC-003.users â†â†’ BC-004.organization_membersï¼ˆçµ„ç¹”æ‰€å±ï¼‰
BC-003.users â†â†’ BC-004.team_membersï¼ˆãƒãƒ¼ãƒ æ‰€å±ï¼‰
BC-003.audit_logs â† BC-004ï¼ˆçµ„ç¹”å¤‰æ›´ãƒ»ã‚¬ãƒãƒŠãƒ³ã‚¹é•åã®ç›£æŸ»ï¼‰
```

---

## ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ {#table-list}

### ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ11ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

| # | ãƒ†ãƒ¼ãƒ–ãƒ«å | æ¨å®šè¡Œæ•° | èª¬æ˜ | ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ |
|---|-----------|---------|------|--------------|
| 1 | **organizations** | ~100 | çµ„ç¹”ãƒã‚¹ã‚¿ | ãªã— |
| 2 | **organization_units** | ~5,000 | çµ„ç¹”å˜ä½ï¼ˆéƒ¨ç½²ãƒ»ãƒãƒ¼ãƒ ç­‰ï¼‰ | ãªã— |
| 3 | **organization_hierarchies** | ~50,000 | çµ„ç¹”éšå±¤é–‰åŒ…ãƒ†ãƒ¼ãƒ–ãƒ« | ãªã— |
| 4 | **organization_members** | ~10,000 | çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼æ‰€å± | ãªã— |
| 5 | **teams** | ~500 | ãƒãƒ¼ãƒ ãƒã‚¹ã‚¿ | ãªã— |
| 6 | **team_members** | ~2,500 | ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ãƒ»ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ | ãªã— |
| 7 | **team_leaders** | ~500 | ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ | ãªã— |
| 8 | **governance_policies** | ~100 | ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒãƒªã‚·ãƒ¼ | ãªã— |
| 9 | **governance_rules** | ~500 | ãƒãƒªã‚·ãƒ¼ãƒ«ãƒ¼ãƒ« | ãªã— |
| 10 | **policy_scopes** | ~1,000 | ãƒãƒªã‚·ãƒ¼é©ç”¨ç¯„å›² | ãªã— |
| 11 | **policy_violations** | ~10,000+ | ãƒãƒªã‚·ãƒ¼é•åè¨˜éŒ² | å¹´æ¬¡ |

### ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ï¼ˆ3ãƒ“ãƒ¥ãƒ¼ï¼‰

| # | ãƒ“ãƒ¥ãƒ¼å | ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ | èª¬æ˜ |
|---|---------|------------|------|
| 1 | **mv_user_allocation_summary** | 1æ™‚é–“æ¯ | ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³é›†è¨ˆ |
| 2 | **mv_team_statistics** | 1æ™‚é–“æ¯ | ãƒãƒ¼ãƒ çµ±è¨ˆæƒ…å ± |
| 3 | **mv_unit_statistics** | 1æ—¥1å› | çµ„ç¹”å˜ä½çµ±è¨ˆæƒ…å ± |

**è©³ç´°**: [tables.md](tables.md)

---

## ERå›³ {#er-diagram}

### çµ„ç¹”ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  organizations   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  id (PK)         â”‚â—„â”€â”
â”‚  name            â”‚  â”‚
â”‚  code (UQ)       â”‚  â”‚
â”‚  type            â”‚  â”‚
â”‚  status          â”‚  â”‚
â”‚  root_unit_id    â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
                       â”‚         â”‚
                       â”‚         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚organization_     â”‚  â”‚  â”‚organization_units    â”‚â—„â”€â”
â”‚members           â”‚  â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚  â”‚id (PK)               â”‚  â”‚
â”‚id (PK)           â”‚  â”‚  â”‚organization_id (FK)  â”‚â”€â”€â”˜
â”‚organization_idâ”€â”€â”€â”¼â”€â”€â”˜  â”‚name                  â”‚
â”‚unit_id (FK)      â”‚â”€â”€â”€â”€â”€â”¤parent_unit_id (FK)   â”‚â”€â”€â”
â”‚user_id (FK)â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â–ºhierarchy_level      â”‚  â”‚
â”‚role_in_unit      â”‚     â”‚path                  â”‚  â”‚ è‡ªå·±å‚ç…§
â”‚status            â”‚     â”‚unit_type             â”‚  â”‚
â”‚joined_at         â”‚     â”‚member_count          â”‚â—„â”€â”˜
â”‚left_at           â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â–²
                                  â”‚  â”‚
                                  â–¼  â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚organization_         â”‚
                         â”‚hierarchies           â”‚
                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
                         â”‚id (PK)               â”‚
                         â”‚ancestor_unit_id (FK) â”‚
                         â”‚descendant_unit_id(FK)â”‚
                         â”‚depth                 â”‚
                         â”‚path                  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒãƒ¼ãƒ ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     teams        â”‚         â”‚   team_members   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  id (PK)         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤  id (PK)         â”‚
â”‚  organization_id â”‚         â”‚  team_id (FK)    â”‚
â”‚  unit_id (FK)    â”‚         â”‚  user_id (FK)â”€â”€â”€â”€â”¼â”€â”€â–º BC-003.users
â”‚  name            â”‚         â”‚  allocation_rate â”‚
â”‚  team_type       â”‚         â”‚  role            â”‚
â”‚  purpose         â”‚         â”‚  status          â”‚
â”‚  status          â”‚         â”‚  start_date      â”‚
â”‚  start_date      â”‚         â”‚  end_date        â”‚
â”‚  end_date        â”‚         â”‚  joined_at       â”‚
â”‚  member_count    â”‚         â”‚  left_at         â”‚
â”‚  leader_count    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
         â”‚                            â”‚
         â”‚                            â–¼
         â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚  team_leaders    â”‚
         â”‚                   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  id (PK)         â”‚
                             â”‚  team_id (FK)    â”‚
                             â”‚  member_id (FK)  â”‚
                             â”‚  user_id (FK)    â”‚
                             â”‚  status          â”‚
                             â”‚  assigned_at     â”‚
                             â”‚  removed_at      â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¬ãƒãƒŠãƒ³ã‚¹ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ governance_policies  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  id (PK)             â”‚â—„â”€â”€â”
â”‚  organization_id (FK)â”‚   â”‚
â”‚  name                â”‚   â”‚
â”‚  policy_type         â”‚   â”‚
â”‚  priority            â”‚   â”‚
â”‚  enforcement_level   â”‚   â”‚
â”‚  status              â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
         â”‚                 â”‚
         â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â–¼    â–¼     â–¼           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚governance_ â”‚ â”‚policy_scopesâ”‚ â”‚policy_violations â”‚
â”‚rules       â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚id (PK)      â”‚ â”‚id (PK)           â”‚
â”‚id (PK)     â”‚ â”‚policy_id(FK)â”œâ”€â”˜policy_id (FK)    â”‚
â”‚policy_id(FK)â”œâ”€â”¤target_type  â”‚  rule_id (FK)     â”‚
â”‚name        â”‚ â”‚target_id    â”‚  target_type      â”‚
â”‚condition   â”‚ â”‚include_desc â”‚  target_id        â”‚
â”‚error_msg   â”‚ â”‚status       â”‚  severity         â”‚
â”‚severity    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  status            â”‚
â”‚status      â”‚                  detected_at       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  resolved_at       â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ {#data-flows}

### 1. çµ„ç¹”ä½œæˆãƒ•ãƒ­ãƒ¼

```
POST /api/bc-004/organizations
â†“
1. organizations ãƒ†ãƒ¼ãƒ–ãƒ«ã«INSERT
   - id, name, code, type, status='active'
â†“
2. ãƒ«ãƒ¼ãƒˆçµ„ç¹”å˜ä½ã‚’organization_units ãƒ†ãƒ¼ãƒ–ãƒ«ã«INSERT
   - parent_unit_id = NULL
   - hierarchy_level = 0
   - path = '/{name}'
â†“
3. organization_hierarchies ãƒ†ãƒ¼ãƒ–ãƒ«ã«è‡ªå·±å‚ç…§ãƒ¬ã‚³ãƒ¼ãƒ‰INSERT
   - ancestor_unit_id = descendant_unit_id = unit.id
   - depth = 0
â†“
4. organizations.root_unit_id ã‚’æ›´æ–°
â†“
5. BC-003.audit_logs ã«ãƒ­ã‚°è¨˜éŒ²
â†“
6. BC-007 ã¸ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ï¼ˆOrganizationCreatedï¼‰
```

### 2. çµ„ç¹”å˜ä½è¿½åŠ ãƒ•ãƒ­ãƒ¼ï¼ˆéšå±¤æ§‹é€ æ§‹ç¯‰ï¼‰

```
POST /api/bc-004/organizations/{orgId}/units
â†“
1. è¦ªå˜ä½ã®å­˜åœ¨ç¢ºèªï¼ˆparent_unit_idï¼‰
â†“
2. å¾ªç’°å‚ç…§ãƒã‚§ãƒƒã‚¯ï¼ˆãƒˆãƒªã‚¬ãƒ¼ã§è‡ªå‹•å®Ÿè¡Œï¼‰
â†“
3. organization_units ãƒ†ãƒ¼ãƒ–ãƒ«ã«INSERT
   - parent_unit_id, hierarchy_level, pathè¨ˆç®—
â†“
4. organization_hierarchies ãƒ†ãƒ¼ãƒ–ãƒ«ã«éšå±¤ãƒ¬ã‚³ãƒ¼ãƒ‰æŒ¿å…¥
   - è‡ªå·±å‚ç…§: (unit_id, unit_id, 0)
   - è¦ªã¨ã®é–¢ä¿‚: è¦ªã®å…¨ç¥–å…ˆ + æ–°å˜ä½ã®é–¢ä¿‚ã‚’è¿½åŠ 
   â†“
   INSERT INTO organization_hierarchies
   SELECT ancestor_unit_id, new_unit_id, depth+1
   FROM organization_hierarchies
   WHERE descendant_unit_id = parent_unit_id
â†“
5. organization_units.member_count ã‚’åˆæœŸåŒ–ï¼ˆ0ï¼‰
â†“
6. BC-003.audit_logs ã«ãƒ­ã‚°è¨˜éŒ²
```

### 3. ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ãƒ•ãƒ­ãƒ¼ï¼ˆã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰

```
POST /api/bc-004/teams/{teamId}/members
â†“
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ç¢ºèªï¼ˆBC-003.usersï¼‰
â†“
2. æ—¢å­˜ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç‡å–å¾—
   SELECT SUM(allocation_rate)
   FROM team_members
   WHERE user_id = $1 AND status = 'active'
â†“
3. ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶ç´„ãƒã‚§ãƒƒã‚¯
   - æ–°è¦ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç‡: 0.0 â‰¤ rate â‰¤ 1.0
   - åˆè¨ˆã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç‡: total â‰¤ 2.0ï¼ˆ200%ï¼‰
   â†“
   ãƒˆãƒªã‚¬ãƒ¼: check_user_allocation_limit()
â†“
4. ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒãƒªã‚·ãƒ¼è©•ä¾¡
   - applicable policieså–å¾—
   - ãƒ«ãƒ¼ãƒ«è©•ä¾¡å®Ÿè¡Œ
   - violationæ¤œå‡ºæ™‚ã¯ã‚¨ãƒ©ãƒ¼è¿”å´ or è­¦å‘Š
â†“
5. team_members ãƒ†ãƒ¼ãƒ–ãƒ«ã«INSERT
â†“
6. teams.member_count ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆãƒˆãƒªã‚¬ãƒ¼ï¼‰
â†“
7. mv_user_allocation_summary ã‚’æ›´æ–°ï¼ˆéåŒæœŸï¼‰
â†“
8. BC-003.audit_logs ã«ãƒ­ã‚°è¨˜éŒ²
```

### 4. ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒãƒªã‚·ãƒ¼è©•ä¾¡ãƒ•ãƒ­ãƒ¼

```
POST /api/bc-004/governance/policies/evaluate
â†“
1. é©ç”¨å¯èƒ½ãƒãƒªã‚·ãƒ¼å–å¾—
   - organizationId, unitId, teamIdã‹ã‚‰å¯¾è±¡ã‚¹ã‚³ãƒ¼ãƒ—ç‰¹å®š
   - policy_scopes ãƒ†ãƒ¼ãƒ–ãƒ«ã§ãƒãƒƒãƒãƒ³ã‚°
   - includeDescendants=trueã®å ´åˆã¯éšå±¤è€ƒæ…®
â†“
2. å„ãƒãƒªã‚·ãƒ¼ã®ãƒ«ãƒ¼ãƒ«è©•ä¾¡
   FOR EACH policy IN applicable_policies:
     FOR EACH rule IN policy.rules:
       - conditionå¼ã‚’è©•ä¾¡ï¼ˆä¾‹: user.totalAllocationRate <= 2.0ï¼‰
       - contextæƒ…å ±ã‚’å¤‰æ•°ãƒã‚¤ãƒ³ãƒ‰
       - è©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³ã§çœŸå½åˆ¤å®š
       â†“
       IF ruleé•å:
         - violationè¨˜éŒ²ä½œæˆ
         - enforcement_levelã«å¿œã˜ãŸå‡¦ç†:
           * strict: ã‚¨ãƒ©ãƒ¼è¿”å´ï¼ˆæ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
           * warning: è­¦å‘Šè¿”å´ï¼ˆæ“ä½œã¯è¨±å¯ï¼‰
           * audit: ãƒ­ã‚°ã®ã¿ï¼ˆpolicy_violations INSERTï¼‰
â†“
3. è©•ä¾¡çµæœè¿”å´
   - allowed: true/false
   - violations: [...]
   - warnings: [...]
â†“
4. policy_violations ãƒ†ãƒ¼ãƒ–ãƒ«ã«INSERTï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
```

### 5. çµ„ç¹”å†ç·¨ãƒ•ãƒ­ãƒ¼ï¼ˆè¦ªå˜ä½å¤‰æ›´ï¼‰

```
PUT /api/bc-004/organizations/{orgId}/units/{unitId}/parent
â†“
1. å¾ªç’°å‚ç…§ãƒã‚§ãƒƒã‚¯
   - æ–°è¦ªãŒå¯¾è±¡å˜ä½ã®å­å­«ã§ãªã„ã“ã¨ã‚’ç¢ºèª
   - organization_hierarchies ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç¢ºèª
   â†“
   SELECT COUNT(*) FROM organization_hierarchies
   WHERE ancestor_unit_id = $unitId
     AND descendant_unit_id = $newParentUnitId
   -- çµæœãŒ0ã§ã‚ã‚‹ã“ã¨
â†“
2. æœ€å¤§éšå±¤æ·±åº¦ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§10éšå±¤ï¼‰
   - æ–°è¦ªã®éšå±¤ãƒ¬ãƒ™ãƒ« + å¯¾è±¡å˜ä½ã®å­å­«æœ€å¤§æ·±åº¦ â‰¤ 10
â†“
3. organization_hierarchies ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
   a. å¤ã„éšå±¤é–¢ä¿‚å‰Šé™¤ï¼ˆè‡ªå·±å‚ç…§ä»¥å¤–ï¼‰
   DELETE FROM organization_hierarchies
   WHERE descendant_unit_id IN (
     SELECT descendant_unit_id
     FROM organization_hierarchies
     WHERE ancestor_unit_id = $unitId
   )
   AND depth > 0

   b. æ–°ã—ã„éšå±¤é–¢ä¿‚æŒ¿å…¥
   INSERT INTO organization_hierarchies
   SELECT p.ancestor_unit_id, c.descendant_unit_id, p.depth+c.depth+1
   FROM organization_hierarchies p
   CROSS JOIN organization_hierarchies c
   WHERE p.descendant_unit_id = $newParentUnitId
     AND c.ancestor_unit_id = $unitId
â†“
4. organization_units ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
   - parent_unit_id, hierarchy_level, pathæ›´æ–°
   - å­å­«å˜ä½ã®pathä¸€æ‹¬æ›´æ–°
â†“
5. å½±éŸ¿ã‚’å—ã‘ãŸå˜ä½æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
â†“
6. BC-003.audit_logs ã«ãƒ­ã‚°è¨˜éŒ²
   - affectedDescendantCountè¨˜éŒ²
```

---

## BCé–“é€£æº {#bc-integration}

### BC-003ï¼ˆAccess Control & Securityï¼‰

**ä¾å­˜é–¢ä¿‚**: BC-004 â†’ BC-003

| BC-003ãƒ†ãƒ¼ãƒ–ãƒ« | BC-004ã§ã®åˆ©ç”¨ | èª¬æ˜ |
|---------------|--------------|------|
| `users` | `organization_members.user_id` | çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ |
| `users` | `team_members.user_id` | ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ |
| `audit_logs` | å…¨æ“ä½œ | ç›£æŸ»ãƒ­ã‚°è¨˜éŒ² |

**ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**:
```
BC-003.users â”€â”€â–º BC-004.organization_membersï¼ˆçµ„ç¹”æ‰€å±ï¼‰
BC-003.users â”€â”€â–º BC-004.team_membersï¼ˆãƒãƒ¼ãƒ æ‰€å±ï¼‰
BC-004.* â”€â”€â–º BC-003.audit_logsï¼ˆç›£æŸ»ãƒ­ã‚°ï¼‰
```

### BC-007ï¼ˆNotification Serviceï¼‰

**ä¾å­˜é–¢ä¿‚**: BC-004 â†’ BC-007

**ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡**:
- `OrganizationCreated`: çµ„ç¹”ä½œæˆæ™‚
- `OrganizationUnitCreated`: çµ„ç¹”å˜ä½ä½œæˆæ™‚
- `OrganizationRestructured`: çµ„ç¹”å†ç·¨æ™‚
- `TeamCreated`: ãƒãƒ¼ãƒ ä½œæˆæ™‚
- `TeamMemberAdded`: ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ æ™‚
- `GovernanceViolationDetected`: ã‚¬ãƒãƒŠãƒ³ã‚¹é•åæ¤œçŸ¥æ™‚

---

## è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ {#detailed-docs}

BC-004ãƒ‡ãƒ¼ã‚¿å±¤ã®è©³ç´°ã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„:

1. **[tables.md](tables.md)** - å…¨11ãƒ†ãƒ¼ãƒ–ãƒ«ã®è©³ç´°å®šç¾©
   - ã‚«ãƒ©ãƒ å®šç¾©ã€åˆ¶ç´„ã€ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«
   - æ¨å®šãƒ‡ãƒ¼ã‚¿é‡ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥

2. **[indexes-constraints.md](indexes-constraints.md)** - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨åˆ¶ç´„
   - å…¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾©ï¼ˆ80+ï¼‰
   - ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ï¼ˆ15+ï¼‰
   - CHECKåˆ¶ç´„ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„

3. **[query-patterns.md](query-patterns.md)** - ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³é›†
   - éšå±¤ã‚¯ã‚¨ãƒªï¼ˆç¥–å…ˆãƒ»å­å­«å–å¾—ï¼‰
   - ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³é›†è¨ˆ
   - ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒãƒªã‚·ãƒ¼è©•ä¾¡
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™ï¼ˆp95ï¼‰

4. **[backup-operations.md](backup-operations.md)** - é‹ç”¨ã¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
   - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥
   - ãƒªã‚¹ãƒˆã‚¢æ‰‹é †
   - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ç®¡ç†
   - ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼æ›´æ–°

---

**æœ€çµ‚æ›´æ–°**: 2025-11-03
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 2.3 - BC-004 ãƒ‡ãƒ¼ã‚¿å±¤è©³ç´°åŒ–
