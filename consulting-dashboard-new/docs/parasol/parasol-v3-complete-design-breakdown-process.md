# パラソルV3完全設計ブレークダウンプロセス

**作成日**: 2025-10-31
**バージョン**: 1.0.0
**目的**: パラソル開発における3層デザイン構造と設計ブレークダウンプロセスの完全な定義

---

## 🎯 3層デザイン構造の全体像

パラソル開発は、以下の**3つの独立したデザインレイヤー**で構成されます。各層は明確な責務を持ち、異なる担当者が異なる目的で設計を行います。

```
┌─────────────────────────────────────────────────────────┐
│ Layer 1: パラソル価値デザイン (Parasol Value Design)      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│
│ 焦点: ビジネス価値の定義                                  │
│ 担当: ビジネス部門、経営層                                │
│ 成果物:                                                 │
│   └─ バリューストリーム (Value Stream)                   │
│       └─ バリューステージ (Value Stage)                  │
│           └─ ケーパビリティL1 (戦略的組織能力)            │
└─────────────────────────────────────────────────────────┘
                        ↓ ブレークダウン
┌─────────────────────────────────────────────────────────┐
│ Layer 2: マイクロサービスデザイン (Microservice Design)    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│
│ 焦点: サービス境界とドメインモデル                        │
│ 担当: アーキテクト、ドメインエキスパート                   │
│ 成果物:                                                 │
│   └─ ケーパビリティL2 (戦術的組織能力) ← BC抽出基準      │
│       └─ バウンデッドコンテキスト (BC)                   │
│           ├─ パラソルドメイン言語                        │
│           ├─ API設計 (BC単位)                          │
│           ├─ DB設計 (BC単位)                           │
│           └─ サービス境界定義                           │
└─────────────────────────────────────────────────────────┘
                        ↓ ブレークダウン
┌─────────────────────────────────────────────────────────┐
│ Layer 3: パラソル開発設計 (Parasol Development Design)    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│
│ 焦点: 実装可能な詳細設計                                 │
│ 担当: アーキテクト、開発リーダー、エンジニア               │
│ 成果物:                                                 │
│   └─ L3 Capability (具体的業務能力)                     │
│       └─ Operation (業務操作)                          │
│           └─ UseCase (ユースケース)                    │
│               ├─ Page定義                              │
│               ├─ API実装仕様                           │
│               └─ テスト仕様                            │
└─────────────────────────────────────────────────────────┘
                        ↓ 実装
                    ソースコード
```

---

## 📐 Layer 1: パラソル価値デザイン

### 1.1 目的と責務

**目的**: ビジネス価値を中心とした戦略的設計

**責務**:
- 顧客への価値提供の流れを定義
- 価値創造の各段階を特定
- 組織の戦略的能力を明確化

**重要原則**:
- 技術的な制約を考慮しない
- ビジネス価値のみに焦点を当てる
- 実装方法には言及しない

### 1.2 構成要素

#### バリューストリーム (Value Stream)

**定義**: 顧客への価値提供の流れ全体

**記述内容**:
```markdown
# バリューストリーム: [価値の流れの名前]

## ビジネス価値
- 顧客に提供する価値
- 競合優位性
- 成功指標 (KVI)

## ステークホルダー
- 誰に価値を提供するか
- 各ステークホルダーが得る価値

## 価値指標
- 測定可能な成果指標
```

**例**:
```markdown
# バリューストリーム: DXプロジェクト成功支援

## ビジネス価値
- 顧客価値: プロジェクト成功率を30%向上
- 競合優位性: AI支援による計画最適化
- KVI: プロジェクト成功率、ROI

## ステークホルダー
- プロジェクトマネージャー: 計画精度向上
- 経営層: 投資対効果の可視化
- 現場メンバー: タスク明確化による生産性向上
```

#### バリューステージ (Value Stage)

**定義**: 価値創造の各段階（スイムレーンとして機能）

**記述内容**:
```markdown
# バリューステージ: [段階の名前]

## 段階の目的
- この段階で創造する価値

## 入力
- 前段階からの入力

## 出力
- 次段階への出力

## KPI
- この段階の成功指標

## 関連ケーパビリティL1
- この段階で必要な組織能力
```

**例**:
```markdown
# バリューステージ: プロジェクト計画支援

## 段階の目的
プロジェクトの実行計画を策定し、成功確率を高める

## 入力
- プロジェクト構想
- 目標設定

## 出力
- 詳細プロジェクト計画
- WBS、スケジュール、リソース配分

## KPI
- 計画策定時間: 50%削減
- 計画精度: 80%以上

## 関連ケーパビリティL1
- プロジェクト構想する能力
- 計画を策定する能力
```

#### ケーパビリティL1 (戦略的組織能力)

**定義**: 組織の戦略的な能力

**記述内容**:
```markdown
# ケーパビリティL1: [能力の名前]

## 能力の定義
- 何を実現する能力か

## ビジネス価値
- この能力が提供する価値

## 成熟度目標
- Level 1-5 のどこを目指すか

## L2分解戦略
- どのようにL2に分解するか
```

**例**:
```markdown
# ケーパビリティL1: プロジェクト構想する能力

## 能力の定義
プロジェクトのゴール、スコープ、制約条件を明確化し、
実現可能な計画の基盤を構築する能力

## ビジネス価値
- プロジェクト開始時の方向性明確化
- ステークホルダー合意形成
- リスクの早期発見

## 成熟度目標
Level 4 (Quantitatively Managed)

## L2分解戦略
- 計画策定の各側面（スコープ、時間、リソース）に分解
- ステークホルダー管理側面に分解
```

### 1.3 パラソルドメイン言語の状態

**Layer 1完了時のドメイン言語の状態**: 5-20%

```markdown
## 初期ドメイン概念

### ビジネス用語の定義
- プロジェクト: ビジネス目標を達成するための一時的な取り組み
- タスク: プロジェクトを構成する作業単位
- メンバー: プロジェクトに参加する人

### 初期エンティティ候補
- プロジェクト
- タスク
- メンバー
- スケジュール

（詳細な属性、ビジネスルール等は未定義）
```

### 1.4 成果物テンプレート

**ディレクトリ構造**:
```
docs/parasol/1-VALUE-DESIGN/
├── value-streams/
│   └── [value-stream-name]/
│       ├── value-stream.md
│       └── value-stages/
│           └── [stage-name]/
│               ├── stage.md
│               └── l1-capabilities/
│                   └── [l1-name]/
│                       └── l1-capability.md
└── domain-concepts/
    └── initial-ubiquitous-language.md  # 初期ユビキタス言語
```

### 1.5 担当者と責任

| 役割 | 責任 | 成果物承認 |
|------|------|----------|
| **経営層** | バリューストリーム定義 | 最終承認 |
| **事業部長** | バリューステージ特定 | 承認 |
| **部門長** | ケーパビリティL1特定 | レビュー |
| **ビジネスアナリスト** | ドキュメント作成 | - |

---

## 🏗️ Layer 2: マイクロサービスデザイン

### 2.1 目的と責務

**目的**: サービス境界の確定とドメインモデルの設計

**責務**:
- ケーパビリティL2の特定（BC抽出の基準）
- バウンデッドコンテキスト（BC）の境界確定
- パラソルドメイン言語の定義
- サービス間の統合パターン設計

**重要原則**:
- ビジネス価値を理解した上で技術的境界を設計
- 実装技術には依存しない
- ドメイン駆動設計（DDD）の原則を適用

### 2.2 構成要素

#### ケーパビリティL2 (戦術的組織能力)

**定義**: BC抽出の基準となる中分類の組織能力

**記述内容**:
```markdown
# ケーパビリティL2: [能力の名前]

## 能力の定義
L1のどの側面を実現する能力か

## 機能概要
具体的に何を実現するか

## BC抽出方針
- この能力をどのBCに割り当てるか
- 1つのBCにするか、複数に分割するか

## L3分解
この能力を実現する具体的な業務能力（L3）のリスト
```

**例**:
```markdown
# ケーパビリティL2: 計画を策定する能力

## 能力の定義
プロジェクト構想（L1）を実現するための、
具体的な計画（WBS、スケジュール、リソース配分）を策定する能力

## 機能概要
- プロジェクトをタスクに分解
- スケジュールを作成
- リソースを配分
- 依存関係を管理

## BC抽出方針
BC-004: プロジェクト計画BC として統合
（計画策定に必要な全機能を1つのBCに集約）

## L3分解
- L3-1: WBS作成能力
- L3-2: スケジュール策定能力
- L3-3: リソース配分能力
- L3-4: 依存関係管理能力
- L3-5: マイルストーン設定能力
```

#### バウンデッドコンテキスト (BC)

**定義**: ドメインモデルの一貫性境界、トランザクション境界

**BC設計の3つの成果物**:

##### (1) BC定義とビジネス価値

```markdown
# Bounded Context: [BC名]

**BC-ID**: BC-XXX
**導出元L2**: [ケーパビリティL2名]

## Why: ビジネス価値

### L2からの導出
- 元となったケーパビリティL2
- ビジネス課題
- 提供価値

### BC境界の根拠
- なぜこの境界にしたか
- トランザクション整合性の要件
- チーム責任範囲

## What: 提供機能

### 含まれるL3 Capability
このBCに含まれるL3能力のリスト

### ビジネスオペレーション
BC内の主要なビジネスプロセス

## How: 実現方法（概要）

### BC統合戦略
他のBCとの連携方法

### サービス実装方針
1 BC = 1 MS か、複数MSか
```

##### (2) パラソルドメイン言語 (BC単位で定義・共有)

```markdown
# パラソルドメイン言語: [BC名]

## エンティティ定義

### [エンティティ名] [English Name] [SYSTEM_NAME]

**定義**: エンティティの説明

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 一意識別子 |
| name | STRING_100 | ○ | 名称 |
| status | ENUM | ○ | 状態 |

#### ビジネスルール
- ルール1
- ルール2

#### ドメインイベント
- イベント名 [EventName]: 発生タイミング

## 値オブジェクト定義

### [値オブジェクト名] [ValueObject Name] [SYSTEM_NAME]

**定義**: 値オブジェクトの説明

**属性**:
- 属性1: 型 - 説明
- 属性2: 型 - 説明

**制約**:
- 制約1
- 制約2

## 集約定義

### [集約名] Aggregate

- **集約ルート**: [エンティティ名]
- **含まれるエンティティ**:
  - エンティティ1（関係）
  - エンティティ2（関係）
- **トランザクション境界**: BC内での整合性保証範囲
- **不変条件**:
  - 条件1
  - 条件2

## ドメインサービス

### [サービス名] Domain Service

**責務**: BC内の複雑なビジネスロジック

**提供機能**:
- 機能1: 説明
- 機能2: 説明

## リポジトリインターフェース

### [リポジトリ名] Repository

- findById(id: UUID): Entity
- save(entity: Entity): void
- findBy[Criteria](): Entity[]
```

##### (3) BC統合設計 (API・DB・統合パターン)

```markdown
# BC統合設計: [BC名]

## API設計（BC単位で共有）

### エンドポイント設計

**ベースURL**: `/api/bc/[bc-name]`

#### L3別エンドポイント

**L3: [L3能力名]**
- `POST /api/bc/[bc-name]/[resource]` - [操作]
- `GET /api/bc/[bc-name]/[resource]/{id}` - [操作]
- `PUT /api/bc/[bc-name]/[resource]/{id}` - [操作]

### リクエスト/レスポンススキーマ
パラソルドメイン言語に基づく型定義

## DB設計（BC単位で共有）

### BCスキーマ設計

```sql
-- BC: [BC名]のスキーマ
CREATE SCHEMA bc_[bc_name];

-- BC集約ルートテーブル
CREATE TABLE bc_[bc_name].[aggregate_root] (
  id UUID PRIMARY KEY,
  -- BC固有のビジネスデータ
  aggregate_version INTEGER NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- L3固有テーブル
CREATE TABLE bc_[bc_name].[l3_entity] (
  id UUID PRIMARY KEY,
  aggregate_id UUID REFERENCES bc_[bc_name].[aggregate_root](id),
  -- L3固有データ
);
```

### BC間データアクセス原則
- BC内: トランザクション整合性
- BC間: 結果整合性（API経由のみ）
- 外部キー制約: BC内のみ許可

## BC間統合パターン

### コンテキストマップ

```
[このBC] --関係パターン--> [他のBC]

例:
[Project Planning BC] --Customer/Supplier--> [Auth BC]
[Project Planning BC] --Partnership--> [Knowledge BC]
```

### 統合パターン詳細

| 連携先BC | パターン | 実装方法 | 理由 |
|---------|---------|---------|------|
| BC-XXX | Customer/Supplier | REST API | 認証が必須 |
| BC-YYY | Partnership | REST + Event | 双方向連携 |
| BC-ZZZ | Anti-Corruption Layer | Adapter | レガシー統合 |
```

### 2.3 パラソルドメイン言語の状態

**Layer 2完了時のドメイン言語の状態**: 60-80%

```markdown
## 詳細ドメインモデル

### エンティティ定義（完全）
プロジェクト [Project] [PROJECT]
├─ プロジェクトID [ProjectID] [PROJECT_ID]: UUID
├─ プロジェクト名 [ProjectName] [PROJECT_NAME]: STRING_100
├─ 状態 [Status] [STATUS]: ENUM（計画中/実行中/完了/中止）
├─ 開始日 [StartDate] [START_DATE]: DATE
├─ 終了日 [EndDate] [END_DATE]: DATE
└─ 作成日時 [CreatedAt] [CREATED_AT]: TIMESTAMP

### 集約定義
プロジェクト集約 [ProjectAggregate]
├─ 集約ルート: プロジェクト [Project]
├─ 包含エンティティ: タスク [Task]（1..*）
└─ 不変条件:
   - 終了日 > 開始日
   - 全タスク完了時のみプロジェクト完了可能

### ビジネスルール
1. プロジェクト名は重複不可
2. 完了したプロジェクトは変更不可
3. タスクは必ずプロジェクトに属する

### ドメインイベント
- プロジェクト作成済み [ProjectCreated]
- プロジェクト開始済み [ProjectStarted]
- プロジェクト完了済み [ProjectCompleted]

（バリデーションルール、エラーパターンは次のLayerで詳細化）
```

### 2.4 成果物テンプレート

**ディレクトリ構造**:
```
docs/parasol/2-MICROSERVICE-DESIGN/
├── capabilities/
│   └── [l1-capability-name]/
│       └── l2-capabilities/
│           └── [l2-capability-name]/
│               └── l2-capability.md
│
└── bounded-contexts/
    ├── bc-catalog.md               # BC全体カタログ
    ├── context-map.md              # BC間関係図
    │
    └── [bc-name]/
        ├── README.md               # BC定義（Why-What-How）
        ├── domain/
        │   ├── domain-language.md  # パラソルドメイン言語
        │   ├── ubiquitous-language.md
        │   └── bounded-context.md
        ├── api/
        │   ├── api-specification.md
        │   └── endpoints/
        ├── data/
        │   ├── database-design.md
        │   └── schemas/
        └── integration/
            ├── integration-map.md  # BC間連携
            └── contracts/
```

### 2.5 担当者と責任

| 役割 | 責任 | 成果物承認 |
|------|------|----------|
| **ドメインエキスパート** | ドメイン言語定義、ビジネスルール | 最終承認 |
| **アーキテクト** | BC境界設計、統合パターン設計 | 最終承認 |
| **部門長** | ケーパビリティL2特定 | レビュー |
| **データアーキテクト** | DB設計 | 承認 |

---

## 💻 Layer 3: パラソル開発設計

### 3.1 目的と責務

**目的**: 実装可能な詳細設計

**責務**:
- L3 Capabilityの特定
- Operationの詳細設計
- UseCaseへの分解
- Page/API実装仕様の作成

**重要原則**:
- BC内でドメイン言語を使用
- 実装可能なレベルまで詳細化
- テスト可能な粒度に分解

### 3.2 構成要素

#### L3 Capability (具体的業務能力)

**定義**: BC内の具体的な業務能力（Operation群を包含）

**記述内容**:
```markdown
# L3 Capability: [能力の名前]

**L3-ID**: L3-BC[XXX]-[YYY]
**所属BC**: BC-XXX
**所属L2**: ケーパビリティL2名

## 能力の定義
何を実現する能力か

## 含まれるOperation
このL3に含まれるOperation（2-4個程度）

## 使用するBCドメイン
このL3が使用するエンティティ・集約

## 成果物
この能力により生成される成果物
```

#### Operation (業務操作)

**定義**: 1つの明確なビジネスオペレーション

**記述内容**:
```markdown
# Operation: [操作の名前]

**Operation-ID**: OP-BC[XXX]-L3[YYY]-[ZZZ]
**所属BC**: BC-XXX
**所属L3**: L3-YYY

## 操作の定義
何をする操作か（アクション指向）

## ビジネス価値
この操作が提供する価値

## 使用するBCドメイン言語

### 集約
- 使用する集約名

### エンティティ
- 操作対象のエンティティ

### ドメインサービス
- 利用するドメインサービス

## 使用するBC API
この操作で呼び出すAPIエンドポイント

## 使用するBC DB
この操作で読み書きするテーブル

## UseCase分解

| UC# | ユースケース名 | 対応ページ | アクター | 優先度 |
|-----|---------------|-----------|----------|--------|
| UC-1 | [ユースケース1] | [ページ1] | [アクター] | 高 |
| UC-2 | [ユースケース2] | [ページ2] | [アクター] | 中 |
```

#### UseCase (ユースケース)

**定義**: エンドユーザーの1つの具体的な活動（1:1でPageに対応）

**記述内容**:
```markdown
# UseCase: [ユースケース名]

**UC-ID**: UC-BC[XXX]-OP[YYY]-[ZZZ]
**所属Operation**: OP-YYY

## ユースケース概要

### 目的
ユーザーが達成したいゴール

### アクター
- 主アクター: [役割]
- 副アクター: [役割]

### 事前条件
- 条件1
- 条件2

### 事後条件（成功時）
- 結果1
- 結果2

## 基本フロー

1. ユーザーは[アクション]
2. システムは[処理]
3. システムは[表示]
4. ...

## 代替フロー

### A1: [代替シナリオ]
- 条件: [条件]
- フロー: ...

## 例外フロー

### E1: [エラーシナリオ]
- 条件: [エラー条件]
- 処理: [エラー処理]

## 使用するドメイン言語

### 入力データ
- エンティティ: [Entity]
  - 属性1: 型
  - 属性2: 型

### 出力データ
- エンティティ: [Entity]

### ビジネスルール適用
- 適用するルール1
- 適用するルール2

## 対応ページ
[Page名]（1:1対応）
```

#### Page定義

**定義**: ユースケースを実現する画面（UseCaseと1:1）

**記述内容**:
```markdown
# Page: [ページの目的を表す名前]

**Page-ID**: PAGE-UC[XXX]
**対応UseCase**: UC-XXX（1:1）

## 画面の目的
この画面で達成したいビジネス目的

## 利用者
- **主要利用者**: [役割] - [利用目的]
- **副次利用者**: [役割] - [利用目的]

## 画面構成

### [エリア名1]
- 表示項目や機能の説明
- 使用するドメインエンティティ

### [エリア名2]
- 表示項目や機能の説明

## 画面の振る舞い

### ユーザー操作
- 操作1: [説明]
- 操作2: [説明]

### ビジネスルールに基づく制御
- ルール1適用時: [画面の振る舞い]
- ルール2適用時: [画面の振る舞い]

## API連携

### 呼び出すAPI
- `POST /api/bc/[bc-name]/[resource]`
  - リクエスト: [パラソルドメインエンティティ]
  - レスポンス: [パラソルドメインエンティティ]

## バリデーションルール
- フィールド1: [ルール]
- フィールド2: [ルール]

## エラー表示
- エラーコード1001: [表示メッセージ]
- エラーコード1002: [表示メッセージ]
```

### 3.3 パラソルドメイン言語の状態

**Layer 3完了時のドメイン言語の状態**: 95-100%（実装可能レベル）

```markdown
## 実装可能ドメインモデル

### エンティティ定義（完全 + バリデーション）
プロジェクト [Project] [PROJECT]
├─ プロジェクトID [ProjectID] [PROJECT_ID]: UUID
│   └─ バリデーション: UUID v4形式、必須
├─ プロジェクト名 [ProjectName] [PROJECT_NAME]: STRING_100
│   └─ バリデーション: 1-100文字、必須、重複不可
├─ 状態 [Status] [STATUS]: ENUM（draft/active/completed/cancelled）
│   └─ バリデーション: 定義された値のみ
├─ 開始日 [StartDate] [START_DATE]: DATE
│   └─ バリデーション: YYYY-MM-DD形式、必須
├─ 終了日 [EndDate] [END_DATE]: DATE
│   └─ バリデーション: YYYY-MM-DD形式、開始日より後、必須
└─ 作成日時 [CreatedAt] [CREATED_AT]: TIMESTAMP
    └─ バリデーション: ISO8601形式、自動設定

### ビジネスルール（完全）
1. プロジェクト名は組織内で重複不可
2. 開始日 < 終了日 であること
3. status = 'completed' の場合、すべてのタスクがcompleted
4. status = 'cancelled' の場合、変更操作は不可
5. メンバーは最低1名必要

### 状態遷移
draft → active → completed
         ↓
      cancelled

### エラーパターン
- 1001: プロジェクト名重複エラー
  - メッセージ: "このプロジェクト名は既に使用されています"
- 1002: 期間不正エラー
  - メッセージ: "終了日は開始日より後に設定してください"
- 1003: メンバー不足エラー
  - メッセージ: "プロジェクトには最低1名のメンバーが必要です"

### API入出力スキーマ
（完全に定義されている）
```

### 3.4 成果物テンプレート

**ディレクトリ構造**:
```
docs/parasol/3-DEVELOPMENT-DESIGN/
└── bounded-contexts/
    └── [bc-name]/
        └── l3-capabilities/
            └── [l3-capability-name]/
                ├── l3-capability.md
                │
                └── operations/
                    └── [operation-name]/
                        ├── operation.md
                        │
                        └── usecases/
                            └── [usecase-name]/
                                ├── usecase.md
                                ├── page.md
                                └── tests/
                                    └── test-scenarios.md
```

### 3.5 担当者と責任

| 役割 | 責任 | 成果物承認 |
|------|------|----------|
| **開発リーダー** | L3/Operation設計、UseCase分解 | 最終承認 |
| **アーキテクト** | 全体整合性確認 | レビュー |
| **エンジニア** | Page/API詳細設計、テスト仕様 | 作成 |
| **ドメインエキスパート** | ビジネスルール確認 | レビュー |

---

## 🔄 パラソルドメイン言語の進化プロセス

### 進化の全体像

```
Layer 1: 価値デザイン (5-20%)
    ↓ ドメイン言語の初期化
    【成果物】
    - 初期ユビキタス言語
    - 主要なビジネス概念リスト
    - エンティティ候補

Layer 2: MSデザイン (60-80%)
    ↓ ドメイン言語の詳細化
    【成果物】
    - エンティティ定義（完全）
    - 集約定義
    - ビジネスルール
    - ドメインイベント
    - ドメインサービス

Layer 3: 開発設計 (95-100%)
    ↓ ドメイン言語の実装準備
    【成果物】
    - バリデーションルール
    - 状態遷移定義
    - エラーパターン
    - API入出力スキーマ

実装フィードバック
    ↓ ドメイン言語の修正
    【フィードバック内容】
    - 実装時の気づき
    - パフォーマンス要件
    - 新しいユースケース
```

### Layer間のドメイン言語引継ぎ

#### Layer 1 → Layer 2

**引き継がれる内容**:
```markdown
# 初期ユビキタス言語（Layer 1成果物）

## ビジネス用語
- プロジェクト: ビジネス目標を達成するための一時的な取り組み
- タスク: プロジェクトを構成する作業単位
- WBS: Work Breakdown Structure、タスクの階層構造

## エンティティ候補
- プロジェクト
- タスク
- メンバー
- スケジュール
- マイルストーン
```

**Layer 2での詳細化**:
```markdown
# パラソルドメイン言語（Layer 2成果物）

## エンティティ定義

### プロジェクト [Project] [PROJECT]
（Layer 1の「プロジェクト」概念を詳細化）

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | プロジェクトID |
| name | STRING_100 | ○ | プロジェクト名 |
| description | TEXT | - | 説明 |
| status | ENUM | ○ | 状態（draft/active/completed/cancelled） |
| startDate | DATE | ○ | 開始日 |
| endDate | DATE | ○ | 終了日 |

#### ビジネスルール
- 終了日 > 開始日
- 完了プロジェクトは変更不可

### タスク [Task] [TASK]
（Layer 1の「タスク」概念を詳細化）
...

## 集約定義
プロジェクト集約 [ProjectAggregate]
├─ 集約ルート: プロジェクト
└─ 含まれるエンティティ: タスク（1..*）
```

#### Layer 2 → Layer 3

**引き継がれる内容**:
```markdown
# BC: プロジェクト計画BC のパラソルドメイン言語（Layer 2成果物）

## エンティティ、集約、ビジネスルール（完全定義済み）
（Layer 3ではこれをそのまま使用）
```

**Layer 3での追加**:
```markdown
# パラソルドメイン言語の実装詳細（Layer 3追加分）

## バリデーションルール

### プロジェクト [Project]
- プロジェクト名 [ProjectName]:
  - 文字数: 1-100文字
  - 形式: 英数字、日本語、記号（-_）のみ
  - 重複チェック: 組織内で一意
  - エラーコード: 1001

- 開始日 [StartDate]:
  - 形式: YYYY-MM-DD
  - 範囲: 現在日以降
  - エラーコード: 1002

- 終了日 [EndDate]:
  - 形式: YYYY-MM-DD
  - 範囲: 開始日より後
  - エラーコード: 1003

## 状態遷移

draft → active → completed
         ↓
      cancelled

遷移条件:
- draft → active: メンバーが1名以上、タスクが1つ以上
- active → completed: すべてのタスクがcompleted
- active → cancelled: 理由（cancellationReason）が必須

## エラーパターン

| コード | 名称 | メッセージ | HTTPステータス |
|--------|------|-----------|---------------|
| 1001 | プロジェクト名重複 | "このプロジェクト名は既に使用されています" | 409 |
| 1002 | 開始日不正 | "開始日は現在日以降に設定してください" | 400 |
| 1003 | 終了日不正 | "終了日は開始日より後に設定してください" | 400 |
| 1004 | メンバー不足 | "プロジェクトには最低1名のメンバーが必要です" | 400 |
```

### ドメイン言語の修正トリガーと対応フロー

#### トリガー1: 新しいユースケースの発見

**発生フェーズ**: Layer 3（UseCase設計時）

**例**:
```
UseCase設計中に気づき:
「プロジェクトをテンプレートから作成する」ユースケースが必要
→ しかし、プロジェクトエンティティに「テンプレートID」属性がない
```

**対応フロー**:
```
1. Layer 3で発見
   └─ UseCase設計者が属性不足に気づく

2. Layer 2へフィードバック
   └─ ドメインエキスパートと協議
   └─ ビジネス的に妥当か確認

3. ドメイン言語修正（Layer 2）
   └─ プロジェクトエンティティに追加:
       templateId: UUID（任意）

4. Layer 3へ反映
   └─ UseCase設計を継続
   └─ API仕様にtemplateIdを追加
```

**更新ドキュメント**:
- Layer 2: `domain-language.md` を修正（バージョンアップ）
- Layer 3: `usecase.md`、`page.md` を更新

#### トリガー2: API設計での型の不一致

**発生フェーズ**: Layer 3（API仕様設計時）

**例**:
```
API設計中に気づき:
リクエストで「プロジェクト期間」をまとめて扱いたい
→ しかし、ドメイン言語に「プロジェクト期間」値オブジェクトがない
```

**対応フロー**:
```
1. Layer 3で発見
   └─ API設計者が値オブジェクト不足に気づく

2. Layer 2へフィードバック
   └─ 値オブジェクト抽出の提案

3. ドメイン言語拡張（Layer 2）
   └─ 値オブジェクト追加:
       プロジェクト期間 [ProjectDuration] [PROJECT_DURATION]
       ├─ 開始日 [startDate] [START_DATE]: DATE
       ├─ 終了日 [endDate] [END_DATE]: DATE
       └─ 期間日数 [durationDays] [DURATION_DAYS]: INTEGER

4. Layer 3へ反映
   └─ API仕様でProjectDuration型を使用
```

**更新ドキュメント**:
- Layer 2: `domain-language.md` に値オブジェクト追加
- Layer 3: `api-specification.md` を更新

#### トリガー3: ビジネスルールの追加要求

**発生フェーズ**: Layer 3（UseCase設計時）またはLayer 2

**例**:
```
ビジネス部門からの要求:
「プロジェクト期間は最大2年まで」というルールを追加したい
```

**対応フロー**:
```
1. ビジネス要求の受領
   └─ ドメインエキスパートが要求を確認

2. Layer 2でビジネスルール追加
   └─ domain-language.md に追加:
       ビジネスルール:
       - プロジェクト期間は最大730日（2年）

3. Layer 3へ反映
   └─ バリデーションルール追加:
       - 終了日 - 開始日 <= 730日
       - エラーコード: 1010
       - エラーメッセージ: "プロジェクト期間は最大2年までです"

4. UseCase/Page更新
   └─ エラー表示処理を追加
```

**更新ドキュメント**:
- Layer 2: `domain-language.md` のビジネスルール追加
- Layer 3: `operation.md`、`usecase.md`、`page.md` を更新

#### トリガー4: 実装時のパフォーマンス問題

**発生フェーズ**: 実装後

**例**:
```
実装・負荷テスト後の発見:
プロジェクト集約にタスクが1000件含まれるとメモリ不足
→ 集約境界の見直しが必要
```

**対応フロー**:
```
1. 実装チームから報告
   └─ パフォーマンス問題の詳細を報告

2. アーキテクトとドメインエキスパートで協議
   └─ 集約境界の再設計が必要か判断

3. Layer 2へ戻って修正
   └─ 集約定義を変更:
       【変更前】
       プロジェクト集約
       └─ タスク（1..*を含む）

       【変更後】
       プロジェクト集約
       └─ タスク参照（IDのみ保持）

       タスク集約（別集約として分離）

4. Layer 2 API/DB設計も修正
   └─ API: タスク取得APIを分離
   └─ DB: タスクテーブルのクエリ最適化

5. Layer 3へ反映
   └─ UseCase: タスク取得処理を別APIコールに変更
   └─ Page: ページング処理を追加

6. 実装修正
   └─ コード修正、再テスト
```

**更新ドキュメント**:
- Layer 2: `domain-language.md` の集約定義、`api-specification.md`、`database-design.md`
- Layer 3: 影響を受ける `operation.md`、`usecase.md`、`page.md`
- 実装: ソースコード修正

### ドメイン言語のバージョン管理

#### セマンティックバージョニング

```
[MAJOR].[MINOR].[PATCH]

例: 1.2.3

MAJOR: 破壊的変更
  - エンティティの削除
  - 属性の削除
  - ビジネスルールの根本的変更
  - 集約境界の大幅な変更

MINOR: 機能追加
  - 新しいエンティティの追加
  - 属性の追加（既存に影響なし）
  - 新しいビジネスルールの追加
  - 値オブジェクトの追加

PATCH: バグ修正、明確化
  - バリデーションルールの修正
  - エラーメッセージの修正
  - ドキュメントの明確化
```

#### 変更履歴の記録

**domain-language.md のヘッダー**:
```markdown
# パラソルドメイン言語: プロジェクト計画BC

**バージョン**: 1.3.2
**最終更新**: 2025-10-31
**BC-ID**: BC-004

## 変更履歴

| バージョン | 日付 | 変更内容 | 変更理由 | 影響範囲 |
|-----------|------|---------|---------|---------|
| 1.3.2 | 2025-10-31 | バリデーションルール修正（プロジェクト名） | エラーメッセージ改善 | Layer 3のみ |
| 1.3.1 | 2025-10-30 | エラーコード1010追加 | 期間制限ビジネスルール追加 | Layer 3 |
| 1.3.0 | 2025-10-25 | 値オブジェクト追加（ProjectDuration） | API設計での要求 | Layer 2, 3 |
| 1.2.0 | 2025-10-20 | 属性追加（templateId） | 新UseCase対応 | Layer 2, 3 |
| 1.1.0 | 2025-10-15 | ビジネスルール追加 | ビジネス要求 | Layer 2, 3 |
| 1.0.0 | 2025-10-10 | 初版 | BC設計完了 | - |
```

---

## 🎯 実践ガイド

### 設計ブレークダウンの実施手順

#### Step 1: Layer 1（パラソル価値デザイン）の実施

**期間**: 1-2週間

**参加者**:
- 経営層（バリューストリーム承認）
- 事業部長（バリューステージ特定）
- 部門長（ケーパビリティL1特定）
- ビジネスアナリスト（ファシリテーション）

**ワークショップ形式**:
```
Day 1-2: バリューストリーム定義
- 顧客への価値提供の流れを明確化
- ステークホルダーマッピング
- KVI（Key Value Indicator）設定

Day 3-5: バリューステージ分解
- 価値創造の各段階を特定
- 各段階の入出力を明確化
- KPI設定

Day 6-10: ケーパビリティL1特定
- 各バリューステージに必要な組織能力を抽出
- L1能力の定義と成熟度目標設定
- 初期ユビキタス言語の作成
```

**成果物チェックリスト**:
- [ ] バリューストリーム定義書
- [ ] バリューステージ定義書（全ステージ）
- [ ] ケーパビリティL1定義書（全L1）
- [ ] 初期ユビキタス言語
- [ ] 経営層承認

#### Step 2: Layer 2（マイクロサービスデザイン）の実施

**期間**: 3-4週間

**参加者**:
- アーキテクト（BC設計リード）
- ドメインエキスパート（ドメイン言語定義）
- データアーキテクト（DB設計）
- 部門長（ケーパビリティL2レビュー）

**作業フロー**:
```
Week 1: ケーパビリティL2特定とBC抽出
- L1を分解してL2を特定
- L2からBC候補を抽出
- BC境界の決定（トランザクション境界、チーム境界）
- BCカタログ作成

Week 2: パラソルドメイン言語定義
- BC単位でドメインモデリングワークショップ
- エンティティ、値オブジェクト、集約の定義
- ビジネスルールの抽出
- ドメインイベントの特定
- ドメインサービスの設計

Week 3: BC統合設計
- BC単位のAPI設計
- BC単位のDB設計
- BC間統合パターン設計
- コンテキストマップ作成

Week 4: レビューと承認
- ドメインエキスパートレビュー
- アーキテクチャレビュー
- BC設計の承認
```

**成果物チェックリスト**:
- [ ] ケーパビリティL2定義書（全L2）
- [ ] BCカタログ
- [ ] コンテキストマップ
- [ ] BC定義書（全BC）
- [ ] パラソルドメイン言語（全BC）
- [ ] BC API仕様（全BC）
- [ ] BC DB設計（全BC）
- [ ] BC間統合設計
- [ ] ドメインエキスパート承認
- [ ] アーキテクト承認

#### Step 3: Layer 3（パラソル開発設計）の実施

**期間**: 4-6週間（BC単位で並行実施可能）

**参加者**:
- 開発リーダー（L3/Operation設計）
- エンジニア（UseCase/Page設計）
- アーキテクト（全体整合性確認）
- ドメインエキスパート（ビジネスルールレビュー）

**作業フロー**:
```
Week 1-2: L3 Capability と Operation設計
- L2をL3に分解
- BC内のL3リスト作成
- 各L3に含まれるOperation特定
- Operation定義書作成
  - 使用するBCドメイン言語の明確化
  - 使用するBC API/DBの明確化

Week 3-4: UseCase分解
- OperationからUseCaseへ分解
- UseCase定義書作成
  - 基本フロー、代替フロー、例外フロー
  - 使用するドメインエンティティの明確化
  - ビジネスルール適用の明確化

Week 5: Page/API詳細設計
- Page定義書作成（UseCaseと1:1）
- API実装仕様の詳細化
- バリデーションルール追加
- エラーパターン定義

Week 6: レビューと実装準備
- 全体レビュー
- ドメイン言語の最終調整
- 実装タスクの洗い出し
```

**成果物チェックリスト**:
- [ ] L3 Capability定義書（全L3）
- [ ] Operation定義書（全Operation）
- [ ] UseCase定義書（全UseCase）
- [ ] Page定義書（全Page）
- [ ] API実装仕様（詳細版）
- [ ] テスト仕様書
- [ ] パラソルドメイン言語（実装可能版、95-100%）
- [ ] 開発リーダー承認
- [ ] アーキテクト承認

### 継続的改善のプロセス

#### 定期レビューサイクル

```
2週間ごと: Layer 3レビュー
- 実装フィードバックの収集
- ドメイン言語の修正必要性確認
- UseCase/Pageの調整

1ヶ月ごと: Layer 2レビュー
- BC境界の妥当性確認
- ドメイン言語の整合性確認
- BC間統合パターンの見直し

3ヶ月ごと: Layer 1レビュー
- ビジネス価値の再確認
- ケーパビリティL1の見直し
- バリューステージの調整
```

#### フィードバックループの記録

**テンプレート**: `feedback-log.md`

```markdown
# フィードバックログ

| 日付 | 発見者 | トリガー | 内容 | 影響Layer | 対応状況 |
|------|--------|---------|------|-----------|---------|
| 2025-10-31 | エンジニアA | 実装時 | プロジェクト期間の最大値制限が必要 | Layer 2, 3 | 対応済 |
| 2025-10-30 | ドメインエキスパートB | ビジネス要求 | テンプレート機能追加 | Layer 2, 3 | 対応中 |
| 2025-10-28 | アーキテクトC | パフォーマンステスト | タスク集約の分離が必要 | Layer 2, 3 | 検討中 |
```

---

## 📚 関連ドキュメント

### Layer 1: パラソル価値デザイン関連
- `VALUE_STREAM_MAP.md` - バリューストリームマップ
- `CAPABILITY_MAP.md` - ケーパビリティ階層図

### Layer 2: マイクロサービスデザイン関連
- `bc-catalog.md` - BCカタログ
- `context-map.md` - コンテキストマップ
- `domain-language-spec.md` - パラソルドメイン言語仕様
- `PARASOL_VALUESTREAM_BC_STRUCTURE_PROPOSAL.md` - BC構造提案

### Layer 3: パラソル開発設計関連
- `parasol-design-process-guide.md` - パラソル設計プロセスガイド
- `business-operation-spec.md` - ビジネスオペレーション仕様
- `use-case-spec.md` - ユースケース仕様

### 全般
- `PARASOL_DEVELOPMENT_GUIDE.md` - パラソル開発ガイド（全体）
- `PARASOL_GUIDE_SUMMARY.md` - パラソルガイド要約

---

## ✅ 品質チェックリスト

### Layer 1完了時チェック
- [ ] バリューストリームが顧客価値を明確に表現している
- [ ] バリューステージの入出力が明確である
- [ ] ケーパビリティL1がビジネス能力として適切に定義されている
- [ ] 初期ユビキタス言語が作成されている
- [ ] 経営層の承認を得ている

### Layer 2完了時チェック
- [ ] BC境界がトランザクション境界として適切である
- [ ] パラソルドメイン言語が実装非依存である
- [ ] エンティティ、集約、ビジネスルールが明確である
- [ ] BC単位のAPI/DB設計が完了している
- [ ] BC間統合パターンが定義されている
- [ ] ドメインエキスパートの承認を得ている

### Layer 3完了時チェック
- [ ] すべてのOperationがBC内ドメイン言語を使用している
- [ ] UseCaseとPageが1:1対応している
- [ ] バリデーションルールが網羅されている
- [ ] エラーパターンが定義されている
- [ ] テスト可能な粒度に分解されている
- [ ] 実装可能なレベルまで詳細化されている

---

## 🎓 まとめ

### パラソルV3の3層デザイン構造の価値

1. **明確な責任分離**
   - Layer 1: ビジネス価値に専念
   - Layer 2: ドメインモデルに専念
   - Layer 3: 実装詳細に専念

2. **段階的詳細化**
   - 各Layerで適切な抽象度
   - 上位Layerが下位Layerの基盤となる
   - フィードバックループで継続改善

3. **パラソルドメイン言語の進化**
   - Layer 1: 5-20%（概念）
   - Layer 2: 60-80%（モデル）
   - Layer 3: 95-100%（実装可能）

4. **チーム協働の最適化**
   - 各Layerで適切な担当者
   - 明確なインターフェース
   - 並行作業が可能

### 次のステップ

1. **Layer 1から開始**: バリューストリーム定義ワークショップの実施
2. **ドメインエキスパートの確保**: Layer 2のドメイン言語定義のために必須
3. **テンプレートの活用**: 各Layer の成果物テンプレートを使用
4. **継続的レビュー**: 2週間/1ヶ月/3ヶ月サイクルでレビュー実施

---

**最終更新**: 2025-10-31
**次回レビュー**: 2025-11-30
