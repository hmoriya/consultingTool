# Layer 2: マイクロサービスデザイン - 実践ガイド

**作成日**: 2025-10-31
**バージョン**: 1.0.0
**対象読者**: アーキテクト、ドメインエキスパート、データアーキテクト

---

## 📖 このドキュメントについて

このドキュメントは、パラソル開発の**第2層（マイクロサービスデザイン）**の実践ガイドです。サービス境界の確定とドメインモデルの設計を行います。

**前提知識**:
- [パラソルV3設計 - 全体概要](./parasol-v3-design-overview.md)
- [Layer 1: パラソル価値デザイン](./parasol-v3-layer1-value-design.md)

**Layer 1からの引継ぎ**:
- バリューストリーム定義
- バリューステージ定義
- ケーパビリティL1定義
- 初期ユビキタス言語（5-20%）

---

## 🎯 Layer 2の目的

### サービス境界とドメインモデルの設計

Layer 2では、以下を定義します：

```
1. ケーパビリティL2（BC抽出の基準）
   └─ L1を戦術的能力に分解

2. バウンデッドコンテキスト（BC）
   ├─ BC境界の確定
   ├─ トランザクション境界
   └─ チーム責任範囲

3. パラソルドメイン言語（BC単位）
   ├─ エンティティ定義
   ├─ 集約定義
   ├─ ビジネスルール
   ├─ ドメインイベント
   └─ ドメインサービス

4. BC統合設計
   ├─ API設計（BC単位）
   ├─ DB設計（BC単位）
   └─ BC間統合パターン
```

### 重要な原則

✅ **ドメイン駆動設計（DDD）の適用**
- ビジネスロジックを中心に設計
- ユビキタス言語の徹底
- 集約による整合性保証

✅ **実装技術非依存**
- TypeScript、Go、Javaなど、どの言語でも実装可能
- パラソルドメイン言語は中間言語

✅ **AI生成を前提としたMD記述**
- AIが解析・生成しやすい形式
- 厳格なテンプレート構造

---

## 📐 成果物の全体像

```
docs/parasol/2-MICROSERVICE-DESIGN/
├── capabilities/
│   └── [l1-capability-name]/
│       └── l2-capabilities/
│           └── [l2-capability-name]/
│               └── l2-capability.md  # ケーパビリティL2定義
│
└── bounded-contexts/
    ├── bc-catalog.md                # BC全体カタログ
    ├── context-map.md               # BC間関係図
    │
    └── [bc-name]/
        ├── README.md                # BC定義（Why-What-How）
        │
        ├── domain/
        │   ├── domain-language.md   # パラソルドメイン言語 ★AI生成入力
        │   ├── ubiquitous-language.md
        │   └── bounded-context.md
        │
        ├── api/
        │   ├── api-specification.md  # API設計 ★AI生成入力
        │   └── endpoints/
        │
        ├── data/
        │   ├── database-design.md    # DB設計 ★AI生成入力
        │   └── schemas/
        │
        └── integration/
            ├── integration-map.md    # BC間連携
            └── contracts/
```

---

## 🚀 Step 1: ケーパビリティL2特定

### 目的

Layer 1のケーパビリティL1を戦術的能力（L2）に分解します。**L2がBC抽出の基準**となります。

### 実施方法

#### L1からL2への分解

**Step 1-1: L1能力の分析**

Layer 1で定義したケーパビリティL1を見直します：

```
例: ケーパビリティL1「プロジェクト構想する能力」

分解の観点:
- この能力を実現するには、どんな側面が必要か？
- どんな戦術的能力に分解できるか？
```

**Step 1-2: L2への分解**

```
L1: プロジェクト構想する能力
  ↓ 分解
L2の候補:
├─ 計画を策定する能力
├─ スコープを定義する能力
├─ リスクを分析する能力
└─ ステークホルダーを管理する能力
```

**分解の基準**:
- 1つのL2 = 1つの明確な戦術的目的
- 1つのL1 = 3-5個のL2程度
- L2間の依存は少なく、独立性が高い

#### BC抽出方針の検討

各L2について、BCへのマッピングを検討します：

```
方針1: 1 L2 = 1 BC
├─ 計画を策定する能力 → BC: プロジェクト計画BC
├─ リスクを分析する能力 → BC: リスク管理BC
└─ ...

方針2: 複数L2 = 1 BC（密接に関連する場合）
├─ 計画を策定する能力 ┐
└─ スコープを定義する能力 ┴→ BC: プロジェクト計画BC

判断基準:
- トランザクション整合性が必要か？
- データ共有が頻繁か？
- チーム編成はどうか？
```

### 成果物テンプレート

**ファイル**: `capabilities/[l1-name]/l2-capabilities/[l2-name]/l2-capability.md`

```markdown
# ケーパビリティL2: [能力の名前]

**作成日**: YYYY-MM-DD
**所属L1**: [ケーパビリティL1名]

## 能力の定義

### 概要
[この能力が何を実現するかを2-3文で]

### L1との関係
[どのL1の側面を実現する能力か]

## 機能概要

### 主要機能
1. [機能1]: [説明]
2. [機能2]: [説明]
3. [機能3]: [説明]

### 関与するステークホルダー
- [ステークホルダー1]: [役割]
- [ステークホルダー2]: [役割]

## BC抽出方針

### マッピング戦略
このL2は以下のBCに割り当てます：

**選択肢1**: 独立したBCとする
- BC名: [BC候補名]
- 理由: [独立させる理由]

**選択肢2**: 他のL2と統合してBCとする
- BC名: [BC候補名]
- 統合するL2: [他のL2名]
- 理由: [統合する理由]

**採用**: [選択肢X]

### BC境界の根拠
- トランザクション整合性: [必要/不要]
- データ共有頻度: [高/中/低]
- チーム責任: [同一チーム/別チーム]

## L3分解

このL2を実現する具体的な業務能力（L3）:

| L3-ID | L3 Capability名 | 説明 | 優先度 |
|-------|----------------|------|--------|
| L3-01 | [L3能力1] | [説明] | 高 |
| L3-02 | [L3能力2] | [説明] | 中 |
| L3-03 | [L3能力3] | [説明] | 中 |

## 次のステップ

BCの詳細設計へ進む
```

### チェックリスト

- [ ] L1からL2への分解が論理的である
- [ ] L2の数が適切（3-5個程度）
- [ ] BC抽出方針が明確である
- [ ] トランザクション境界が考慮されている
- [ ] アーキテクトの承認を得ている

---

## 🏗️ Step 2: BC定義とビジネス価値

### 目的

バウンデッドコンテキスト（BC）の境界を確定し、ビジネス価値を明確にします。

### BCとは

**定義**: ドメインモデルの一貫性境界、トランザクション境界、チーム責任範囲

**重要な特徴**:
- BC内では一つのユビキタス言語
- BC内ではトランザクション整合性
- BC間では結果整合性

### 実施方法

#### BC境界の決定

**Step 2-1: BC候補のリストアップ**

L2からBC候補を抽出します：

```
L2: 計画を策定する能力
  ↓
BC-004: プロジェクト計画BC
```

**Step 2-2: BC境界の検証**

以下の観点でBC境界を検証：

```
1. トランザクション境界
   Q: この範囲で整合性を保証する必要があるか？

2. ビジネスルール境界
   Q: 独立したビジネスルールの集合か？

3. 変更の頻度
   Q: 一緒に変更される可能性が高いか？

4. チーム境界
   Q: 1つのチームが責任を持てる範囲か？
```

#### ビジネス価値の明確化

**Step 2-3: Why（なぜこのBCが必要か）**

```
質問フレームワーク:
- どんなビジネス課題を解決するか？
- どんな価値を提供するか？
- 競合優位性は何か？
```

### 成果物テンプレート

**ファイル**: `bounded-contexts/[bc-name]/README.md`

```markdown
# Bounded Context: [BC名]

**BC-ID**: BC-XXX
**導出元L2**: [ケーパビリティL2名]
**バージョン**: 1.0.0
**作成日**: YYYY-MM-DD

---

## 🎯 Why: ビジネス価値

### L2からの導出

**元となったケーパビリティL2**: [L2名]

**L2の目的**: [L2の目的を引用]

### このBCが解決する課題

**ビジネス課題**:
- [課題1]
- [課題2]

**解決後の価値**:
- [価値1]（定量的）
- [価値2]（定量的）

### BC境界の根拠

**なぜこの境界にしたか**:
1. **トランザクション整合性**: [理由]
2. **ビジネスルール境界**: [理由]
3. **チーム責任範囲**: [理由]

**他のBCとの違い**:
- [BC-XXX]との違い: [説明]
- [BC-YYY]との違い: [説明]

---

## 📋 What: 提供機能

### 含まれるL3 Capability

このBCに含まれるL3能力:

| L3-ID | L3 Capability名 | Operation数 | 優先度 |
|-------|----------------|------------|--------|
| L3-01 | [L3能力1] | 2-4 | 高 |
| L3-02 | [L3能力2] | 2-4 | 中 |
| L3-03 | [L3能力3] | 2-4 | 低 |

**合計**: X個のL3 Capability、Y個のOperation

### 主要なビジネスプロセス

BC内の主要なビジネスプロセス:

1. **[プロセス1]**: [説明]
   - 入力: [入力]
   - 出力: [出力]
   - ビジネスルール: [ルール]

2. **[プロセス2]**: [説明]
   - 入力: [入力]
   - 出力: [出力]
   - ビジネスルール: [ルール]

---

## 🏗️ How: 実現方法（概要）

### ドメインモデル概要

**中核となる概念**:
- [概念1]: [説明]
- [概念2]: [説明]

**詳細**: [domain/domain-language.md](./domain/domain-language.md)

### API設計概要

**ベースURL**: `/api/bc/[bc-name]`

**主要エンドポイント**:
- `POST /api/bc/[bc-name]/[resource]`
- `GET /api/bc/[bc-name]/[resource]/{id}`

**詳細**: [api/api-specification.md](./api/api-specification.md)

### DB設計概要

**スキーマ**: `bc_[bc_name]`

**主要テーブル**:
- `bc_[bc_name].[aggregate_root]`
- `bc_[bc_name].[entity]`

**詳細**: [data/database-design.md](./data/database-design.md)

---

## 🔗 BC統合

### このBCが含まれるサービス

| サービス名 | 含まれるBC | 統合戦略 |
|-----------|-----------|---------|
| [service-1] | BC-XXX, BC-YYY | [戦略] |

### BC間連携

**上流BC（このBCが依存）**:
- [BC-AAA]: [関係パターン] - [理由]

**下流BC（このBCに依存）**:
- [BC-BBB]: [関係パターン] - [理由]

**詳細**: [integration/integration-map.md](./integration/integration-map.md)

---

## ✅ 次のステップ

1. パラソルドメイン言語の定義
2. API設計
3. DB設計
4. BC間統合設計
```

### チェックリスト

- [ ] BC境界が明確に定義されている
- [ ] ビジネス価値が定量的に表現されている
- [ ] トランザクション境界が適切である
- [ ] 含まれるL3が明確である
- [ ] ドメインエキスパートの承認を得ている

---

## 📝 Step 3: パラソルドメイン言語定義

### 目的

BC単位で、実装非依存の厳密なドメインモデルを定義します。

**重要**: これが**AI自動生成の入力**となります。

### パラソルドメイン言語とは

**定義**: 実装技術に依存しない、ビジネス中心の形式言語

**3要素記法**:
```
日本語名 [英語名] [SYSTEM_NAME]

例:
プロジェクト [Project] [PROJECT]
```

### 実施方法

#### ドメインモデリングワークショップ

**参加者**: ドメインエキスパート、アーキテクト

**Step 3-1: エンティティの抽出**

```
質問:
- このBCで重要な概念は何か？
- ライフサイクルを持つものは何か？
- 一意に識別する必要があるものは何か？

手法:
- イベントストーミング
- エンティティ候補のリストアップ
- 3要素記法での命名
```

**Step 3-2: 集約の設計**

```
質問:
- トランザクション境界はどこか？
- どのエンティティをまとめて更新するか？
- 不変条件は何か？

手法:
- 集約ルートの特定
- 集約内エンティティの特定
- 不変条件の定義
```

**Step 3-3: ビジネスルールの抽出**

```
質問:
- 必ず守るべきルールは何か？
- 状態遷移のルールは？
- 計算ロジックは？

手法:
- ルールの文書化
- 状態遷移図の作成
```

### 成果物テンプレート

**ファイル**: `bounded-contexts/[bc-name]/domain/domain-language.md`

このファイルが**AI自動生成の重要な入力**です。

```markdown
# パラソルドメイン言語: [BC名]

**BC-ID**: BC-XXX
**バージョン**: 1.0.0
**作成日**: YYYY-MM-DD

---

## パラソルドメイン概要

このBCのドメインモデルの概要を1-2段落で説明

---

## ユビキタス言語定義

### 基本型定義

このBC固有の基本型:

| 型名 | 説明 | 制約 |
|------|------|------|
| [CustomType1] | [説明] | [制約] |
| [CustomType2] | [説明] | [制約] |

---

## エンティティ（Entities）

### [エンティティ名] [EnglishName] [SYSTEM_NAME]

**定義**: [エンティティの説明]

**ライフサイクル**: [作成] → [状態1] → [状態2] → [完了]

**責務**: [このエンティティの責務]

| 属性名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 一意識別子 |
| name | STRING_100 | ○ | 名称 |
| status | ENUM(draft/active/completed) | ○ | 状態 |
| createdAt | TIMESTAMP | ○ | 作成日時 |
| updatedAt | TIMESTAMP | ○ | 更新日時 |

#### ビジネスルール
- [ルール1]: [説明]
- [ルール2]: [説明]

#### ドメインイベント
- [イベント名] [EventName]: [発生タイミング]
- [イベント名2] [EventName2]: [発生タイミング]

#### 集約ルート
[集約における役割の説明]

---

## 値オブジェクト（Value Objects）

### [値オブジェクト名] [ValueObjectName] [SYSTEM_NAME]

**定義**: [値オブジェクトの説明]

**不変性**: この値オブジェクトは不変です

**属性**:
- [属性1] [attr1] [ATTR1]: [型] - [説明]
- [属性2] [attr2] [ATTR2]: [型] - [説明]

**制約**:
- [制約1]
- [制約2]

**使用エンティティ**: [Entity1], [Entity2]

**例**: [具体例]

---

## 集約（Aggregates）

### [集約名] Aggregate

- **集約ルート**: [エンティティ名]
- **含まれるエンティティ**:
  - [エンティティ1]: [関係の説明]（多重度）
  - [エンティティ2]: [関係の説明]（多重度）
- **含まれる値オブジェクト**:
  - [ValueObject1]: [使用場所]
  - [ValueObject2]: [使用場所]
- **トランザクション境界**: [境界の説明]
- **不変条件**:
  - [条件1]
  - [条件2]
- **外部参照ルール**:
  - 集約外からは[ルート]のIDのみで参照
  - 集約内のエンティティへの直接参照は禁止

---

## ドメインサービス

### [サービス名] Domain Service

**責務**: [ドメインサービスの責務]

**提供機能**:
- [機能1] [function1]: [説明]
  - 入力: [型]
  - 出力: [型]
  - ビジネスロジック: [説明]

- [機能2] [function2]: [説明]
  - 入力: [型]
  - 出力: [型]
  - ビジネスロジック: [説明]

---

## ドメインイベント

### [イベント名] [EventName]

**発生タイミング**: [いつ発生するか]

**ペイロード**:
- [属性1]: [型] - [説明]
- [属性2]: [型] - [説明]

**購読者（想定）**:
- [BC-XXX]: [何に使うか]
- [BC-YYY]: [何に使うか]

---

## ビジネスルール

### [カテゴリ1]ルール

1. **[ルール名1]**: [ルールの内容]
2. **[ルール名2]**: [ルールの内容]

### 状態遷移

```
[初期状態] → [状態1] → [状態2] → [最終状態]
                ↓
            [例外状態]
```

**遷移条件**:
- [初期状態] → [状態1]: [条件]
- [状態1] → [状態2]: [条件]

---

## リポジトリインターフェース

### [リポジトリ名] Repository

**責務**: [集約]の永続化

**メソッド**:
- `findById(id: UUID): [Entity]` - ID検索
- `save(entity: [Entity]): void` - 保存
- `findBy[Criteria]([params]): [Entity][]` - 条件検索
- `delete(id: UUID): void` - 削除

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | YYYY-MM-DD | 初版作成 |
```

### チェックリスト

- [ ] すべてのエンティティが3要素記法で定義されている
- [ ] 集約境界が明確である
- [ ] ビジネスルールが網羅されている
- [ ] 実装技術に依存していない（TypeScript等の言及がない）
- [ ] AI生成可能な構造になっている
- [ ] ドメインエキスパートの承認を得ている

---

## 🔌 Step 4: BC統合設計

### API設計

**ファイル**: `bounded-contexts/[bc-name]/api/api-specification.md`

テンプレートは省略しますが、以下を含めます：
- BC単位のエンドポイント設計
- パラソルドメイン言語に基づくスキーマ
- L3別のAPI分類

### DB設計

**ファイル**: `bounded-contexts/[bc-name]/data/database-design.md`

テンプレートは省略しますが、以下を含めます：
- BCスキーマ設計
- BC内トランザクション整合性
- BC間の外部キー禁止ルール

### BC間統合パターン

**ファイル**: `bounded-contexts/[bc-name]/integration/integration-map.md`

- Customer/Supplier
- Partnership
- Anti-Corruption Layer等

---

## ✅ Layer 2完了チェックリスト

### 成果物の完成度

- [ ] すべてのL2定義書が作成されている
- [ ] BCカタログが作成されている
- [ ] すべてのBC定義書（README.md）が作成されている
- [ ] すべてのパラソルドメイン言語が作成されている
- [ ] BC API設計が作成されている
- [ ] BC DB設計が作成されている
- [ ] BC間統合設計が作成されている
- [ ] コンテキストマップが作成されている

### 承認プロセス

- [ ] ドメインエキスパートがパラソルドメイン言語を承認
- [ ] アーキテクトがBC境界を承認
- [ ] データアーキテクトがDB設計を承認

### ドメイン言語の状態

- [ ] パラソルドメイン言語: 60-80%の完成度
- [ ] エンティティ定義が完全である
- [ ] 集約定義が完全である
- [ ] ビジネスルールが網羅されている

---

## 🎯 次のステップ

Layer 2が完了したら、Layer 3（パラソル開発設計）へ進みます。

📄 **次のガイド**: [parasol-v3-layer3-development-design.md](./parasol-v3-layer3-development-design.md)

---

## 📚 関連ドキュメント

- [パラソルワールド - 概要](./parasol-world-overview.md)
- [パラソルV3設計 - 全体概要](./parasol-v3-design-overview.md)
- [Layer 1: パラソル価値デザイン](./parasol-v3-layer1-value-design.md)
- [Layer 3: パラソル開発設計](./parasol-v3-layer3-development-design.md)
- [ドメイン言語進化ガイド](./parasol-v3-domain-language-evolution.md)
- [サブドメイン・BC・マイクロサービスの整合性ガイド](./parasol-v3-subdomain-bc-ms-alignment.md)

---

## 📝 改訂履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2025-10-31 | 初版作成 |
