# サブドメイン・BC・マイクロサービスの整合性ガイド

**作成日**: 2025-11-01
**バージョン**: 1.0.0
**対象読者**: アーキテクト、ドメインエキスパート、開発リーダー

---

## 📖 このドキュメントについて

このドキュメントは、DDD(Domain-Driven Design)における**問題領域(Problem Space)**と**解決領域(Solution Space)**の整合性を、パラソルV3の3層デザイン構造でどのように取るかを説明します。

**位置づけ**:
- [Layer 2: マイクロサービスデザイン](./parasol-v3-layer2-microservice-design.md)の**補完ガイド**
- BC境界決定の4つの検証観点（トランザクション/ビジネスルール/変更頻度/チーム境界）は、Layer 2ガイドに既に記載されています
- 本ドキュメントは、DDDの理論とパラソルV3の実践を橋渡しし、整合性の取り方を体系的に説明します

**前提知識**:
- [パラソルV3設計 - 全体概要](./parasol-v3-design-overview.md)
- [Layer 2: マイクロサービスデザイン](./parasol-v3-layer2-microservice-design.md) ← **必読**
- ドメイン駆動設計(DDD)の基礎知識

---

## 🎯 問題領域と解決領域とは

### DDDにおける2つの空間

```
【問題領域 - Problem Space】
├─ ドメイン (Domain)
│   └─ サブドメイン (Subdomain)
│       ├─ コアドメイン (Core Domain)
│       ├─ サポートドメイン (Supporting Domain)
│       └─ 汎用ドメイン (Generic Domain)
└─ 目的: ビジネス課題の理解と分析

【解決領域 - Solution Space】
├─ バウンデッドコンテキスト (Bounded Context)
│   ├─ ドメインモデル
│   ├─ ユビキタス言語
│   └─ コンテキスト境界
├─ マイクロサービス (実装単位)
└─ 目的: 技術的な解決策の設計
```

### 重要な原則

**問題領域と解決領域は1:1対応ではない**

```
サブドメイン ≠ バウンデッドコンテキスト
サブドメイン ≠ マイクロサービス
バウンデッドコンテキスト ≠ マイクロサービス
```

理由:
- **サブドメイン**: ビジネスの論理的な分割
- **BC**: モデルの一貫性境界、チーム境界、トランザクション境界
- **マイクロサービス**: デプロイ可能な実装単位

---

## 🏗️ パラソルV3における対応構造

### 3層での対応関係

```
┌─────────────────────────────────────────────────────────┐
│ 【問題領域 - Problem Space】                              │
│                                                         │
│ Layer 1: パラソル価値デザイン                              │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│
│ バリューストリーム                                        │
│   └─ バリューステージ                                    │
│       └─ ケーパビリティL1 (戦略的組織能力)                │
│           ≈ ドメイン/サブドメイン                         │
│                                                         │
│           ↓ 分解                                        │
│                                                         │
│ ケーパビリティL2 (戦術的組織能力)                          │
│   ≈ サブドメインの詳細化                                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
                        ↓
        【境界 - Problem → Solution の変換】
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 【解決領域 - Solution Space】                             │
│                                                         │
│ Layer 2: マイクロサービスデザイン                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│
│ バウンデッドコンテキスト (BC)                             │
│   ├─ パラソルドメイン言語                                │
│   ├─ BC API設計                                        │
│   └─ BC DB設計                                         │
│       = モデルの一貫性境界                               │
│                                                         │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 【実装 - Implementation】                                │
│                                                         │
│ Layer 3: パラソル開発設計                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│
│ マイクロサービス実装単位                                  │
│   ├─ L3 Capability                                     │
│   ├─ Operation                                         │
│   └─ UseCase/Page                                      │
│       = デプロイ可能な実装単位                           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 重要な対応ルール

#### 1. ケーパビリティL2がBC抽出の基準

```
ケーパビリティL2 ← 問題領域の最小単位（戦術的能力）
        ↓
    BC抽出方針の決定
        ↓
バウンデッドコンテキスト ← 解決領域の境界
```

**なぜL2が基準なのか**:
- L1: 戦略的すぎて、実装境界を決めるには粗い
- L2: ちょうど良い粒度で、トランザクション境界やチーム境界を検討できる
- L3: 詳細すぎて、既にBC内の実装詳細

#### 2. BC抽出の2つの基本方針

**方針A: 1 L2 = 1 BC**（独立BC戦略）

```
ケーパビリティL2: 計画を策定する能力
    ↓
BC: プロジェクト計画BC

ケーパビリティL2: リスクを分析する能力
    ↓
BC: リスク管理BC
```

**適用ケース**:
- トランザクション整合性が独立している
- ビジネスルールが独立している
- 異なるチームが担当する
- 変更頻度が異なる

**方針B: 複数L2 = 1 BC**（統合BC戦略）

```
ケーパビリティL2: 計画を策定する能力 ┐
ケーパビリティL2: スコープを定義する能力 ┴→ BC: プロジェクト計画BC
```

**適用ケース**:
- トランザクション整合性が必要
- ビジネスルールが密接に関連
- 同じチームが担当する
- 一緒に変更される可能性が高い

---

## 🔄 整合性を取るプロセス

### Step 1: 問題領域の分析（Layer 1）

**ビジネス価値からのトップダウン分析**

```markdown
バリューストリーム: DXプロジェクト成功支援
    ≈ ドメイン全体
    ↓
バリューステージ: プロジェクト計画支援
    ≈ サブドメイン候補
    ↓
ケーパビリティL1: プロジェクト構想する能力
    ≈ サブドメイン（戦略的能力）
```

**この段階での成果物**:
- ビジネス価値の定義
- ステークホルダーマッピング
- 初期ユビキタス言語（5-20%）

### Step 2: 問題領域の詳細化（Layer 2 前半）

**L1からL2への分解（サブドメインの詳細化）**

```markdown
ケーパビリティL1: プロジェクト構想する能力
    ↓ 戦術的能力への分解
ケーパビリティL2:
├─ 計画を策定する能力
├─ スコープを定義する能力
├─ リスクを分析する能力
└─ ステークホルダーを管理する能力
```

**分解の基準**:
- 1つのL2 = 1つの明確な戦術的目的
- 1つのL1 = 3-5個のL2程度
- L2間の依存は少なく、独立性が高い

### Step 3: 解決領域への変換（Layer 2 後半）

**L2からBCへの変換（問題領域→解決領域）**

これが**最も重要な設計判断**です。

> **注**: BC境界決定の検証観点は、[Layer 2: マイクロサービスデザイン](./parasol-v3-layer2-microservice-design.md#step-2-bc定義とビジネス価値)に記載されています。以下は、その詳細化と実践例です。

#### BC境界決定の4つの検証観点

```markdown
1. トランザクション境界
   Q: この範囲で整合性を保証する必要があるか？

   例: プロジェクトとタスクの整合性
   - プロジェクト作成時にタスクも作成する
   - 削除時も同時に削除する
   → 同一BCが適切

2. ビジネスルール境界
   Q: 独立したビジネスルールの集合か？

   例: 計画策定のルール vs. リスク分析のルール
   - 計画: WBS分解ルール、スケジューリングルール
   - リスク: リスク評価ルール、緩和策ルール
   → 独立したビジネスルールなら別BC

3. 変更の頻度
   Q: 一緒に変更される可能性が高いか？

   例: 計画策定機能とスコープ定義機能
   - 計画変更時、スコープも見直される
   - スコープ変更時、計画も調整される
   → 同一BCが適切

4. チーム境界
   Q: 1つのチームが責任を持てる範囲か？

   例: プロジェクト計画チーム
   - WBS作成、スケジュール、リソース配分を担当
   - チーム内で完結する
   → 同一BCが適切
```

#### 具体的な検証例

**ケース1: 独立BCの判断**

```markdown
L2: 計画を策定する能力
├─ トランザクション境界: ✓ プロジェクト全体の整合性が必要
├─ ビジネスルール: ✓ 計画策定固有のルールがある
├─ 変更頻度: ✓ 計画は独立して変更される
└─ チーム: ✓ プロジェクト計画チームが責任を持つ
    ↓
決定: 独立したBC「プロジェクト計画BC」とする
```

**ケース2: 統合BCの判断**

```markdown
L2: スコープを定義する能力
├─ トランザクション境界: △ 計画と密接に関連
├─ ビジネスルール: △ 計画策定のサブセット
├─ 変更頻度: ✓ 計画と一緒に変更される
└─ チーム: ✓ 同じプロジェクト計画チーム
    ↓
決定: 「プロジェクト計画BC」に統合
```

#### BC設計の成果物

各BCについて以下を定義:

```markdown
# Bounded Context: プロジェクト計画BC

## Why: ビジネス価値
- 導出元L2: 計画を策定する能力、スコープを定義する能力
- 解決する課題: プロジェクト計画の精度向上
- 提供価値: 計画策定時間50%削減、精度80%達成

## What: 提供機能
- 含まれるL3 Capability: 5個
- 主要ビジネスプロセス: WBS作成、スケジューリング等

## How: 実現方法
- パラソルドメイン言語: 60-80%完成
- API設計: BC単位で共有
- DB設計: BC単位でスキーマ分離
```

### Step 4: マイクロサービス実装単位の決定（Layer 2-3）

**BCからマイクロサービスへのマッピング**

#### 戦略A: 1 BC = 1 マイクロサービス（標準）

```
BC: プロジェクト計画BC
    ↓
マイクロサービス: project-planning-service
```

**適用ケース**:
- BCの規模が適切（中規模）
- チームが1つ
- デプロイ頻度が同じ

#### 戦略B: 複数BC = 1 マイクロサービス（初期フェーズ）

```
BC: プロジェクト計画BC ┐
BC: リスク管理BC      ┴→ マイクロサービス: project-service
```

**適用ケース**:
- 初期MVP開発
- BC間の連携が非常に密
- チームリソースが限定的
- 後で分割する前提（フェーズ2で1 BC = 1 MSに移行）

---

## 📊 整合性マッピングの実例

### 例: コンサルティングプロジェクト管理システム

#### Layer 1: 問題領域の分析

```
ドメイン: コンサルティングプロジェクト管理
    ↓
バリューストリーム: DXプロジェクト成功支援
    ↓
バリューステージ:
├─ プロジェクト構想
├─ プロジェクト計画支援 ← Focus
├─ プロジェクト実行支援
└─ 成果可視化
    ↓
ケーパビリティL1:
├─ プロジェクト構想する能力 ← Focus
├─ プロジェクト計画する能力
├─ リソースを最適配置する能力
└─ 成果を可視化する能力
```

#### Layer 2 前半: 問題領域の詳細化

```
ケーパビリティL1: プロジェクト構想する能力
    ↓ L2への分解
ケーパビリティL2:
├─ L2-01: 計画を策定する能力
├─ L2-02: スコープを定義する能力
├─ L2-03: リスクを分析する能力
├─ L2-04: ステークホルダーを管理する能力
└─ L2-05: 投資対効果を評価する能力
```

#### Layer 2 後半: 解決領域への変換

**BC抽出の検討**

| L2 | トランザクション | ビジネスルール | 変更頻度 | チーム | BC決定 |
|----|--------------|-------------|---------|--------|--------|
| L2-01: 計画策定 | 必要 | 独立 | 高 | 計画チーム | **BC-01: プロジェクト計画BC** |
| L2-02: スコープ定義 | 計画と密接 | 計画の一部 | 計画と同じ | 計画チーム | ↑ BC-01に統合 |
| L2-03: リスク分析 | 独立 | 独立 | 中 | リスクチーム | **BC-02: リスク管理BC** |
| L2-04: SH管理 | 独立 | 独立 | 低 | SHチーム | **BC-03: ステークホルダーBC** |
| L2-05: ROI評価 | 独立 | 独立 | 低 | 財務チーム | **BC-04: 財務評価BC** |

**結果: 4つのBCを定義**

```
BC-01: プロジェクト計画BC
├─ L2-01: 計画を策定する能力
└─ L2-02: スコープを定義する能力

BC-02: リスク管理BC
└─ L2-03: リスクを分析する能力

BC-03: ステークホルダーBC
└─ L2-04: ステークホルダーを管理する能力

BC-04: 財務評価BC
└─ L2-05: 投資対効果を評価する能力
```

#### Layer 3: マイクロサービスの決定

**フェーズ1（MVP）: 統合戦略**

```
BC-01 + BC-02 → project-management-service
BC-03 + BC-04 → stakeholder-finance-service
```

**フェーズ2（成長期）: 分離戦略**

```
BC-01 → project-planning-service
BC-02 → risk-management-service
BC-03 → stakeholder-service
BC-04 → finance-evaluation-service
```

---

## ✅ 整合性チェックリスト

### Layer 1完了時（問題領域の分析）

- [ ] バリューストリームがビジネス価値を明確に表現している
- [ ] バリューステージが価値創造の流れを適切に分割している
- [ ] ケーパビリティL1が組織の戦略的能力として定義されている
- [ ] 初期ユビキタス言語が作成されている（5-20%）
- [ ] ドメイン/サブドメインの境界が暗黙的に見えている

### Layer 2前半完了時（問題領域の詳細化）

- [ ] L1からL2への分解が論理的である
- [ ] L2が戦術的能力として適切な粒度である（3-5個/L1）
- [ ] L2間の依存が少なく、独立性が高い
- [ ] 各L2のビジネス価値が明確である
- [ ] サブドメインの詳細が見えている

### Layer 2後半完了時（解決領域への変換）

- [ ] BC抽出方針が明確である（1 L2 = 1 BC or 複数L2 = 1 BC）
- [ ] BC境界がトランザクション境界として適切である
- [ ] BC境界がビジネスルール境界として適切である
- [ ] BC境界がチーム境界として適切である
- [ ] 各BCのビジネス価値が定量的に表現されている
- [ ] パラソルドメイン言語が定義されている（60-80%）
- [ ] BC API/DB設計が完了している
- [ ] BC間統合パターンが定義されている

### Layer 3完了時（実装単位の決定）

- [ ] BCからマイクロサービスへのマッピング戦略が明確である
- [ ] マイクロサービスの境界がデプロイ単位として適切である
- [ ] スケール要件が考慮されている
- [ ] チーム構成が考慮されている
- [ ] フェーズ別の進化戦略が定義されている

---

## 🎓 よくある質問と回答

### Q1: サブドメインとBCは必ず1:1対応させるべきですか？

**A**: いいえ、必ずしも1:1対応ではありません。

```
ケース1: 1サブドメイン = 複数BC
例: 大規模なプロジェクト管理サブドメイン
  → BC: プロジェクト計画BC
  → BC: リスク管理BC
  → BC: スケジュール管理BC

ケース2: 複数サブドメイン = 1BC
例: 小規模な支援機能
  → サブドメイン: 通知、ログ
  → BC: 共通サービスBC

ケース3: 1サブドメイン = 1BC
例: 認証サブドメイン
  → BC: 認証BC
```

**判断基準**: トランザクション境界、チーム境界、ビジネスルール境界

### Q2: コアドメイン/サポートドメイン/汎用ドメインの分類は、パラソルV3でどう扱いますか？

**A**: ケーパビリティL1/L2の投資優先度として扱います。

```
ケーパビリティL1: プロジェクト構想する能力
├─ ビジネスインパクト: 高
├─ 競合優位性: 高
└─ 投資優先度: 高
    → コアドメイン相当

ケーパビリティL1: 通知を送る能力
├─ ビジネスインパクト: 低
├─ 競合優位性: なし（汎用機能）
└─ 投資優先度: 低
    → 汎用ドメイン相当（SaaSや既製品検討）
```

### Q3: BCとマイクロサービスの境界が違う場合、どう管理しますか？

**A**: BCは設計上の境界、マイクロサービスは実装上の境界として分けて管理します。

**原則**:
```
BC定義（Layer 2成果物）
└─ パラソルドメイン言語
└─ BC API仕様
└─ BC DB設計
    ↓ これは変更しない

マイクロサービス実装（Layer 3成果物）
└─ 実装単位の決定
└─ デプロイ戦略
└─ スケール戦略
    ↓ これはフェーズで変更可能
```

**例**:
```
フェーズ1:
  BC-01 + BC-02 → service-1

フェーズ2:
  BC-01 → service-1
  BC-02 → service-2

BC定義はそのまま、実装だけ分割
```

### Q4: Layer 2でBCを統合したが、後で分離する必要が出た場合はどうしますか？

**A**: Layer 2に戻って再設計します。

**フィードバックフロー**:
```
1. 実装フェーズで問題発見
   - パフォーマンス問題
   - チーム分割の必要性
   - スケール要件の違い

2. Layer 3で影響を評価
   - どのOperation/UseCaseが影響を受けるか

3. Layer 2へフィードバック
   - BC境界の再検討
   - パラソルドメイン言語の再検討
   - API/DB設計の修正

4. Layer 3へ反映
   - Operation/UseCase/Page設計の修正

5. 実装修正
   - コード修正、リファクタリング
```

### Q5: 小規模プロジェクトでも、この整合性プロセスは必要ですか？

**A**: 規模に応じて簡略化できますが、基本プロセスは推奨します。

**小規模プロジェクトの簡略化例**:
```
Layer 1: 簡略版
- バリューストリーム: 1つ
- バリューステージ: 2-3個
- ケーパビリティL1: 3-5個
- 期間: 2-3日

Layer 2: 標準版（必須）
- ケーパビリティL2: 10-15個
- BC: 3-5個
- 期間: 1-2週間

Layer 3: 標準版（必須）
- L3/Operation/UseCase設計
- 期間: 2-3週間
```

最低限、**L2→BCの整合性検証**は必須です。

---

## 📋 設計判断の記録テンプレート

BC抽出の判断プロセスを記録することを推奨します。

### テンプレート: BC抽出判断記録

```markdown
# BC抽出判断記録: [BC名]

**BC-ID**: BC-XXX
**判断日**: YYYY-MM-DD
**判断者**: [アーキテクト名]

## 導出元L2

| L2-ID | L2名 | 含める/除外 | 理由 |
|-------|------|-----------|------|
| L2-01 | 計画を策定する能力 | ✓ 含める | コア機能 |
| L2-02 | スコープを定義する能力 | ✓ 含める | 計画と密接に関連 |
| L2-03 | リスクを分析する能力 | ✗ 除外 → BC-002 | 独立したビジネスルール |

## BC境界の検証

### 1. トランザクション境界

**判断**: ✓ 適切

**理由**:
- プロジェクト作成時、計画とスコープを同時に作成
- 削除時も同時に削除
- BC内でACID保証が必要

### 2. ビジネスルール境界

**判断**: ✓ 適切

**理由**:
- 計画策定ルール: WBS分解ルール、スケジューリングルール
- スコープ定義ルール: スコープ変更管理ルール
- 両者は密接に関連し、同じBCで管理すべき

### 3. 変更の頻度

**判断**: ✓ 適切

**理由**:
- 計画変更時、スコープも見直される
- スコープ変更時、計画も調整される
- 変更が連動するため、同一BCが適切

### 4. チーム境界

**判断**: ✓ 適切

**理由**:
- プロジェクト計画チームが両機能を担当
- チーム内で完結する

## BC間統合パターン

### 上流BC（このBCが依存）

| BC-ID | BC名 | 関係パターン | 理由 |
|-------|------|------------|------|
| BC-001 | 認証BC | Customer/Supplier | ユーザー認証が必須 |

### 下流BC（このBCに依存）

| BC-ID | BC名 | 関係パターン | 理由 |
|-------|------|------------|------|
| BC-002 | リスク管理BC | Partnership | プロジェクト情報を共有 |

## 代替案の検討

### 案1: 計画とスコープを別BCに分離

**却下理由**:
- トランザクション整合性が損なわれる
- ビジネスルールが密接に関連
- チームが同じで、分離のメリットがない

### 案2: 採用（現在の案）

**採用理由**:
- 4つの検証観点すべてで適切と判断
- トランザクション整合性を保証できる
- チーム責任範囲として適切

## マイクロサービス実装方針

### フェーズ1（MVP）

**戦略**: 1 BC = 1 マイクロサービス

```
BC-XXX → project-planning-service
```

### フェーズ2（成長期）

**戦略**: 維持（変更なし）

## 承認

- [ ] ドメインエキスパート承認: [名前] [日付]
- [ ] アーキテクト承認: [名前] [日付]
- [ ] データアーキテクト承認: [名前] [日付]

## 改訂履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|---------|--------|
| 1.0.0 | YYYY-MM-DD | 初版作成 | [名前] |
```

---

## 📚 関連ドキュメント

### パラソルV3設計ガイド
- [パラソルV3設計 - 全体概要](./parasol-v3-design-overview.md)
- [Layer 1: パラソル価値デザイン](./parasol-v3-layer1-value-design.md)
- [Layer 2: マイクロサービスデザイン](./parasol-v3-layer2-microservice-design.md)
- [Layer 3: パラソル開発設計](./parasol-v3-layer3-development-design.md)
- [ドメイン言語進化ガイド](./parasol-v3-domain-language-evolution.md)

### DDD参考文献
- Eric Evans "Domain-Driven Design"
- Vaughn Vernon "Implementing Domain-Driven Design"
- Sam Newman "Building Microservices"

---

## 🎯 まとめ

### パラソルV3における整合性の取り方

1. **Layer 1 (ケーパビリティL1)**:
   - ビジネス領域の戦略的分解
   - ≈ ドメイン/サブドメイン

2. **Layer 2前半 (ケーパビリティL2)**:
   - 戦術的能力への分解
   - ≈ サブドメインの詳細化
   - **BC抽出の基準**

3. **Layer 2後半 (BC抽出)**:
   - L2からBCへの変換
   - = **問題領域→解決領域の境界**
   - 4つの検証観点で判断

4. **Layer 3 (サービス実装方針)**:
   - BCからマイクロサービスへのマッピング
   - フェーズ別に進化

### 重要な原則

✅ **L2がBC抽出の基準**
- 問題領域と解決領域の架け橋

✅ **トランザクション境界 = BC境界**
- 整合性の保証範囲

✅ **BC内は強い整合性、BC間は結果整合性**
- 実装の指針

✅ **BCとマイクロサービスは別物**
- BCは設計境界、マイクロサービスは実装境界

✅ **フィードバックループ**
- 実装から設計へのフィードバックを重視

この方法により、**ビジネス価値(問題領域)からマイクロサービス実装(解決領域)まで、トレーサビリティを保ちながら設計**できます。

---

## 📝 改訂履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2025-11-01 | 初版作成 |

---

**次のステップ**:
- [Layer 2ガイド](./parasol-v3-layer2-microservice-design.md)でBC設計を実践
- BC抽出判断記録テンプレートを活用
