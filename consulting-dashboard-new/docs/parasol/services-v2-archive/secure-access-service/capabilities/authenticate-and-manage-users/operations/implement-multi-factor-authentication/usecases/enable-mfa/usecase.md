# ユースケース: MFAを有効化する

**バージョン**: 2.0.0
**更新日**: 2025-10-21
**設計方針**: セキュリティ強化・段階的導入・利便性両立

## 基本情報
- **ユースケースID**: UC-MFA-01
- **アクター**: ユーザー（主アクター）、システム（副アクター）
- **概要**: ユーザーが自身のアカウントに多要素認証を設定し、セキュリティを大幅に強化する

## 🏗️ パラソルドメイン連携

### 操作エンティティ
- **MFAConfigurationEntity**（自サービス管理・状態更新: disabled → enabled → verified）: MFA設定の初期化、秘密鍵関連付け、状態管理
- **MFASecretEntity**（自サービス管理・作成）: TOTP秘密鍵の生成、QRコード用データ作成
- **BackupCodeEntity**（自サービス管理・作成）: 緊急時バックアップコードの生成、暗号化保存

### 他サービスユースケース利用
- **knowledge-co-creation-service**: UC-KNOWLEDGE-01: MFA教育資料を提供する
- **collaboration-facilitation-service**: UC-NOTIFY-02: MFA設定完了通知を配信する
- **project-success-service**: UC-AUDIT-01: セキュリティ監査ログを記録する

## 事前条件
- ユーザーがシステムにログインしている
- ユーザーのアカウントでMFAが無効化されている
- ユーザーがスマートフォンまたは認証アプリを利用可能である
- システムにMFA機能が実装・有効化されている

## 事後条件
### 成功時
- MFAConfigurationEntity が verified 状態になっている
- MFASecretEntity が生成・保存されている
- BackupCodeEntity が生成され、ユーザーに提供されている
- MFA設定完了通知がユーザーに配信されている
- セキュリティ監査ログが記録されている
- ユーザーが次回ログイン時からMFA認証を要求される

### 失敗時
- MFAConfigurationEntity の状態変更がロールバックされている
- 部分的に生成されたエンティティが削除されている
- エラーログが記録されている
- ユーザーに適切なエラーメッセージが表示されている

## 基本フロー
1. **ユーザー**がセキュリティ設定画面でMFA有効化を選択する
2. **システム**がMFA教育資料を表示する（他サービス連携）
3. **ユーザー**がMFA設定開始を確認する
4. **システム**がMFAConfigurationEntityを作成し、状態を disabled → enabled に変更する
5. **システム**がTOTP秘密鍵を生成しMFASecretEntityを作成する
6. **システム**がQRコードとテキスト形式の秘密鍵を表示する
7. **ユーザー**が認証アプリ（Google Authenticator等）でQRコードをスキャンする
8. **ユーザー**が認証アプリで生成された6桁コードを入力する
9. **システム**が入力されたコードを検証する
10. **システム**がMFAConfigurationEntityの状態を enabled → verified に変更する
11. **システム**が10個のバックアップコードを生成しBackupCodeEntityを作成する
12. **システム**がバックアップコードをユーザーに表示する
13. **ユーザー**がバックアップコードを安全な場所に保存する
14. **システム**がMFA設定完了通知を配信する（他サービス連携）
15. **システム**がセキュリティ監査ログを記録する（他サービス連携）
16. **システム**が設定完了画面を表示する

## 代替フロー

### 代替フロー1: QRコード読み取り不可
- **分岐点**: ステップ7（QRコードスキャン）
- **条件**: QRコードが読み取れない、カメラが利用できない
- **処理**:
  - 7a1. ユーザーがテキスト入力オプションを選択する
  - 7a2. システムが秘密鍵をテキスト形式で表示する
  - 7a3. ユーザーが認証アプリに手動で秘密鍵を入力する
  - 7a4. ステップ8に続行

### 代替フロー2: コード検証失敗
- **分岐点**: ステップ9（コード検証）
- **条件**: 入力されたコードが不正または期限切れ
- **処理**:
  - 9a1. システムがエラーメッセージを表示する
  - 9a2. システムが再試行を促す
  - 9a3. ユーザーが新しいコードを生成・入力する
  - 9a4. ステップ9に戻る（最大3回まで）

### 代替フロー3: バックアップコード保存確認
- **分岐点**: ステップ13（バックアップコード保存）
- **条件**: ユーザーが保存完了を明示的に確認
- **処理**:
  - 13a1. システムが保存確認チェックボックスを表示する
  - 13a2. ユーザーが保存完了をチェックする
  - 13a3. システムが次の手順に進行を許可する

## 例外フロー

### 例外1: 連続失敗によるロック
- **発生点**: ステップ9（コード検証）
- **処理**:
  - 9e1. 3回連続でコード検証が失敗した場合
  - 9e2. システムが15分間のMFA設定ロックを適用する
  - 9e3. システムがセキュリティアラートを送信する（他サービス連携）
  - 9e4. システムがロック期間とリトライ時刻を表示する

### 例外2: システムエラー
- **発生点**: 任意のステップ
- **処理**:
  - *e1. システムエラーが発生した場合
  - *e2. システムが部分的に作成されたエンティティを削除する
  - *e3. システムがMFAConfigurationEntityの状態をdisabledにロールバックする
  - *e4. システムがエラーログを記録し、管理者に通知する
  - *e5. ユーザーに一時的な問題である旨を通知し、再試行を案内する

### 例外3: 認証アプリ非対応
- **発生点**: ステップ7（認証アプリ設定）
- **処理**:
  - 7e1. ユーザーが対応認証アプリを持たない場合
  - 7e2. システムが推奨認証アプリリストを表示する
  - 7e3. システムがアプリストアリンクを提供する
  - 7e4. ユーザーがアプリインストール完了後にステップ7に戻る

## 特別要件

### セキュリティ要件
- **秘密鍵強度**: RFC 6238準拠のTOTP秘密鍵（160-bit以上）
- **バックアップコード**: 暗号学的に安全な乱数生成（16文字×10個）
- **状態管理**: 原子性を保つトランザクション処理
- **ログ記録**: 全操作の詳細ログ（個人情報除く）

### ユーザビリティ要件
- **直感的UI**: ステップバイステップの分かりやすい案内
- **プログレス表示**: 設定進行状況の視覚的表示
- **ヘルプ機能**: 各ステップでのコンテキスト依存ヘルプ
- **アクセシビリティ**: スクリーンリーダー対応、キーボードナビゲーション

### 性能要件
- **QRコード生成**: 2秒以内
- **コード検証**: 500ms以内
- **バックアップコード生成**: 3秒以内
- **画面遷移**: 1秒以内

## ドメインサービス連携
- **MFASecurityService.strengthen[AuthenticationSecurity]()**: 認証セキュリティの全体的強化
- **MFAEnrollmentService.enhance[UserSecurityPosture]()**: ユーザーセキュリティ体制の向上

## 入出力仕様

### 入力（フロントエンド → API）
```json
{
  "mfaSetup": {
    "userId": "UUID",
    "verificationCode": "123456",
    "setupStep": "qr_scan|code_verify|backup_save",
    "clientTimestamp": "2024-10-21T10:30:00Z"
  }
}
```

### 出力（API → フロントエンド）
```json
{
  "result": "success",
  "setupData": {
    "qrCodeDataUrl": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
    "secretKey": "JBSWY3DPEHPK3PXP",
    "backupCodes": [
      "1a2b3c4d5e6f7g8h",
      "2b3c4d5e6f7g8h9i",
      "..."
    ]
  },
  "status": {
    "currentStep": "backup_display",
    "isComplete": true,
    "nextAction": "save_backup_codes"
  }
}
```

## 関連ユースケース
- **UC-MFA-02**: 認証コードを入力する（設定完了後の日常利用）
- **UC-MFA-03**: バックアップコードを使用する（緊急時利用）
- **UC-MFA-04**: MFAをリセットする（問題発生時のリセット）

---
*このユースケースは、セキュリティと利便性を両立し、段階的なMFA導入を実現するパラソル設計v2.0仕様に基づいています*