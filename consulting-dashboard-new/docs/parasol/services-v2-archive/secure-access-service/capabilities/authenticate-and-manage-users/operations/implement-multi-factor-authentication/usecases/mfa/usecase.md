# ユースケース: MFAをリセットする

## 基本情報
- **ユースケースID**: UC-SEC-004
- **アクター**: ユーザー, システム管理者, セキュリティ管理者
- **概要**: 認証デバイス紛失やバックアップコード全消費時にMFA設定を安全にリセットし、新規設定を可能にする

## 事前条件
- ユーザーアカウントでMFAが有効化されている
- 以下のいずれかの状況が発生している：
  - 認証デバイス（スマートフォン等）が紛失・故障・盗難された
  - バックアップコードが全て使用済みになった
  - 認証アプリの設定が破損した
- 管理者権限を持つユーザーがシステムにアクセス可能である

## 事後条件
### 成功時
- ユーザーのMFA設定が完全に無効化される
- 古い秘密鍵とバックアップコードが全て削除される
- MFAリセット完了通知がユーザーに送信される
- ユーザーが新しいMFA設定を実行可能になる
- リセット実行ログが監査ログに記録される

### 失敗時
- 既存のMFA設定が保持される
- エラーメッセージが表示される
- リセット失敗ログが記録される
- 代替手段の案内が表示される

## 基本フロー
1. ユーザーがMFAリセット要求を管理者に連絡する
2. 管理者がユーザーの本人確認を実施する
3. 管理者がシステム管理画面にアクセスする
4. 管理者がユーザー管理画面で対象ユーザーを検索する
5. 管理者がユーザーのMFA設定詳細を確認する
6. 管理者がMFAリセット理由を入力する
7. 管理者がMFAリセットを実行する
8. システムがリセット確認画面を表示する
9. 管理者がリセット実行を最終確認する
10. システムが既存MFA設定を完全削除する
11. システムがリセット完了通知をユーザーに送信する
12. システムが監査ログに詳細を記録する

## 代替フロー
### 代替フロー1: セルフリセット（緊急時）
- 1a. ユーザーが緊急時セルフリセットを選択する場合
  - 1a1. システムが追加認証（メール認証等）を要求する
  - 1a2. ユーザーが追加認証を完了する
  - 1a3. システムが24時間の待機期間を設定する
  - 1a4. 待機期間経過後、自動的にMFAリセットを実行する
  - 1a5. 基本フロー11に進む

### 代替フロー2: 段階的リセット
- 7a. 部分的リセットが選択される場合
  - 7a1. 管理者がバックアップコードのみリセットを選択する
  - 7a2. システムが新しいバックアップコードを生成する
  - 7a3. システムが古いバックアップコードを無効化する
  - 7a4. 基本フロー11に進む

### 代替フロー3: 一括リセット（管理者権限）
- 3a. セキュリティ管理者が一括リセットを実行する場合
  - 3a1. セキュリティ管理者が部門または全社のMFAリセットを選択する
  - 3a2. システムが対象ユーザー一覧を表示する
  - 3a3. セキュリティ管理者がリセット理由を入力する
  - 3a4. システムが一括リセット確認画面を表示する
  - 3a5. セキュリティ管理者が実行を確認する
  - 3a6. システムが対象全ユーザーのMFAをリセットする

## 例外フロー
### 例外1: 本人確認失敗
- 2a. 管理者による本人確認が失敗した場合
  - 2a1. 管理者がリセット要求を却下する
  - 2a2. システムが却下理由をユーザーに通知する
  - 2a3. システムが却下ログを記録する
  - 2a4. ユーザーに追加証明書類の提出を案内する

### 例外2: システムエラー
- *a. リセット処理中にシステムエラーが発生した場合
  - *a1. システムがロールバック処理を実行する
  - *a2. システムがエラーログを記録する
  - *a3. システムが管理者にエラー通知を送信する
  - *a4. 既存MFA設定の整合性を確認する

### 例外3: 権限不足
- 3b. アクセスしたユーザーに十分な権限がない場合
  - 3b1. システムが権限不足エラーを表示する
  - 3b2. システムが不正アクセス試行ログを記録する
  - 3b3. システムがセキュリティ管理者に通知する
  - 3b4. ユーザーに適切な権限者への相談を案内する

### 例外4: 悪用防止
- *b. 短期間内に同一ユーザーの複数リセット要求を検知した場合
  - *b1. システムが不正利用の可能性を警告する
  - *b2. システムが追加承認プロセスを要求する
  - *b3. システムがセキュリティ管理者に報告する
  - *b4. 必要に応じてアカウント一時停止を実行する

## 特別要件
- **セキュリティ**: MFAリセットは最高レベルのセキュリティイベントとして記録・監視
- **監査性**: リセット理由、実行者、実行時刻を詳細に記録
- **可用性**: 緊急時のセルフリセット機能を提供（ただし厳格な制限付き）
- **承認プロセス**: 重要アカウントのリセットは複数承認を必須とする

## 関連ユースケース
- **包含**: なし
- **拡張**: 「MFAを有効化する」（リセット完了後の再設定）
- **汎化**: なし