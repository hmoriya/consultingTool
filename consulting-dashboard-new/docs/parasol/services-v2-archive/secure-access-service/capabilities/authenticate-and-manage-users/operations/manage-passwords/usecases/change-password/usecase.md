# ユースケース: パスワードを変更する

**バージョン**: 2.0.0
**更新日**: 2025-10-21
**設計方針**: パラソルドメイン連携 + ユーザーセキュリティ重視

## 基本情報
- **ユースケースID**: UC-PASS-01
- **アクター**: ユーザー（主アクター）、システム（副アクター）
- **概要**: ユーザーが現在のパスワードを新しいパスワードに安全に変更し、セキュリティポリシーに準拠させる

## 🏗️ パラソルドメイン連携

### 操作エンティティ
- **User**（自サービス管理）: passwordHash, passwordChangedAt, passwordExpiresAt を更新
- **Password**（値オブジェクト作成）: 新しいパスワードの強度評価・ハッシュ化
- **PasswordPolicy**（参照のみ）: ポリシー準拠チェック

### 他サービスユースケース利用
- **collaboration-facilitation-service**: UC-NOTIFY-01: パスワード変更完了通知を配信する
- **project-success-service**: UC-AUDIT-01: パスワード変更を監査記録する

## 事前条件
- ユーザーが認証済みでシステムにログインしている
- 現在のパスワードを知っている
- アカウントがロックされていない
- パスワード変更権限を持っている

## 事後条件
### 成功時
- 新しいパスワードがハッシュ化されてUserエンティティに保存されている
- passwordChangedAt が現在日時に更新されている
- passwordExpiresAt が新しい有効期限に更新されている
- パスワード変更完了通知が配信されている
- 監査ログに変更記録が残されている

### 失敗時
- パスワードは変更されていない
- エラーメッセージが表示されている
- 失敗理由が監査ログに記録されている

## 基本フロー
1. **ユーザー**がパスワード変更フォームにアクセスする
2. **システム**が現在のパスワード入力フィールドと新しいパスワード入力フィールドを表示する
3. **ユーザー**が現在のパスワードを入力する
4. **システム**が現在のパスワードを検証する
5. **ユーザー**が新しいパスワードと確認用パスワードを入力する
6. **システム**がリアルタイムでパスワード強度を評価・表示する（UC-PASS-04連携）
7. **ユーザー**がパスワード変更を実行する
8. **システム**がPasswordPolicyに基づく準拠チェックを実行する
9. **システム**が新しいパスワードをハッシュ化し、Userエンティティを更新する
10. **システム**がパスワード変更完了通知を配信する（他サービス連携）
11. **システム**が監査ログを記録する（他サービス連携）
12. **システム**が成功メッセージを表示する

## 代替フロー

### 代替フロー1: ポリシー違反時の教育案内
- **分岐点**: ステップ8（ポリシー準拠チェック）
- **条件**: 新しいパスワードがポリシーに違反している
- **処理**:
  - 8a1. システムが具体的な違反内容を表示する
  - 8a2. システムが推奨パスワード例を提示する
  - 8a3. システムがセキュリティ教育リンクを表示する
  - 8a4. ステップ5に戻る（再入力）

### 代替フロー2: 強制変更期限切れ対応
- **分岐点**: ステップ1（フォームアクセス）
- **条件**: パスワード有効期限が切れている
- **処理**:
  - 1a1. システムが期限切れ警告を表示する
  - 1a2. システムが緊急変更モードでフォームを表示する
  - 1a3. ステップ2に続行する

## 例外フロー

### 例外1: 現在パスワードが不正
- **発生点**: ステップ4（現在パスワード検証）
- **処理**:
  - 4e1. システムが「現在のパスワードが正しくありません」エラーを表示する
  - 4e2. 失敗回数をカウント・記録する
  - 4e3. ステップ3に戻る

### 例外2: システム障害
- **発生点**: ステップ9（エンティティ更新）
- **処理**:
  - 9e1. システムがトランザクションをロールバックする
  - 9e2. システムが「一時的なエラーが発生しました」メッセージを表示する
  - 9e3. エラー詳細を管理者に通知する

## 特別要件

### セキュリティ要件
- 現在のパスワード検証必須
- 新しいパスワードのハッシュ化（bcrypt、コスト12以上）
- パスワード履歴チェック（過去5世代の再利用禁止）
- ブルートフォース攻撃対策（失敗回数制限）

### 性能要件
- パスワード強度評価：リアルタイム（500ms以内）
- パスワード変更処理：3秒以内
- 同時変更可能ユーザー数：100ユーザー

### ユーザビリティ要件
- パスワード強度の視覚的表示
- リアルタイムバリデーション
- 明確なエラーメッセージ
- 改善提案の提示

## ドメインサービス連携
- **PasswordSecurityService.strengthen[PasswordResilience]()**: パスワード耐性強化
- **PasswordComplianceService.validate[PasswordComplexity]()**: 複雑性検証
- **PasswordSecurityService.prevent[SecurityBreaches]()**: セキュリティ侵害予防

## 関連ユースケース
- **UC-PASS-04**: パスワード強度を検証する（リアルタイム強度表示）
- **UC-PASS-02**: パスワードポリシーを設定する（準拠チェック基準）
- **UC-AUTH-01**: ユーザー認証を実行する（事前認証）

---
*このユースケースは、パラソル設計v2.0仕様に基づき、セキュリティ強化と1対1ページ対応を実現しています*