# ユースケース: パスワードをリセットする

**バージョン**: 2.0.0
**更新日**: 2025-10-21
**設計方針**: ワークフロー重視・セキュリティ強化

## 基本情報
- **ユースケースID**: UC-PASS-03
- **アクター**: ユーザー（主アクター）、管理者（副アクター）、システム（副アクター）
- **概要**: パスワードを忘れたユーザーまたは管理者が、安全なプロセスを通じてパスワードをリセットし、新しいパスワードを設定する

## 🏗️ パラソルドメイン連携

### 操作エンティティ
- **User**（自サービス管理）: passwordResetToken, passwordHash, passwordChangedAt, failedLoginAttempts を更新
- **Password**（値オブジェクト作成）: 新しいパスワードの生成・ハッシュ化
- **PasswordSecurityAggregate**（集約管理）: リセットプロセスの統合管理

### 他サービスユースケース利用
- **collaboration-facilitation-service**: UC-NOTIFY-02: セキュリティアラートを送信する
- **collaboration-facilitation-service**: UC-NOTIFY-01: パスワードリセット完了通知を配信する
- **project-success-service**: UC-AUDIT-03: セキュリティイベントを監査記録する
- **knowledge-co-creation-service**: UC-KNOWLEDGE-02: パスワード教育資料を蓄積する

## 事前条件
- ユーザーアカウントが存在している
- メールアドレスが有効で到達可能である
- アカウントが永久停止されていない
- リセット要求制限（24時間に3回）に達していない

## 事後条件
### 成功時（ユーザー主導リセット）
- passwordResetTokenが無効化されている
- 新しいパスワードがハッシュ化されてUserエンティティに保存されている
- passwordChangedAt が現在日時に更新されている
- failedLoginAttempts がリセット（0）されている
- パスワードリセット完了通知が配信されている
- セキュリティイベントが監査ログに記録されている

### 成功時（管理者代行リセット）
- 管理者による代行リセットが監査ログに記録されている
- ユーザーに管理者リセット通知が配信されている
- 次回ログイン時のパスワード変更が強制設定されている

### 失敗時
- パスワードは変更されていない
- 失敗理由がセキュリティログに記録されている
- 異常なリセット要求の場合、セキュリティアラートが発動している

## 基本フロー（ユーザー主導リセット）
1. **ユーザー**がパスワードリセット要求ページにアクセスする
2. **システム**がメールアドレス入力フォームを表示する
3. **ユーザー**が登録済みメールアドレスを入力する
4. **システム**がメールアドレスの有効性を確認する
5. **システム**が一意のリセットトークンを生成し、Userエンティティに保存する
6. **システム**がリセット用URLを含むメールを送信する（他サービス連携）
7. **ユーザー**がメール内のリセットURLをクリックする
8. **システム**がトークンの有効性（有効期限1時間以内）を検証する
9. **システム**が新しいパスワード設定フォームを表示する
10. **ユーザー**が新しいパスワードと確認用パスワードを入力する
11. **システム**がPasswordPolicyに基づく準拠チェックを実行する
12. **システム**が新しいパスワードをハッシュ化し、Userエンティティを更新する
13. **システム**がリセットトークンを無効化する
14. **システム**がパスワードリセット完了通知を配信する（他サービス連携）
15. **システム**がセキュリティイベントを監査ログに記録する（他サービス連携）
16. **システム**が成功メッセージとログイン画面への遷移を表示する

## 代替フロー

### 代替フロー1: 管理者による代行リセット
- **分岐点**: ステップ1（リセット要求開始）
- **条件**: ユーザーが自分でリセットできない状況
- **処理**:
  - 1a1. 管理者が管理者リセット画面にアクセスする
  - 1a2. 管理者が対象ユーザーを検索・選択する
  - 1a3. 管理者がリセット理由と緊急度を入力する
  - 1a4. システムが管理者権限を確認する
  - 1a5. システムが一時パスワードを生成する
  - 1a6. システムが一時パスワードとリセット通知をユーザーに送信する（他サービス連携）
  - 1a7. システムが次回ログイン時のパスワード変更を強制設定する
  - 1a8. システムが管理者代行リセットを監査ログに記録する（他サービス連携）

### 代替フロー2: 複数回失敗によるセキュリティ強化
- **分岐点**: ステップ3（メールアドレス入力）
- **条件**: 存在しないメールアドレスの頻繁な要求
- **処理**:
  - 3a1. システムが異常なリセット要求パターンを検出する
  - 3a2. システムがCAPTCHA認証を追加で要求する
  - 3a3. システムがセキュリティアラートを管理者に送信する（他サービス連携）
  - 3a4. ステップ4に続行（強化された検証）

### 代替フロー3: トークン期限切れ時の再発行
- **分岐点**: ステップ8（トークン検証）
- **条件**: リセットトークンの有効期限が切れている
- **処理**:
  - 8a1. システムが期限切れメッセージを表示する
  - 8a2. システムが新しいリセット要求の選択肢を提供する
  - 8a3. ユーザーが再リセット要求を選択した場合、ステップ2に戻る

## 例外フロー

### 例外1: 存在しないメールアドレス
- **発生点**: ステップ4（メールアドレス確認）
- **処理**:
  - 4e1. システムが一般的な成功メッセージを表示する（セキュリティ対策）
    - 「リセット手順をメールで送信しました。メールをご確認ください」
  - 4e2. システムが実際のメールは送信しない
  - 4e3. システムが異常な試行を内部ログに記録する

### 例外2: 頻繁なリセット要求（ブルートフォース対策）
- **発生点**: ステップ5（トークン生成）
- **処理**:
  - 5e1. システムがリセット要求制限（24時間に3回）を確認する
  - 5e2. 制限超過の場合、システムが一時的なアクセス制限を適用する
  - 5e3. システムがセキュリティアラートを管理者に送信する（他サービス連携）
  - 5e4. 一般的なメッセージを表示（制限の詳細は秘匿）

### 例外3: 無効なリセットトークン
- **発生点**: ステップ8（トークン検証）
- **処理**:
  - 8e1. システムが「無効なリンクです」エラーを表示する
  - 8e2. システムが不正アクセス試行を記録する
  - 8e3. システムが新しいリセット要求ページへのリンクを提供する

## 特別要件

### セキュリティ要件
- リセットトークンの暗号化強度（256bit）
- トークン有効期限（1時間）の厳格な管理
- リセット要求制限（24時間に3回）
- 管理者代行リセットの多段階認証
- すべてのリセット操作の完全な監査証跡

### 性能要件
- メール送信：10秒以内
- トークン検証：2秒以内
- パスワードリセット処理：5秒以内
- 同時リセット要求処理：50件/分

### ユーザビリティ要件
- 明確なリセット手順の説明
- 進行状況の視覚的表示
- 分かりやすいエラーメッセージ
- モバイルフレンドリーなUI

### 法的・コンプライアンス要件
- GDPR準拠（データ処理の同意確認）
- セキュリティ侵害時の適切な通知
- 監査要件への完全対応

## ドメインサービス連携
- **PasswordSecurityService.coordinate[EmergencyAccess]()**: 緊急アクセス調整
- **PasswordSecurityService.prevent[SecurityBreaches]()**: セキュリティ侵害予防
- **PasswordComplianceService.validate[PasswordComplexity]()**: 新パスワード複雑性検証

## 入出力仕様

### リセット要求入力
```json
{
  "resetRequest": {
    "email": "user@example.com",
    "captchaToken": "optional_captcha_token",
    "clientInfo": {
      "ipAddress": "192.168.1.100",
      "userAgent": "Mozilla/5.0...",
      "timestamp": "2024-10-21T10:30:00Z"
    }
  }
}
```

### リセット実行入力
```json
{
  "passwordReset": {
    "resetToken": "encrypted_reset_token",
    "newPassword": "string",
    "confirmPassword": "string"
  }
}
```

### 出力（API → ページ）
```json
{
  "result": "success",
  "resetTokenId": "UUID",
  "expiresAt": "2024-10-21T11:30:00Z",
  "securityLevel": "standard/enhanced",
  "nextActions": [
    "メール確認",
    "リセットURL クリック",
    "新パスワード設定"
  ],
  "estimatedTime": "15分以内"
}
```

## 関連ユースケース
- **UC-PASS-01**: パスワードを変更する（リセット後の通常変更）
- **UC-PASS-04**: パスワード強度を検証する（新パスワードの強度確認）
- **UC-AUTH-01**: ユーザー認証を実行する（リセット後の認証）
- **UC-NOTIFY-02**: セキュリティアラートを送信する（他サービス連携）

---
*このユースケースは、セキュリティと利便性を両立し、緊急時の確実なアクセス復旧を実現するパラソル設計v2.0仕様に基づいています*