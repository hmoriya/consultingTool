# ユースケース: パスワードポリシーを設定する

**バージョン**: 2.0.0
**更新日**: 2025-10-21
**設計方針**: パラソルドメイン連携 + 組織セキュリティ統制

## 基本情報
- **ユースケースID**: UC-PASS-02
- **アクター**: セキュリティ管理者（主アクター）、システム（副アクター）
- **概要**: セキュリティ管理者が組織全体のパスワードセキュリティポリシーを設定し、全ユーザーのパスワードに適用される基準を統制する

## 🏗️ パラソルドメイン連携

### 操作エンティティ
- **PasswordPolicy**（自サービス管理）: 新規作成・更新（minLength, complexityScore, maxAge, historyCount 等）
- **Organization**（参照のみ）: 組織情報の確認
- **PasswordSecurityAggregate**（集約管理）: ポリシー変更の統合管理

### 他サービスユースケース利用
- **collaboration-facilitation-service**: UC-NOTIFY-03: ポリシー変更通知を配信する
- **project-success-service**: UC-AUDIT-02: ポリシー違反を監査記録する
- **knowledge-co-creation-service**: UC-KNOWLEDGE-02: パスワード教育資料を蓄積する

## 事前条件
- セキュリティ管理者がシステムに認証済みでログインしている
- セキュリティ管理者権限を持っている
- 組織IDが確定している
- 現在のポリシー設定が確認できている

## 事後条件
### 成功時
- 新しいPasswordPolicyエンティティが作成・更新されている
- 全ユーザーへのポリシー変更通知が配信されている
- 影響ユーザー数と準拠状況分析が完了している
- ポリシー変更が監査ログに記録されている
- 教育資料が更新・配信されている

### 失敗時
- ポリシー設定は変更されていない
- エラーの詳細と原因が記録されている
- 管理者にエラー通知が送信されている

## 基本フロー
1. **セキュリティ管理者**がポリシー設定画面にアクセスする
2. **システム**が現在のポリシー設定と影響範囲を表示する
3. **セキュリティ管理者**が新しいポリシー要件を設定する
   - 最小文字数（minLength）
   - 複雑性要件（大文字・小文字・数字・記号）
   - パスワード有効期間（maxAge）
   - 履歴保持数（historyCount）
   - 最小複雑性スコア（complexityScore）
4. **システム**がリアルタイムで影響ユーザー数を算出・表示する
5. **システム**が現在の準拠率と新ポリシー適用後の推定準拠率を表示する
6. **セキュリティ管理者**がポリシー適用を確認・実行する
7. **システム**がPasswordPolicyエンティティを作成・更新する
8. **システム**が全ユーザーへのポリシー変更通知を配信する（他サービス連携）
9. **システム**が監査ログにポリシー変更を記録する（他サービス連携）
10. **システム**がパスワード教育資料を更新する（他サービス連携）
11. **システム**が設定完了と影響分析結果を表示する

## 代替フロー

### 代替フロー1: 段階的適用（猶予期間設定）
- **分岐点**: ステップ6（ポリシー適用確認）
- **条件**: 影響ユーザー数が大きく、即座適用が困難
- **処理**:
  - 6a1. システムが猶予期間設定オプションを表示する
  - 6a2. セキュリティ管理者が猶予期間（7日〜90日）を設定する
  - 6a3. システムが段階的適用スケジュールを生成・表示する
  - 6a4. ステップ7に続行（猶予期間付きポリシー作成）

### 代替フロー2: テストモード（一部ユーザー先行適用）
- **分岐点**: ステップ6（ポリシー適用確認）
- **条件**: 新ポリシーの影響を事前評価したい場合
- **処理**:
  - 6b1. システムがテスト対象ユーザー選択画面を表示する
  - 6b2. セキュリティ管理者がテスト対象（5-10%のユーザー）を選択する
  - 6b3. システムがテストモードでポリシーを適用する
  - 6b4. 1週間の評価期間後、本格適用を判断する

## 例外フロー

### 例外1: ポリシー設定値の矛盾
- **発生点**: ステップ3（ポリシー要件設定）
- **処理**:
  - 3e1. システムが設定値の矛盾を検出・表示する
    - 例: 「最小文字数12文字 + 複雑性要件なし」は弱いポリシー
  - 3e2. システムが推奨設定値を提示する
  - 3e3. ステップ3に戻る（再設定）

### 例外2: 準拠率が極端に低下
- **発生点**: ステップ5（準拠率表示）
- **処理**:
  - 5e1. システムが準拠率低下警告（50%以下）を表示する
  - 5e2. システムが段階的適用や教育期間設定を推奨する
  - 5e3. セキュリティ管理者に適用方針の再検討を促す

### 例外3: システム障害による適用失敗
- **発生点**: ステップ7（ポリシー作成・更新）
- **処理**:
  - 7e1. システムがトランザクションをロールバックする
  - 7e2. 設定内容を一時保存し、復旧後に再適用可能にする
  - 7e3. 管理者に障害通知とエスカレーション手順を送信する

## 特別要件

### セキュリティ要件
- ポリシー変更権限の厳格な管理（セキュリティ管理者のみ）
- ポリシー変更履歴の完全な監査証跡
- 悪意のあるポリシー変更の検出と防止
- 緊急時のポリシー無効化機能

### 性能要件
- 影響ユーザー数算出：2秒以内
- 準拠率分析：5秒以内
- ポリシー適用処理：10秒以内（1000ユーザーまで）
- 通知配信：バックグラウンド処理（30分以内に全配信）

### ビジネス要件
- 法的コンプライアンス要件への準拠
- 業界標準（ISO27001、SOC2等）への対応
- 組織のリスクレベルに応じたポリシー調整
- ユーザビリティとセキュリティのバランス

## ドメインサービス連携
- **PasswordComplianceService.enforce[PolicyCompliance]()**: ポリシー準拠の強制
- **PasswordSecurityService.coordinate[PolicyUpdates]()**: ポリシー更新の調整
- **PasswordComplianceService.monitor[PolicyAdherence]()**: ポリシー遵守の監視

## 入出力仕様

### 入力（ページ → API）
```json
{
  "policyConfiguration": {
    "organizationId": "UUID",
    "minLength": 12,
    "complexityRequirements": {
      "requireUpperCase": true,
      "requireLowerCase": true,
      "requireNumbers": true,
      "requireSymbols": true
    },
    "maxAge": 90,
    "historyCount": 5,
    "complexityScore": 80,
    "gracePerìod": 30,
    "testMode": false
  }
}
```

### 出力（API → ページ）
```json
{
  "result": "success",
  "policyId": "UUID",
  "affectedUsers": 1250,
  "complianceAnalysis": {
    "currentCompliance": 78,
    "estimatedCompliance": 45,
    "impactLevel": "high"
  },
  "rolloutSchedule": {
    "startDate": "2024-11-01",
    "fullEnforcement": "2024-12-01",
    "phases": ["notification", "grace_period", "enforcement"]
  },
  "nextActions": [
    "教育資料配信",
    "ユーザー向け変更案内",
    "準拠状況監視開始"
  ]
}
```

## 関連ユースケース
- **UC-PASS-01**: パスワードを変更する（新ポリシーの適用対象）
- **UC-PASS-04**: パスワード強度を検証する（新ポリシー基準での検証）
- **UC-AUTH-02**: 権限を検証する（ポリシー変更権限の確認）
- **UC-NOTIFY-03**: ポリシー変更通知を配信する（他サービス連携）

---
*このユースケースは、組織のセキュリティガバナンスを強化し、パラソル設計v2.0仕様による統合管理を実現しています*