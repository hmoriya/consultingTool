# ビジネスオペレーション: コミュニケーションを促進する

**バージョン**: 2.0.0
**更新日**: 2025-10-08
**設計方針**: ユースケース・ページ分解指向 + パラソルドメイン言語連携

## 📋 概要
**目的**: チームメンバー間の円滑なコミュニケーションを実現し、リアルタイムメッセージング、スレッド会話、ファイル共有を通じてチームの生産性と創造性を最大化する
**パターン**: Communication
**ゴール**: メッセージ投稿成功率99.9%以上、配信遅延100ms以内、アクティブユーザー率70%以上を達成

## 🎭 関係者とロール
- **チャネルメンバー**: メッセージの投稿・閲覧・リアクションを行うユーザー
- **チャネル管理者**: チャネル設定の変更・メンバー管理を担当
- **ワークスペース管理者**: ワークスペース全体のポリシー設定を担当
- **システム**: メッセージ配信・検索インデックス更新・通知生成を自動実行

## 🏗️ パラソルドメイン連携

### 主要エンティティ
このオペレーションで操作する主要なドメインエンティティ：

```
Entity: Channel (チャネル) - Aggregate Root
├── id: UUID - チャネル識別子
├── name: STRING_100 - チャネル名
├── type: ENUM - チャネルタイプ(public/private/direct)
├── workspaceId: UUID - 所属ワークスペース
└── 状態: active → archived（不可逆）

Entity: Message (メッセージ)
├── id: UUID - メッセージ識別子
├── channelId: UUID - 所属チャネル
├── authorId: UUID - 送信者
├── content: TEXT - メッセージ内容
├── type: ENUM - メッセージタイプ(text/file/system)
└── 状態: draft → posted → edited → deleted

Entity: ChannelMember (チャネルメンバー)
├── channelId: UUID - チャネル識別子
├── userId: UUID - ユーザー識別子
├── role: ENUM - ロール(owner/admin/member)
└── notificationEnabled: BOOLEAN - 通知設定

ValueObject: MentionContext (メンション文脈)
├── userId: UUID - メンション対象
├── position: INTEGER - テキスト内の位置
└── type: ENUM - メンションタイプ(user/team/channel)

Aggregate: ChannelAggregate (チャネル集約)
├── ルート: Channel
├── 包含: Message[], ChannelMember[], Thread[]
└── 不変条件: プライベートチャネルは招待制、アーカイブ後は投稿不可
```

### ドメインサービス
```
DomainService: CollaborationCoordinator
├── validateMessageContent() - メッセージ内容検証
├── processMessage() - メッセージ投稿処理
├── notifyMentions() - メンション通知送信
└── updateSearchIndex() - 検索インデックス更新
```

## 🔄 プロセスフロー（ユースケース分解指向）

> **重要**: 各ステップは「誰が何をするか」を明記し、ユースケース分解の根拠とする

### 基本フロー
1. **チャネルメンバーがメッセージ作成画面でテキスト入力を実行** → **UC1: メッセージを作成する**
   - **操作エンティティ**: Message
   - **必要ページ**: メッセージ作成ページ - テキスト入力・ファイル添付・メンション機能

2. **システムがメッセージ内容検証を実行** → **内部処理（ページなし）**
   - **ドメインサービス**: CollaborationCoordinator.validateMessageContent()

3. **チャネルメンバーがメッセージ送信ボタンをクリック** → **UC2: メッセージを送信する**
   - **操作エンティティ**: Message, ChannelAggregate
   - **必要ページ**: メッセージ送信確認ページ - 送信確認・プレビュー表示

4. **システムがメッセージ保存とチャネル配信を実行** → **内部処理（ページなし）**
   - **ドメインサービス**: CollaborationCoordinator.processMessage()

5. **チャネルメンバーが投稿済みメッセージを確認** → **UC3: メッセージを表示する**
   - **操作エンティティ**: Message, Channel
   - **必要ページ**: メッセージ表示ページ - 既読・未読表示・スレッド・リアクション機能

### ユースケース分解原則
- **ユーザー操作ステップ** → ユースケース + ページ
- **システム内部処理** → ドメインサービス（ページなし）
- **1ユースケース = 1つの明確な目的 = 1つのページ**

## 📄 ユースケース・ページ設計マトリックス

| UC# | ユースケース名 | 対応ページ | エンティティ | アクター | 設計方針 |
|-----|---------------|-----------|-------------|----------|----------|
| UC1 | メッセージを作成する | メッセージ作成ページ | Message | チャネルメンバー | 入力重視 - テキスト入力・ファイル添付・メンション |
| UC2 | メッセージを送信する | メッセージ送信確認ページ | Message, ChannelAggregate | チャネルメンバー | 操作重視 - 送信確認・プレビュー表示 |
| UC3 | メッセージを表示する | メッセージ表示ページ | Message, Channel | チャネルメンバー | 表示重視 - 既読表示・スレッド・リアクション |

## 🔀 代替フロー（ユースケース分岐指向）

### 代替フロー1: メンション付きメッセージ
- **分岐元**: 基本フロー ステップ1
- **条件**: メッセージに@マークでのメンションが含まれる
- **代替ユースケース**: UC1-Alt: メンションを含むメッセージを作成する
  - **必要ページ**: メンション付きメッセージ作成ページ - メンション候補表示・自動補完
  - **操作エンティティ**: Message, MentionContext

### 代替フロー2: ファイル添付メッセージ
- **分岐元**: 基本フロー ステップ1
- **条件**: ファイルが添付される
- **代替ユースケース**: UC1-Alt2: ファイル付きメッセージを作成する
  - **必要ページ**: ファイル添付メッセージ作成ページ - ファイルアップロード・プレビュー表示
  - **操作エンティティ**: Message, FileAttachment

### 代替フロー3: スレッド返信
- **分岐元**: 基本フロー ステップ3
- **条件**: 既存メッセージへの返信として投稿
- **代替ユースケース**: UC2-Alt: スレッドでメッセージを送信する
  - **必要ページ**: スレッド返信送信ページ - 親メッセージ表示・スレッド文脈表示
  - **操作エンティティ**: Message, Thread

## ⚠️ 例外フロー（エラーページ設計指向）

### 例外1: メッセージ内容検証エラー
- **発生ステップ**: ステップ2
- **エラーユースケース**: UC1-Error: メッセージ作成エラーを処理する
  - **必要ページ**: メッセージ作成エラーページ - エラー内容表示・修正方法提示・再入力フォーム
  - **表示情報**: 文字数制限超過、禁止ワード検出、ファイルサイズ超過

### 例外2: 送信権限エラー
- **発生ステップ**: ステップ4
- **エラーユースケース**: UC2-Error: メッセージ送信エラーを処理する
  - **必要ページ**: 送信権限エラーページ - 権限不足の説明・管理者連絡方法・代替チャネル提案
  - **表示情報**: 権限レベル、必要権限、回復手順

### 例外3: ネットワーク接続エラー
- **発生ステップ**: ステップ4
- **エラーユースケース**: UC2-Error2: ネットワークエラーを処理する
  - **必要ページ**: 接続エラーページ - 自動再試行・手動再送・下書き保存
  - **表示情報**: 接続状態、再試行回数、下書き保存状況

## 📊 ビジネス状態（エンティティライフサイクル）

```mermaid
stateDiagram-v2
    [*] --> draft: UC1実行（メッセージ作成）
    draft --> validating: UC2実行（送信クリック）
    validating --> posted: 検証成功
    validating --> draft: 検証失敗（UC1-Error）
    posted --> delivered: UC3表示可能
    posted --> edited: メッセージ編集
    edited --> posted: 再投稿
    posted --> deleted: 削除実行
    delivered --> read: メンバー閲覧
    deleted --> [*]
    read --> [*]
```

**状態とエンティティの対応**:
- **draft**: Message.type = 'draft', Message.content = 入力中テキスト
- **posted**: Message.type = 'text', Message.createdAt = 投稿時刻
- **delivered**: Channel.lastActivityAt = 最新メッセージ時刻

## 📏 KPI（ユースケース別成功指標）

| ユースケース | KPI | 目標値 | 測定方法 |
|-------------|-----|--------|----------|
| UC1 | メッセージ作成完了率 | 95%以上 | 作成開始/作成完了の比率 |
| UC2 | メッセージ送信成功率 | 99.9%以上 | 送信試行/送信成功の比率 |
| UC3 | メッセージ表示応答時間 | 100ms以内 | API応答時間の95パーセンタイル |

## 📜 ビジネスルール（ドメイン制約）

### エンティティ制約
- **Message**: content長は10,000文字以内 → CollaborationCoordinator.validateMessageContent()で実装
- **Channel**: アーカイブ後は新規投稿不可 → ChannelAggregate不変条件で実装
- **MentionContext**: 1メッセージ最大20メンション → ドメインサービスで実装

### ユースケース制約
- **UC1**: 下書き保存は24時間 → メッセージ作成ページバリデーションで実装
- **UC2**: 連続投稿は1分間10件まで → メッセージ送信ページで制限実装
- **UC3**: 既読状態は自動更新 → メッセージ表示ページで自動処理

## 🔗 入出力仕様（API・ページ連携）

### ユースケース別入出力

#### UC1: メッセージを作成する
**入力（ページ → API）**:
```json
{
  "messageData": {
    "content": "string - メッセージ本文",
    "channelId": "UUID - 投稿先チャネル",
    "mentions": ["UUID[] - メンション対象ユーザー"],
    "attachments": ["FileAttachment[] - 添付ファイル"]
  }
}
```

**出力（API → ページ）**:
```json
{
  "result": "success/error",
  "message": {
    "id": "UUID",
    "content": "string",
    "status": "draft"
  },
  "nextAction": "UC2実行可能 | エラー修正要求"
}
```

#### UC2: メッセージを送信する
**入力（ページ → API）**:
```json
{
  "sendData": {
    "messageId": "UUID - 送信対象メッセージ",
    "confirmSend": "boolean - 送信確認"
  }
}
```

**出力（API → ページ）**:
```json
{
  "result": "success/error",
  "message": {
    "id": "UUID",
    "status": "posted",
    "timestamp": "ISO8601"
  },
  "nextAction": "UC3表示可能"
}
```

#### UC3: メッセージを表示する
**入力（ページ → API）**:
```json
{
  "displayParams": {
    "channelId": "UUID - 表示対象チャネル",
    "limit": "number - 表示件数",
    "before": "ISO8601 - 取得基準時刻"
  }
}
```

**出力（API → ページ）**:
```json
{
  "result": "success/error",
  "messages": [
    {
      "id": "UUID",
      "content": "string",
      "author": {"id": "UUID", "name": "string"},
      "timestamp": "ISO8601",
      "readBy": ["UUID[]"],
      "reactions": [{"emoji": "string", "count": "number"}]
    }
  ],
  "hasMore": "boolean"
}
```

## 🚀 実装指針

### 推奨実装順序
1. **パラソルドメイン言語実装** - Message, Channel, ChannelMemberエンティティ
2. **ドメインサービス実装** - CollaborationCoordinator中核ロジック
3. **UC1実装** - メッセージ作成ページ + API
4. **UC2実装** - メッセージ送信ページ + API
5. **UC3実装** - メッセージ表示ページ + API
6. **代替・例外フロー実装** - メンション、ファイル添付、エラー処理
7. **統合テスト** - プロセスフロー全体の検証

### 品質チェックポイント
- [ ] 各ユースケースに対応するページが1対1で存在する
- [ ] Message, Channel エンティティが正しく操作される
- [ ] ビジネス状態遷移がエンティティ状態と一致する
- [ ] 代替・例外フローにも適切なページが用意される
- [ ] KPI目標値が実装で達成可能である

---
*このビジネスオペレーション設計は、ユースケース・ページ分解とパラソルドメイン言語連携を強化した設計指針v2.0に基づいています*