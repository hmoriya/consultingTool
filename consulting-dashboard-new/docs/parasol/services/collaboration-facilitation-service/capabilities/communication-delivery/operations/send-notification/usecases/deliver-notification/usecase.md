# ユースケース: 通知を配信する

**ユースケースID**: UC-NOTIFY-02
**バージョン**: 2.0.0
**更新日**: 2025-10-10
**設計方針**: パラソルv2.0仕様 + 確実な配信実行 + リアルタイム監視

## 📋 基本情報
- **主アクター**: システム（自動配信）、配信管理者
- **副アクター**: 配信基盤システム、外部通知サービス（メール・SMS等）
- **概要**: 作成・承認された通知コンテンツを対象者に確実に配信し、配信状況をリアルタイムで監視する

## 🎯 事前条件
- UC-NOTIFY-01（通知コンテンツを作成する）が完了し、NotificationContent.status="ready"
- 配信対象者・タイミング・チャネルが適切に設定されている
- 配信に必要なシステム・外部サービスが正常稼働している
- 配信権限・配信制限の確認が完了している

## ✅ 事後条件

### 成功時
- NotificationDelivery エンティティが作成され、配信記録が保存される
- 全対象者への配信が実行され、status="delivered"または"processing"
- 配信状況がリアルタイムで監視・記録されている
- 次フェーズ（配信状況確認・分析）への移行準備が完了している

### 失敗時
- 配信エラーが特定され、エラー内容・対象者が記録される
- 部分配信の場合、成功・失敗の詳細が分離記録される
- 配信再試行またはエラー処理の方針が決定される

## 🔄 基本フロー

1. **システムが配信実行準備を開始する**
   - 配信予約時刻の確認・配信条件の最終チェック
   - 配信対象者リストの検証・重複除外・オプトアウト確認

2. **システムが配信前確認を実行する**
   - 内部処理: NotificationDeliveryService.prepareDelivery()
   - コンテンツ整合性・配信チャネル可用性・システムリソースの確認
   - 大量配信の場合の負荷分散・段階配信の準備

3. **システムが配信を実行する**
   - 内部処理: NotificationDeliveryService.executeDelivery()
   - チャネル別配信（メール・アプリ・SMS・Webプッシュ）の並行実行
   - 配信優先度・緊急度に基づく配信順序制御

4. **システムが配信状況を監視する**
   - 内部処理: NotificationDeliveryService.monitorDelivery()
   - 配信成功・失敗・エラーのリアルタイム検出
   - 配信遅延・システム負荷・外部サービス障害の監視

5. **システムが配信結果を記録する**
   - 内部処理: NotificationDeliveryService.recordResults()
   - 対象者別配信結果（成功・失敗・保留）の詳細記録
   - 配信時刻・応答時間・エラー内容の記録

6. **システムが配信完了処理を実行する**
   - NotificationContent.status="delivered"への更新
   - 配信統計・サマリー情報の生成
   - 次ステップ（開封追跡・効果測定）への準備

7. **配信管理者への完了通知**
   - 配信完了・配信統計の報告
   - エラー・問題があった場合の詳細レポート
   - 必要に応じた再配信・追加対応の提案

## 🔀 代替フロー

### 代替フロー1: 段階配信による負荷分散
- **分岐点**: 基本フロー ステップ3
- **条件**: 大量配信・システム負荷軽減が必要
- **代替処理**:
  1. システムが対象者をグループ分割・配信スケジュール作成
  2. グループ別順次配信・配信間隔制御の実行
  3. 全グループ配信完了・統合結果記録の実行

### 代替フロー2: 緊急配信による優先処理
- **分岐点**: 基本フロー ステップ1
- **条件**: 緊急度が「緊急」で即座配信が必要
- **代替処理**:
  1. システムが緊急配信モード・優先キュー処理を開始
  2. 通常配信の一時停止・リソース優先割り当て
  3. 緊急配信完了後の通常配信再開・遅延最小化

## ⚠️ 例外フロー

### 例外1: 配信チャネル障害・配信失敗
- **発生点**: 基本フロー ステップ3
- **条件**: メールサーバー・外部API・ネットワーク障害
- **処理**:
  1. システムが障害チャネル特定・代替チャネル検討
  2. 部分配信継続・失敗対象者の記録・再配信スケジューリング
  3. 配信管理者への障害通知・手動介入要請

### 例外2: 配信制限・ポリシー違反検出
- **発生点**: 基本フロー ステップ2
- **条件**: 配信量制限・スパム判定・ポリシー違反の検出
- **処理**:
  1. システムが制限内容・違反詳細・影響範囲を分析
  2. 配信計画調整・配信内容修正・承認者確認の実行
  3. 制限解除・修正完了後の配信再開

## 🏗️ パラソルドメイン連携

### 操作エンティティ
- **NotificationDelivery**: 配信実行（status="processing"→"delivered", deliveryResults, metrics）
- **NotificationContent**: 配信状況更新（status="ready"→"delivered", deliveredAt, deliveryCount）
- **DeliveryLog**: 配信詳細記録（channelType, targetUserId, deliveredAt, result, errorMessage）

### 集約操作
- **NotificationAggregate**: 配信ライフサイクル統合管理
- **不変条件確認**: 配信権限妥当性、対象者整合性、配信制限準拠

### ドメインサービス利用
- **NotificationDeliveryService**:
  - `prepareDelivery()`: 配信準備・最終確認
  - `executeDelivery()`: マルチチャネル配信実行
  - `monitorDelivery()`: リアルタイム監視
  - `recordResults()`: 配信結果記録
- **NotificationSecurityService**:
  - `validateDeliveryPolicy()`: 配信ポリシー検証

## 🔗 他サービス連携（ユースケース利用型）

### 必須連携
- **[secure-access-service]**:
  - `UC-AUTH-02: 権限を検証する` → 配信権限確認
  - `UC-LOG-01: アクセスログを記録する` → 配信ログ記録

### オプション連携
- **[productivity-visualization-service]**:
  - `UC-MONITOR-01: システム負荷を監視する` → 配信負荷監視
- **[collaboration-facilitation-service]**:
  - `UC-ALERT-01: 障害通知を配信する` → 配信障害時の管理者通知

## 📊 成功指標・KPI
- **配信成功率**: 95%以上（全チャネル合計）
- **配信完了時間**: 予定時刻±5分以内
- **システム応答時間**: 通常配信3秒以内、緊急配信1秒以内
- **配信エラー復旧時間**: 15分以内（自動復旧または手動介入）

## 📝 特別要件

### パフォーマンス要件
- 大量配信: 10,000件/分の配信能力
- 同時配信: 複数チャネル並行処理
- 応答時間: チャネル別配信開始3秒以内

### セキュリティ要件
- 配信対象者情報の厳格な保護
- 配信内容の送信時暗号化
- 配信履歴・ログの改ざん防止
- 不正配信・スパム防止機能

### 可用性要件
- 配信システム可用性: 99.9%以上
- 障害時の自動フェイルオーバー
- 配信失敗時の自動再試行（最大3回）
- 障害復旧時の配信再開機能

## 🔄 関連ユースケース
- **前提**: UC-NOTIFY-01（通知コンテンツを作成する）の完了
- **後続**: UC-NOTIFY-03（配信状況を確認する）、配信効果分析
- **代替**: 段階配信フロー、緊急配信フロー
- **例外**: 配信障害対応、制限解除・修正フロー

---
*このユースケースは、確実で効率的な組織コミュニケーションを実現するパラソルv2.0設計指針に基づいています*
