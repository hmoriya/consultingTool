# ユースケース: 成果物更新を処理する

## 基本情報
- **ユースケースID**: UC-DELIVER-01
- **アクター**: コンサルタント、PM
- **概要**: 成果物の更新を受け付け、バージョン管理システムでの変更履歴記録とバージョン番号の付与を行う

## 事前条件
- ユーザーがログインしている（User.status = "active"）
- 更新対象の成果物が存在している（Deliverable.status = "active"）
- ユーザーが成果物の更新権限を持っている
- 成果物がロック状態でない（concurrency_lock = false）

## 事後条件
### 成功時
- 成果物が新しいバージョンで更新されている（Deliverable.version = incremented）
- 変更履歴が記録されている（VersionHistory.status = "recorded"）
- バージョン管理メタデータが更新されている
- 関係者に変更通知が配信されている
- 更新後の成果物が利用可能状態になっている

### 失敗時
- 更新処理がロールバックされている
- エラー詳細がログに記録されている
- ユーザーにエラー内容が通知されている
- 成果物の状態が更新前に復元されている

## 基本フロー
1. **コンサルタントが成果物更新を開始する**
   - 更新対象成果物の選択・変更内容の入力
   - 変更理由の記載・バージョンタイプの選択（パッチ/マイナー/メジャー）

2. **システムが更新権限を検証する**
   - → UC-AUTH-02: 成果物更新権限を検証する
   - ユーザーロールと成果物アクセス権限の確認
   - 同時編集制御のためのロック状態確認

3. **システムが変更内容を解析・バリデーションする**
   - ファイル形式・サイズ制限の確認
   - 変更内容の整合性チェック・差分分析の実行
   - バージョン番号の自動決定（変更レベルに応じて）

4. **システムが新バージョンとして保存する**
   - 成果物の新バージョン保存・メタデータの更新
   - 変更履歴の記録・前バージョンとの関連付け

5. **システムが変更通知と履歴更新を実行する**
   - → UC-NOTIFY-01: 成果物変更通知を配信する
   - プロジェクトメンバーへの通知配信
   - 成果物管理ダッシュボードの更新

## 代替フロー
### 代替フロー1: マイナーバージョンアップ
- 3a. 機能追加レベルの変更の場合
  - 3a1. システムがマイナーバージョン番号を自動インクリメント
  - 3a2. 機能追加に関するレビュー要求を関係者に通知
  - 3a3. 基本フロー4（新バージョン保存）に進む

### 代替フロー2: メジャーバージョンアップ
- 3b. 大幅な変更・互換性なしの場合
  - 3b1. システムがメジャーバージョン番号をインクリメント
  - 3b2. 管理者承認フローを開始（重要な変更のため）
  - 3b3. 承認完了後、基本フロー4に戻る

## 例外フロー
### 例外1: 同時編集競合
- *a. 他ユーザーが同じ成果物を編集中の場合
  - *a1. → UC-AUTH-03: 同時編集競合ログを記録する
  - *a2. 競合状況をユーザーに通知・編集中ユーザー情報の表示
  - *a3. 待機またはマージ編集の選択肢を提供
  - *a4. 競合解決後、基本フロー1に復帰

### 例外2: バージョン管理システム障害
- *b. バージョン管理システムにアクセスできない場合
  - *b1. 一時的なローカル保存を実行
  - *b2. システム復旧後の自動同期をスケジュール
  - *b3. 管理者に障害通知・手動復旧手順の案内
  - *b4. 復旧完了後、基本フロー4に再挑戦

### 例外3: ストレージ容量不足
- *c. ストレージ容量が不足している場合
  - *c1. 容量不足の詳細情報を表示
  - *c2. 古いバージョンのアーカイブを提案
  - *c3. 管理者に容量拡張要求を送信
  - *c4. 容量確保後、基本フロー4に復帰

## 特別要件
- **性能**: ファイル更新処理5秒以内、バージョン保存10秒以内
- **可用性**: バージョン管理システム稼働率99.9%以上
- **セキュリティ**: 更新履歴暗号化、アクセス権限厳格管理、変更証跡保存
- **精度**: バージョン番号付与精度100%、変更履歴記録精度100%
- **ユーザビリティ**: 直感的な更新インターフェース、明確な進捗表示

## 関連ユースケース
- **包含**: UC-AUTH-02（権限検証）、UC-AUTH-03（ログ記録）、UC-NOTIFY-01（通知配信）
- **前提**: 成果物作成、ユーザー認証完了必須
- **後続**: バージョン履歴表示、成果物配布、品質レビュー

---
*このユースケースは パラソル設計v2.0仕様 に基づいて作成されました*
