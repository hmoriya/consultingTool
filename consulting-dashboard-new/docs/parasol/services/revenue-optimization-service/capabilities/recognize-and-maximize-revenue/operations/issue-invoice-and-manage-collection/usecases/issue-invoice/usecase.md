# ユースケース: 請求書を発行する

## 基本情報
- **ユースケースID**: UC-INVOICE-01
- **アクター**: 財務マネージャー、PM、経理担当者
- **概要**: 納品完了したプロジェクトに対して精度の高い請求書を発行し、確実な収益確保を実現する

## 事前条件
- 財務マネージャーが適切な請求権限を有している
- プロジェクトの納品が完了している（UC-PROJECT-02で確認可能）
- InvoiceEntity（draft状態）が初期化可能である
- 請求根拠資料が揃っている

## 事後条件
### 成功時
- 精度99%以上の請求書が発行されている
- InvoiceEntity（状態変更: draft → issued → sent）
- PaymentEntity（入金予定情報）が生成されている
- クライアントへの請求書送付通知が配信されている

### 失敗時
- 請求書発行エラーが記録されている
- InvoiceEntity（状態: draft）が維持されている
- エラー内容が関係者に通知されている

## 基本フロー
1. **財務マネージャーが請求書発行プロセスを開始する**
   - → UC-AUTH-01: ユーザー認証を実行する
   - → UC-AUTH-02: 請求権限を検証する
   - InvoiceEntity（状態初期化: draft）

2. **システムが納品・収益情報を収集・統合する**
   - → UC-PROJECT-01: プロジェクト進捗情報を取得する
   - → UC-PROJECT-02: 納品状況を確認する
   - → UC-PROJECT-03: 請求基準情報を取得する

3. **財務マネージャーが請求書を作成・最適化する**
   - InvoiceOptimizationService による精度向上支援
   - PaymentEntity（入金予定・支払条件）作成
   - 請求根拠資料との整合性確認・調整

4. **システムが請求書品質を検証・確定する**
   - CollectionIntelligenceService による回収可能性評価
   - 請求精度99%達成確認・品質保証
   - InvoiceEntity（状態変更: draft → issued）

5. **請求書を送付・追跡準備する**
   - CashFlowMaximizationService（キャッシュフロー予測）更新
   - → UC-COMM-01: 請求書送付通知を配信する
   - InvoiceEntity（状態変更: issued → sent）

## 代替フロー
### 代替フロー1: AI支援による精度向上
- 3a. InvoiceOptimizationService が精度向上を提案した場合
  - 3a1. AI分析による請求内容最適化実行
  - 3a2. 類似請求事例の参照・学習適用
  - 3a3. CollectionIntelligenceService による回収戦略提案
  - 3a4. 基本フロー4（品質検証）に戻る

### 代替フロー2: 緊急請求書発行
- 1a. 月末締めなど緊急性が高い請求要求の場合
  - 1a1. → UC-COMM-03: 緊急請求会議を調整する
  - 1a2. 24時間以内の短縮プロセス適用
  - 1a3. 緊急発行フロー（最小限品質確保）
  - 1a4. 基本フロー4（品質検証）に戻る

## 例外フロー
### 例外1: プロジェクト情報取得失敗
- *a. project-success-service連携エラーが発生した場合
  - *a1. → UC-COMM-01: データ取得障害アラートを配信する
  - *a2. 代替データソースからの情報取得
  - *a3. 手動情報補完モードへの切り替え
  - *a4. 情報取得完了後、基本フロー3から再開

### 例外2: 請求権限不足・競合
- *b. 請求権限が不足または競合している場合
  - *b1. → UC-AUTH-02: 上位権限者への承認依頼
  - *b2. 権限昇格または権限調整プロセス
  - *b3. 権限確定後、基本フロー1から再開

### 例外3: 請求精度基準未達
- *c. InvoiceOptimizationService が品質基準未達を検出した場合
  - *c1. 精度向上のための追加分析実行
  - *c2. 専門コンサルテーション支援要請
  - *c3. 請求書見直しまたは段階的発行検討
  - *c4. 品質確保後、基本フロー4から再開

## 特別要件
- **性能**: 請求書発行プロセス完了時間5営業日以内
- **可用性**: システム稼働率99.5%以上
- **セキュリティ**: 請求書データの暗号化、アクセスログ記録
- **精度**: 請求精度99%以上達成（InvoiceOptimizationService評価）
- **ユーザビリティ**: 直感的UI、請求支援ガイド機能

## 関連ユースケース
- **包含**: UC-AUTH-01〜02, UC-PROJECT-01〜03, UC-COMM-01, UC-COMM-03
- **拡張**: UC-INVOICE-02（入金管理）
- **前提**: 納品完了・請求根拠の明確化完了必須

---
*このユースケースは パラソル設計v2.0仕様 に基づいて作成されました*
