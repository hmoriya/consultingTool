# テスト定義: ユーザー認証機能

## テストの目的
ユーザー認証機能が正常に動作し、セキュリティ要件を満たしていることを確認する

## テスト情報
- **テストレベル**: システムテスト
- **テストタイプ**: 機能テスト、セキュリティテスト
- **優先度**: 高
- **実行頻度**: リグレッションテスト（全リリース前）

## テストケース群

### テストケース1: 正常系 - 基本ログイン成功

#### 事前条件
- テストユーザー（test@example.com）が登録済み
- パスワード: TestPass123!
- アカウントが有効状態
- MFA未設定

#### テスト手順
1. ブラウザでログイン画面を開く
2. メールアドレス欄に「test@example.com」を入力
3. パスワード欄に「TestPass123!」を入力
4. ログインボタンをクリック
5. 画面遷移を確認

#### 期待結果
- ローディングインジケータが表示される
- 認証が成功する
- ダッシュボード画面に遷移する
- ヘッダーにユーザー名が表示される
- セッションクッキーが設定される

#### 事後処理
- ログアウトを実行
- ブラウザキャッシュをクリア

### テストケース2: 正常系 - MFA認証成功

#### 事前条件
- MFA有効なテストユーザー（mfa@example.com）
- 有効なMFAデバイス設定済み
- TOTPシークレット: JBSWY3DPEHPK3PXP

#### テスト手順
1. ログイン画面を開く
2. メールアドレスとパスワードを入力
3. ログインボタンをクリック
4. MFA画面が表示されることを確認
5. 現在のTOTPコードを生成
6. 6桁コードを入力
7. 確認ボタンをクリック

#### 期待結果
- 一次認証後にMFA画面が表示される
- 正しいコードで認証が成功する
- ダッシュボードに遷移する
- 監査ログにMFA成功が記録される

### テストケース3: 異常系 - 不正なパスワード

#### 事前条件
- 有効なテストユーザーアカウント
- 正しいメールアドレス: test@example.com
- 誤ったパスワード: WrongPass123

#### テスト手順
1. ログイン画面を開く
2. 正しいメールアドレスを入力
3. 誤ったパスワードを入力
4. ログインボタンをクリック
5. エラーメッセージを確認

#### 期待結果
- 「メールアドレスまたはパスワードが正しくありません」が表示
- ログイン画面に留まる
- パスワードフィールドがクリアされる
- failed_login_countがインクリメントされる
- 監査ログにログイン失敗が記録される

### テストケース4: 異常系 - アカウントロック

#### 事前条件
- アカウントロック閾値: 5回
- テストユーザー: lock@example.com

#### テスト手順
1. ログイン画面を開く
2. 正しいメールアドレスを入力
3. 誤ったパスワードで5回連続ログイン試行
4. 6回目のログイン試行
5. ロックメッセージを確認
6. 正しいパスワードでログイン試行

#### 期待結果
- 5回目の失敗後にアカウントロック
- 「アカウントがロックされています。15分後に再試行してください」表示
- ロック中は正しいパスワードでもログイン不可
- カウントダウンタイマー表示
- 管理者に通知メール送信

### テストケース5: 境界値テスト - パスワード長

#### 事前条件
- 最小パスワード長: 8文字
- 最大パスワード長: 128文字

#### テスト手順
1. 7文字のパスワードでユーザー登録を試行
2. 8文字のパスワードでユーザー登録
3. 128文字のパスワードでユーザー登録
4. 129文字のパスワードで登録試行

#### 期待結果
- 7文字: バリデーションエラー
- 8文字: 登録成功
- 128文字: 登録成功
- 129文字: バリデーションエラー

### テストケース6: セキュリティテスト - SQLインジェクション

#### 事前条件
- ログイン画面にアクセス可能

#### テスト手順
1. メールアドレス欄に「' OR '1'='1' --」を入力
2. パスワード欄に任意の文字列を入力
3. ログインボタンをクリック
4. 応答を確認

#### 期待結果
- ログインが失敗する
- 通常のエラーメッセージが表示される
- SQLエラーが表示されない
- 監査ログに不審なアクティビティとして記録

### テストケース7: セキュリティテスト - ブルートフォース対策

#### 事前条件
- レート制限: 5回/分

#### テスト手順
1. 自動化スクリプトで1分間に10回ログイン試行
2. 6回目以降の応答を確認

#### 期待結果
- 5回目まで: 通常の応答
- 6回目以降: 429 Too Many Requests
- X-RateLimit-Remainingヘッダー確認
- IPアドレスの一時ブロック

## 性能テスト

### 負荷テスト
- **同時ユーザー数**: 1000
- **レスポンス時間**: 平均2秒以内
- **成功率**: 99%以上
- **スループット**: 100リクエスト/秒

### ストレステスト
- **限界値**: 5000同時ユーザー
- **復旧能力**: 負荷解除後5分以内に正常化
- **エラー率**: 5%未満

## セキュリティテスト

### 認証テスト
- パスワード総当たり攻撃への耐性
- セッション固定攻撃への対策確認
- クッキー改ざんテスト

### 認可テスト
- ロール別アクセス制御
- 権限昇格攻撃への対策
- 直接URLアクセス制限

## 自動化対象
- **自動化可能**:
  - 正常系ログインテスト
  - パスワードバリデーション
  - API負荷テスト
  - セキュリティスキャン

- **手動実行**:
  - UI/UXテスト
  - アクセシビリティテスト
  - エクスプロラトリテスト

## テスト環境
- **OS**: Windows 11, macOS 13, Ubuntu 22.04
- **ブラウザ**: Chrome 120+, Firefox 120+, Safari 17+, Edge 120+
- **デバイス**: Desktop, iPad, iPhone, Android
- **ネットワーク**: 通常接続, 3G, オフライン
- **言語設定**: 日本語, 英語