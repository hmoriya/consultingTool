# ユースケース: MFAを有効化する

**バージョン**: 2.0.0
**更新日**: 2025-10-20
**パラソル設計v2.0仕様**: 完全準拠

## 基本情報
- **ユースケースID**: UC-MFA-01
- **アクター**: ユーザー、セキュリティ管理者、システム管理者
- **概要**: ユーザーアカウントに多要素認証を設定し、セキュリティを強化する

## 事前条件
- ユーザーがシステムにログインしている
- ユーザーアカウントでMFAが無効化されている
- ユーザーが認証アプリをインストール可能なスマートフォンまたはデバイスを所有している
- MFAポリシーが組織で有効化されている

## 事後条件
### 成功時
- ユーザーアカウントでMFAが有効化されている
- 秘密鍵が生成され、認証アプリに登録されている
- バックアップコードが生成され、安全に保存されている
- MFA有効化完了通知が送信されている
- 以降のログイン時にMFA認証が要求される

### 失敗時
- MFA設定が無効のまま保持される
- 設定エラーの原因が明確に表示される
- 設定再開のための状態が保持される

## 基本フロー
1. ユーザーがセキュリティ設定画面にアクセスする
2. システムがMFA設定オプションを表示する
3. ユーザーがMFA有効化を選択する
4. システムがMFA設定ウィザードを開始する
5. システムが秘密鍵を生成し、QRコードを表示する
6. ユーザーが認証アプリでQRコードをスキャンする
7. システムがテスト用認証コード入力を要求する
8. ユーザーが認証アプリから6桁コードを入力する
9. システムがコードを検証し、設定を確認する
10. システムがバックアップコードを生成・表示する
11. ユーザーがバックアップコードを安全に保存する
12. システムがMFA有効化を完了し、確認画面を表示する
13. システムがMFA有効化通知を送信する

## 代替フロー
### 代替フロー1: 手動コード入力
- 6a. QRコードをスキャンできない場合
  - 6a1. ユーザーが手動入力オプションを選択する
  - 6a2. システムが英数字の秘密鍵を表示する
  - 6a3. ユーザーが認証アプリに手動で秘密鍵を入力する
  - 6a4. 基本フロー7に進む

### 代替フロー2: 管理者強制有効化
- 1a. セキュリティ管理者が強制有効化を実行する場合
  - 1a1. セキュリティ管理者がユーザー管理画面にアクセスする
  - 1a2. 対象ユーザーを選択し、MFA強制有効化を実行する
  - 1a3. システムがユーザーにMFA設定要求通知を送信する
  - 1a4. ユーザーが基本フロー2から設定を開始する

## 例外フロー
### 例外1: 認証コード検証失敗
- 8a. 入力された認証コードが無効な場合
  - 8a1. システムがエラーメッセージを表示する
  - 8a2. システムが3回まで再入力を許可する
  - 8a3. 3回失敗した場合、設定をリセットして基本フロー5に戻る

### 例外2: デバイス非対応
- 6b. ユーザーのデバイスが認証アプリに対応していない場合
  - 6b1. システムが代替認証方法（SMS等）を提案する
  - 6b2. ユーザーが代替方法を選択する
  - 6b3. システムが選択された方法での設定フローを開始する

### 例外3: 設定中断・再開
- *a. 設定途中でユーザーが中断した場合
  - *a1. システムが中断状態を保存する
  - *a2. ユーザーが再アクセス時に継続確認を表示する
  - *a3. 継続選択時は中断ポイントから再開する

## 🏗️ パラソルドメイン連携

### マイクロサービス設計原則（ユースケース利用型）
- **自サービス管理**: MFAConfigurationEntity（新規作成: disabled → enrolling → enabled）
- **他サービス連携**: 他サービス公開ユースケース利用（エンティティ直接参照禁止）

#### 📊 操作エンティティ
- **MFAConfigurationEntity** (自サービス管理・新規作成): disabled → enrolling → enabled → verified
- **MFASecretEntity** (自サービス管理・新規作成): 秘密鍵生成・QRコード作成
- **BackupCodeEntity** (自サービス管理・新規作成): 10個のバックアップコード生成

#### 🏢 パラソル集約
- **MFAEnrollmentAggregate** - MFA登録プロセス統合管理
  - 集約ルート: MFAConfiguration
  - 包含エンティティ: MFASecret, BackupCode, EnrollmentStep, ValidationAttempt
  - 不変条件: 検証完了したMFAのみ有効化可能、バックアップコードは必ず10個生成、秘密鍵は一意性保証

#### ⚙️ ドメインサービス
- **MFAEnrollmentService**: enhance[UserSecurity]() - ユーザーセキュリティ向上
- **SecretKeyGenerationService**: strengthen[CryptographicSecurity]() - 暗号化セキュリティ強化
- **BackupCodeGenerationService**: coordinate[RecoveryPreparation]() - 復旧準備統制

#### 🔗 他サービスユースケース利用（ユースケース呼び出し型）
**責務**: ❌ エンティティ知識不要 ✅ ユースケース利用のみ

**[secure-access-service] 自サービス内利用:**
├── UC-AUTH-01: ユーザー認証を実行する → POST /api/auth/authenticate
├── UC-AUTH-02: セッション検証を実行する → POST /api/auth/validate-session
└── UC-AUTH-03: セキュリティイベントを記録する → POST /api/auth/log-security-event

**[collaboration-facilitation-service] ユースケース利用:**
├── UC-COMM-01: MFA設定完了通知を配信する → POST /api/notifications/send-mfa-setup-completion
├── UC-COMM-02: セキュリティ強化通知を送信する → POST /api/notifications/send-security-enhancement
└── UC-COMM-03: 管理者にMFA有効化報告を送信する → POST /api/notifications/send-mfa-activation-report

## 特別要件
- **セキュリティ**: 秘密鍵は暗号化して保存、QRコード表示は一回限り
- **可用性**: 設定プロセスは中断・再開が可能
- **性能**: QRコード生成は3秒以内、バックアップコード生成は1秒以内
- **監査**: MFA有効化の全プロセスを監査ログに記録

## 関連ユースケース
- **前提**: UC-AUTH-01（ユーザー認証）
- **拡張**: UC-MFA-02（認証コード入力）、UC-MFA-03（バックアップコード利用）
- **依存**: UC-AUTH-02（セッション検証）、UC-COMM-01（通知配信）

## MFA有効化の段階
1. **準備段階**: デバイス確認・アプリインストール案内
2. **登録段階**: 秘密鍵生成・QRコード表示・アプリ設定
3. **検証段階**: テストコード入力・動作確認
4. **完了段階**: バックアップコード生成・安全保存・有効化確定

## セキュリティ考慮事項
- **秘密鍵のセキュリティ**: 生成後は暗号化保存、平文での保存禁止
- **QRコード保護**: 表示時間制限、スクリーンショット検出時の警告
- **バックアップコード保護**: 安全な保存方法の指導、印刷推奨
- **設定プロセス保護**: HTTPS必須、セッション管理強化

## ビジネス価値
包括的なMFA有効化プロセスにより、ユーザーアカウントのセキュリティを劇的に向上させ、不正アクセスリスクを99%以上削減する。同時に、ユーザビリティを維持した設定体験により、組織全体のセキュリティ意識向上と自発的なセキュリティ強化を促進する。