# ページ定義: 認証コード入力ページ

**バージョン**: 2.0.0
**更新日**: 2025-10-21
**設計方針**: 利便性重視・直感的UI・リアルタイムフィードバック

## 画面の目的
ユーザーがMFA認証を完了するために、認証アプリで生成された6桁コードを簡単かつ確実に入力でき、リアルタイムでの検証フィードバックにより、迅速で安心な認証体験を提供する。

## 利用者
- **主要利用者**: MFA設定済みのすべてのユーザー（日常ログイン時）
- **副次利用者**: 一時的にMFA認証が必要な管理者、緊急アクセスが必要なユーザー

## 画面構成

### 🔐 認証ステータスセクション（ページ上部）

#### 認証進行状況
- **プログレスインジケーター**:
  - ステップ表示: 「認証中 2/2」
  - 進行バー: 50% → 100%完了
  - ステータス: 🔐「MFA認証」→ ✅「認証完了」

#### セキュリティ確認表示
- **ユーザー確認**:
  - 「こんにちは、[ユーザー名] さん」
  - 「最終ログイン: 2024-10-21 09:30 (東京)」
  - 「IPアドレス: 192.168.1.100」

#### セッション情報
- **有効期限表示**: 「このセッションは10分後に自動終了します」
- **セキュリティレベル**: 🛡️「高セキュリティ認証中」

---

### 📱 認証コード入力セクション（メイン）

#### 6桁コード入力フィールド
- **専用入力ボックス**:
  - レイアウト: 6個の大きな個別ボックス（□ □ □ □ □ □）
  - サイズ: 各ボックス60px × 60px
  - フォント: 大きくて読みやすいモノスペースフォント
  - 自動フォーカス: 入力完了時に次のボックスに自動移動
  - ペースト対応: 6桁コピペ時の自動分割入力

#### リアルタイム検証システム
- **入力時フィードバック**:
  - 入力中: ボックス境界が青色で点滅
  - 6桁完了: 自動検証開始（ローディングアニメーション）
  - 検証中: 🔄 「認証中...」+ 進行バー
  - 成功時: ✅ 緑色確認マーク + 「認証成功」
  - 失敗時: ❌ 赤色エラー表示 + エラーメッセージ

#### コード有効期限表示
- **時間窓カウントダウン**:
  - 「現在のコード有効期限: 残り23秒」
  - 進行バー形式で残り時間を視覚化
  - 10秒を切ったら黄色→赤色に変化
  - 0秒で「新しいコードを生成してください」

---

### 🔄 補助操作・ガイダンスセクション（下部）

#### 認証アプリガイド
- **手順リマインダー**:
  - 📱 「認証アプリを開く」
  - 🔍 「[サービス名] アカウントを探す」
  - 🔢 「表示されている6桁コードを入力」

#### トラブルシューティング
- **よくある問題と解決**:
  - 🕒 **時刻ずれ**: 「コードが合わない場合、デバイスの時刻設定を確認してください」
  - 📶 **同期問題**: 「アプリの時刻同期を実行してください」
  - 🔄 **新コード待機**: 「残り時間が少ない場合は、新しいコードの生成をお待ちください」

#### 代替認証手段
- **バックアップコード利用**:
  - リンク: 「バックアップコードを使用する」
  - 説明: 「認証アプリが利用できない場合の緊急手段」
  - アクセス: モーダルダイアログでバックアップコード入力画面を表示

- **管理者連絡**:
  - リンク: 「認証に関するサポートを受ける」
  - 説明: 「上記の方法で解決しない場合」

---

### ⚠️ セキュリティ警告・制限表示

#### 試行回数制限
- **残り試行回数**: 「残り試行回数: 2回」
- **制限警告**: 「3回失敗すると15分間ロックされます」
- **ロック状況**: ロック時は「15分12秒後に再試行可能」

#### セキュリティ注意事項
- **注意喚起**:
  - 🚫 「コードを他人に教えないでください」
  - 👀 「周囲に誰もいないことを確認してから入力してください」
  - 🔒 「このページを開いたまま席を離れないでください」

---

## データ表示

### 表示データ一覧
| データ項目 | 表示形式 | 更新頻度 | 説明 |
|-----------|---------|---------|------|
| 認証コード入力状況 | リアルタイム | キーストローク毎 | 入力文字数とボックス状態 |
| コード有効期限 | カウントダウン | 1秒毎 | TOTP時間窓の残り時間 |
| 認証結果 | ステータス表示 | 検証完了時 | 成功・失敗・エラーの状況 |
| 試行回数制限 | 数値表示 | 失敗時更新 | 残り試行可能回数 |
| セッション情報 | 静的表示 | ページ読み込み時 | ユーザー情報、IP、時刻 |

## 入力項目

### フォーム一覧
| 入力項目 | 入力形式 | 必須 | バリデーション | 説明 |
|---------|---------|------|---------------|------|
| 認証コード | 6桁数字 | ○ | 数字のみ、6桁固定 | TOTPコード入力 |
| バックアップコード | 16文字英数 | × | 英数のみ、16文字固定 | 緊急時代替認証 |

### 入力制御
- **自動補完**: 無効（セキュリティ考慮）
- **コピー制限**: 入力内容のコピー禁止
- **履歴無効**: ブラウザ履歴に入力内容を保存しない
- **タイムアウト**: 10分間無操作でセッション終了

## アクション・操作

### 主要アクション
- **認証実行**:
  - トリガー: 6桁入力完了または「認証」ボタンクリック
  - 処理: リアルタイムコード検証、結果表示
  - 成功時: ダッシュボードへ自動リダイレクト
  - 失敗時: エラーメッセージ表示、再入力促進

- **コードクリア**:
  - トリガー: 「クリア」ボタンクリック
  - 処理: 全入力フィールドの内容消去
  - 結果: 1番目のボックスにフォーカス復帰

### 副次アクション
- **バックアップコード切り替え**: 代替認証方法への変更
- **新しいコード待機**: 有効期限切れ時の自動待機モード
- **ヘルプ表示**: 認証手順の詳細ガイド表示
- **管理者連絡**: サポート要請フォームの表示

### セキュリティアクション
- **自動ロック**: 連続失敗時の自動アカウントロック
- **セッション終了**: タイムアウト時の自動ログアウト
- **不正検知通知**: 異常なアクセスパターンの検知・通知

## 画面の振る舞い

### ユーザー操作への反応
- **コード入力時**:
  - 各文字入力で次のボックスに自動移動
  - 6桁完了で自動検証開始（500ms以内）
  - 不正文字入力時は即座に拒否・警告表示

- **検証処理中**:
  - ローディングアニメーション表示
  - 入力フィールドを一時的に無効化
  - プログレスバーで処理進行表示

- **結果表示時**:
  - 成功: 緑色アニメーション + 自動リダイレクト（1秒後）
  - 失敗: 赤色フラッシュ + エラーメッセージ + 自動クリア
  - ロック: 警告表示 + 再試行時刻案内

### 条件による表示変更
- **残り時間少ない時**: コード入力を無効化、新コード待機モード
- **連続失敗時**: 警告レベル上昇、バックアップコード案内強調
- **ロック状態時**: 全入力無効化、解除時刻のカウントダウン表示
- **ネットワークエラー時**: 自動リトライ機能、オフライン状態表示

## 画面遷移

### 遷移元画面
- **ログイン画面**: ユーザー名・パスワード認証成功後
- **セッション復帰**: ブラウザ再起動時の認証確認
- **権限昇格**: 管理機能アクセス時の追加認証
- **バックアップコードページ**: バックアップコード認証失敗時

### 遷移先画面
- **ダッシュボード**: 認証成功時のメイン画面
- **バックアップコード入力**: 「バックアップコードを使用」選択時
- **MFAリセットページ**: 管理者権限でのリセット実行時
- **ログイン画面**: セッション期限切れ・ロック時

## エラーハンドリング

### エラー表示方法
- **認証コード不正**: 「コードが正しくありません。認証アプリで新しいコードを確認してください。」
- **時間窓期限切れ**: 「コードの有効期限が切れました。新しいコードを生成してから再試行してください。」
- **連続失敗警告**: 「残り試行回数: 1回。次回失敗するとアカウントがロックされます。」
- **ネットワークエラー**: 「接続に問題があります。インターネット接続を確認して再試行してください。」
- **システムエラー**: 「一時的な問題が発生しました。しばらく後に再試行してください。」

### 復旧・対処機能
- **自動リトライ**: ネットワークエラー時の自動再送機能
- **代替手段案内**: 認証失敗時のバックアップコード利用ガイド
- **管理者連絡**: 解決困難時のサポート要請機能
- **自動ログアウト**: セキュリティリスク検知時の自動セッション終了

## アクセシビリティ要件

### キーボードナビゲーション
- タブ順序: 入力フィールド（1→6）→ 認証ボタン → 代替手段リンク
- ショートカット: Enter キーでの認証実行、Escape キーでの入力クリア

### スクリーンリーダー対応
- 入力フィールド: 「認証コード入力、X桁目」の明確な読み上げ
- 進行状況: 「認証中、しばらくお待ちください」の状況説明
- 結果通知: 「認証成功」「認証失敗、再試行してください」の明確な結果通知

### 色覚障害への配慮
- 成功・エラー表示: 色だけでなくアイコンと文字で明確に表現
- 高コントラスト表示オプション: 背景と文字の明確な識別
- カスタマイズ可能な色設定: ユーザー設定に応じた表示調整

## レスポンシブ対応

### デスクトップ（1024px以上）
- 中央配置レイアウト: 認証フォームを画面中央に配置
- 6桁入力: 大きなボックス（60px × 60px）で視認性確保

### タブレット（768px-1023px）
- フルスクリーン活用: 画面幅を最大限活用したレイアウト
- 6桁入力: 中サイズボックス（50px × 50px）で最適化

### モバイル（767px以下）
- 縦画面最適化: 縦向きでの使いやすさを重視
- 6桁入力: モバイル用ボックス（45px × 45px）、タッチ操作最適化
- キーパッド表示: 数字キーパッドの自動表示

## セキュリティ配慮

### データ保護
- 入力コードの即座クリア: 検証後の入力内容自動削除
- メモリ保護: JavaScriptメモリ内での機密情報の即座削除
- 画面キャプチャ制限: スクリーンショット防止機能

### セッション管理
- 厳格なタイムアウト: 10分間の無操作でセッション強制終了
- セッション固定化防止: 認証成功時のセッションID再生成
- 同時セッション制限: 複数デバイスでの同時ログイン制御

### 監査・ログ
- 全認証試行の記録: 成功・失敗・ロックの詳細ログ
- 異常パターン検知: ブルートフォース攻撃の自動検知
- リアルタイム監視: セキュリティインシデントの即座通知

---
*このページ定義は、UC-MFA-02「認証コードを入力する」と1対1対応し、セキュリティと利便性を両立した最適なMFA認証体験を実現しています*