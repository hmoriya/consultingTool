# ページ定義: MFA認証コード入力ページ

**バージョン**: 2.0.0
**更新日**: 2025-10-20
**対応ユースケース**: UC-MFA-02（認証コードを入力する）

## 画面の目的
ログイン時にユーザーが認証アプリから取得した6桁の認証コードを安全かつ迅速に入力し、多要素認証を完了してシステムへの安全なアクセスを実現する。

## 利用者
- **一般ユーザー**: MFA有効化済みでログインを行うユーザー
- **管理者ユーザー**: 管理機能アクセス時にMFA認証が必要なユーザー
- **財務・人事担当**: 機密情報アクセス時の強制MFA認証対象ユーザー
- **外部ユーザー**: ゲストアクセス時の追加セキュリティ対象ユーザー

## 画面構成

### ヘッダー部
- 画面タイトル: 「多要素認証（MFA）」
- セキュリティインジケーター: 安全な接続状態の表示
- 残り時間表示: 認証コード有効期限のカウントダウン（30秒）
- ログアウトボタン: 認証キャンセル・セキュアログアウト

### 認証状況セクション
- **ユーザー情報**: ログイン中のユーザー名・アカウント表示
- **認証段階表示**: パスワード認証完了 → MFA認証中の進捗
- **セキュリティレベル**: 現在の認証セキュリティレベル表示
- **デバイス情報**: ログイン元デバイス・IP情報の表示

### 認証コード入力セクション
- **入力フィールド**: 6桁認証コード専用入力フィールド
- **フォーカス自動設定**: ページ読み込み時の自動フォーカス
- **数字制限**: 数字のみ入力可能・自動フォーマット機能
- **リアルタイム検証**: 6桁入力完了時の自動検証実行

### 認証アプリ案内セクション
- **取得手順**: 認証アプリからのコード取得手順の簡潔な表示
- **アプリ推奨**: Google Authenticator、Microsoft Authenticator等の案内
- **同期注意**: デバイス時刻同期の重要性説明
- **更新案内**: 30秒毎のコード更新タイミング表示

### 代替認証オプション
- **バックアップコード利用**: 「バックアップコードを使用」リンク
- **デバイス紛失対応**: 「認証アプリにアクセスできない場合」リンク
- **管理者連絡**: 緊急時のサポート連絡先表示
- **再送信機能**: SMS認証等の代替手段（設定により）

### エラー・フィードバック表示エリア
- **エラーメッセージ**: 認証失敗時の明確なエラー表示
- **残り試行回数**: 連続失敗時の残り試行回数表示
- **セキュリティ警告**: 不正アクセス検出時の警告表示
- **解決案内**: エラー解決のための具体的手順提示

## データ表示

### 表示データ一覧
| データ項目 | 表示形式 | 更新頻度 | 説明 |
|-----------|---------|---------|------|
| ユーザー識別情報 | テキスト | 静的 | ログイン中ユーザーの名前・ID |
| 認証コード有効期限 | カウントダウン | 1秒毎 | 30秒の残り時間表示 |
| 認証試行回数 | 数値 | 試行毎 | 残り試行可能回数（5回まで） |
| セキュリティ状況 | ステータス | リアルタイム | 認証進行状況・セキュリティレベル |
| デバイス情報 | テキスト | 静的 | ログイン元IP・デバイス識別情報 |

### データの更新頻度
- **リアルタイム更新**: 認証コード有効期限・認証結果・エラーメッセージ
- **試行毎更新**: 認証失敗回数・セキュリティアラート状況
- **認証完了時**: ログイン成功・ダッシュボード遷移準備
- **セキュリティイベント**: 異常検出・管理者アラート送信

## 入力項目

### 基本入力項目
| 入力項目 | 入力形式 | 必須 | バリデーション | 説明 |
|---------|---------|------|---------------|------|
| 認証コード | テキスト（6桁） | ○ | 数字6桁、30秒以内 | 認証アプリからの時間ベースコード |

### 入力制御・バリデーション
| バリデーション項目 | ルール | エラーメッセージ | 対応アクション |
|-------------------|--------|-----------------|---------------|
| 文字数 | 6桁必須 | 「6桁の数字を入力してください」 | 入力継続促進 |
| 文字種別 | 数字のみ | 「数字のみ入力可能です」 | 自動フィルタリング |
| 有効期限 | 30秒以内 | 「認証コードの有効期限が切れました」 | 新しいコード取得案内 |
| 試行回数 | 5回まで | 「認証に失敗しました（残り X 回）」 | 注意喚起・代替手段案内 |

## アクション・操作

### 主要アクション
- **認証実行**: 6桁コード入力完了時の自動認証実行
- **手動認証**: 「認証」ボタンクリックによる手動実行
- **コード再取得**: 認証アプリでの新しいコード生成案内
- **認証完了**: 成功時のダッシュボード画面への自動遷移

### 代替・支援アクション
- **バックアップコード利用**: 代替認証方法への切替
- **認証キャンセル**: ログアウト・認証プロセスの中断
- **ヘルプ表示**: 認証手順・トラブルシューティング表示
- **時刻同期確認**: デバイス時刻とサーバー時刻の同期確認

### セキュリティアクション
- **異常検出通知**: 不正アクセス試行の管理者通知
- **アカウントロック**: 連続失敗時の一時的アカウント無効化
- **セキュリティログ記録**: 全認証試行の詳細ログ保存
- **管理者エスカレーション**: 重要セキュリティイベントの即座報告

## 画面の振る舞い

### 自動化・利便性機能
- **自動フォーカス**時: ページ読み込み完了時の認証コードフィールド自動選択
- **数字自動フィルタ**時: 数字以外の文字入力時の自動除去・フォーマット
- **6桁完了検出**時: 6桁入力完了の自動検出・即座認証実行
- **残り時間警告**時: 有効期限10秒前の視覚的・音声的警告

### リアルタイム応答・フィードバック
- **入力リアルタイム**時: 各桁入力時の即座フィードバック・プログレス表示
- **認証結果即座表示**時: 成功/失敗の瞬時判定・明確な視覚的フィードバック
- **エラー即座案内**時: エラー発生時の具体的解決手順・代替方法提示
- **ネットワーク状況表示**時: 通信状態・レスポンス時間のリアルタイム監視

### セキュリティ保護機能
- **スクリーンショット検出**時: 画面キャプチャ検出・セキュリティ警告表示
- **不正試行検出**時: 異常な認証パターン検出・自動セキュリティ強化
- **セッション管理**時: 認証タイムアウト・セキュアセッション維持管理
- **入力内容保護**時: 認証コード入力の暗号化・メモリクリア

## 画面遷移

### 遷移元画面
- パスワード認証画面: 第一要素認証完了後の自動遷移
- ログイン画面: MFA有効ユーザーの直接MFA認証要求
- セキュリティ確認画面: 機密操作実行時の追加認証要求

### 遷移先画面
- ダッシュボード画面: MFA認証成功時の標準遷移先
- バックアップコード入力画面: 代替認証選択時の遷移
- アカウントロック画面: 連続認証失敗時の一時ロック画面
- ログイン画面: 認証キャンセル・タイムアウト時の戻り遷移

## MFA認証の専門機能

### TOTP技術実装
- **時刻同期**: サーバーとデバイス間の時刻同期状況確認・自動調整案内
- **コード有効性**: 30秒ウィンドウでの厳密な有効性検証・前後1ステップ許容
- **リプレイ攻撃防止**: 使用済みコードの記録・重複利用阻止
- **アルゴリズム準拠**: RFC 6238準拠のTOTP実装・SHA-1ハッシュ利用

### ユーザビリティ最適化
- **入力支援**: 自動数字フィルタ・桁区切り表示・残り桁数表示
- **視覚的支援**: 大きな文字表示・高コントラスト・色覚障害対応
- **音声支援**: スクリーンリーダー対応・音声入力支援・音声フィードバック
- **操作簡素化**: 最小限の操作・直感的インターフェース・エラー回復支援

### セキュリティ監視
- **レート制限**: 同一ユーザー5回/分・同一IP 20回/分の厳格な制限
- **異常検出**: 異常な認証パターン・地理的異常・デバイス変更の検出
- **即座対応**: セキュリティインシデント検出時の自動対応・管理者通知
- **監査証跡**: 全認証試行の詳細記録・法的要件対応・フォレンジック支援

## エラーハンドリング

### 認証エラー対応
- **認証コードエラー**: 無効コード入力時の明確なエラー表示・正しい手順案内
- **有効期限エラー**: 期限切れコード使用時の新コード取得案内・自動更新表示
- **連続失敗エラー**: 複数回失敗時の警告・残り試行回数・代替手段案内
- **アカウントロックエラー**: ロック発生時の解除手順・管理者連絡先案内

### 技術エラー対応
- **ネットワークエラー**: 通信障害時の自動再試行・オフライン対応・状況説明
- **時刻同期エラー**: デバイス時刻ずれ検出時の同期手順・具体的修正方法
- **ブラウザエラー**: 非対応ブラウザ・設定問題時の対応手順・代替ブラウザ案内
- **デバイスエラー**: 認証アプリ問題・デバイス故障時の代替手段・復旧支援

## パフォーマンス最適化

### 高速応答
- **瞬時認証**: 認証コード検証の1秒以内応答・即座フィードバック
- **軽量表示**: 最小限のリソース使用・高速ページ読み込み
- **効率通信**: 最適化されたAPI通信・圧縮データ転送
- **キャッシュ活用**: 静的リソースの効率的キャッシュ・CDN活用

### レスポンシブ対応
- **デバイス最適化**: スマートフォン・タブレット・デスクトップの完全対応
- **画面サイズ適応**: 動的レイアウト調整・最適な表示サイズ
- **タッチ操作**: モバイルデバイスでの快適な操作・大きなタップエリア
- **アクセシビリティ**: 障害者対応・多様なニーズへの配慮

この包括的なMFA認証環境により、セキュリティを最大化しながら優れたユーザーエクスペリエンスを実現し、組織全体の認証成功率99%以上と高いセキュリティレベルを両立する。