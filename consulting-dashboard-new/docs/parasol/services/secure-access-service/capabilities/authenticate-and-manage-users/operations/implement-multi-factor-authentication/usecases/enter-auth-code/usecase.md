# ユースケース: 認証コードを入力する

**バージョン**: 2.0.0
**更新日**: 2025-10-21
**設計方針**: 利便性重視・セキュリティ確保・リアルタイム検証

## 基本情報
- **ユースケースID**: UC-MFA-02
- **アクター**: ユーザー（主アクター）、システム（副アクター）
- **概要**: ユーザーが認証アプリで生成された6桁コードを入力し、MFA認証を完了する

## 🏗️ パラソルドメイン連携

### 操作エンティティ
- **MFAConfigurationEntity**（自サービス管理・状態参照: verified状態の確認）: MFA設定の有効性確認
- **MFASecretEntity**（自サービス管理・参照）: TOTP秘密鍵との照合処理
- **SessionEntity**（自サービス管理・状態更新: pending → authenticated）: セッション認証状態の更新

### 他サービスユースケース利用
- **collaboration-facilitation-service**: UC-NOTIFY-01: セキュリティアラートを送信する（認証失敗時）
- **project-success-service**: UC-AUDIT-01: セキュリティ監査ログを記録する
- **knowledge-co-creation-service**: UC-KNOWLEDGE-03: セキュリティ学習進捗を記録する

## 事前条件
- ユーザーがログイン画面で基本認証（ユーザー名・パスワード）を完了している
- ユーザーのアカウントでMFAが有効化されている（MFAConfigurationEntity.status = verified）
- ユーザーが認証アプリ（Google Authenticator等）を利用可能である
- システムが一時セッション（pending状態）を作成している

## 事後条件
### 成功時
- SessionEntityの状態がpending → authenticatedに変更されている
- 認証成功のセキュリティログが記録されている
- ユーザーがシステム内の保護されたリソースにアクセス可能になっている
- 認証成功の学習進捗がナレッジサービスに記録されている

### 失敗時
- SessionEntityの状態はpendingのまま維持されている
- 認証失敗のセキュリティログが記録されている
- 連続失敗時のセキュリティアラートが送信されている
- ユーザーに適切なエラーメッセージと再試行案内が表示されている

## 基本フロー
1. **ユーザー**が認証コード入力画面を表示する
2. **システム**がMFAConfigurationEntityの有効性を確認する
3. **システム**が現在時刻のTOTPコード生成に必要な情報を準備する
4. **ユーザー**が認証アプリで表示された6桁コードを確認する
5. **ユーザー**が6桁の認証コードを入力フィールドに入力する
6. **システム**が入力されたコードをリアルタイムで検証する
7. **システム**がMFASecretEntityから秘密鍵を取得し、期待値を計算する
8. **システム**が入力コードと期待値を比較検証する
9. **システム**がSessionEntityの状態をpending → authenticatedに更新する
10. **システム**が認証成功ログを記録する（他サービス連携）
11. **システム**がセキュリティ学習進捗を記録する（他サービス連携）
12. **システム**がメインダッシュボードへリダイレクトする

## 代替フロー

### 代替フロー1: 時刻同期ずれ対応
- **分岐点**: ステップ8（コード検証）
- **条件**: 時刻ずれによりコードが一致しない場合
- **処理**:
  - 8a1. システムが前後の時間窓（±30秒）でコード検証を実行する
  - 8a2. 拡張時間窓で一致する場合、認証成功として処理する
  - 8a3. ステップ9に続行

### 代替フロー2: 即座認証（自動検証）
- **分岐点**: ステップ5（コード入力）
- **条件**: 6桁入力完了と同時に自動検証を実行
- **処理**:
  - 5a1. ユーザーが6桁目を入力完了する
  - 5a2. システムが自動的に検証処理を開始する
  - 5a3. 成功時は即座にステップ9へ、失敗時はエラー表示

### 代替フロー3: 新しいコード待機
- **分岐点**: ステップ5（コード入力前）
- **条件**: 現在のコードの有効期限が間近（残り5秒以下）
- **処理**:
  - 5a1. システムが「新しいコード生成まで待機中」を表示する
  - 5a2. 30秒カウントダウンを表示する
  - 5a3. 新しいコード生成後にステップ5に戻る

## 例外フロー

### 例外1: 連続認証失敗によるロック
- **発生点**: ステップ8（コード検証）
- **処理**:
  - 8e1. 3回連続でコード検証が失敗した場合
  - 8e2. システムが15分間の認証ロックを適用する
  - 8e3. システムがセキュリティアラートを送信する（他サービス連携）
  - 8e4. システムがロック期間とリトライ時刻を表示する
  - 8e5. ユーザーにバックアップコード利用を案内する

### 例外2: MFA設定無効化検出
- **発生点**: ステップ2（MFA有効性確認）
- **処理**:
  - 2e1. MFAConfigurationEntityが無効状態の場合
  - 2e2. システムが通常ログインフローにリダイレクトする
  - 2e3. システムがMFA設定変更の監査ログを記録する
  - 2e4. 管理者に設定変更アラートを送信する

### 例外3: システムエラー・ネットワーク障害
- **発生点**: 任意のステップ
- **処理**:
  - *e1. システムエラーまたはネットワーク障害が発生した場合
  - *e2. システムがセッション状態を保持する
  - *e3. システムがエラーログを記録し、管理者に通知する
  - *e4. ユーザーに一時的な問題である旨を通知し、再試行を案内する
  - *e5. 自動リトライ機能を提供する

## 特別要件

### セキュリティ要件
- **時間窓制限**: TOTP仕様に準拠した30秒時間窓、±1窓の許容
- **レート制限**: 同一ユーザーからの認証試行を1分間に10回まで制限
- **ブルートフォース対策**: 3回連続失敗でアカウント一時ロック
- **セッション管理**: 認証成功時の既存セッション無効化

### ユーザビリティ要件
- **リアルタイム検証**: 6桁入力完了と同時に自動検証開始
- **視覚的フィードバック**: 検証中のローディング、成功・失敗の明確な表示
- **時間案内**: コード有効期限のリアルタイム表示
- **代替手段案内**: バックアップコード利用への明確な導線

### 性能要件
- **検証処理**: 500ms以内でのコード検証完了
- **画面遷移**: 認証成功後1秒以内での次画面表示
- **リアルタイム更新**: 100ms以内での入力フィードバック

## ドメインサービス連携
- **MFASecurityService.authenticate[UserAccess]()**: ユーザーアクセスの認証実行
- **SessionManagementService.elevate[SecurityLevel]()**: セキュリティレベルの向上

## 入出力仕様

### 入力（フロントエンド → API）
```json
{
  "mfaAuth": {
    "sessionId": "UUID",
    "verificationCode": "123456",
    "clientTimestamp": "2024-10-21T10:30:00Z",
    "deviceFingerprint": "hash_string"
  }
}
```

### 出力（API → フロントエンド）
```json
{
  "result": "success|failure|locked",
  "authData": {
    "sessionToken": "jwt_token",
    "expiresAt": "2024-10-21T18:30:00Z",
    "permissions": ["read", "write"],
    "mfaStatus": "authenticated"
  },
  "status": {
    "remainingAttempts": 2,
    "lockoutUntil": null,
    "nextAction": "dashboard_redirect"
  },
  "feedback": {
    "message": "認証に成功しました",
    "redirectUrl": "/dashboard"
  }
}
```

### エラーレスポンス例
```json
{
  "result": "failure",
  "error": {
    "code": "INVALID_CODE",
    "message": "認証コードが正しくありません",
    "details": "新しいコードを生成してから再度お試しください"
  },
  "status": {
    "remainingAttempts": 1,
    "lockoutUntil": null,
    "timeWindow": "残り23秒で新しいコード生成"
  }
}
```

## 関連ユースケース
- **UC-MFA-01**: MFAを有効化する（初回設定完了後の日常利用）
- **UC-MFA-03**: バックアップコードを使用する（認証失敗時の代替手段）
- **UC-MFA-04**: MFAをリセットする（認証不可時の復旧手段）

---
*このユースケースは、セキュリティと利便性を両立し、日常的なMFA認証の最適な体験を実現するパラソル設計v2.0仕様に基づいています*