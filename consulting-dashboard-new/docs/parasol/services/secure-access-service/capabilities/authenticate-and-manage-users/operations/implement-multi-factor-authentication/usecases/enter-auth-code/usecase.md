# ユースケース: 認証コードを入力する

**バージョン**: 2.0.0
**更新日**: 2025-10-20
**パラソル設計v2.0仕様**: 完全準拠

## 基本情報
- **ユースケースID**: UC-MFA-02
- **アクター**: ユーザー、システム
- **概要**: ログイン時に認証アプリから取得した6桁の認証コードを入力し、多要素認証を完了する

## 事前条件
- ユーザーアカウントでMFAが有効化されている
- ユーザーが第一要素（パスワード）認証を完了している
- ユーザーが認証アプリをインストールし、設定済みである
- 認証アプリが正常に動作している

## 事後条件
### 成功時
- MFA認証が完了し、ユーザーがシステムにログインしている
- セキュアなセッションが確立されている
- ログイン成功ログが記録されている
- MFA認証成功通知が送信されている（設定により）

### 失敗時
- ユーザーはログイン前の状態に留まる
- 認証失敗ログが記録されている
- 失敗回数が規定値を超えた場合、一時的なアカウントロックが実行される
- 適切なエラーメッセージとガイダンスが表示されている

## 基本フロー
1. システムがパスワード認証完了後、MFA認証画面を表示する
2. システムが認証コード入力フォームを表示する
3. ユーザーが認証アプリを起動する
4. ユーザーが該当アカウントの6桁認証コードを確認する
5. ユーザーが認証コード入力フィールドに6桁コードを入力する
6. ユーザーが「認証」ボタンをクリックする
7. システムが入力コードの形式を検証する
8. システムが認証コードの有効性を検証する
9. システムが認証成功を確認し、セッションを確立する
10. システムがダッシュボード画面にリダイレクトする
11. システムがMFA認証成功ログを記録する
12. システムがセキュリティ通知を送信する（設定により）

## 代替フロー
### 代替フロー1: 認証コード自動入力
- 5a. デバイスが自動入力機能に対応している場合
  - 5a1. システムが自動入力オプションを表示する
  - 5a2. ユーザーが自動入力を選択する
  - 5a3. システムが認証アプリからコードを自動取得する
  - 5a4. 基本フロー6に進む

### 代替フロー2: バックアップコード利用への切替
- 3a. 認証アプリが利用できない場合
  - 3a1. ユーザーが「バックアップコードを使用」リンクを選択する
  - 3a2. システムがバックアップコード入力画面に遷移する
  - 3a3. UC-MFA-03（バックアップコード利用）に移行する

### 代替フロー3: 信頼できるデバイス設定
- 10a. ユーザーが信頼できるデバイスとして登録を希望する場合
  - 10a1. システムが信頼デバイス登録オプションを表示する
  - 10a2. ユーザーが信頼デバイスとして登録を選択する
  - 10a3. システムがデバイス情報を記録し、次回MFAスキップを設定する
  - 10a4. 基本フロー11に進む

## 例外フロー
### 例外1: 認証コード有効期限切れ
- 8a. 入力された認証コードが有効期限切れの場合
  - 8a1. システムが有効期限切れエラーを表示する
  - 8a2. システムが新しいコード取得の案内を表示する
  - 8a3. 基本フロー3に戻る

### 例外2: 認証コード形式エラー
- 7a. 入力された認証コードが形式不正の場合
  - 7a1. システムが形式エラーメッセージを表示する
  - 7a2. システムが正しい入力形式を案内する
  - 7a3. 基本フロー5に戻る

### 例外3: 認証連続失敗
- 8b. 認証コード検証が連続で失敗した場合
  - 8b1. システムが失敗回数をカウントアップする
  - 8b2. 3回失敗時、システムが警告メッセージを表示する
  - 8b3. 5回失敗時、システムがアカウントを一時ロックする
  - 8b4. システムがセキュリティアラートを管理者に送信する

### 例外4: 時刻同期エラー
- 8c. デバイスとサーバーの時刻が大幅にずれている場合
  - 8c1. システムが時刻同期エラーを検出する
  - 8c2. システムが時刻同期の案内を表示する
  - 8c3. ユーザーがデバイス時刻を修正する
  - 8c4. 基本フロー3に戻る

## 🏗️ パラソルドメイン連携

### マイクロサービス設計原則（ユースケース利用型）
- **自サービス管理**: AuthenticationAttemptEntity（認証試行記録）、MFASessionEntity（MFAセッション管理）
- **他サービス連携**: 他サービス公開ユースケース利用（エンティティ直接参照禁止）

#### 📊 操作エンティティ
- **AuthenticationAttemptEntity** (自サービス管理・新規作成): pending → success → expired
- **MFASessionEntity** (自サービス管理・状態更新): pending → verified → active
- **MFAConfigurationEntity** (自サービス管理・参照のみ): 設定済みMFA情報の検証用参照

#### 🏢 パラソル集約
- **MFAAuthenticationAggregate** - MFA認証プロセス統合管理
  - 集約ルート: MFASession
  - 包含エンティティ: AuthenticationAttempt, CodeValidation, SecurityEvent, TrustedDevice
  - 不変条件: 有効期限内コードのみ認証可能、連続失敗時の自動ロック、セッション一意性保証

#### ⚙️ ドメインサービス
- **MFAValidationService**: enhance[AuthenticationSecurity]() - 認証セキュリティ向上
- **SessionEstablishmentService**: coordinate[SecureAccess]() - 安全アクセス統制
- **SecurityMonitoringService**: strengthen[ThreatDetection]() - 脅威検出強化

#### 🔗 他サービスユースケース利用（ユースケース呼び出し型）
**責務**: ❌ エンティティ知識不要 ✅ ユースケース利用のみ

**[secure-access-service] 自サービス内利用:**
├── UC-AUTH-01: セッション管理を実行する → POST /api/auth/manage-session
├── UC-AUTH-02: セキュリティログを記録する → POST /api/auth/log-security-event
└── UC-AUTH-03: アクセス制御を検証する → POST /api/auth/validate-access-control

**[collaboration-facilitation-service] ユースケース利用:**
├── UC-COMM-01: ログイン成功通知を配信する → POST /api/notifications/send-login-success
├── UC-COMM-02: セキュリティアラートを送信する → POST /api/notifications/send-security-alert
└── UC-COMM-03: 管理者に異常ログイン報告を送信する → POST /api/notifications/send-anomaly-report

## 特別要件
- **性能**: 認証コード検証は1秒以内に完了
- **セキュリティ**: 認証試行は必ず監査ログに記録、失敗時のレート制限
- **可用性**: 99.9%の認証可用性、タイムアウト時の適切なフォールバック
- **ユーザビリティ**: 30秒の認証コード有効期限内での快適な入力体験

## 関連ユースケース
- **前提**: UC-MFA-01（MFA有効化）、UC-AUTH-01（パスワード認証）
- **代替**: UC-MFA-03（バックアップコード利用）
- **拡張**: UC-AUTH-02（セッション管理）、UC-COMM-01（通知配信）
- **依存**: UC-AUTH-03（セキュリティログ記録）

## 認証コード検証の技術仕様

### TOTP（Time-based One-Time Password）仕様
- **アルゴリズム**: RFC 6238準拠のTOTP
- **コード長**: 6桁数字
- **有効期間**: 30秒
- **時刻同期許容**: ±30秒（前後1ステップ）
- **ハッシュ関数**: SHA-1（互換性重視）

### セキュリティ制御
- **レート制限**: 同一ユーザー5回/分、同一IP 20回/分
- **連続失敗制御**: 5回連続失敗でアカウント一時ロック（15分）
- **時刻同期**: サーバー時刻とのずれ検出・警告
- **リプレイ攻撃防止**: 使用済みコードの記録・再利用禁止

### ユーザビリティ向上
- **入力支援**: 自動フォーカス・数字のみ入力制限
- **視覚的フィードバック**: 残り有効時間の表示・進捗インジケーター
- **エラーガイダンス**: 具体的な解決手順・代替方法の提示
- **アクセシビリティ**: 音声読み上げ・大文字表示対応

## ビジネス価値
迅速で確実なMFA認証体験により、セキュリティを損なうことなく優れたユーザビリティを実現する。適切なエラーハンドリングと代替手段の提供により、ユーザーの認証成功率99%以上を維持し、組織全体のセキュリティレベル向上と生産性維持を両立する。