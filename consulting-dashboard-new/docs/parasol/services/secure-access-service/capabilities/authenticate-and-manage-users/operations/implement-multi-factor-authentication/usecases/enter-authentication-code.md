# ユースケース: 認証コードを入力する

## 基本情報
- **ユースケースID**: UC-SEC-002
- **アクター**: ユーザー, システム
- **概要**: MFAが有効化されたユーザーがログイン時に認証アプリからの6桁コードを入力して本人確認を完了する

## 事前条件
- ユーザーアカウントでMFAが有効化されている
- ユーザーが正しいユーザー名・パスワードでプライマリ認証を完了している
- 認証アプリがユーザーのデバイスで正常に動作している
- 認証アプリに該当アカウントが登録されている

## 事後条件
### 成功時
- ユーザーがシステムに完全にログインする
- セッショントークンが発行される
- ログイン成功ログが記録される
- ユーザーがダッシュボードまたはリクエストされたページにリダイレクトされる

### 失敗時
- ユーザーがログイン未完了状態を維持する
- 失敗ログが記録される
- 連続失敗時は一時的にアカウントロックが実行される
- 適切なエラーメッセージが表示される

## 基本フロー
1. システムがプライマリ認証完了を検知する
2. システムがMFA認証画面を表示する
3. システムが6桁認証コード入力フィールドを表示する
4. ユーザーが認証アプリを開く
5. ユーザーが該当アカウントの現在のコードを確認する
6. ユーザーが6桁認証コードを入力する
7. システムがコードの形式を検証する
8. システムがコードの正当性をTOTP（Time-based One-Time Password）アルゴリズムで検証する
9. システムがユーザーセッションを確立する
10. システムがダッシュボードにリダイレクトする

## 代替フロー
### 代替フロー1: コード期限切れ
- 8a. 入力されたコードが期限切れの場合
  - 8a1. システムがコード期限切れメッセージを表示する
  - 8a2. システムが新しいコードの入力を促す
  - 8a3. 基本フロー4に戻る

### 代替フロー2: コード形式エラー
- 7a. 入力されたコードが6桁数字でない場合
  - 7a1. システムが形式エラーメッセージを表示する
  - 7a2. システムが正しい形式での再入力を促す
  - 7a3. 基本フロー6に戻る

### 代替フロー3: コード不正
- 8b. 入力されたコードが認証に失敗した場合
  - 8b1. システムが不正コードエラーメッセージを表示する
  - 8b2. システムが失敗回数をカウントする
  - 8b3. 失敗回数が3回未満の場合、基本フロー6に戻る
  - 8b4. 失敗回数が3回の場合、代替フロー4に進む

### 代替フロー4: 連続失敗によるロック
- 8c. 認証コード入力が3回連続で失敗した場合
  - 8c1. システムがアカウント一時ロックを実行する
  - 8c2. システムがロック通知メッセージを表示する
  - 8c3. システムが15分間のロック時間を設定する
  - 8c4. システムが管理者とユーザーにロック通知を送信する
  - 8c5. ロック時間経過後、ログイン画面に戻る

## 例外フロー
### 例外1: システムエラー
- *a. 認証処理中にシステムエラーが発生した場合
  - *a1. システムが一般的なエラーメッセージを表示する
  - *a2. システムがエラーログを記録する
  - *a3. システムが管理者にエラー通知を送信する
  - *a4. ユーザーに後で再試行するよう案内する

### 例外2: 時刻同期エラー
- *b. サーバー時刻とクライアント時刻の差が大きい場合
  - *b1. システムが時刻同期エラーを検知する
  - *b2. システムが許容範囲内で時刻補正を試行する
  - *b3. 補正不可能な場合、管理者に通知する

### 例外3: デバイス紛失時
- *c. ユーザーが認証デバイスにアクセスできない場合
  - *c1. システムがバックアップコード入力オプションを表示する
  - *c2. ユーザーがバックアップコード利用を選択する
  - *c3. 「バックアップコードを使用する」ユースケースに移行する

## 特別要件
- **セキュリティ**: コード入力失敗ログを詳細記録、不正アクセス検知に活用
- **パフォーマンス**: コード検証処理は1秒以内で完了すること
- **可用性**: 時刻同期エラーに対する30秒の許容範囲を設定
- **ユーザビリティ**: 認証アプリが利用できない場合の代替手段を明示

## 関連ユースケース
- **包含**: なし
- **拡張**: 「バックアップコードを使用する」（認証デバイス紛失時）
- **汎化**: なし