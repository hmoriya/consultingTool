# ユースケース: バックアップコードを使用する

## 基本情報
- **ユースケースID**: UC-SEC-003
- **アクター**: ユーザー, システム
- **概要**: 認証デバイスが利用できない緊急時にバックアップコードを使用してMFA認証を完了する

## 事前条件
- ユーザーアカウントでMFAが有効化されている
- ユーザーが正しいユーザー名・パスワードでプライマリ認証を完了している
- バックアップコードが事前に生成・保存されている
- 認証デバイス（スマートフォン等）が利用できない状況である

## 事後条件
### 成功時
- ユーザーがシステムに完全にログインする
- 使用されたバックアップコードが無効化される
- バックアップコード使用ログが記録される
- 残りバックアップコード数が1つ減る
- ユーザーがダッシュボードまたはリクエストされたページにリダイレクトされる

### 失敗時
- ユーザーがログイン未完了状態を維持する
- 失敗ログが記録される
- 無効なコード使用試行が記録される
- 適切なエラーメッセージが表示される

## 基本フロー
1. システムがMFA認証画面を表示する
2. ユーザーが「バックアップコードを使用」オプションを選択する
3. システムがバックアップコード入力画面を表示する
4. システムがバックアップコード使用に関する注意事項を表示する
5. ユーザーが保存されたバックアップコードの1つを確認する
6. ユーザーがバックアップコードを入力する
7. システムがコードの形式を検証する
8. システムが入力されたコードを未使用バックアップコードリストと照合する
9. システムが使用されたコードを無効化する
10. システムが残りバックアップコード数を更新する
11. システムがユーザーセッションを確立する
12. システムがダッシュボードにリダイレクトする

## 代替フロー
### 代替フロー1: コード形式エラー
- 7a. 入力されたコードが正しい形式でない場合
  - 7a1. システムが形式エラーメッセージを表示する
  - 7a2. システムが正しい形式での再入力を促す
  - 7a3. 基本フロー6に戻る

### 代替フロー2: 無効コード
- 8a. 入力されたコードが無効または既に使用済みの場合
  - 8a1. システムが無効コードエラーメッセージを表示する
  - 8a2. システムが別のバックアップコード入力を促す
  - 8a3. 基本フロー6に戻る

### 代替フロー3: バックアップコード枯渇警告
- 10a. 残りバックアップコードが2個以下になった場合
  - 10a1. システムが枯渇警告メッセージを表示する
  - 10a2. システムが新しいバックアップコード生成を推奨する
  - 10a3. ユーザーが生成を選択した場合、新規生成処理に移行する
  - 10a4. ユーザーが後で実行を選択した場合、基本フロー11に進む

### 代替フロー4: 認証デバイス復旧確認
- 12a. ログイン成功後の画面で
  - 12a1. システムが認証デバイス状況確認メッセージを表示する
  - 12a2. ユーザーがデバイス復旧を報告した場合、通常のMFA認証に戻す
  - 12a3. ユーザーがデバイス紛失を報告した場合、MFAリセット手順に案内する

## 例外フロー
### 例外1: バックアップコード全消費
- 8b. 全てのバックアップコードが使用済みの場合
  - 8b1. システムがバックアップコード枯渇メッセージを表示する
  - 8b2. システムが管理者による認証リセットが必要である旨を通知する
  - 8b3. システムが管理者にリセット要求通知を送信する
  - 8b4. ユーザーに管理者への連絡方法を案内する

### 例外2: システムエラー
- *a. 認証処理中にシステムエラーが発生した場合
  - *a1. システムが一般的なエラーメッセージを表示する
  - *a2. システムがエラーログを記録する
  - *a3. システムが管理者にエラー通知を送信する
  - *a4. ユーザーに後で再試行するよう案内する

### 例外3: 不正利用検知
- *b. 短時間内に複数のバックアップコード試行を検知した場合
  - *b1. システムが不正利用の可能性を検知する
  - *b2. システムがアカウント一時ロックを実行する
  - *b3. システムが管理者とユーザーに緊急通知を送信する
  - *b4. システムがセキュリティログに詳細を記録する

## 特別要件
- **セキュリティ**: バックアップコード使用時は特別なセキュリティログを記録
- **可用性**: バックアップコードは認証デバイス紛失時の最後の認証手段として機能
- **監査性**: バックアップコード使用は高リスク行動として監査対象にする
- **ユーザビリティ**: 残りコード数の視覚的な表示とアラート機能

## 関連ユースケース
- **包含**: なし
- **拡張**: 「MFAをリセットする」（全バックアップコード消費時）
- **汎化**: なし