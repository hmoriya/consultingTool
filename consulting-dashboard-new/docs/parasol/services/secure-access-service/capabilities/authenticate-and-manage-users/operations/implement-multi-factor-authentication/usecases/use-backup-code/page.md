# ページ定義: バックアップコード入力ページ

**バージョン**: 2.0.0
**更新日**: 2025-10-21
**設計方針**: 緊急時対応・分かりやすい案内・セキュリティ確保

## 画面の目的
認証アプリが利用できない緊急時に、ユーザーが事前に保存したバックアップコードを安全かつ確実に入力し、MFA認証を完了できる緊急時アクセス機能を提供する。また、バックアップコードの適切な管理と新規生成の案内を行う。

## 利用者
- **主要利用者**: 認証アプリが利用できないユーザー（スマートフォン故障、アプリ削除等）
- **副次利用者**: 海外出張等で認証アプリの時刻同期に問題があるユーザー、緊急時アクセスが必要な管理者

## 画面構成

### 🚨 緊急時認証セクション（ページ上部）

#### 緊急時状況の説明
- **緊急認証モード表示**:
  - アイコン: 🆘「緊急時認証」
  - 説明: 「認証アプリが利用できない場合の代替手段です」
  - 注意: 「バックアップコードは一度のみ使用可能です」

#### セキュリティ警告
- **重要な注意事項**:
  - 🔒 「バックアップコードは機密情報です」
  - 👀 「周囲に人がいないことを確認してから入力してください」
  - 📝 「使用後は安全に保管している記録から削除してください」

#### 利用状況表示
- **バックアップコード残数**: 「残りバックアップコード: 7個」
- **最終使用**: 「前回使用: 2024-09-15」
- **緊急度表示**: 残り3個以下で「⚠️ 残り少数 - 新規生成推奨」

---

### 📝 バックアップコード入力セクション（メイン）

#### 16文字コード入力フィールド
- **入力フィールド**:
  - 形式: 単一の大きな入力ボックス
  - プレースホルダー: 「abcd-efgh-ijkl-mnop」
  - フォント: モノスペース、大きなサイズ
  - 自動フォーマット: 4文字毎にハイフン自動挿入
  - 大文字・小文字無視: 自動で統一

#### 入力支援機能
- **ペースト対応**:
  - ハイフンあり・なしどちらも対応
  - 「貼り付け」ボタン提供
  - 形式自動調整機能

#### リアルタイム検証
- **入力時フィードバック**:
  - 文字数カウント: 「16文字入力済み」
  - 形式チェック: 有効文字（英数字）のみ許可
  - 完了検知: 16文字入力完了で認証ボタン有効化

---

### 🔍 バックアップコード探し方ガイド（左側）

#### コード保存場所の案内
- **一般的な保存場所**:
  - 📄 「手書きメモ・ノートブック」
  - 💾 「パスワードマネージャー」
  - 🖨️「印刷した紙（金庫・机の引き出し）」
  - 📧 「暗号化されたメール（下書き・アーカイブ）」

#### 探し方のヒント
- **検索キーワード**:
  - 「MFA」「バックアップ」「緊急時」
  - 「２要素認証」「backup codes」
  - サービス名「[アプリケーション名]」

#### 注意すべき場所
- **避けるべき場所**:
  - ❌ 「スクリーンショット（セキュリティリスク）」
  - ❌ 「暗号化されていないクラウドストレージ」
  - ❌ 「共有デバイスのメモ帳」

---

### ⚡ 代替手段・復旧支援セクション（右側）

#### 他の認証方法
- **認証コード入力に戻る**:
  - リンク: 「認証アプリでコードを再試行」
  - 説明: 「アプリが復旧した場合」

#### 管理者支援
- **管理者連絡**:
  - ボタン: 「管理者にMFAリセットを依頼」
  - 説明: 「バックアップコードが見つからない場合」
  - 所要時間: 「通常24時間以内に対応」

#### セルフサービス復旧
- **アカウント復旧**:
  - リンク: 「身元確認によるアカウント復旧」
  - 説明: 「秘密の質問・メール認証による復旧」
  - 条件: 「事前設定が必要」

---

### 📊 認証後案内セクション（認証成功時表示）

#### 新しいバックアップコード生成案内
- **即座生成オプション**:
  - ボタン: 「今すぐ新しいバックアップコードを生成」
  - 説明: 「使用したコードを新しいコードセットで補充」
  - 推奨タイミング: 「今すぐ実行することを強く推奨」

#### セキュリティ状況
- **使用履歴**:
  - 「バックアップコード使用: 1個」
  - 「残りバックアップコード: 6個」
  - 「次回推奨アクション: 新規生成」

#### 今後の予防策
- **推奨対策**:
  - 📱 「認証アプリのバックアップ設定」
  - 🔄 「複数デバイスでの認証アプリ設定」
  - 📄 「バックアップコードの安全な保管方法」

---

## データ表示

### 表示データ一覧
| データ項目 | 表示形式 | 更新頻度 | 説明 |
|-----------|---------|---------|------|
| バックアップコード残数 | 数値表示 | ページ読み込み時 | 利用可能なコード数 |
| コード使用履歴 | 日時表示 | ページ読み込み時 | 最終使用日時 |
| 入力コード検証状況 | リアルタイム | 入力時 | 形式・長さの確認状況 |
| 認証結果 | ステータス表示 | 認証完了時 | 成功・失敗の結果 |

## 入力項目

### フォーム一覧
| 入力項目 | 入力形式 | 必須 | バリデーション | 説明 |
|---------|---------|------|---------------|------|
| バックアップコード | 16文字英数字 | ○ | 英数字のみ、16文字固定 | ハイフン区切り対応 |

### 入力制御
- **自動フォーマット**: 4文字毎のハイフン自動挿入
- **大文字小文字統一**: 自動で小文字に変換
- **不正文字除去**: 英数字以外の文字は自動削除
- **コピー・ペースト**: 全形式のバックアップコードに対応

## アクション・操作

### 主要アクション
- **バックアップコード認証**:
  - トリガー: 「認証する」ボタンクリック
  - 処理: コード検証、認証状態更新
  - 成功時: 認証成功画面→ダッシュボードまたは新規生成案内
  - 失敗時: エラーメッセージ表示、再入力促進

- **新規バックアップコード生成**:
  - トリガー: 「新しいコードを生成」ボタンクリック
  - 処理: MFA設定画面への遷移
  - 結果: 新しい10個セットの生成・表示

### 副次アクション
- **認証方法切り替え**: 認証コード入力への復帰
- **管理者連絡**: MFAリセット依頼フォームの表示
- **ヘルプ表示**: バックアップコード管理ガイドの表示
- **探し方ガイド**: コード探索支援ツールの表示

### 緊急時アクション
- **緊急連絡**: セキュリティ部門への直接連絡
- **インシデント報告**: 不正アクセス疑いの報告
- **アカウント保護**: 一時的なアカウント保護モード

## 画面の振る舞い

### ユーザー操作への反応
- **コード入力時**:
  - 4文字毎の自動ハイフン挿入
  - 16文字完了で認証ボタンの有効化
  - 不正文字入力時の即座拒否・修正

- **認証処理中**:
  - ローディングアニメーション表示
  - 入力フィールドの一時無効化
  - 処理進行状況の表示

- **認証結果表示時**:
  - 成功: 緑色確認マーク + 新規生成案内
  - 失敗: 赤色エラー表示 + 残り試行回数
  - 枯渇: 警告表示 + 管理者連絡案内

### 条件による表示変更
- **残りコード少数時**: 緊急度の高い新規生成案内を強調表示
- **連続失敗時**: セキュリティ警告レベル上昇、管理者連絡案内強調
- **全コード使用済み時**: 管理者連絡のみ表示、自動復旧案内
- **セキュリティロック時**: 全入力無効化、解除時刻表示

## 画面遷移

### 遷移元画面
- **認証コード入力画面**: 「バックアップコードを使用」リンクから
- **認証失敗画面**: 連続失敗時の代替手段として
- **MFA設定画面**: バックアップコードテスト機能から
- **アカウント復旧画面**: 復旧プロセスの一環として

### 遷移先画面
- **ダッシュボード**: 認証成功時（新規生成スキップ）
- **MFA設定画面**: 新しいバックアップコード生成選択時
- **管理者連絡フォーム**: 「管理者に連絡」選択時
- **ログイン画面**: セッション期限切れ・セキュリティロック時

## エラーハンドリング

### エラー表示方法
- **無効なバックアップコード**: 「バックアップコードが正しくありません。16文字の英数字コードを確認してください。」
- **使用済みコード**: 「このバックアップコードは既に使用済みです。別のコードをお試しください。」
- **バックアップコード枯渇**: 「利用可能なバックアップコードがありません。管理者にMFAリセットを依頼してください。」
- **連続失敗**: 「セキュリティのため30分間ロックされます。管理者に連絡するか、しばらく後に再試行してください。」
- **システムエラー**: 「一時的な問題が発生しました。しばらく後に再試行してください。」

### 復旧・対処機能
- **コード探し支援**: 保存場所ガイド、検索キーワード案内
- **代替認証手段**: 他の認証方法への切り替え案内
- **管理者エスカレーション**: 自動的な管理者通知、連絡フォーム
- **セルフサービス復旧**: 身元確認による自動復旧オプション

## アクセシビリティ要件

### キーボードナビゲーション
- タブ順序: バックアップコード入力 → 認証ボタン → 代替手段リンク
- ショートカット: Enter キーでの認証実行、Escape キーでの入力クリア

### スクリーンリーダー対応
- 入力フィールド: 「バックアップコード入力、16文字の英数字」の明確な説明
- エラー内容: 「無効なコードです。正しい16文字のコードを入力してください」
- 進行状況: 「認証中、しばらくお待ちください」の状況説明

### 色覚障害への配慮
- 成功・エラー表示: 色だけでなくアイコンと文字で明確に表現
- 緊急度表示: 色以外の視覚的手がかり（太字、サイズ、アイコン）
- 高コントラスト表示オプション: 視認性向上設定

## レスポンシブ対応

### デスクトップ（1024px以上）
- 3カラムレイアウト: 探し方ガイド | メイン入力 | 代替手段
- 大きな入力フィールド: 視認性とタイピング容易性確保

### タブレット（768px-1023px）
- 2カラムレイアウト: メイン入力 + サイドガイド
- タブ切り替え: 探し方ガイドと代替手段の切り替え表示

### モバイル（767px以下）
- 1カラム縦積み: メイン入力 → アコーディオン形式の補助情報
- 大きなタッチターゲット: モバイル最適化されたボタンサイズ
- スワイプ操作: 左右スワイプでの補助情報表示

## セキュリティ配慮

### データ保護
- 入力コードの即座クリア: 認証完了後の自動削除
- メモリ保護: JavaScript内でのコード情報の即座削除
- 画面キャプチャ防止: セキュアな入力フィールドの利用

### 使用追跡
- 詳細ログ記録: 成功・失敗・使用コードの記録
- 異常パターン検知: 短時間での大量試行の検知
- 管理者通知: 緊急時使用・異常使用の即座通知

### コード管理
- 一回限り使用: 使用済みコードの即座無効化
- 残数管理: リアルタイムでの残数追跡・警告
- 自動期限切れ: 長期未使用コードの定期無効化

---
*このページ定義は、UC-MFA-03「バックアップコードを使用する」と1対1対応し、緊急時の確実なアクセス確保とセキュリティを両立した信頼性の高い認証体験を実現しています*