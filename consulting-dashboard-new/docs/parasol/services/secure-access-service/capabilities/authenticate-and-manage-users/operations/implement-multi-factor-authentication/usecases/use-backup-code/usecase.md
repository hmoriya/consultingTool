# ユースケース: バックアップコードを使用する

**バージョン**: 2.0.0
**更新日**: 2025-10-20
**パラソル設計v2.0仕様**: 完全準拠

## 基本情報
- **ユースケースID**: UC-MFA-03
- **アクター**: ユーザー、システム
- **概要**: 認証アプリが利用できない場合に、事前生成されたバックアップコードを使用して多要素認証を完了する

## 事前条件
- ユーザーアカウントでMFAが有効化されている
- ユーザーが第一要素（パスワード）認証を完了している
- バックアップコードが事前に生成・保存されている
- 認証アプリが利用できない状況である（デバイス紛失、故障、時刻同期エラー等）

## 事後条件
### 成功時
- バックアップコード認証が完了し、ユーザーがシステムにログインしている
- 使用されたバックアップコードが無効化されている
- セキュアなセッションが確立されている
- バックアップコード使用ログが記録されている
- バックアップコード残数が減少している

### 失敗時
- ユーザーはログイン前の状態に留まる
- 無効なバックアップコード使用のログが記録されている
- 連続失敗時は一時的なアカウントロックが実行される
- 適切なエラーメッセージとガイダンスが表示されている

## 基本フロー
1. システムがMFA認証画面でバックアップコードオプションを表示する
2. ユーザーが「バックアップコードを使用」リンクをクリックする
3. システムがバックアップコード入力画面に遷移する
4. システムがバックアップコード入力フォームを表示する
5. ユーザーが保存されたバックアップコードを確認する
6. ユーザーがバックアップコード入力フィールドに10桁コードを入力する
7. ユーザーが「認証」ボタンをクリックする
8. システムがバックアップコードの形式を検証する
9. システムがバックアップコードの有効性を検証する
10. システムが認証成功を確認し、使用済みコードを無効化する
11. システムがセッションを確立し、ダッシュボード画面にリダイレクトする
12. システムがバックアップコード使用ログを記録する
13. システムが残バックアップコード数をチェックし、必要に応じて警告を表示する

## 代替フロー
### 代替フロー1: 認証アプリへの復帰
- 3a. バックアップコード画面で認証アプリが復旧した場合
  - 3a1. ユーザーが「認証アプリを使用」リンクを選択する
  - 3a2. システムが通常のMFA認証画面に戻る
  - 3a3. UC-MFA-02（認証コード入力）に移行する

### 代替フロー2: 新しいバックアップコード生成
- 13a. 残バックアップコード数が3個以下の場合
  - 13a1. システムが新しいバックアップコード生成の案内を表示する
  - 13a2. ユーザーが新しいバックアップコード生成を選択する
  - 13a3. システムが10個の新しいバックアップコードを生成・表示する
  - 13a4. ユーザーが新しいバックアップコードを安全に保存する

### 代替フロー3: 管理者によるリセット
- 10a. 全バックアップコードが使い切られた場合
  - 10a1. システムがバックアップコード枯渇エラーを表示する
  - 10a2. システムが管理者連絡方法を案内する
  - 10a3. ユーザーが管理者にMFAリセットを依頼する
  - 10a4. UC-MFA-04（MFAリセット）に移行する

## 例外フロー
### 例外1: バックアップコード無効
- 9a. 入力されたバックアップコードが無効な場合
  - 9a1. システムが無効コードエラーを表示する
  - 9a2. システムが正しい入力形式を案内する
  - 9a3. 基本フロー6に戻る

### 例外2: バックアップコード既使用
- 9b. 入力されたバックアップコードが既に使用済みの場合
  - 9b1. システムが使用済みコードエラーを表示する
  - 9b2. システムが未使用コードの利用を案内する
  - 9b3. 基本フロー6に戻る

### 例外3: バックアップコード連続失敗
- 9c. バックアップコード認証が連続で失敗した場合
  - 9c1. システムが失敗回数をカウントアップする
  - 9c2. 3回失敗時、システムが警告メッセージを表示する
  - 9c3. 5回失敗時、システムがアカウントを一時ロックする
  - 9c4. システムがセキュリティアラートを管理者に送信する

### 例外4: バックアップコード枯渇
- 9d. 有効なバックアップコードが残っていない場合
  - 9d1. システムがバックアップコード枯渇を検出する
  - 9d2. システムが管理者による手動リセットの案内を表示する
  - 9d3. UC-MFA-04（MFAリセット）への遷移を案内する

## 🏗️ パラソルドメイン連携

### マイクロサービス設計原則（ユースケース利用型）
- **自サービス管理**: BackupCodeEntity（バックアップコード管理）、BackupCodeUsageEntity（使用履歴記録）
- **他サービス連携**: 他サービス公開ユースケース利用（エンティティ直接参照禁止）

#### 📊 操作エンティティ
- **BackupCodeEntity** (自サービス管理・状態更新): unused → used → expired
- **BackupCodeUsageEntity** (自サービス管理・新規作成): 使用履歴とメタデータの記録
- **MFASessionEntity** (自サービス管理・状態更新): pending → backup_verified → active

#### 🏢 パラソル集約
- **BackupCodeRecoveryAggregate** - バックアップコード復旧プロセス統合管理
  - 集約ルート: BackupCodeUsage
  - 包含エンティティ: BackupCode, SecurityEvent, RecoveryAttempt, UserNotification
  - 不変条件: バックアップコードは一度のみ利用可能、使用済みコードの再利用禁止、残数管理の整合性保証

#### ⚙️ ドメインサービス
- **BackupCodeValidationService**: strengthen[AccountRecoverySecurity]() - アカウント復旧セキュリティ強化
- **BackupCodeManagementService**: coordinate[EmergencyAccess]() - 緊急アクセス統制
- **BackupCodeRegenerationService**: enhance[ContinuityPreparation]() - 継続性準備向上

#### 🔗 他サービスユースケース利用（ユースケース呼び出し型）
**責務**: ❌ エンティティ知識不要 ✅ ユースケース利用のみ

**[secure-access-service] 自サービス内利用:**
├── UC-AUTH-01: セッション管理を実行する → POST /api/auth/manage-session
├── UC-AUTH-02: セキュリティログを記録する → POST /api/auth/log-security-event
└── UC-AUTH-03: アクセス制御を検証する → POST /api/auth/validate-access-control

**[collaboration-facilitation-service] ユースケース利用:**
├── UC-COMM-01: バックアップコード使用通知を配信する → POST /api/notifications/send-backup-code-usage
├── UC-COMM-02: セキュリティアラートを送信する → POST /api/notifications/send-security-alert
└── UC-COMM-03: 管理者に復旧支援要請を送信する → POST /api/notifications/send-recovery-request

## 特別要件
- **セキュリティ**: バックアップコード使用は必ず監査ログに記録、使用済みコードの即座無効化
- **可用性**: 99.9%のバックアップコード認証可用性、失敗時の適切なガイダンス
- **継続性**: バックアップコード残数監視、自動警告・生成機能
- **ユーザビリティ**: 10桁コードの快適な入力体験、明確なエラーメッセージ

## 関連ユースケース
- **前提**: UC-MFA-01（MFA有効化）、UC-AUTH-01（パスワード認証）
- **代替**: UC-MFA-02（認証コード入力）の代替手段
- **拡張**: UC-MFA-04（MFAリセット）、UC-AUTH-02（セッション管理）
- **依存**: UC-AUTH-03（セキュリティログ記録）

## バックアップコードの技術仕様

### バックアップコード形式
- **コード長**: 10桁英数字（例：AB12CD34EF）
- **文字種**: 大文字アルファベット（A-Z）・数字（0-9）
- **生成数**: 初回10個、消費時に自動補充
- **有効期限**: 生成から1年間
- **使用回数**: 各コード1回のみ

### セキュリティ制御
- **レート制限**: 同一ユーザー5回/5分、同一IP 10回/5分
- **連続失敗制御**: 5回連続失敗でアカウント一時ロック（30分）
- **使用追跡**: 全使用履歴の記録・監視
- **不正利用検出**: 異常な使用パターンの検出・アラート

### ユーザビリティ向上
- **入力支援**: 自動フォーカス・大文字変換・区切り表示
- **視覚的フィードバック**: 残り有効コード数の表示・使用状況インジケーター
- **エラーガイダンス**: 具体的な解決手順・代替方法の提示
- **アクセシビリティ**: 音声読み上げ・大文字表示対応

### バックアップコード管理
- **自動補充**: 残り3個以下で新規生成の案内
- **重複排除**: 既存コードとの重複チェック・再生成
- **安全保存**: 印刷推奨・パスワードマネージャー連携
- **定期更新**: 年次での全コード更新推奨

## ビジネス価値
認証アプリが利用できない緊急時における確実なアクセス復旧により、ユーザーの業務継続性を保証する。同時に、厳格なセキュリティ制御により不正利用を防止し、組織全体のセキュリティレベル維持と生産性確保を両立する。バックアップコードの計画的管理により、ユーザーの自立的なアカウント管理を促進する。