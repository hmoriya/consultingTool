# ユースケース: バックアップコードを使用する

**バージョン**: 2.0.0
**更新日**: 2025-10-21
**設計方針**: 緊急時対応・セキュリティ確保・利用追跡

## 基本情報
- **ユースケースID**: UC-MFA-03
- **アクター**: ユーザー（主アクター）、システム（副アクター）
- **概要**: 認証アプリが利用できない緊急時に、事前に生成されたバックアップコードを使用してMFA認証を完了する

## 🏗️ パラソルドメイン連携

### 操作エンティティ
- **BackupCodeEntity**（自サービス管理・状態更新: unused → used）: バックアップコードの使用状況管理
- **MFAConfigurationEntity**（自サービス管理・状態参照: verified状態の確認）: MFA設定の有効性確認
- **SessionEntity**（自サービス管理・状態更新: pending → authenticated）: セッション認証状態の更新

### 他サービスユースケース利用
- **collaboration-facilitation-service**: UC-NOTIFY-01: セキュリティアラートを送信する（バックアップコード使用通知）
- **project-success-service**: UC-AUDIT-01: セキュリティ監査ログを記録する
- **knowledge-co-creation-service**: UC-KNOWLEDGE-04: セキュリティ教育資料を提供する（新しいバックアップコード生成案内）

## 事前条件
- ユーザーがログイン画面で基本認証（ユーザー名・パスワード）を完了している
- ユーザーのアカウントでMFAが有効化されている（MFAConfigurationEntity.status = verified）
- 事前にバックアップコードが生成・保存されている（BackupCodeEntity.status = unused）
- 認証アプリが利用不可または認証コード認証に失敗している状況

## 事後条件
### 成功時
- 使用されたBackupCodeEntityの状態がunused → usedに変更されている
- SessionEntityの状態がpending → authenticatedに変更されている
- バックアップコード使用のセキュリティアラートが送信されている
- セキュリティ監査ログが記録されている
- ユーザーが新しいバックアップコード生成の案内を受けている

### 失敗時
- BackupCodeEntityの状態は変更されていない
- SessionEntityの状態はpendingのまま維持されている
- 不正アクセス試行のセキュリティログが記録されている
- ユーザーに適切なエラーメッセージが表示されている

## 基本フロー
1. **ユーザー**が認証コード入力画面で「バックアップコードを使用」を選択する
2. **システム**がバックアップコード入力画面を表示する
3. **システム**がMFAConfigurationEntityの有効性を確認する
4. **ユーザー**が保存していたバックアップコードを準備する
5. **ユーザー**が16文字のバックアップコードを入力する
6. **システム**が入力されたコードをBackupCodeEntitysと照合する
7. **システム**が有効かつ未使用のコードであることを確認する
8. **システム**がBackupCodeEntityの状態をunused → usedに更新する
9. **システム**がSessionEntityの状態をpending → authenticatedに更新する
10. **システム**がバックアップコード使用アラートを送信する（他サービス連携）
11. **システム**がセキュリティ監査ログを記録する（他サービス連携）
12. **システム**が新しいバックアップコード生成案内を表示する
13. **システム**がメインダッシュボードへリダイレクトする

## 代替フロー

### 代替フロー1: 即座新バックアップコード生成
- **分岐点**: ステップ12（生成案内表示）
- **条件**: ユーザーが即座に新しいバックアップコード生成を希望
- **処理**:
  - 12a1. ユーザーが「今すぐ新しいコードを生成」を選択する
  - 12a2. システムがMFAを有効化するユースケースの一部を実行する
  - 12a3. 新しいバックアップコードセットを生成・表示する
  - 12a4. ユーザーが新しいコードセットを保存完了を確認する
  - 12a5. ステップ13に続行

### 代替フロー2: 警告付き認証（残り少数）
- **分岐点**: ステップ7（コード照合）
- **条件**: 残りのバックアップコードが3個以下
- **処理**:
  - 7a1. システムが使用可能バックアップコード数を確認する
  - 7a2. 残り数の警告を表示する「残りバックアップコード: 2個」
  - 7a3. 緊急コード生成の強い推奨案内を表示する
  - 7a4. ステップ8に続行（通常の認証処理）

### 代替フロー3: 管理者通知付き認証
- **分岐点**: ステップ10（アラート送信）
- **条件**: 管理者権限ユーザーまたは重要アカウント
- **処理**:
  - 10a1. システムがユーザーのアカウント重要度を確認する
  - 10a2. 重要アカウントの場合、管理者に即座通知する
  - 10a3. 「重要アカウントでのバックアップコード使用」アラートを送信
  - 10a4. ステップ11に続行

## 例外フロー

### 例外1: バックアップコード全消費
- **発生点**: ステップ3（事前確認）
- **処理**:
  - 3e1. システムが利用可能バックアップコードが0個であることを検知
  - 3e2. 「バックアップコードがすべて使用済みです」を表示
  - 3e3. 管理者によるMFAリセットの案内を表示
  - 3e4. 管理者連絡フォームへのリンクを提供
  - 3e5. ユースケース終了

### 例外2: 不正バックアップコード連続試行
- **発生点**: ステップ6（コード照合）
- **処理**:
  - 6e1. 3回連続で無効なバックアップコードが入力された場合
  - 6e2. システムが30分間のバックアップコード認証ロックを適用
  - 6e3. 高優先度セキュリティアラートを送信する（他サービス連携）
  - 6e4. 「不正アクセスの可能性があります」の警告を表示
  - 6e5. 管理者連絡およびMFAリセット手順を案内

### 例外3: MFA設定無効化検出
- **発生点**: ステップ3（MFA有効性確認）
- **処理**:
  - 3e1. MFAConfigurationEntityが無効状態の場合
  - 3e2. 「MFA設定が無効化されています」を表示
  - 3e3. 通常ログインフローにリダイレクト
  - 3e4. MFA設定変更の監査ログを記録
  - 3e5. セキュリティ管理者に設定変更アラートを送信

## 特別要件

### セキュリティ要件
- **一回限り使用**: 各バックアップコードは一度のみ使用可能
- **暗号化保存**: バックアップコードのハッシュ化保存
- **使用追跡**: すべてのバックアップコード使用の詳細ログ記録
- **緊急時通知**: バックアップコード使用時の即座アラート送信

### 運用要件
- **コード管理**: 10個セットでの生成・管理
- **残数警告**: 残り3個以下での強制的な再生成案内
- **全消費時対応**: 管理者による強制リセット手順の明確化
- **定期監査**: バックアップコード使用パターンの分析

### ユーザビリティ要件
- **明確な案内**: バックアップコードの探し方・入力方法の詳細説明
- **エラー原因特定**: 無効コードの理由（使用済み、不正、期限切れ）の明確化
- **代替手段案内**: バックアップコード以外の復旧手段の案内
- **新規生成支援**: 簡単な新しいバックアップコード生成フロー

### 性能要件
- **照合処理**: 500ms以内でのバックアップコード検証完了
- **状態更新**: 1秒以内での使用状態更新
- **通知配信**: 3秒以内でのセキュリティアラート送信

## ドメインサービス連携
- **MFARecoveryService.coordinate[EmergencyAccess]()**: 緊急時アクセス回復の調整
- **SecurityMonitoringService.track[BackupCodeUsage]()**: バックアップコード使用追跡

## 入出力仕様

### 入力（フロントエンド → API）
```json
{
  "backupCodeAuth": {
    "sessionId": "UUID",
    "backupCode": "abcd-efgh-ijkl-mnop",
    "clientTimestamp": "2024-10-21T10:30:00Z",
    "emergencyContext": "認証アプリ故障"
  }
}
```

### 出力（API → フロントエンド）
```json
{
  "result": "success|failure|exhausted",
  "authData": {
    "sessionToken": "jwt_token",
    "expiresAt": "2024-10-21T18:30:00Z",
    "permissions": ["read", "write"],
    "mfaStatus": "authenticated_backup"
  },
  "backupStatus": {
    "remainingCodes": 7,
    "lastUsed": "2024-10-21T10:30:00Z",
    "regenerationRequired": false,
    "urgentRegeneration": false
  },
  "feedback": {
    "message": "バックアップコード認証成功",
    "warning": "残りバックアップコード: 7個",
    "nextAction": "新しいバックアップコード生成を推奨"
  }
}
```

### 緊急時レスポンス例
```json
{
  "result": "exhausted",
  "error": {
    "code": "NO_BACKUP_CODES",
    "message": "利用可能なバックアップコードがありません",
    "details": "管理者によるMFAリセットが必要です"
  },
  "recovery": {
    "adminContact": "admin@example.com",
    "resetProcedure": "/mfa/reset/request",
    "estimatedTime": "24時間以内"
  }
}
```

## 関連ユースケース
- **UC-MFA-01**: MFAを有効化する（新しいバックアップコード生成）
- **UC-MFA-02**: 認証コードを入力する（認証失敗時の代替手段）
- **UC-MFA-04**: MFAをリセットする（バックアップコード全消費時の復旧）

---
*このユースケースは、緊急時の確実なアクセス確保とセキュリティの両立を実現するパラソル設計v2.0仕様に基づいています*