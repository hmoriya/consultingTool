# ユースケース: パスワードをリセットする

## 基本情報
- **ユースケースID**: UC-SEC-006
- **アクター**: ユーザー, システム, 管理者
- **概要**: パスワードを忘れたユーザーが安全な方法でパスワードをリセットし、新しいパスワードを設定してアカウントアクセスを回復する

## 事前条件
- ユーザーアカウントが存在し有効である
- ユーザーが登録したメールアドレスが有効である
- パスワードリセット機能が有効になっている
- ユーザーが現在のパスワードを忘れている、または知らない状況である

## 事後条件
### 成功時
- ユーザーのパスワードが新しいパスワードに更新される
- 古いパスワードが完全に無効化される
- パスワードリセット完了通知がユーザーに送信される
- パスワード履歴に新しいパスワードハッシュが記録される
- セキュリティログにパスワードリセットが記録される

### 失敗時
- 既存のパスワードが維持される
- エラーメッセージが表示される
- 失敗ログが記録される
- 不正利用の可能性がある場合、アカウント保護措置が実行される

## 基本フロー
1. ユーザーがログイン画面で「パスワードを忘れた」を選択する
2. システムがパスワードリセット画面を表示する
3. システムがメールアドレス入力を要求する
4. ユーザーが登録済みメールアドレスを入力する
5. システムがメールアドレスの存在を確認する
6. システムが一意のリセットトークンを生成する
7. システムがリセットリンク付きメールを送信する
8. ユーザーがメール内のリセットリンクをクリックする
9. システムがトークンの有効性を検証する
10. システムが新しいパスワード設定画面を表示する
11. ユーザーが新しいパスワードを入力する
12. システムがパスワードポリシー適合性を検証する
13. システムが新しいパスワードを暗号化して保存する
14. システムがパスワードリセット完了通知を送信する

## 代替フロー
### 代替フロー1: メールアドレス未登録
- 5a. 入力されたメールアドレスが登録されていない場合
  - 5a1. システムがセキュリティ上、成功と同じメッセージを表示する
  - 5a2. システムが実際にはメールを送信しない
  - 5a3. システムが未登録メール試行をログに記録する
  - 5a4. ユースケース終了

### 代替フロー2: トークン期限切れ
- 9a. リセットトークンが期限切れの場合
  - 9a1. システムが期限切れエラーメッセージを表示する
  - 9a2. システムが新しいリセット要求を促す
  - 9a3. 基本フロー2に戻る

### 代替フロー3: 無効トークン
- 9b. リセットトークンが無効または改ざんされている場合
  - 9b1. システムが無効トークンエラーメッセージを表示する
  - 9b2. システムがセキュリティ警告をログに記録する
  - 9b3. システムが管理者に不正アクセス試行を通知する
  - 9b4. 基本フロー2に戻る

### 代替フロー4: 管理者によるリセット
- 1a. 管理者がユーザーのパスワードリセットを実行する場合
  - 1a1. 管理者がユーザー管理画面でパスワードリセットを選択する
  - 1a2. 管理者が本人確認を実施する
  - 1a3. システムが一時パスワードを生成する
  - 1a4. システムがユーザーに一時パスワードを通知する
  - 1a5. ユーザーが初回ログイン時に新しいパスワード設定を強制される

## 例外フロー
### 例外1: メール送信失敗
- 7a. リセットメールの送信に失敗した場合
  - 7a1. システムがメール送信エラーをログに記録する
  - 7a2. システムが管理者にメール送信失敗を通知する
  - 7a3. ユーザーに別の方法（SMS、管理者経由）での対応を案内する
  - 7a4. 基本フロー3に戻る

### 例外2: 頻繁なリセット要求
- 3a. 短時間内に同一メールアドレスで複数回のリセット要求を検知した場合
  - 3a1. システムが不正利用の可能性を警告する
  - 3a2. システムが一時的にリセット要求を制限する
  - 3a3. システムが管理者に異常なリセット要求を通知する
  - 3a4. ユーザーに管理者への直接連絡を案内する

### 例外3: システムエラー
- *a. パスワードリセット処理中にシステムエラーが発生した場合
  - *a1. システムがトランザクションをロールバックする
  - *a2. システムがエラーログを記録する
  - *a3. システムが管理者にエラー通知を送信する
  - *a4. ユーザーに後で再試行するよう案内する

## 特別要件
- **セキュリティ**: リセットトークンは1回限り使用で30分の有効期限を設定
- **セキュリティ**: リセット要求の頻度制限（同一IPから1時間に3回まで）
- **可用性**: リセットメールは5分以内に配信される
- **監査性**: 全てのリセット要求と実行を詳細ログと共に記録

## 関連ユースケース
- **包含**: なし
- **拡張**: 「パスワードを変更する」（リセット完了後の通常変更）
- **汎化**: なし