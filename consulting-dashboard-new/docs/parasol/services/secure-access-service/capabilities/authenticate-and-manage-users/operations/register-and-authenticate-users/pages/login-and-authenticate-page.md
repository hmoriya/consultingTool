# ページ定義：ログイン・認証

## 画面の目的
ユーザーがメールアドレスとパスワードで本人確認を行い、システムへ安全にアクセスする画面。認証成功後、ユーザーのロールに応じた適切なダッシュボードへ導く。

## 利用者
- **全ユーザー**: Executive、PM、Consultant、Client、Admin
- **初回ログインユーザー**: パスワード変更が必要な新規アカウント保持者
- **MFA有効ユーザー**: 多要素認証を設定しているユーザー

## 画面構成

### ヘッダー部
- アプリケーションロゴ（中央配置）
- サービス名「コンサルティングダッシュボード」（ロゴ下）
- 言語切り替え（右上）：日本語/English

### ログインフォーム部（中央配置）

#### メインタイトル
- 「ログイン」見出し（大きく表示）
- サブテキスト「アカウント情報を入力してください」

#### 入力フィールド
- **メールアドレス**
  - プレースホルダー：「your.name@example.com」
  - 入力タイプ：email（メールアドレス用キーボード）
  - アイコン：📧（メールアイコン、フィールド左側）

- **パスワード**
  - プレースホルダー：「パスワードを入力」
  - 入力タイプ：password（マスク表示）
  - 表示/非表示切り替えボタン（目のアイコン、フィールド右側）
  - アイコン：🔒（鍵アイコン、フィールド左側）

#### オプション設定
- **ログイン状態を保持する**（チェックボックス）
  - デフォルト：未チェック
  - チェック時：30日間セッション保持

#### アクションボタン
- **ログインボタン**（プライマリボタン、青、幅100%）
  - 全ての必須項目入力後に有効化
  - クリックで認証処理を実行
  - ローディング時：スピナー表示、ボタン無効化

#### 補助リンク
- **パスワードをお忘れですか？**（テキストリンク、右寄せ）
  - パスワードリセット画面へ遷移

- **アカウントをお持ちでない方**（テキスト、中央）
  - 「新規アカウント申請」リンク

### フッター部
- プライバシーポリシーへのリンク
- 利用規約へのリンク
- お問い合わせ窓口の表示（メールアドレスまたは電話番号）
- コピーライト表記「© 2024 Consulting Firm. All rights reserved.」

## データ表示

### 初期表示
- 空のログインフォーム
- ログインボタンは無効状態
- エラーメッセージなし

### エラー表示
- **認証エラー**
  - フォーム上部に赤背景のエラーバナー表示
  - 「メールアドレスまたはパスワードが正しくありません」
  - エラーアイコン（⚠️）付き

- **アカウントロックエラー**
  - 「アカウントがロックされています。管理者にお問い合わせください」
  - ロックアイコン（🔒）付き

- **バリデーションエラー**
  - 各フィールド下に赤字でエラー表示
  - 例：「メールアドレスの形式が正しくありません」

### 成功表示
- ログイン成功時：緑のチェックマーク（✅）とともに「ログインしています...」
- ダッシュボードへリダイレクト（1秒後）

## 入力項目

| 項目 | 形式 | 必須 | バリデーション |
|------|------|------|---------------|
| メールアドレス | テキスト（email） | ○ | RFC5322準拠、100文字以内 |
| パスワード | パスワード | ○ | 1文字以上 |
| ログイン状態保持 | チェックボックス | × | - |

## 画面の振る舞い

### ログインボタンクリック時の処理フロー

#### 1. クライアント側バリデーション
- メールアドレス形式チェック
- パスワード未入力チェック
- エラーがあれば該当フィールドにエラー表示し、処理中断

#### 2. 認証リクエスト送信
- ローディング状態表示（ボタンにスピナー、無効化）
- サーバーに認証情報を送信
- CSRFトークンを含める

#### 3. サーバーレスポンス処理

##### 成功時（200 OK）
- セッションCookieを保存
- 「ログインしています...」メッセージ表示
- ユーザー情報をローカルストレージまたはセッションストレージに保存
- ロールに応じたダッシュボードへリダイレクト
  - Executive → エグゼクティブダッシュボード
  - PM → PMダッシュボード
  - Consultant → コンサルタントダッシュボード
  - Client → クライアントダッシュボード
  - Admin → 管理画面

##### 初回ログイン時（200 OK + requirePasswordChange: true）
- パスワード変更画面へリダイレクト
- 「初回ログインのため、パスワードを変更してください」メッセージ表示

##### MFA必要時（200 OK + requireMFA: true）
- MFA認証画面へ遷移
- 「認証コードを入力してください」メッセージ表示

##### 認証失敗時（401 Unauthorized）
- エラーメッセージ表示「メールアドレスまたはパスワードが正しくありません」
- パスワードフィールドをクリア
- ログイン試行回数をカウント（3回まで）

##### アカウントロック時（403 Forbidden）
- エラーメッセージ表示「アカウントがロックされています」
- 「お問い合わせ窓口」へのリンク表示
- 全フィールドを無効化

##### サーバーエラー時（500 Internal Server Error）
- エラーメッセージ表示「システムエラーが発生しました」
- 「しばらく経ってから再度お試しください」案内
- 再試行ボタン表示

#### 4. セキュリティ対策

##### ログイン試行制限
- 連続3回失敗：5分間ロック（クライアント側）
- ロック中はエラーメッセージ表示「ログイン試行回数が上限に達しました。5分後に再度お試しください」
- カウントダウンタイマー表示

##### CAPTCHA表示（3回失敗後）
- reCAPTCHAまたは同等のCAPTCHA表示
- CAPTCHA成功後にログイン処理を継続

### リアルタイムバリデーション

#### メールアドレスフィールド
- フォーカスアウト時に形式チェック
- 不正な形式の場合：「メールアドレスの形式が正しくありません」エラー表示

#### パスワードフィールド
- 入力中はバリデーションなし（入力を妨げない）
- ログインボタンクリック時にチェック

### パスワード表示/非表示切り替え
- 目のアイコンボタンクリック
- クリック時：パスワードを平文表示、アイコン変更（目に斜線）
- 再クリック：マスク表示に戻す

### Enter キー対応
- パスワードフィールドでEnterキー押下時、ログインボタンをクリック
- 未入力項目がある場合は何もしない

## 画面遷移

### 遷移元画面
- **外部URL**: 組織の社内ポータルやブックマークから直接アクセス
- **アカウント申請完了画面**: 承認後の初回ログイン
- **ログアウト後**: セッション終了後の再ログイン
- **セッションタイムアウト**: タイムアウト後の再認証

### 遷移先画面
- **ダッシュボード**（ロール別）
  - Executive → `/dashboard/executive`
  - PM → `/dashboard/pm`
  - Consultant → `/dashboard/consultant`
  - Client → `/dashboard/client`
  - Admin → `/admin`

- **パスワード変更画面**: 初回ログイン時
- **MFA認証画面**: MFA有効ユーザー
- **パスワードリセット画面**: 「パスワードをお忘れですか？」リンクから
- **アカウント申請画面**: 「新規アカウント申請」リンクから

## エラーハンドリング

### 認証エラー
- **誤った認証情報**: 「メールアドレスまたはパスワードが正しくありません」
  - パスワードフィールドをクリア
  - メールアドレスフィールドにフォーカス

### アカウント状態エラー
- **アカウント無効化**: 「このアカウントは無効化されています。管理者にお問い合わせください」
- **アカウント有効期限切れ**: 「アカウントの有効期限が切れています。管理者にお問い合わせください」
- **パスワード有効期限切れ**: 「パスワードの有効期限が切れています。パスワードを変更してください」→ パスワード変更画面へ

### ネットワークエラー
- **タイムアウト**: 「接続がタイムアウトしました。ネットワーク接続を確認してください」
- **接続エラー**: 「サーバーに接続できません。しばらく経ってから再度お試しください」

### システムエラー
- **サーバーエラー**: 「システムエラーが発生しました。管理者に連絡してください」
- エラー詳細をコンソールに出力（開発環境のみ）

## アクセシビリティ要件

### キーボード操作
- Tabキーでフィールド間を移動（メール → パスワード → チェックボックス → ログインボタン）
- Enterキーでログイン実行
- Escキーでエラーメッセージを閉じる

### スクリーンリーダー対応
- 各入力フィールドにaria-labelを設定
- エラーメッセージはaria-liveで即座に読み上げ
- ログインボタンの状態（有効/無効）をaria-disabledで通知
- パスワード表示/非表示ボタンの状態をaria-pressedで通知

### 色覚対応
- エラー表示は色だけでなくアイコンと文字で表現
- 成功時の緑チェックマークも「ログインしています」テキスト併記

## レスポンシブ対応

### デスクトップ（1024px以上）
- ログインフォーム：中央配置、最大幅400px
- 背景：グラデーションまたはブランドイメージ
- フォーム：白背景のカード形式、シャドウ付き

### タブレット（768px〜1023px）
- ログインフォーム：画面幅の70%
- 中央配置維持
- タッチ操作に適したボタンサイズ（最小44x44px）

### モバイル（767px以下）
- ログインフォーム：画面幅の90%
- ロゴを小さく表示
- フィールド間の余白を詰める
- フッターリンクを縦並びに配置
- 仮想キーボード表示時にフォームが隠れないようスクロール調整

## セキュリティ要件

### 認証セキュリティ
- **HTTPS必須**: 平文通信を拒否
- **CSRF対策**: ログインリクエストにCSRFトークンを含める
- **パスワード送信**: ハッシュ化せず平文で送信（HTTPS内で暗号化）
- **セッション管理**: HttpOnly、Secure、SameSite属性付きCookie使用

### ログイン試行制限
- **クライアント側**: 連続3回失敗で5分間ロック
- **サーバー側**: 同一IPからの連続10回失敗で15分間IP制限
- **アカウントロック**: 同一アカウントで連続5回失敗で30分間ロック

### 監査ログ
- 全てのログイン試行を記録（成功/失敗、IPアドレス、ユーザーエージェント、タイムスタンプ）
- ログイン成功時：セッションID、ロール情報も記録
- ログイン失敗時：失敗理由（認証エラー、アカウントロック等）も記録

### MFA（多要素認証）
- MFA有効ユーザーは、パスワード認証後に追加認証画面へ遷移
- TOTP（Time-based One-Time Password）方式に対応
- バックアップコードによる認証も可能
