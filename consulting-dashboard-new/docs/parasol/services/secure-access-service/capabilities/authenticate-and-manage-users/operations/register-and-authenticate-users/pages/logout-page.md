# ページ定義：ログアウト

## 画面の目的
ユーザーが安全にシステムからログアウトし、セッションを完全に終了する画面。セキュリティを確保しつつ、ユーザーに適切なログアウト完了通知を提供する。

## 利用者
- **全ユーザー**: システムにログインしている全てのユーザー（Executive、PM、Consultant、Client、Admin）

## 画面構成

### ログアウト確認画面（オプション）

#### ヘッダー部
- アプリケーションロゴ（中央配置）
- 「ログアウト確認」見出し

#### メッセージ部
- 主メッセージ：「ログアウトしますか？」（大きく表示）
- 補足テキスト：「保存されていない変更は失われます」（必要に応じて表示）
- ユーザー情報表示：「〇〇さんとしてログイン中」

#### アクションボタン部
- **ログアウトボタン**（プライマリボタン、赤、幅200px）
  - クリックでログアウト処理を実行
- **キャンセルボタン**（セカンダリボタン、グレー、幅200px）
  - 前の画面に戻る

### ログアウト処理中画面

#### ローディング表示
- スピナーアイコン（中央配置、大きめ）
- 「ログアウトしています...」テキスト
- 背景：半透明オーバーレイ

### ログアウト完了画面

#### ヘッダー部
- アプリケーションロゴ（中央配置）
- 「ログアウト完了」見出し

#### メッセージ部
- 成功メッセージ：「ログアウトしました」（大きく、緑色のチェックアイコン付き）
- 補足メッセージ：「ご利用ありがとうございました」
- セキュリティ案内：「セキュリティのため、ブラウザを閉じることをお勧めします」

#### アクションボタン部
- **ログイン画面へ**ボタン（プライマリボタン、青、幅200px）
  - ログイン画面へ遷移
- **ホームページへ**ボタン（セカンダリボタン、幅200px）
  - 組織のホームページや公開サイトへ遷移（任意）

#### 情報表示部
- ログアウト日時：「YYYY年MM月DD日 HH:MM にログアウトしました」
- ログインセッション情報（任意）：
  - ログイン日時
  - セッション時間
  - アクセスしたページ数（概算）

### フッター部
- プライバシーポリシーへのリンク
- お問い合わせ窓口
- コピーライト表記

## データ表示

### ログアウト確認画面
- ログインユーザーの名前（姓名）
- ログイン中のロール（任意）
- 現在日時

### ログアウト完了画面
- ログアウト完了日時（YYYY年MM月DD日 HH:MM形式）
- ログインしていたセッション時間（例：「2時間15分ログインしていました」）
- 最終アクセスページ（任意）

## 入力項目

なし（確認ダイアログのボタン選択のみ）

## 画面の振る舞い

### ログアウト処理フロー

#### 1. ログアウト要求
ユーザーがログアウトを実行する方法：
- **ヘッダーメニューから「ログアウト」選択**
- **アカウントドロップダウンから「ログアウト」選択**
- **直接URLアクセス**（`/logout`）

#### 2. 確認ダイアログ表示（オプション）
- 設定により確認画面の表示/非表示を切り替え
- デフォルト：確認画面を表示
- 緊急ログアウト時：確認なしで即座に実行

#### 3. ログアウト処理実行

##### サーバーサイド処理
1. **セッション無効化**
   - サーバー側のセッションを削除
   - セッションIDをブラックリストに追加（再利用防止）

2. **トークン無効化**
   - JWTトークンをブラックリストに追加
   - リフレッシュトークンを削除

3. **監査ログ記録**
   - ログアウト日時、ユーザーID、IPアドレス、ユーザーエージェントを記録

##### クライアントサイド処理
1. **認証情報クリア**
   - ローカルストレージからユーザー情報削除
   - セッションストレージからトークン削除
   - 認証Cookieの削除（HttpOnlyでない場合）

2. **アプリケーション状態リセット**
   - Reduxストアやコンテキストの認証状態をクリア
   - キャッシュデータの削除

3. **ブラウザ履歴クリア**
   - 戻るボタンで認証ページに戻れないよう履歴を置き換え

#### 4. ログアウト完了表示
- ローディング終了（スピナー非表示）
- 完了画面を表示
- 成功メッセージとチェックアイコン表示
- 3秒後にログイン画面へ自動リダイレクト（カウントダウン表示）

### エラー処理

#### セッション既に無効の場合
- サーバーから「既にログアウト済み」レスポンス
- クライアント側でも認証情報をクリア
- 完了画面を表示（エラーではなく正常完了として扱う）

#### ネットワークエラーの場合
- タイムアウト（5秒）後もレスポンスがない場合
- クライアント側の認証情報を強制クリア
- 「ログアウト処理が完了しませんでしたが、ローカルのセッションはクリアされました」メッセージ
- ログイン画面へリダイレクト

#### サーバーエラーの場合
- 500エラー時も認証情報をクライアント側でクリア
- 「サーバーエラーが発生しましたが、ローカルのセッションはクリアされました」
- ログイン画面へリダイレクト

### 自動ログアウト（セッションタイムアウト）

#### タイムアウト警告
- セッション有効期限の5分前に警告モーダル表示
- 「セッションが間もなく期限切れになります」メッセージ
- 「セッションを延長」ボタン（アクティブな操作でセッション更新）
- カウントダウンタイマー表示（残り時間）

#### 自動ログアウト実行
- タイムアウト時に自動的にログアウト処理
- 「セッションが期限切れになりました」メッセージ表示
- ログイン画面へリダイレクト
- リダイレクト時にURLパラメータで元のページを保持（`?redirect=/previous-page`）

### 多重ログアウト防止
- ログアウトボタンクリック後、即座にボタンを無効化
- 2回目以降のクリックを無視
- ローディング中は全ての操作を無効化

## 画面遷移

### 遷移元画面
- **全画面**: ヘッダーのログアウトボタンから
- **アカウント設定画面**: 「ログアウト」メニュー項目から
- **セッションタイムアウト**: 自動ログアウト

### 遷移先画面
- **ログイン画面**（デフォルト）
  - パス：`/login`
  - 元のページURLを保持（`?redirect=/previous-page`）

- **ホームページ**（任意）
  - 組織の公開サイトまたはポータル

- **完了画面からの自動遷移**
  - 3秒後にログイン画面へ自動リダイレクト
  - カウントダウン表示「3秒後にログイン画面へ移動します...」

## エラーハンドリング

### セッション関連エラー
- **既にログアウト済み**: 完了画面を表示（エラーとして扱わない）
- **セッション不正**: 認証情報をクリアしてログイン画面へ
- **トークン無効**: 同上

### ネットワークエラー
- **タイムアウト**: ローカル認証情報クリア + ログイン画面へ
- **接続エラー**: 同上
- エラーメッセージ：「ネットワークエラーが発生しましたが、ローカルのセッションはクリアされました」

### システムエラー
- **サーバーエラー**: ローカル認証情報クリア + ログイン画面へ
- エラーメッセージ：「ログアウト処理でエラーが発生しましたが、セキュリティのためローカルセッションをクリアしました」

## アクセシビリティ要件

### キーボード操作
- Tabキーでボタン間を移動
- Enterキーでボタンクリック
- Escキーで確認ダイアログをキャンセル（確認画面がある場合）

### スクリーンリーダー対応
- ログアウト処理の各ステップをaria-liveで通知
- 「ログアウトしています」→「ログアウトしました」の変化を読み上げ
- ボタンの役割をaria-labelで明示
- カウントダウンタイマーをaria-liveで定期的に読み上げ

### 色覚対応
- 成功メッセージは色だけでなくチェックアイコンと文字で表現
- エラーは赤色だけでなくアイコン（⚠️）と文字で表現

## レスポンシブ対応

### デスクトップ（1024px以上）
- 確認画面・完了画面：中央配置、最大幅500px
- ボタン：横並び配置（ログアウト/キャンセル）
- 白背景のカード形式、シャドウ付き

### タブレット（768px〜1023px）
- 画面幅の80%
- ボタンサイズを大きく（タッチ操作対応）
- カード形式維持

### モバイル（767px以下）
- 画面幅の95%
- ボタン：縦並び配置（全幅）
- フォントサイズを大きく
- タップ領域を広く確保（最小44x44px）

## セキュリティ要件

### セッション管理
- **完全な無効化**: サーバー側でセッションを完全削除
- **トークンブラックリスト**: JWTをブラックリストに追加（有効期限まで保持）
- **Cookie削除**: 認証Cookie（HttpOnly、Secure）を削除

### 監査ログ
- ログアウト日時、ユーザーID、IPアドレス、ユーザーエージェントを記録
- ログアウト理由（手動/自動タイムアウト/強制）を記録
- セッション時間を記録

### 強制ログアウト（管理者機能）
- 管理者が特定ユーザーを強制ログアウト可能
- 強制ログアウト時は理由を記録
- ユーザーには「管理者によりログアウトされました」メッセージ表示

### 全デバイスログアウト
- ユーザーが全てのデバイスからログアウト可能
- 現在のセッションだけでなく、全てのアクティブセッションを無効化
- 「全デバイスからログアウトしました」確認メッセージ

### リダイレクト制御
- ログアウト後は認証が必要なページにアクセス不可
- 戻るボタンで認証ページに戻れないよう制御
- リダイレクトURLのバリデーション（オープンリダイレクト脆弱性対策）
