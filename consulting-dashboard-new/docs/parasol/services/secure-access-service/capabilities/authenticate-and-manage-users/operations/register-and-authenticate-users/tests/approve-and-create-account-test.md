# テスト定義：アカウント承認・作成

## テストの目的
管理者がアカウント申請を審査し、承認または却下を適切に実行できること、およびアカウント作成処理が正常に完了することを確認する。

## テスト情報
- **テストレベル**: システムテスト / 統合テスト
- **テストタイプ**: 機能テスト / ワークフローテスト
- **優先度**: 高
- **実行頻度**: リグレッションテスト（各リリース前）

## テストケース群

### テストケース1: 正常系 - アカウント承認成功

#### 事前条件
- 管理者権限を持つユーザーでログイン済み
- 未承認のアカウント申請が1件以上存在する
- 申請データ：
  - 申請者名：山田太郎
  - メールアドレス：yamada.taro@consulting-firm.com
  - 申請種別：正社員
  - 所属組織：デジタルトランスフォーメーション本部

#### テスト手順
1. アカウント申請管理画面にアクセスする
2. 未承認タブを選択する
3. 申請一覧から「山田太郎」の申請を見つける
4. 「詳細」ボタンをクリックして詳細画面を開く
5. アカウント設定を入力する
   - ユーザーID：「yamada.taro」（自動生成されたIDを確認）
   - ロール：「Consultant」を選択
   - 所属組織：組織ツリーから「デジタルトランスフォーメーション本部」を選択
   - 初期パスワード設定：「自動生成してメール送信」を選択
6. 「承認」ボタンをクリックする
7. 承認確認ダイアログで設定内容を確認する
8. 「承認する」ボタンをクリックする

#### 期待結果
- ローディング表示が表示される
- 「アカウントを作成しました」成功メッセージが表示される
- 詳細画面が閉じて一覧画面に戻る
- 承認した申請が未承認タブから消える
- データベースにユーザーアカウントが作成される
  - ユーザーID：yamada.taro
  - メールアドレス：yamada.taro@consulting-firm.com
  - ロール：Consultant
- 初期パスワードが記載されたメールが申請者に送信される
- アクション履歴に承認記録が追加される

#### 事後処理
- 作成したテストアカウントをデータベースから削除する
- 送信されたメールを削除する

### テストケース2: 正常系 - アカウント却下

#### 事前条件
- 管理者権限を持つユーザーでログイン済み
- 未承認のアカウント申請が1件以上存在する

#### テスト手順
1. アカウント申請管理画面にアクセスする
2. 未承認タブから申請を選択し、詳細画面を開く
3. 「却下」ボタンをクリックする
4. 却下理由入力ダイアログで理由を入力する
   - 「申請内容に不備があるため、却下します。詳細はメールでお知らせします。」（50文字）
5. 「却下する」ボタンをクリックする
6. 却下確認ダイアログで「確定」をクリックする

#### 期待結果
- ローディング表示が表示される
- 「申請を却下しました」成功メッセージが表示される
- 一覧画面に戻る
- 却下した申請のステータスが「却下済み」に変更される
- 申請者に却下通知メールが送信される（却下理由を含む）
- アクション履歴に却下記録が追加される
  - 実行者、日時、却下理由が記録される

### テストケース3: 異常系 - 必須項目未入力で承認

#### 事前条件
- 管理者権限を持つユーザーでログイン済み
- 未承認のアカウント申請が存在する

#### テスト手順
1. アカウント申請管理画面にアクセスする
2. 未承認の申請を選択し、詳細画面を開く
3. アカウント設定でロールを選択しない（未選択のまま）
4. 所属組織も選択しない
5. 「承認」ボタンをクリックする

#### 期待結果
- 「承認」ボタンが無効状態である（クリックできない）
- または、クリック後にバリデーションエラーが表示される
- 必須項目にエラーメッセージが表示される
  - ロール：「ロールを選択してください」
  - 所属組織：「所属組織を選択してください」
- 承認処理は実行されない

### テストケース4: 異常系 - ユーザーID重複

#### 事前条件
- 管理者権限を持つユーザーでログイン済み
- 既存ユーザー：ユーザーID「yamada.taro」が登録済み
- 未承認の申請が存在する

#### テスト手順
1. アカウント申請管理画面にアクセスする
2. 未承認の申請を選択し、詳細画面を開く
3. アカウント設定を入力する
   - ユーザーID：「yamada.taro」（既存と重複）
   - ロール：「Consultant」
   - 所属組織：任意の組織を選択
4. 「承認」ボタンをクリックする
5. 確認ダイアログで「承認する」をクリックする

#### 期待結果
- エラーメッセージが表示される
  - 「このユーザーIDは既に使用されています。別のIDを指定してください」
- ユーザーIDフィールドが赤枠で強調表示される
- アカウントは作成されない
- 詳細画面は開いたままで、修正可能な状態になる

### テストケース5: 異常系 - 却下理由未入力

#### 事前条件
- 管理者権限を持つユーザーでログイン済み
- 未承認の申請が存在する

#### テスト手順
1. アカウント申請管理画面にアクセスする
2. 未承認の申請を選択し、詳細画面を開く
3. 「却下」ボタンをクリックする
4. 却下理由入力ダイアログで理由を入力しない（空欄のまま）
5. 「却下する」ボタンをクリックする

#### 期待結果
- 「却下する」ボタンが無効状態である
- または、クリック後にバリデーションエラーが表示される
- エラーメッセージ：「却下理由を入力してください（20文字以上）」
- 却下処理は実行されない

### テストケース6: 異常系 - 却下理由の文字数不足

#### 事前条件
- 管理者権限を持つユーザーでログイン済み
- 未承認の申請が存在する

#### テスト手順
1. アカウント申請管理画面にアクセスする
2. 未承認の申請を選択し、詳細画面を開く
3. 「却下」ボタンをクリックする
4. 却下理由入力ダイアログで短い理由を入力する
   - 「不備あり」（5文字、最小20文字未満）
5. 文字数カウンターを確認する
6. 「却下する」ボタンをクリックする

#### 期待結果
- リアルタイム文字数カウンターが表示される
  - 「5 / 20文字以上」のように表示
- 20文字未満の場合、エラーメッセージが表示される
  - 「却下理由は20文字以上で入力してください」
- 「却下する」ボタンが無効状態である
- 却下処理は実行されない

### テストケース7: 正常系 - 保留処理

#### 事前条件
- 管理者権限を持つユーザーでログイン済み
- 未承認の申請が存在する

#### テスト手順
1. アカウント申請管理画面にアクセスする
2. 未承認の申請を選択し、詳細画面を開く
3. 「保留」ボタンをクリックする
4. 保留理由入力ダイアログ（任意）で理由を入力する
   - 「追加確認が必要なため、一旦保留します」
5. 「保留する」ボタンをクリックする

#### 期待結果
- 「申請を保留しました」成功メッセージが表示される
- 一覧画面に戻る
- 申請のステータスが「保留中」に変更される
- ただし、未承認タブには引き続き表示される
- アクション履歴に保留記録が追加される
  - 実行者、日時、保留理由が記録される

### テストケース8: UI/UXテスト - 検索・フィルタ機能

#### 事前条件
- 管理者権限を持つユーザーでログイン済み
- 複数の申請が存在する（未承認、承認済み、却下済み）

#### テスト手順
1. アカウント申請管理画面にアクセスする
2. 検索ボックスに申請者名の一部を入力する
   - 「山田」と入力
3. 申請種別フィルタで「正社員」を選択する
4. ステータスタブで「承認済み」を選択する
5. 各フィルタをクリアして全件表示に戻す

#### 期待結果
- 検索入力時、デバウンス（500ms）後に即座にフィルタリングされる
- 「山田」を含む申請のみが表示される
- 申請種別フィルタで「正社員」のみが表示される
- ステータスタブで承認済みの申請のみが表示される
- フィルタクリア時、全件が再表示される

### テストケース9: UI/UXテスト - ソート機能

#### 事前条件
- 管理者権限を持つユーザーでログイン済み
- 複数の申請が存在する（申請日時が異なる）

#### テスト手順
1. アカウント申請管理画面にアクセスする
2. 「申請日時」カラムのヘッダーをクリックする
3. 再度同じヘッダーをクリックする
4. 「申請者名」カラムのヘッダーをクリックする

#### 期待結果
- 1回目のクリック：申請日時の昇順でソートされる（矢印アイコン↑表示）
- 2回目のクリック：申請日時の降順でソートされる（矢印アイコン↓表示）
- 申請者名クリック：名前の昇順（あいうえお順）でソートされる

### テストケース10: UI/UXテスト - ページネーション

#### 事前条件
- 管理者権限を持つユーザーでログイン済み
- 21件以上の申請が存在する（デフォルト表示：20件/ページ）

#### テスト手順
1. アカウント申請管理画面にアクセスする
2. 一覧の下部にあるページネーションを確認する
3. 「次へ」ボタンをクリックする
4. ページ番号「1」をクリックして最初のページに戻る
5. 表示件数ドロップダウンで「50件」を選択する

#### 期待結果
- デフォルトで20件が表示される
- ページネーションに「1」「2」のページ番号が表示される
- 「次へ」クリック時、2ページ目（21件目以降）が表示される
- ページ番号クリック時、該当ページが表示される
- 表示件数変更時、50件が1ページに表示される

## 性能テスト

### 負荷テスト
- **同時承認処理**: 10件の同時承認リクエストを処理できる
- **レスポンス時間**: 承認処理が2秒以内に完了する
- **メール送信**: 初期パスワードメールが5秒以内に送信される

### 一覧表示パフォーマンス
- **表示速度**: 100件の申請一覧が1秒以内に表示される
- **検索・フィルタ**: フィルタリング結果が500ms以内に表示される

## セキュリティテスト

### 権限チェックテスト

#### テスト手順
1. 管理者権限を持たないユーザー（Consultant等）でログインする
2. アカウント申請管理画面のURLに直接アクセスする
   - `/admin/account-requests`

#### 期待結果
- 403 Forbiddenエラーが返される
- エラーページ表示：「この操作を実行する権限がありません」
- 一覧画面は表示されない

### 操作ログテスト

#### テスト手順
1. 管理者権限を持つユーザーでログインする
2. アカウント申請を承認する
3. 監査ログを確認する

#### 期待結果
- 監査ログに以下の情報が記録されている
  - 操作：アカウント承認
  - 実行者：管理者のユーザーID
  - 対象：承認した申請のID、申請者メールアドレス
  - 日時：承認実行日時（ISO8601形式）
  - 詳細：付与したロール、所属組織
  - IPアドレス：実行元IPアドレス

### CSRF対策テスト

#### テスト手順
1. 正常な承認リクエストのHTMLを取得する
2. CSRFトークンを含まない偽の承認リクエストを送信する

#### 期待結果
- 403 Forbiddenエラーが返される
- エラーメッセージ：「CSRFトークンが無効です」
- 承認処理は実行されない

## 自動化対象
- **自動化可能**: テストケース1〜7（正常系、異常系）
- **半自動化**: テストケース8〜10（UI/UXテスト、手動確認を含む）
- **手動実行**: セキュリティテスト（権限チェック、監査ログ確認）

## テスト環境
- **OS**: Windows 10/11, macOS 13+, Ubuntu 22.04
- **ブラウザ**:
  - Chrome（最新版）
  - Firefox（最新版）
  - Safari（macOSのみ、最新版）
  - Edge（最新版）
- **デバイス**: デスクトップ、タブレット（iPad）
- **画面解像度**:
  - デスクトップ：1920x1080、1366x768
  - タブレット：1024x768
- **テストデータ**: 最低20件の申請データ（未承認、承認済み、却下済みを含む）
