# テスト定義：ログイン・認証

## テストの目的
ユーザーがメールアドレスとパスワードで正しく認証され、適切なダッシュボードにアクセスできること、およびセキュリティ機能が正常に動作することを確認する。

## テスト情報
- **テストレベル**: システムテスト / E2Eテスト
- **テストタイプ**: 機能テスト / セキュリティテスト
- **優先度**: 最高
- **実行頻度**: リグレッションテスト（毎回リリース前）、スモークテスト

## テストケース群

### テストケース1: 正常系 - Executiveユーザーのログイン成功

#### 事前条件
- データベースにExecutiveロールのユーザーが登録されている
  - メールアドレス：exec@example.com
  - パスワード：password123
  - ロール：Executive
- ログインページにアクセスできる
- ユーザーは未ログイン状態

#### テスト手順
1. ログインページ（`/login`）にアクセスする
2. メールアドレスを入力する
   - 「exec@example.com」
3. パスワードを入力する
   - 「password123」
4. 「ログイン」ボタンをクリックする

#### 期待結果
- ローディング表示（スピナーアイコン）が表示される
- 「ログインしています...」メッセージが緑のチェックマーク付きで表示される
- 1秒後にExecutiveダッシュボードへリダイレクトされる
  - URL：`/dashboard/executive`
- ダッシュボードページが表示される
- セッションCookieが保存される（HttpOnly、Secure属性付き）
- 監査ログにログイン成功が記録される

#### 事後処理
- テストセッションをログアウトする

### テストケース2: 正常系 - PMユーザーのログイン成功

#### 事前条件
- PMロールのユーザーが登録されている
  - メールアドレス：pm@example.com
  - パスワード：password123
  - ロール：PM

#### テスト手順
1. ログインページにアクセスする
2. メールアドレス「pm@example.com」を入力する
3. パスワード「password123」を入力する
4. 「ログイン」ボタンをクリックする

#### 期待結果
- 認証成功後、PMダッシュボードへリダイレクトされる
  - URL：`/dashboard/pm`
- PMダッシュボードが表示される

### テストケース3: 正常系 - 初回ログイン時のパスワード変更

#### 事前条件
- 新規作成されたユーザーが存在する
  - メールアドレス：newuser@example.com
  - 初期パスワード：temp123
  - requirePasswordChange：true（パスワード変更フラグ）

#### テスト手順
1. ログインページにアクセスする
2. メールアドレス「newuser@example.com」を入力する
3. 初期パスワード「temp123」を入力する
4. 「ログイン」ボタンをクリックする

#### 期待結果
- 認証は成功する
- ダッシュボードではなく、パスワード変更画面へリダイレクトされる
  - URL：`/change-password`
- 「初回ログインのため、パスワードを変更してください」メッセージが表示される
- パスワード変更フォームが表示される

### テストケース4: 正常系 - MFA認証フロー

#### 事前条件
- MFA有効ユーザーが存在する
  - メールアドレス：mfa@example.com
  - パスワード：password123
  - MFA有効：true
  - TOTP秘密鍵：登録済み

#### テスト手順
1. ログインページにアクセスする
2. メールアドレス「mfa@example.com」を入力する
3. パスワード「password123」を入力する
4. 「ログイン」ボタンをクリックする
5. MFA認証画面が表示される
6. 認証アプリ（Google Authenticator等）から6桁のコードを取得する
7. 認証コードを入力する
8. 「認証」ボタンをクリックする

#### 期待結果
- パスワード認証成功後、MFA認証画面へ遷移する
  - URL：`/mfa`
- 「認証コードを入力してください」メッセージが表示される
- 正しいTOTPコード入力後、ダッシュボードへリダイレクトされる
- セッションにMFA認証済みフラグが設定される

### テストケース5: 正常系 - ログイン状態を保持

#### 事前条件
- ユーザーアカウントが存在する
  - メールアドレス：test@example.com
  - パスワード：password123

#### テスト手順
1. ログインページにアクセスする
2. メールアドレスとパスワードを入力する
3. 「ログイン状態を保持する」チェックボックスをチェックする
4. 「ログイン」ボタンをクリックする
5. ログイン成功後、ブラウザを閉じる
6. 再度ブラウザを開き、アプリケーションにアクセスする

#### 期待結果
- ログイン成功後、長期セッションCookie（有効期限30日）が保存される
- ブラウザ再起動後も、ログイン状態が保持される
- 再度ログインせずにダッシュボードにアクセスできる

### テストケース6: 異常系 - 誤ったパスワード

#### 事前条件
- ユーザーアカウントが存在する
  - メールアドレス：user@example.com
  - 正しいパスワード：password123

#### テスト手順
1. ログインページにアクセスする
2. メールアドレス「user@example.com」を入力する
3. 誤ったパスワード「wrongpassword」を入力する
4. 「ログイン」ボタンをクリックする

#### 期待結果
- 認証失敗エラーが表示される
  - 「メールアドレスまたはパスワードが正しくありません」
- エラーバナーが赤背景で画面上部に表示される（⚠️アイコン付き）
- パスワードフィールドがクリアされる
- メールアドレスフィールドにフォーカスが移動する
- ログイン試行回数がカウントされる（1回目）
- 監査ログにログイン失敗が記録される

### テストケース7: 異常系 - 存在しないメールアドレス

#### 事前条件
- データベースにメールアドレス「nonexistent@example.com」のユーザーが存在しない

#### テスト手順
1. ログインページにアクセスする
2. 存在しないメールアドレス「nonexistent@example.com」を入力する
3. パスワード「anypassword」を入力する
4. 「ログイン」ボタンをクリックする

#### 期待結果
- 認証失敗エラーが表示される
  - 「メールアドレスまたはパスワードが正しくありません」
- セキュリティのため、「存在しないメールアドレス」とは表示しない（アカウント列挙攻撃対策）
- エラーメッセージは誤パスワードと同じ内容

### テストケース8: 異常系 - 連続ログイン失敗（アカウントロック）

#### 事前条件
- ユーザーアカウントが存在する
  - メールアドレス：user@example.com
  - パスワード：password123
- アカウントロック設定：5回失敗で30分間ロック

#### テスト手順
1. ログインページにアクセスする
2. 正しいメールアドレス「user@example.com」を入力する
3. 誤ったパスワード「wrongpassword」を入力する
4. 「ログイン」ボタンをクリックする
5. 手順2〜4を5回繰り返す
6. 6回目のログイン試行を行う

#### 期待結果
- 5回目の失敗後、アカウントがロックされる
- 6回目の試行時、エラーメッセージが表示される
  - 「アカウントがロックされています。管理者にお問い合わせください」
- ロックアイコン（🔒）が表示される
- 全フィールドが無効化される
- お問い合わせ窓口へのリンクが表示される
- 監査ログにアカウントロックが記録される

### テストケース9: 異常系 - クライアント側ログイン試行制限

#### 事前条件
- ログインページにアクセスできる

#### テスト手順
1. ログインページにアクセスする
2. 任意のメールアドレスとパスワードを入力する
3. 「ログイン」ボタンをクリックする（失敗）
4. 手順2〜3を3回繰り返す
5. 4回目のログイン試行を行う

#### 期待結果
- 3回失敗後、クライアント側で5分間ロックされる
- エラーメッセージ表示：「ログイン試行回数が上限に達しました。5分後に再度お試しください」
- カウントダウンタイマーが表示される（残り時間）
- ログインボタンが無効化される
- 5分経過後、再度ログイン試行が可能になる

### テストケース10: 異常系 - CAPTCHA表示（3回失敗後）

#### 事前条件
- ログインページにアクセスできる
- CAPTCHA機能が有効

#### テスト手順
1. ログインページにアクセスする
2. 誤った認証情報で3回ログイン失敗する
3. 4回目のログイン試行時、画面を確認する
4. CAPTCHAチェックボックスをチェックする
5. 正しい認証情報を入力してログインする

#### 期待結果
- 3回失敗後、CAPTCHAが表示される（reCAPTCHA）
- CAPTCHAチェック前は「ログイン」ボタンが無効
- CAPTCHA成功後、ログインボタンが有効化される
- 正しい認証情報で正常にログインできる

### テストケース11: 異常系 - メールアドレス形式不正

#### 事前条件
- ログインページにアクセスできる

#### テスト手順
1. ログインページにアクセスする
2. 不正な形式のメールアドレスを入力する
   - 「invalid-email」（@がない）
3. メールアドレスフィールドからフォーカスを外す
4. 「ログイン」ボタンをクリックする

#### 期待結果
- フォーカスアウト時にバリデーションエラーが表示される
  - 「メールアドレスの形式が正しくありません」
- メールアドレスフィールドが赤枠で強調表示される
- 「ログイン」ボタンが無効状態である

### テストケース12: UI/UXテスト - パスワード表示/非表示切り替え

#### 事前条件
- ログインページにアクセスできる

#### テスト手順
1. ログインページにアクセスする
2. パスワードフィールドに「password123」を入力する
3. パスワードフィールド右側の目のアイコンをクリックする
4. 再度目のアイコンをクリックする

#### 期待結果
- 初期状態：パスワードは「•••••••••」のようにマスク表示
- 1回目のクリック：パスワードが平文「password123」で表示される
- アイコンが目に斜線のアイコンに変更される
- 2回目のクリック：再びマスク表示に戻る
- アイコンが元の目のアイコンに戻る

### テストケース13: UI/UXテスト - Enterキーでログイン

#### 事前条件
- ログインページにアクセスできる

#### テスト手順
1. ログインページにアクセスする
2. メールアドレス「user@example.com」を入力する
3. パスワード「password123」を入力する
4. パスワードフィールドでEnterキーを押す

#### 期待結果
- 「ログイン」ボタンをクリックしたのと同じ動作になる
- ログイン処理が実行される
- 認証成功後、ダッシュボードへリダイレクトされる

## 性能テスト

### 負荷テスト
- **同時ログイン数**: 100件の同時ログインリクエストを処理できる
- **レスポンス時間**: 認証処理が1秒以内に完了する
- **セッション生成**: セッションCookieが500ms以内に生成される

### 認証処理パフォーマンス
- **パスワードハッシュ検証**: bcrypt検証が300ms以内に完了する
- **JWT生成**: トークン生成が100ms以内に完了する

## セキュリティテスト

### パスワードハッシュ検証

#### テスト手順
1. データベースから保存されているパスワードハッシュを確認する
2. ハッシュアルゴリズムを確認する

#### 期待結果
- パスワードは平文で保存されていない
- bcryptアルゴリズムでハッシュ化されている（ソルト付き）
- ハッシュ形式：`$2b$10$...`

### セッション管理テスト

#### テスト手順
1. 正常にログインする
2. ブラウザの開発ツールでCookieを確認する
3. セッションCookieの属性を確認する

#### 期待結果
- セッションCookieに以下の属性が設定されている
  - `HttpOnly`：JavaScriptからアクセス不可
  - `Secure`：HTTPS通信のみ
  - `SameSite=Lax`または`Strict`：CSRF対策

### CSRF対策テスト

#### テスト手順
1. ログインフォームのHTMLを取得する
2. CSRFトークンを含まない偽のログインリクエストを送信する

#### 期待結果
- 403 Forbiddenエラーが返される
- エラーメッセージ：「CSRFトークンが無効です」
- 認証は実行されない

### ブルートフォース攻撃対策テスト

#### テスト手順
1. 自動化スクリプトで同一アカウントに対して連続ログイン試行を行う
2. 100回のログイン試行を1分以内に実行する

#### 期待結果
- 5回失敗後、アカウントロックが発動する
- IP制限が発動する（同一IPから10回失敗で15分間制限）
- レート制限エラー：429 Too Many Requests

## 自動化対象
- **自動化可能**: テストケース1〜7（正常系、異常系）
- **半自動化**: テストケース8〜13（UI/UX、セキュリティ）
- **手動実行**: パスワードハッシュ検証、セッション属性確認

## テスト環境
- **OS**: Windows 10/11, macOS 13+, Ubuntu 22.04
- **ブラウザ**:
  - Chrome（最新版）
  - Firefox（最新版）
  - Safari（macOSのみ、最新版）
  - Edge（最新版）
- **デバイス**: デスクトップ、タブレット、モバイル
- **ネットワーク**: 高速回線、低速回線（3G）、オフライン
