# テスト定義：ログアウト

## テストの目的
ユーザーが安全にシステムからログアウトでき、セッションが完全に無効化されること、およびセキュリティ要件が満たされることを確認する。

## テスト情報
- **テストレベル**: システムテスト / セキュリティテスト
- **テストタイプ**: 機能テスト / セキュリティテスト
- **優先度**: 高
- **実行頻度**: リグレッションテスト（各リリース前）

## テストケース群

### テストケース1: 正常系 - 通常ログアウト成功

#### 事前条件
- ユーザーがログイン済みである
  - ログインユーザー：test@example.com
  - セッションが有効
- ダッシュボード画面を表示している

#### テスト手順
1. ヘッダー部のアカウントメニューをクリックする
2. ドロップダウンメニューから「ログアウト」を選択する
3. ログアウト確認ダイアログで内容を確認する
4. 「ログアウト」ボタンをクリックする

#### 期待結果
- ローディング表示が表示される（スピナーアイコン、「ログアウトしています...」）
- 「ログアウトしました」成功メッセージが緑のチェックアイコン付きで表示される
- ログアウト完了画面に遷移する
- 完了画面に以下が表示される
  - 「ご利用ありがとうございました」メッセージ
  - ログアウト日時（YYYY年MM月DD日 HH:MM形式）
  - セッション時間（例：「2時間15分ログインしていました」）
- セッションCookieが削除される
- ローカルストレージ・セッションストレージの認証情報がクリアされる
- 監査ログにログアウト記録が追加される
- 3秒後にログイン画面へ自動リダイレクトされる（カウントダウン表示）

#### 事後処理
- なし（セッションは既に無効化されている）

### テストケース2: 正常系 - 確認なしログアウト

#### 事前条件
- ユーザーがログイン済み
- ログアウト設定で「確認画面を表示しない」が設定されている

#### テスト手順
1. ヘッダー部のアカウントメニューをクリックする
2. ドロップダウンメニューから「ログアウト」を選択する

#### 期待結果
- 確認ダイアログが表示されない
- 即座にログアウト処理が実行される
- ローディング表示後、完了画面に遷移する
- セッションが無効化される

### テストケース3: 正常系 - ログアウト後の再アクセス防止

#### 事前条件
- ユーザーがログイン済み
- 認証が必要なページ（ダッシュボード）を表示している

#### テスト手順
1. ログアウトを実行する
2. ログアウト完了画面が表示される
3. ブラウザの「戻る」ボタンをクリックする

#### 期待結果
- 戻るボタンクリック時、ダッシュボードは表示されない
- ログイン画面へリダイレクトされる
- または、「セッションが無効です。再度ログインしてください」メッセージが表示される
- 認証が必要なページへのアクセスが拒否される

### テストケース4: 正常系 - セッションタイムアウトによる自動ログアウト

#### 事前条件
- ユーザーがログイン済み
- セッション有効期限：30分
- ダッシュボードを表示している

#### テスト手順
1. ダッシュボードを表示したまま35分間放置する
2. セッションタイムアウト警告が表示されるか確認する（期限5分前）
3. 警告を無視してさらに5分待つ
4. 画面の状態を確認する

#### 期待結果
- セッション有効期限の5分前（25分経過時）に警告モーダルが表示される
  - 「セッションが間もなく期限切れになります」メッセージ
  - 「セッションを延長」ボタン
  - カウントダウンタイマー（残り5分）
- 30分経過時、自動的にログアウト処理が実行される
- 「セッションが期限切れになりました」メッセージ表示
- ログイン画面へリダイレクトされる
- リダイレクト時、元のページURLが保持される（`?redirect=/dashboard`）
- 監査ログに「自動ログアウト（タイムアウト）」が記録される

### テストケース5: 正常系 - セッション延長

#### 事前条件
- ユーザーがログイン済み
- セッションタイムアウト警告が表示されている（残り5分）

#### テスト手順
1. セッションタイムアウト警告モーダルを確認する
2. 「セッションを延長」ボタンをクリックする

#### 期待結果
- 警告モーダルが閉じる
- セッション有効期限が現在時刻から30分延長される
- 「セッションを延長しました」成功メッセージが表示される
- ユーザーは引き続き作業を継続できる

### テストケース6: 異常系 - セッション既に無効

#### 事前条件
- ユーザーがログイン済み
- 別のタブまたは別のデバイスで同じユーザーがログアウト済み
- 現在のタブはログイン状態のまま

#### テスト手順
1. 現在のタブでログアウトボタンをクリックする
2. サーバーからのレスポンスを確認する

#### 期待結果
- サーバーから「既にログアウト済み」レスポンスが返される
- クライアント側でも認証情報をクリアする
- エラーではなく、正常完了として扱う
- 完了画面を表示する
  - 「ログアウトしました」メッセージ（既にログアウト済みとは表示しない）
- ログイン画面へリダイレクトされる

### テストケース7: 異常系 - ネットワークエラー時のログアウト

#### 事前条件
- ユーザーがログイン済み
- ネットワーク接続をシミュレートできる環境

#### テスト手順
1. ブラウザの開発ツールでネットワークをオフラインに設定する
2. ログアウトボタンをクリックする
3. サーバーへのリクエストがタイムアウトするまで待つ（5秒）

#### 期待結果
- ローディング表示が表示される
- 5秒後、タイムアウトエラーが発生する
- クライアント側の認証情報は強制的にクリアされる
- エラーメッセージ表示：「ログアウト処理が完了しませんでしたが、ローカルのセッションはクリアされました」
- ログイン画面へリダイレクトされる
- 次回ログイン時、サーバー側のセッションも削除される

### テストケース8: 異常系 - サーバーエラー時のログアウト

#### 事前条件
- ユーザーがログイン済み
- サーバーでエラーをシミュレートできる環境

#### テスト手順
1. サーバーでログアウト処理時に500エラーを発生させる
2. ログアウトボタンをクリックする

#### 期待結果
- 500エラーが返される
- クライアント側の認証情報は強制的にクリアされる
- エラーメッセージ表示：「サーバーエラーが発生しましたが、ローカルのセッションはクリアされました」
- ログイン画面へリダイレクトされる
- セキュリティのため、ローカルセッションは必ず削除される

### テストケース9: セキュリティテスト - 多重ログアウト防止

#### 事前条件
- ユーザーがログイン済み

#### テスト手順
1. ログアウトボタンをクリックする
2. ローディング中に再度ログアウトボタンをクリックする（連打）

#### 期待結果
- 最初のクリック後、ログアウトボタンが即座に無効化される
- 2回目以降のクリックは無視される
- ローディング中は全ての操作が無効化される
- ログアウト処理は1回だけ実行される

### テストケース10: セキュリティテスト - 全デバイスログアウト

#### 事前条件
- ユーザーが複数のデバイスでログイン済み
  - デバイス1：デスクトップPC（現在のデバイス）
  - デバイス2：タブレット
  - デバイス3：スマートフォン

#### テスト手順
1. デバイス1（デスクトップPC）でアカウント設定画面にアクセスする
2. 「全デバイスからログアウト」ボタンをクリックする
3. 確認ダイアログで「確定」をクリックする
4. デバイス2、デバイス3の状態を確認する

#### 期待結果
- デバイス1でログアウト処理が実行される
- 全てのアクティブセッションが無効化される
- デバイス2、デバイス3で自動的にログアウトされる
- 各デバイスで「他のデバイスからログアウトされました」メッセージが表示される
- ログイン画面へリダイレクトされる
- 監査ログに「全デバイスログアウト」が記録される

### テストケース11: セキュリティテスト - 強制ログアウト（管理者機能）

#### 事前条件
- 管理者権限を持つユーザーがログイン済み
- 対象ユーザー（user@example.com）がログイン済み

#### テスト手順
1. 管理者画面でアクティブセッション一覧を表示する
2. 対象ユーザー（user@example.com）のセッションを選択する
3. 「強制ログアウト」ボタンをクリックする
4. 強制ログアウト理由を入力する
   - 「セキュリティポリシー違反のため」
5. 「実行」ボタンをクリックする
6. 対象ユーザーの画面を確認する

#### 期待結果
- 管理者画面で強制ログアウトが実行される
- 対象ユーザーのセッションが即座に無効化される
- 対象ユーザーの画面に通知が表示される
  - 「管理者によりログアウトされました」
- 対象ユーザーはログイン画面へリダイレクトされる
- 監査ログに以下が記録される
  - 操作：強制ログアウト
  - 実行者：管理者のユーザーID
  - 対象：user@example.com
  - 理由：「セキュリティポリシー違反のため」
  - 日時：実行日時

### テストケース12: UI/UXテスト - ログアウト確認キャンセル

#### 事前条件
- ユーザーがログイン済み
- ログアウト確認画面が表示される設定

#### テスト手順
1. ヘッダー部のログアウトボタンをクリックする
2. ログアウト確認ダイアログを確認する
3. 「キャンセル」ボタンをクリックする

#### 期待結果
- 確認ダイアログが閉じる
- ログアウト処理は実行されない
- 元の画面（ダッシュボード）に戻る
- セッションは維持される

### テストケース13: UI/UXテスト - 自動リダイレクトカウントダウン

#### 事前条件
- ユーザーがログアウト完了画面を表示している

#### テスト手順
1. ログアウトを実行し、完了画面を表示する
2. カウントダウンタイマーを確認する
3. 3秒待つ

#### 期待結果
- 完了画面に「3秒後にログイン画面へ移動します...」と表示される
- カウントダウンタイマーが1秒ごとに減少する（3→2→1）
- 0になった時点で自動的にログイン画面へリダイレクトされる
- ユーザーが「ログイン画面へ」ボタンをクリックすると、即座にリダイレクトされる

## 性能テスト

### レスポンス時間
- **ログアウト処理**: 500ms以内にセッション無効化が完了する
- **画面遷移**: ログアウト完了画面が1秒以内に表示される

### 同時ログアウト処理
- **負荷**: 50件の同時ログアウトリクエストを処理できる

## セキュリティテスト

### セッション無効化確認

#### テスト手順
1. ログイン後、セッションIDを取得する（Cookieから）
2. ログアウトを実行する
3. 保存しておいたセッションIDを使用して認証APIにアクセスする

#### 期待結果
- ログアウト前のセッションIDでアクセスすると、401 Unauthorizedエラーが返される
- サーバー側でセッションが完全に削除されている
- 再利用不可能である

### トークンブラックリスト確認

#### テスト手順
1. ログイン後、JWTトークンを取得する
2. ログアウトを実行する
3. 保存しておいたJWTトークンを使用してAPIにアクセスする

#### 期待結果
- ログアウト後、JWTトークンがブラックリストに追加される
- ブラックリスト登録されたトークンでアクセスすると、403 Forbiddenエラーが返される
- エラーメッセージ：「このトークンは無効化されています」

### Cookie削除確認

#### テスト手順
1. ログイン後、ブラウザの開発ツールでCookieを確認する
2. 認証Cookieの名前と値を記録する
3. ログアウトを実行する
4. 再度Cookieを確認する

#### 期待結果
- ログアウト前：認証Cookie（`session_id`等）が存在する
- ログアウト後：認証Cookieが削除されている
- または、Cookieの値が空文字列に設定され、有効期限が過去に設定されている

## 自動化対象
- **自動化可能**: テストケース1〜9（正常系、異常系）
- **半自動化**: テストケース10〜13（UI/UX、セキュリティ）
- **手動実行**: セッション無効化確認、トークンブラックリスト確認

## テスト環境
- **OS**: Windows 10/11, macOS 13+, Ubuntu 22.04
- **ブラウザ**:
  - Chrome（最新版）
  - Firefox（最新版）
  - Safari（macOSのみ、最新版）
  - Edge（最新版）
- **デバイス**: デスクトップ、タブレット、モバイル
- **複数デバイステスト**: デスクトップ、タブレット、スマートフォンで同時ログイン
