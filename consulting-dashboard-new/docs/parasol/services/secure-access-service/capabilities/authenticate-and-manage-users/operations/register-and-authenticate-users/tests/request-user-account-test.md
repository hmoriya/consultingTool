# テスト定義：ユーザーアカウント申請

## テストの目的
新規メンバーまたはクライアントがアカウント申請を正常に完了できること、および異常系での適切なエラーハンドリングを確認する。

## テスト情報
- **テストレベル**: システムテスト / E2Eテスト
- **テストタイプ**: 機能テスト / ユーザビリティテスト
- **優先度**: 高
- **実行頻度**: リグレッションテスト（各リリース前）

## テストケース群

### テストケース1: 正常系 - 新規メンバーのアカウント申請成功

#### 事前条件
- ブラウザでアカウント申請ページにアクセスできる
- テスト用メールアドレスが未登録である
- 申請ページが正しく表示される

#### テスト手順
1. アカウント申請ページ（`/register`）にアクセスする
2. 申請者情報を入力する
   - 姓：「山田」
   - 名：「太郎」
   - フリガナ（姓）：「ヤマダ」
   - フリガナ（名）：「タロウ」
   - メールアドレス：「yamada.taro@consulting-firm.com」
3. 申請理由を入力する
   - 「新規プロジェクトチームのメンバーとして参画するため、システムアクセスが必要です。」
4. 組織情報を入力する
   - 申請種別：「正社員」を選択
   - 所属組織：「デジタルトランスフォーメーション本部」
5. 任意項目を入力する
   - 役職・役割：「シニアコンサルタント」
   - 電話番号：「090-1234-5678」
6. 利用規約を確認し、同意チェックボックスをチェックする
7. 「申請」ボタンをクリックする
8. 確認ダイアログで内容を確認し、「はい」をクリックする

#### 期待結果
- ローディング表示が表示される（スピナーアイコン）
- 「申請を受け付けました」成功メッセージが表示される
- 申請番号が表示される（例：「申請番号：REQ-20240115-001」）
- 「承認まで通常1〜2営業日かかります」案内が表示される
- 「確認メールを送信しました」通知が表示される
- 申請完了画面に遷移する
- 入力したメールアドレスに確認メールが届く

#### 事後処理
- データベースから該当の申請レコードを削除する
- 送信された確認メールを削除する（テストメールボックスの場合）

### テストケース2: 正常系 - クライアントのアカウント申請成功

#### 事前条件
- ブラウザでアカウント申請ページにアクセスできる
- テスト用クライアントメールアドレスが未登録である

#### テスト手順
1. アカウント申請ページにアクセスする
2. 申請者情報を入力する
   - 姓：「鈴木」
   - 名：「花子」
   - フリガナ：「スズキ」「ハナコ」
   - メールアドレス：「suzuki.hanako@client-company.com」
3. 申請理由を入力する
   - 「プロジェクト進捗確認のため、ダッシュボードへのアクセスを申請します。」
4. 組織情報を入力する
   - 申請種別：「クライアント」を選択
   - 所属組織：「株式会社クライアント企業」
5. 利用規約に同意する
6. 「申請」ボタンをクリックする
7. 確認ダイアログで「はい」をクリックする

#### 期待結果
- 申請が正常に受理される
- 申請番号が発行される
- 完了画面に遷移する
- クライアント企業のメールアドレスに確認メールが届く

### テストケース3: 異常系 - 必須項目未入力

#### 事前条件
- アカウント申請ページにアクセスできる

#### テスト手順
1. アカウント申請ページにアクセスする
2. 一部の必須項目のみ入力する
   - 姓：「テスト」（入力）
   - 名：空欄（未入力）
   - メールアドレス：「test@example.com」（入力）
   - 申請理由：空欄（未入力）
3. 「申請」ボタンをクリックする

#### 期待結果
- 「申請」ボタンが無効状態である（クリックできない）
- または、クリック後にバリデーションエラーが表示される
- 未入力の必須項目に赤字でエラーメッセージが表示される
  - 名：「名を入力してください」
  - 申請理由：「申請理由を入力してください（20文字以上）」
- 申請処理は実行されない

### テストケース4: 異常系 - メールアドレス形式不正

#### 事前条件
- アカウント申請ページにアクセスできる

#### テスト手順
1. アカウント申請ページにアクセスする
2. 全ての必須項目を入力するが、メールアドレスを不正な形式で入力
   - メールアドレス：「invalid-email」（@がない不正な形式）
3. メールアドレスフィールドからフォーカスを外す（他のフィールドをクリック）

#### 期待結果
- メールアドレスフィールドの下に赤字でエラーメッセージが表示される
  - 「メールアドレスの形式が正しくありません」
- メールアドレスフィールドが赤枠で強調表示される
- 「申請」ボタンが無効状態である

### テストケース5: 異常系 - 重複メールアドレス

#### 事前条件
- データベースに既存のアカウント申請がある
- 既存申請のメールアドレス：「existing@example.com」

#### テスト手順
1. アカウント申請ページにアクセスする
2. 全ての必須項目を正しく入力する
3. 既存申請と同じメールアドレスを入力する
   - メールアドレス：「existing@example.com」
4. メールアドレスフィールドからフォーカスを外す
5. 「申請」ボタンをクリックする（有効化されている場合）

#### 期待結果
- メールアドレスのフォーカスアウト時、または申請ボタンクリック時にエラーが表示される
- エラーメッセージ：「このメールアドレスは既に申請済みです。管理者にお問い合わせください」
- 申請処理は実行されない

### テストケース6: 異常系 - 文字数制限超過

#### 事前条件
- アカウント申請ページにアクセスできる

#### テスト手順
1. アカウント申請ページにアクセスする
2. 文字数制限を超える入力を行う
   - 申請理由：501文字のテキストを入力（制限：500文字）
3. 入力中に残り文字数カウンターを確認する
4. 制限を超えた文字を入力しようとする

#### 期待結果
- 残り文字数カウンターが動的に更新される
- 500文字に達した時点で、カウンターが「残り0文字」と赤字で表示される
- 501文字目以降は入力できない（入力がブロックされる）
- または、入力はできるがエラーメッセージが表示される
  - 「申請理由は500文字以内で入力してください（現在：501文字）」

### テストケース7: 異常系 - 利用規約未同意

#### 事前条件
- アカウント申請ページにアクセスできる

#### テスト手順
1. アカウント申請ページにアクセスする
2. 全ての必須項目を正しく入力する
3. 利用規約の同意チェックボックスをチェックしない
4. 「申請」ボタンの状態を確認する
5. 「申請」ボタンをクリックしようとする

#### 期待結果
- 「申請」ボタンが無効状態（グレーアウト）である
- ボタンにマウスオーバーすると、ツールチップが表示される
  - 「利用規約に同意してください」
- クリックしても申請処理は実行されない

### テストケース8: 境界値テスト - 文字数最小値

#### 事前条件
- アカウント申請ページにアクセスできる

#### テスト手順
1. アカウント申請ページにアクセスする
2. 必須項目に最小文字数の値を入力する
   - 姓：「あ」（1文字）
   - 名：「い」（1文字）
   - 申請理由：20文字ちょうどのテキスト
3. 「申請」ボタンをクリックする

#### 期待結果
- バリデーションエラーが発生しない
- 申請が正常に受理される
- 確認ダイアログが表示される

### テストケース9: ネットワークエラー

#### 事前条件
- アカウント申請ページにアクセスできる
- ネットワーク接続をシミュレートできる環境（開発ツール等）

#### テスト手順
1. アカウント申請ページにアクセスする
2. 全ての必須項目を正しく入力する
3. ブラウザの開発ツールでネットワークをオフラインに設定する
4. 「申請」ボタンをクリックする
5. 確認ダイアログで「はい」をクリックする

#### 期待結果
- ローディング表示が表示される
- タイムアウト後（5秒程度）にエラーメッセージが表示される
  - 「通信エラーが発生しました。ネットワーク接続を確認してもう一度お試しください」
- 「再試行」ボタンが表示される
- 入力内容は保持されている（再入力不要）

### テストケース10: UI/UXテスト - リアルタイムバリデーション

#### 事前条件
- アカウント申請ページにアクセスできる

#### テスト手順
1. アカウント申請ページにアクセスする
2. メールアドレスフィールドに不正な値を入力する
   - 「test」と入力
3. 他のフィールドをクリック（フォーカスアウト）
4. メールアドレスフィールドに戻り、正しい形式に修正する
   - 「test@example.com」
5. 再度フォーカスアウトする

#### 期待結果
- 最初のフォーカスアウト時：エラーメッセージが表示される
- 修正後のフォーカスアウト時：エラーメッセージが消える
- フィールドの枠線の色が変わる（赤→デフォルト色）

## 性能テスト

### 負荷テスト
- **同時申請数**: 50件の同時申請リクエストを処理できる
- **レスポンス時間**: 申請処理が3秒以内に完了する
- **データベース処理**: 申請レコードの挿入が500ms以内に完了する

## セキュリティテスト

### XSS（クロスサイトスクリプティング）対策

#### テスト手順
1. 申請理由フィールドにJavaScriptコードを含むテキストを入力
   - `<script>alert('XSS')</script>`
2. 申請を実行する
3. 承認画面で申請詳細を確認する

#### 期待結果
- スクリプトが実行されない
- エスケープされたテキストとして表示される
  - `&lt;script&gt;alert('XSS')&lt;/script&gt;`

### CSRF（クロスサイトリクエストフォージェリ）対策

#### テスト手順
1. 正常な申請フォームのHTMLを取得する
2. CSRFトークンを含まない偽の申請リクエストを送信する
3. サーバーのレスポンスを確認する

#### 期待結果
- 403 Forbiddenエラーが返される
- エラーメッセージ：「CSRFトークンが無効です」
- 申請は処理されない

### レート制限テスト

#### テスト手順
1. 同一IPアドレスから連続して申請を実行する
2. 1時間に4回目の申請を試みる（制限：3回/時間）

#### 期待結果
- 4回目の申請時にエラーメッセージが表示される
  - 「申請回数が上限に達しました。しばらく経ってから再度お試しください」
- HTTPステータスコード：429 Too Many Requests

## 自動化対象
- **自動化可能**: テストケース1〜8（正常系、異常系、境界値）
- **手動実行**: テストケース9（ネットワークエラー）、セキュリティテスト

## テスト環境
- **OS**: Windows 10/11, macOS 13+, Ubuntu 22.04
- **ブラウザ**:
  - Chrome（最新版）
  - Firefox（最新版）
  - Safari（macOSのみ、最新版）
  - Edge（最新版）
- **デバイス**: デスクトップ、タブレット（iPad）、モバイル（iPhone、Android）
- **画面解像度**:
  - デスクトップ：1920x1080、1366x768
  - タブレット：1024x768
  - モバイル：375x667、414x896
