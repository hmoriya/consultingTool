# ユースケース: アカウントを承認・作成する

## ユースケース概要

### 目的
管理者がユーザーアカウントの申請内容を審査し、適切と判断した場合にアカウントを作成して申請者に通知する。

### アクター
- **主アクター**: 管理者
  - 説明: アカウント申請を審査し、承認または却下する権限を持つユーザー
- **副アクター**: 申請者（新規メンバー、クライアント）
  - 説明: アカウント申請をした人で、審査結果の通知を受け取る

### 事前条件
1. ユーザーアカウント申請が「承認待ち」状態で登録されている
2. 管理者が管理者権限を持ってログインしている
3. 申請内容に必要な情報がすべて含まれている

### 事後条件
1. 申請が「承認」または「却下」状態に更新される
2. 承認の場合、ユーザーアカウントが「Active」状態で作成される
3. 初期パスワードが自動生成され、安全に保存される
4. 申請者に審査結果と必要な情報（承認時はログイン情報、却下時は理由）がメールで通知される
5. 審査結果が監査ログに記録される

### トリガー
- **種別**: 要求駆動
- **詳細**: 管理者が管理画面の「承認待ちアカウント一覧」から申請を選択し、審査を開始する

## 基本フロー

1. 管理者が管理画面にログインする
2. システムが「承認待ちアカウント一覧」を表示する（申請日時順）
3. 管理者が審査対象の申請を選択する
4. システムが申請詳細（氏名、メールアドレス、所属、申請理由、希望ロール）を表示する
5. 管理者が申請内容を確認し、妥当性を判断する
6. 管理者が「承認」ボタンをクリックする
7. システムが承認確認ダイアログを表示する
8. 管理者が承認を確定する
9. システムが以下の処理を実行する
   - 申請ステータスを「承認」に更新
   - 新規ユーザーアカウントレコードを作成（状態：Active）
   - 初期パスワードを自動生成（8文字、英数字記号を含む）
   - パスワードをbcryptでハッシュ化して保存
   - 「初回ログイン時にパスワード変更必須」フラグを設定
   - 申請時の希望ロールを設定
10. システムが申請者に承認通知メールを送信する（ログインURL、メールアドレス、初期パスワード含む）
11. システムが管理者に完了通知を画面に表示する
12. 管理者が次の申請審査または他の業務に移る

## 代替フロー

### 代替フロー1: 申請を却下する
- **分岐点**: 基本フロー ステップ6
- **条件**: 管理者が申請内容を不適切と判断した場合
1. 管理者が「却下」ボタンをクリックする
2. システムが却下理由入力ダイアログを表示する
3. 管理者が却下理由を具体的に入力する（最低20文字）
4. 管理者が却下を確定する
5. システムが申請ステータスを「却下」に更新する
6. システムが申請者に却下通知メールを送信する（却下理由、再申請方法を含む）
7. システムが管理者に完了通知を表示する
8. 基本フロー ステップ12に進む

### 代替フロー2: 申請内容の修正を依頼する
- **分岐点**: 基本フロー ステップ5
- **条件**: 申請内容に不明点や不足があるが、完全に却下する必要はない場合
1. 管理者が「修正依頼」ボタンをクリックする
2. システムが修正依頼内容入力フィールドを表示する
3. 管理者が具体的な修正依頼内容を入力する
4. システムが申請ステータスを「修正依頼中」に更新する
5. システムが申請者に修正依頼メールを送信する（何を修正すべきか明記）
6. 申請者が内容を修正して再申請する
7. システムが申請を「承認待ち」に戻す
8. 基本フロー ステップ2に戻る

### 代替フロー3: ロールを変更して承認する
- **分岐点**: 基本フロー ステップ5
- **条件**: 申請された希望ロールが不適切だが、別のロールなら承認可能な場合
1. 管理者が申請詳細画面で「ロールを変更」を選択する
2. システムが利用可能なロール一覧を表示する
3. 管理者が適切なロールを選択する
4. 管理者がロール変更の理由をコメント欄に記入する
5. 基本フロー ステップ6に進む（変更後のロールで承認）

## 例外フロー

### 例外フロー1: メールアドレスが既に使用されている
- **発生点**: 基本フロー ステップ9
- **条件**: アカウント作成時に同じメールアドレスのアカウントが既に存在する場合
1. システムが「このメールアドレスは既に登録されています」というエラーを検知する
2. システムが既存アカウント情報を管理者に表示する
3. システムが以下の選択肢を提示する
   - 既存アカウントと統合する
   - 申請を却下する（重複理由を通知）
   - 申請者に別のメールアドレスでの再申請を依頼する
4. 管理者が適切な対応を選択する
5. 選択に応じた処理を実行する

### 例外フロー2: メール送信失敗
- **発生点**: 基本フロー ステップ10
- **条件**: メールサーバーの障害等で通知メールの送信に失敗した場合
1. システムがメール送信エラーを検知する
2. システムが「メール送信に失敗しました」という警告を管理者に表示する
3. システムがアカウントは作成済みだが通知未完了という状態を記録する
4. システムが「未通知アカウント」リストに追加する
5. 管理者が以下のいずれかを選択する
   - メール送信を再試行する
   - 申請者に直接連絡する（電話等）
   - 別の通知方法を使用する
6. 通知が完了したら「未通知」フラグを解除する

### 例外フロー3: 申請の有効期限切れ
- **発生点**: 基本フロー ステップ4
- **条件**: 申請から30日以上経過している場合
1. システムが申請の有効期限切れを検知する
2. システムが「この申請は有効期限切れです」という警告を表示する
3. システムが以下の選択肢を提示する
   - 有効期限を延長して審査を続ける
   - 期限切れとして自動却下する
4. 管理者が選択肢を選ぶ
5. 延長の場合は基本フロー ステップ5に進む、自動却下の場合は代替フロー1に進む

## ビジネスルール

1. **審査期限**: 申請から24時間以内に審査を完了することを目標とする
   - 適用タイミング: 全体を通して適用
   - 例: 24時間経過した未審査申請は管理者ダッシュボードで強調表示

2. **却下理由の必須**: 申請を却下する場合、20文字以上の具体的な理由が必要
   - 適用タイミング: 代替フロー1 ステップ3
   - 例: 「不適切」では不十分、「申請理由が業務と無関係で、アクセス必要性が不明」が適切

3. **初期パスワードの複雑性**: 自動生成パスワードは8文字以上で、英大文字、英小文字、数字、記号を各1文字以上含む
   - 適用タイミング: 基本フロー ステップ9
   - 例: `A1b@cD3e`は有効

4. **管理者権限の必要性**: アカウント承認・作成はAdmin または UserAdminロールのみ実行可能
   - 適用タイミング: 基本フロー ステップ1
   - 例: ConsultantやClientロールではアクセス不可

## 入出力情報

### 入力情報
- 申請ID
  - 内容: 審査対象の申請を識別するID
  - 形式: REQ-YYYYMMDD-XXXX
  - 必須/任意: 必須（一覧から選択）
  - 検証ルール: 存在する申請IDであること

- 承認/却下の判断
  - 内容: 管理者の審査結果
  - 形式: 選択（承認/却下/修正依頼）
  - 必須/任意: 必須
  - 検証ルール: いずれか1つを選択

- 却下理由（却下時のみ）
  - 内容: 却下する具体的な理由
  - 形式: テキスト（20文字以上500文字以内）
  - 必須/任意: 却下時は必須
  - 検証ルール: 20文字以上、具体的な記述

- ロール変更（必要時のみ）
  - 内容: 申請とは異なるロールへの変更
  - 形式: 選択肢（Executive, PM, Consultant, Client）
  - 必須/任意: ロール変更時は必須
  - 初期値: 申請時の希望ロール

### 出力情報
- ユーザーアカウント
  - 内容: ユーザーID、メールアドレス、ハッシュ化パスワード、ロール、状態
  - 用途: システムログインとアクセス制御
  - 保存期間: アカウント削除まで永続

- 初期パスワード（平文、一時的）
  - 内容: 自動生成された初期パスワード
  - 用途: 申請者への通知（メール本文）のみ
  - 保存期間: メール送信後即座に破棄（DBには保存しない）

- 承認/却下通知メール
  - 内容: 審査結果、ログイン情報（承認時）、却下理由（却下時）
  - 用途: 申請者への正式な結果通知
  - 送信先: 申請時のメールアドレス

- 監査ログレコード
  - 内容: 審査イベント（管理者、申請ID、結果、タイムスタンプ）
  - 用途: コンプライアンス、セキュリティ監査
  - 保存期間: 5年間

## 非機能要件

- **応答性**:
  - 通常時: 承認処理は3秒以内に完了
  - ピーク時: 5秒以内に完了

- **利用可能性**:
  - 利用時間: 24時間365日（管理者はいつでも審査可能）
  - 計画停止: システムメンテナンス時のみ

- **セキュリティ**:
  - 認証: 管理者権限必須
  - 認可: Admin、UserAdminロールのみ実行可能
  - 監査: すべての承認・却下を記録
  - パスワード: 初期パスワードは平文でDBに保存しない

- **使いやすさ**:
  - 操作手順: 最大4ステップ（一覧→詳細→承認/却下→完了）
  - 一括処理: 複数申請を同時に審査可能
  - エラー復旧: エラー時は状態をロールバック、再試行可能

## 関連ユースケース

- <<include>> なし

- <<extend>> ロール変更を伴う承認
  - 説明: 申請ロールとは異なるロールで承認する場合

- 先行: ユーザーアカウントを申請する
  - 説明: 申請が存在しないと審査できない

- 後続: ログインして認証する
  - 説明: アカウント作成後、申請者がログインする

## ページ遷移概要

```
[管理者ダッシュボード] → [承認待ち一覧] → [申請詳細] → [承認/却下確認] → [完了画面]
                                      ↓
                               [修正依頼フォーム]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 申請を承認し、アカウントが正常に作成される
   - 申請者に初期パスワード付きメールが届く
   - 監査ログに承認が記録される

2. **代替系テスト**:
   - 申請を却下し、理由付きメールが送信される
   - ロールを変更して承認（申請Consultant→実際はClient）
   - 修正依頼を送信し、申請が修正依頼中状態になる

3. **異常系テスト**:
   - メールアドレス重複エラー（既存アカウント表示）
   - メール送信失敗（未通知リスト追加）
   - 有効期限切れ申請の審査試行（警告表示）

4. **境界値テスト**:
   - 却下理由20文字（最小）での却下成功
   - 却下理由500文字（最大）での却下成功
   - 19文字で文字数不足エラー

5. **権限テスト**:
   - Admin、UserAdminロールでアクセス可能
   - Consultant、Clientロールでアクセス拒否
