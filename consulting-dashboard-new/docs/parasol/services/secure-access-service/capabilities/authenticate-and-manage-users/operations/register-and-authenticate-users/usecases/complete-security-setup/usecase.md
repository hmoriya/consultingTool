# ユースケース: セキュリティ設定を完了する

## 基本情報
- **ユースケースID**: UC-AUTH-04
- **アクター**: 申請者（新規ユーザー）、セキュリティ管理者
- **概要**: 初回ログイン成功後にユーザーがセキュリティ環境を最終設定し、MFA有効化・パスワード変更・セキュリティ通知設定を完了してセキュアアクセス環境を確立する

## 事前条件
- ユーザーが初回ログインに成功している（UC-AUTH-03完了）
- アカウントが有効状態である（User.status = "active"）
- セッションが確立されている（Session.isActive = true）
- セキュリティポリシーが設定済みである
- MFA設定が可能な状態である

## 事後条件
### 成功時
- セキュリティ設定が完了している（User.passwordChangedAt = now()）
- MFAが有効化されている（User.mfaEnabled = true）
- セキュリティ通知設定が確定している
- セキュアアクセス環境が確立されている
- 設定完了通知が配信されている

### 失敗時
- セキュリティ設定エラーが記録されている
- 未完了項目が明確化されている
- ユーザーにガイダンスと次のアクションが表示されている
- セキュリティリスクレベルが評価されている

## 基本フロー
1. **ユーザーがセキュリティ設定画面にアクセスする**
   - システムがセキュリティ設定フォームを表示
   - 現在のセキュリティレベルと推奨設定を表示
   - 必須設定項目と推奨設定項目を明示

2. **ユーザーがパスワード変更を実行する**
   - 現在のパスワード確認
   - 新パスワード入力とポリシー適合性確認
   - パスワード変更実行とUser.passwordChangedAt更新

3. **ユーザーがMFA設定を実行する**
   - MFA方式選択（SMS、認証アプリ、ハードウェアキー）
   - MFAデバイス登録・設定・テスト実行
   - User.mfaEnabled = true への更新

4. **ユーザーがセキュリティ通知設定を確定する**
   - → UC-NOTIFY-01: セキュリティ通知を配信する（設定）
   - 通知レベル・配信方法・頻度設定
   - セキュリティアラート設定の確定

5. **システムがセキュリティ環境確立を完了する**
   - → UC-AUTH-03: セキュリティ設定完了ログを記録する
   - セキュアアクセス環境の最終確認
   - → UC-NOTIFY-01: 設定完了通知を配信する（ユーザー・管理者）

## 代替フロー
### 代替フロー1: 段階的設定完了
- 3a. ユーザーがMFA設定を後で実行したい場合
  - 3a1. 段階的設定スケジュールの提示
  - 3a2. セキュリティリスクレベルの説明
  - 3a3. 後日設定リマインダーの設定
  - 3a4. 基本フロー4（通知設定）に進む

### 代替フロー2: 管理者支援設定
- 2a. パスワード設定に支援が必要な場合
  - 2a1. セキュリティ管理者支援要請
  - 2a2. 管理者による設定支援実行
  - 2a3. 支援完了後の設定引き継ぎ
  - 2a4. 基本フロー3（MFA設定）に戻る

## 例外フロー
### 例外1: MFA設定失敗
- *a. MFAデバイス登録に失敗した場合
  - *a1. → UC-AUTH-03: MFA設定失敗イベントを記録する
  - *a2. 代替MFA方式の提示・選択支援
  - *a3. 技術サポート連絡先の提供
  - *a4. 一時的セキュリティ設定での継続オプション

### 例外2: セキュリティポリシー不適合
- *b. 設定内容がポリシーに不適合な場合
  - *b1. 詳細な不適合理由の表示
  - *b2. ポリシー適合のためのガイダンス提供
  - *b3. セキュリティ管理者への相談オプション
  - *b4. ポリシー適合後、該当フローに復帰

### 例外3: システム障害
- *c. 設定処理中にシステム障害が発生した場合
  - *c1. 設定進捗の自動保存実行
  - *c2. 障害レベルに応じた復旧処理
  - *c3. ユーザーに状況説明と復旧予定時刻案内
  - *c4. 復旧後の設定継続機能提供

## 特別要件
- **性能**: 各設定項目完了2秒以内、全体設定完了3分以内
- **可用性**: システム稼働率99.9%以上
- **セキュリティ**: MFA設定データ暗号化、設定変更ログ記録、不正変更検知
- **精度**: パスワードポリシー適合100%、MFA設定成功率98%
- **ユーザビリティ**: 直感的設定フロー、リアルタイムガイダンス、設定支援

## 関連ユースケース
- **包含**: UC-AUTH-03（ログ記録）、UC-NOTIFY-01（通知配信）
- **前提**: UC-AUTH-03（セキュアログイン完了）必須
- **後続**: セキュアアクセス環境での日常利用開始

---
*このユースケースは パラソル設計v2.0仕様 に基づいて作成されました*
