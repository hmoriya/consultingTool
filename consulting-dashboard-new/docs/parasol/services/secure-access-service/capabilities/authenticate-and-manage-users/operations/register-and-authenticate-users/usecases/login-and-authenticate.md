# ユースケース: ログインして認証する

## ユースケース概要

### 目的
組織メンバーが自身のアカウント情報を使用してシステムにログインし、身元を確認されることで、システムの機能とデータに安全にアクセスできるようにする。

### アクター
- **主アクター**: 組織メンバー
  - 説明: システムを利用する全ての組織メンバー（エグゼクティブ、PM、コンサルタント、クライアント）
- **副アクター**: セキュリティ監査システム
  - 説明: 認証イベントを記録し、セキュリティ上の異常を検知する

### 事前条件
1. ユーザーアカウントが有効な状態で存在している
2. ユーザーが正しいメールアドレスとパスワードを知っている
3. アカウントがロックされていない（連続ログイン失敗が5回未満）

### 事後条件
1. ユーザーが認証され、有効なセッションが確立される
2. ユーザーのロールと権限情報がシステムに読み込まれる
3. ログイン成功が監査ログに記録される
4. ユーザーがシステムのメインダッシュボードにアクセスできる状態になる

### トリガー
- **種別**: 要求駆動
- **詳細**: ユーザーがログインページにアクセスし、ログイン操作を開始する

## フロー定義

### 基本フロー

1. ユーザーがログインページにアクセスする
2. システムがログインフォーム（メールアドレス、パスワード入力欄）を表示する
3. ユーザーがメールアドレスとパスワードを入力し、「ログイン」ボタンをクリックする
4. システムが入力内容の形式を検証する（メールアドレス形式、パスワード入力確認）
5. システムがユーザー情報をデータベースから取得し、パスワードを照合する
6. システムが認証成功を確認し、セッショントークン（JWT）を生成する
7. システムがユーザーのロール情報と権限情報を読み込む
8. システムがログイン成功を監査ログに記録する
9. システムがユーザーをメインダッシュボードにリダイレクトする
10. ユーザーがダッシュボードで自分の名前とロールが表示されていることを確認する

## 代替フロー

### 代替フロー1: 初回ログイン時のパスワード変更

- **分岐点**: 基本フロー ステップ6
- **条件**: ユーザーが初回ログインである、または強制パスワード変更フラグが立っている場合

1. システムが初回ログインまたはパスワード変更要求を検知する
2. システムがパスワード変更画面にリダイレクトする
3. ユーザーが新しいパスワードを2回入力する
4. システムがパスワードポリシー（8文字以上、英数字記号を含む）を検証する
5. システムが新しいパスワードをハッシュ化して保存する
6. システムが強制変更フラグを解除する
7. 基本フロー ステップ7に進む

### 代替フロー2: MFA（多要素認証）が有効な場合

- **分岐点**: 基本フロー ステップ6
- **条件**: ユーザーアカウントでMFAが有効化されている場合

1. システムが認証コード入力画面を表示する
2. システムがユーザーの登録済みデバイス（メール、SMS、認証アプリ）に認証コードを送信する
3. ユーザーが受け取った認証コードを入力する
4. システムが認証コードを検証する（制限時間5分以内、コード一致）
5. 基本フロー ステップ7に進む

## 例外フロー

### 例外フロー1: メールアドレスまたはパスワードが誤っている

- **発生点**: 基本フロー ステップ5
- **条件**: 入力されたメールアドレスまたはパスワードがデータベースの情報と一致しない場合

1. システムが「メールアドレスまたはパスワードが正しくありません」というエラーメッセージを表示する
2. システムがログイン失敗回数をカウントアップする
3. ユーザーが正しい情報を再入力する
4. 基本フロー ステップ4に戻る

### 例外フロー2: アカウントがロックされている

- **発生点**: 基本フロー ステップ5
- **条件**: ログイン失敗が連続5回に達し、アカウントがロックされている場合

1. システムが「アカウントがロックされています。管理者にお問い合わせください」というメッセージを表示する
2. システムがアカウントロック状態を監査ログに記録する
3. システムがパスワードリセットリンクを表示する
4. ユーザーが管理者に連絡するか、パスワードリセット手続きを開始する
5. ユースケース終了

### 例外フロー3: セッション生成失敗

- **発生点**: 基本フロー ステップ6
- **条件**: サーバー側でセッショントークンの生成に失敗した場合

1. システムが「システムエラーが発生しました。しばらく待ってから再度お試しください」というエラーメッセージを表示する
2. システムがエラー詳細を技術ログに記録する
3. システムが管理者に通知を送信する
4. ユーザーが数分後に再度ログインを試みる
5. 基本フロー ステップ1に戻る

## ビジネスルール

1. **パスワードポリシー**: パスワードは8文字以上で、英字、数字、記号をそれぞれ1文字以上含む必要がある
   - 適用タイミング: 代替フロー1 ステップ4
   - 例: `P@ssw0rd123`は有効、`password`は無効

2. **アカウントロックルール**: 連続5回ログインに失敗した場合、アカウントは30分間ロックされる
   - 適用タイミング: 例外フロー2
   - 例: 5回目の失敗後、30分間はログイン試行が拒否される

3. **セッション有効期限**: ログインセッションは最後の操作から8時間有効
   - 適用タイミング: 基本フロー ステップ6
   - 例: 8時間操作がない場合、自動的にログアウトされる

4. **監査ログ記録**: すべてのログイン試行（成功・失敗）を記録する
   - 適用タイミング: 全体を通して適用
   - 例: タイムスタンプ、IPアドレス、ユーザーID、結果が記録される

## 入出力情報

### 入力情報
- **メールアドレス**
  - 内容: ユーザーの登録メールアドレス
  - 形式: RFC5322準拠のメールアドレス形式
  - 必須/任意: 必須
  - 検証ルール: メールアドレス形式、組織ドメイン(@example.com)である

- **パスワード**
  - 内容: ユーザーの秘密パスワード
  - 形式: 8文字以上の文字列（マスク表示）
  - 必須/任意: 必須
  - 検証ルール: 8文字以上、空白文字を含まない

- **認証コード（MFA有効時のみ）**
  - 内容: 6桁の数字コード
  - 形式: 数値6桁
  - 必須/任意: MFA有効時は必須
  - 初期値: なし

### 出力情報
- **セッショントークン（JWT）**
  - 内容: ユーザーID、ロール、権限、有効期限を含む暗号化トークン
  - 用途: 以降のAPI呼び出しで認証情報として使用
  - 保存期間: 8時間（httpOnlyクッキーとして保存）

- **ダッシュボード画面**
  - 内容: ユーザー名、ロール、最終ログイン日時、通知情報
  - 用途: ユーザーがシステムを利用するための起点画面
  - 形式: HTML画面表示

- **監査ログレコード**
  - 内容: ログインイベント詳細（タイムスタンプ、ユーザーID、IPアドレス、結果）
  - 用途: セキュリティ監査とコンプライアンス
  - 保存期間: 90日間

## 非機能要件

- **応答性**:
  - 通常時: 認証処理は2秒以内に完了
  - ピーク時: 5秒以内に認証完了

- **利用可能性**:
  - 利用時間: 24時間365日稼働
  - 計画停止: 月1回、日曜日深夜2時間以内（事前通知あり）

- **セキュリティ**:
  - 認証: パスワードはbcryptでハッシュ化（salt付き）
  - 認可: ロールベースアクセス制御（RBAC）
  - 監査: すべてのログイン試行を記録

- **使いやすさ**:
  - 操作手順: 最大3ステップ（メール入力→パスワード入力→ログイン）
  - エラー復旧: パスワードリセットリンクから1操作で復旧手続き開始

## 関連ユースケース

- **<<include>>** なし（このユースケースは基本的な認証で他のユースケースに依存しない）

- **<<extend>>** MFA認証を実行する
  - 説明: MFA有効時のみ実行される追加認証ステップ

- **先行**: ユーザーアカウントを作成する
  - 説明: ログイン前にアカウントが作成されている必要がある

- **後続**: ロールに応じたダッシュボードを表示する
  - 説明: 認証成功後、ユーザーロールに応じた画面を表示

## ページ遷移概要

```
[ログインページ] → [MFA認証ページ（該当時）] → [パスワード変更ページ（初回時）] → [ダッシュボード]
       ↓
[パスワードリセットページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 正しいメールアドレスとパスワードでログイン
   - セッションが確立され、ダッシュボードが表示される
   - 監査ログにログイン成功が記録される

2. **代替系テスト**:
   - 初回ログイン時のパスワード強制変更フロー
   - MFA有効アカウントでの認証コード入力フロー

3. **異常系テスト**:
   - 誤ったパスワードでログイン試行（エラーメッセージ表示）
   - 連続5回失敗してアカウントロック
   - ロック後のパスワードリセット手続き

4. **境界値テスト**:
   - 最小パスワード長（8文字）での正常ログイン
   - 4回失敗後の5回目成功（ロック直前）
   - セッション有効期限切れ直後のアクセス

5. **権限テスト**:
   - Executive、PM、Consultant、Client各ロールでのログイン
   - 各ロールに応じたダッシュボード表示確認
