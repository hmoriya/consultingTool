# ユースケース: ログアウトする

## ユースケース概要

### 目的
ユーザーが安全にシステムからログアウトし、セッションを終了することで、不正アクセスを防止し、セキュリティを確保する。

### アクター
- **主アクター**: 認証済みユーザー（すべてのロール）
  - 説明: 現在ログイン中のユーザーで、ログアウトを希望する
- **副アクター**: セキュリティ監査システム
  - 説明: ログアウトイベントを記録し、セッション管理を行う

### 事前条件
1. ユーザーが有効なセッションでログインしている
2. セッショントークン（JWT）が有効期限内である
3. ユーザーがシステムの任意のページにアクセス中である

### 事後条件
1. ユーザーのセッションが無効化される
2. セッショントークン（JWT）が破棄される
3. ログアウトイベントが監査ログに記録される
4. ユーザーがログインページにリダイレクトされる
5. ブラウザのセッションクッキーが削除される

### トリガー
- **種別**: 要求駆動
- **詳細**: ユーザーがヘッダーのユーザーメニューから「ログアウト」を選択する、またはセッション有効期限切れで自動ログアウトされる

## 基本フロー

1. ユーザーがヘッダー右上のユーザーアイコンをクリックする
2. システムがユーザーメニューを表示する（プロフィール、設定、ログアウト）
3. ユーザーが「ログアウト」メニューをクリックする
4. システムがログアウト確認ダイアログを表示する（オプション設定による）
5. ユーザーがログアウトを確定する
6. システムが以下の処理を実行する
   - サーバー側でセッションを無効化する
   - セッショントークン（JWT）をブラックリストに追加する
   - ユーザーIDとログアウト時刻を監査ログに記録する
   - クライアント側のセッションクッキーを削除する
   - ローカルストレージの認証情報をクリアする
7. システムがログインページにリダイレクトする
8. システムが「ログアウトしました」というメッセージを表示する
9. ユーザーが再度ログインする場合はログインフォームを利用する

## 代替フロー

### 代替フロー1: 作業中の変更を保存してからログアウト
- **分岐点**: 基本フロー ステップ4
- **条件**: ユーザーが編集中のデータがあり、未保存の変更が存在する場合
1. システムが「未保存の変更があります」という警告を表示する
2. システムが以下の選択肢を提示する
   - 「保存してログアウト」
   - 「破棄してログアウト」
   - 「キャンセル」
3. ユーザーが「保存してログアウト」を選択する
4. システムが編集中のデータを保存する
5. システムが保存完了を確認する
6. 基本フロー ステップ6に進む

### 代替フロー2: すべてのデバイスからログアウト
- **分岐点**: 基本フロー ステップ3
- **条件**: ユーザーが複数デバイスでログインしており、すべてのセッションを終了したい場合
1. ユーザーが「すべてのデバイスからログアウト」オプションを選択する
2. システムが確認ダイアログを表示する（「すべてのデバイスのセッションを終了しますか？」）
3. ユーザーが確認する
4. システムが該当ユーザーの全セッショントークンを無効化する
5. システムが他のデバイスに「別の場所でログアウトされました」という通知を送信する
6. 基本フロー ステップ7に進む

### 代替フロー3: セッション有効期限切れによる自動ログアウト
- **分岐点**: 基本フロー開始前
- **条件**: ユーザーの無操作が8時間継続し、セッションが自動的に期限切れとなった場合
1. システムがセッション有効期限切れを検知する
2. システムが自動的にセッションを無効化する
3. システムがユーザーに「セッションの有効期限が切れました。再度ログインしてください」というメッセージを表示する
4. システムがログアウトイベントを監査ログに記録する（理由：タイムアウト）
5. システムがログインページにリダイレクトする
6. ユーザーが必要に応じて再ログインする

## 例外フロー

### 例外フロー1: ネットワークエラーによるログアウト失敗
- **発生点**: 基本フロー ステップ6
- **条件**: サーバーとの通信が切断され、ログアウトリクエストが失敗した場合
1. システムがネットワークエラーを検知する
2. システムが「ログアウト処理に失敗しました」というエラーメッセージを表示する
3. システムが以下の選択肢を提示する
   - 「再試行」
   - 「ローカルのみログアウト」（クライアント側のみクリア）
4. ユーザーが選択を行う
5. 再試行の場合は基本フロー ステップ6に戻る、ローカルのみの場合はクライアント側のみクリアして基本フロー ステップ7に進む

### 例外フロー2: 既にログアウト済みのセッション
- **発生点**: 基本フロー ステップ6
- **条件**: 他のデバイスで既にログアウトされており、セッションが無効になっている場合
1. システムが「このセッションは既に無効です」というメッセージを検知する
2. システムがクライアント側の認証情報のみをクリアする
3. システムが「既にログアウトされています」というメッセージを表示する
4. 基本フロー ステップ7に進む

### 例外フロー3: 強制ログアウト（管理者による）
- **発生点**: ユーザーの操作中
- **条件**: 管理者がセキュリティ上の理由でユーザーを強制ログアウトさせた場合
1. システムが管理者からの強制ログアウト指示を受信する
2. システムが即座にセッションを無効化する
3. システムがユーザーに「セキュリティ上の理由によりログアウトされました。詳細は管理者にお問い合わせください」というメッセージを表示する
4. システムが監査ログに強制ログアウトイベントを記録する（実行者：管理者ID、理由を含む）
5. システムがログインページにリダイレクトする
6. ユーザーが再ログインを試みる場合、アカウント状態を確認する必要がある

## ビジネスルール

1. **セッション有効期限**: 最後の操作から8時間経過すると自動的にログアウトする
   - 適用タイミング: 代替フロー3
   - 例: 朝9時にログインし、17時まで操作がない場合、17時に自動ログアウト

2. **未保存変更の警告**: 編集中のデータがある場合、ログアウト前に必ず警告する
   - 適用タイミング: 代替フロー1 ステップ1
   - 例: フォーム入力中、レポート作成中等

3. **トークンブラックリスト**: ログアウトしたトークンは24時間ブラックリストに保持し、再利用を防ぐ
   - 適用タイミング: 基本フロー ステップ6
   - 例: ログアウト後に古いトークンを使った不正アクセスを防止

4. **監査ログ記録**: すべてのログアウト（手動、自動、強制）を理由と共に記録する
   - 適用タイミング: 全体を通して適用
   - 例: タイムスタンプ、ユーザーID、ログアウト理由、IPアドレスを記録

## 入出力情報

### 入力情報
- ログアウト操作
  - 内容: ユーザーによるログアウト要求
  - 形式: ボタンクリックまたはメニュー選択
  - 必須/任意: ユーザーの明示的な操作（手動ログアウトの場合）

- セッショントークン
  - 内容: 現在のセッションを識別するJWT
  - 形式: JWT文字列（httpOnlyクッキー）
  - 必須/任意: 必須
  - 検証ルール: 有効なトークン形式、期限内

### 出力情報
- ログアウト完了メッセージ
  - 内容: ログアウトが正常に完了したことの確認
  - 用途: ユーザーへの視覚的フィードバック
  - 形式: 画面上のメッセージ表示

- 監査ログレコード
  - 内容: ログアウトイベント詳細（ユーザーID、タイムスタンプ、理由、IPアドレス）
  - 用途: セキュリティ監査、コンプライアンス
  - 保存期間: 90日間

- セッション無効化記録
  - 内容: 無効化されたトークンのブラックリストエントリ
  - 用途: トークンの再利用防止
  - 保存期間: 24時間

## 非機能要件

- **応答性**:
  - 通常時: ログアウト処理は1秒以内に完了
  - ピーク時: 2秒以内に完了

- **利用可能性**:
  - 利用時間: 24時間365日（いつでもログアウト可能）
  - オフライン時: ローカルログアウトのみ実行可能

- **セキュリティ**:
  - トークン破棄: サーバー・クライアント両側で完全に削除
  - ブラックリスト: 無効化トークンの再利用を防止
  - 監査: すべてのログアウトを記録
  - 自動ログアウト: 無操作8時間でセッション終了

- **使いやすさ**:
  - 操作手順: 最大2ステップ（メニュー選択→確認）
  - 未保存警告: データ損失を防ぐための明確な警告
  - 確認ダイアログ: 誤操作を防ぐための確認（オプション）

## 関連ユースケース

- <<include>> なし

- <<extend>> すべてのデバイスからログアウト
  - 説明: 複数デバイスの全セッションを一括終了する場合

- 先行: ログインして認証する
  - 説明: ログインしていないとログアウトできない

- 後続: ログインして認証する（再ログイン）
  - 説明: ログアウト後、再度ログインする場合

## ページ遷移概要

```
[任意のページ] → [ユーザーメニュー] → [ログアウト確認（オプション）] → [ログインページ]
                                              ↓
                                    [未保存変更警告（該当時）]
```

## テストシナリオ概要

1. **正常系テスト**:
   - ログアウトボタンをクリックしてログアウト
   - セッションが無効化され、ログインページが表示される
   - 監査ログにログアウトが記録される

2. **代替系テスト**:
   - 未保存の変更がある状態でログアウト（警告表示）
   - 保存してからログアウト（データが保存される）
   - すべてのデバイスからログアウト（全セッション終了）
   - セッションタイムアウトで自動ログアウト

3. **異常系テスト**:
   - ネットワークエラー時のログアウト（ローカルのみクリア）
   - 既に無効なセッションでのログアウト（エラーメッセージ）
   - 管理者による強制ログアウト（セキュリティメッセージ）

4. **境界値テスト**:
   - セッション有効期限ちょうど8時間で自動ログアウト
   - ログアウト直後に古いトークンでアクセス（拒否される）

5. **権限テスト**:
   - すべてのロール（Executive、PM、Consultant、Client）でログアウト可能
   - ログアウト後は認証が必要なページにアクセス不可
