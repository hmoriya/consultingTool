# ユースケース: ユーザーアカウントを申請する

## ユースケース概要

### 目的
新しい組織メンバーまたはクライアントが、システム利用のためのアカウント発行を申請し、承認者の審査を経てアカウントを取得する。

### アクター
- **主アクター**: アカウント申請者（新規メンバー、クライアント）
  - 説明: システムアカウントをまだ持っていない、組織への新規参加者
- **副アクター**: 管理者
  - 説明: アカウント申請を審査し、承認または却下する権限を持つ

### 事前条件
1. 申請者が組織から正式に採用またはプロジェクトへのアサインが決定している
2. 申請者が組織ドメインのメールアドレスを持っている、またはクライアント用の承認済みドメインを持っている
3. アカウント申請システムが稼働している

### 事後条件
1. アカウント申請が受理され、「承認待ち」状態で登録される
2. 管理者に申請通知が送信される
3. 申請内容が監査ログに記録される
4. 申請者に申請受付確認のメールが送信される

### トリガー
- **種別**: 要求駆動
- **詳細**: 新規メンバーまたはクライアントがアカウント申請ページにアクセスし、申請フォームを送信する

## フロー定義

### 基本フロー

1. 申請者がアカウント申請ページにアクセスする
2. システムが申請フォーム（氏名、メールアドレス、所属、申請理由、希望ロール）を表示する
3. 申請者が必要情報を入力する
   - 氏名（姓・名）
   - メールアドレス（組織ドメイン）
   - 所属部署
   - 申請理由
   - 希望するロール（Consultant/Client等）
4. システムが入力内容を検証する（必須項目、メールアドレス形式、ドメイン確認）
5. 申請者が入力内容を確認画面で再確認する
6. 申請者が「申請する」ボタンをクリックする
7. システムがアカウント申請レコードを「承認待ち」状態でデータベースに保存する
8. システムが申請IDを生成する
9. システムが管理者に申請通知メールを送信する
10. システムが申請者に受付確認メールを送信する（申請ID、審査期間の目安を含む）
11. システムが申請受付を画面に表示する
12. 申請者が申請ID と審査期間の案内を確認する

## 代替フロー

### 代替フロー1: クライアント用アカウント申請

- **分岐点**: 基本フロー ステップ3
- **条件**: 申請者がクライアント企業のメンバーである場合

1. 申請者が「クライアント」ロールを選択する
2. システムが追加情報入力フィールドを表示する
   - クライアント企業名
   - プロジェクト名
   - 担当PM（社内）の名前
3. 申請者が追加情報を入力する
4. システムが担当PMに確認メールを自動送信する
5. 基本フロー ステップ4に進む

### 代替フロー2: 既存メールアドレスでの再申請

- **分岐点**: 基本フロー ステップ4
- **条件**: 入力されたメールアドレスが既に申請済みまたは登録済みの場合

1. システムが「このメールアドレスは既に使用されています」というメッセージを表示する
2. システムが以下の選択肢を提示する
   - 「既存アカウントでログインする」リンク
   - 「パスワードをリセットする」リンク
   - 「別のメールアドレスで申請する」オプション
3. 申請者が適切な選択肢を選ぶ
4. 選択に応じて該当ユースケースに遷移する

## 例外フロー

### 例外フロー1: メールアドレスドメインが許可されていない

- **発生点**: 基本フロー ステップ4
- **条件**: 入力されたメールアドレスのドメインが組織の許可リストにない場合

1. システムが「このドメインからの申請は受け付けていません」というエラーメッセージを表示する
2. システムが許可されているドメイン例を表示する（@company.com, @client-approved.com）
3. システムが「別のメールアドレスを使用するか、管理者にお問い合わせください」と案内する
4. 申請者が正しいドメインのメールアドレスを入力し直す
5. 基本フロー ステップ4に戻る

### 例外フロー2: 申請理由が不十分

- **発生点**: 基本フロー ステップ4
- **条件**: 申請理由の文字数が10文字未満、または不適切な内容の場合

1. システムが「申請理由を具体的に記入してください（10文字以上）」というメッセージを表示する
2. システムが記入例を表示する（例：「DX推進プロジェクトのコンサルタントとして参画」）
3. 申請者が申請理由を詳細に記入し直す
4. 基本フロー ステップ4に戻る

### 例外フロー3: メール送信失敗

- **発生点**: 基本フロー ステップ9、10
- **条件**: メールサーバーの障害やネットワークエラーでメール送信に失敗した場合

1. システムが申請は受理されたが通知メール送信に失敗したことをログに記録する
2. システムが「申請は受理されましたが、確認メールの送信に失敗しました」というメッセージを表示する
3. システムが申請IDを画面に表示する
4. システムが管理画面の「未通知申請」リストに追加する
5. 管理者が手動で通知を行う
6. ユースケース終了（申請自体は成功）

## ビジネスルール

1. **メールアドレスドメイン制限**: 申請可能なドメインは組織の許可リストに登録されたもののみ
   - 適用タイミング: 基本フロー ステップ4
   - 例: @company.com, @approved-client.com は可、@gmail.com は不可

2. **申請理由の必須性**: 申請理由は10文字以上で具体的に記述する必要がある
   - 適用タイミング: 基本フロー ステップ4
   - 例: 「プロジェクト参加のため」では不十分、「DX推進プロジェクトのコンサルタントとして参画するため」が適切

3. **重複申請の防止**: 同一メールアドレスでの重複申請は不可
   - 適用タイミング: 基本フロー ステップ4
   - 例: 既に申請中または登録済みのメールアドレスは受け付けない

4. **申請の有効期限**: 申請から30日以内に承認または却下されない場合、申請は自動的に期限切れとなる
   - 適用タイミング: 申請受理後、バックグラウンドで監視
   - 例: 30日経過した申請は「期限切れ」状態に自動更新

## 入出力情報

### 入力情報
- **氏名**
  - 内容: 申請者の姓名（フルネーム）
  - 形式: テキスト（姓・名それぞれ50文字以内）
  - 必須/任意: 必須
  - 検証ルール: 空白不可、全角・半角両対応

- **メールアドレス**
  - 内容: 申請者の業務用メールアドレス
  - 形式: RFC5322準拠のメールアドレス
  - 必須/任意: 必須
  - 検証ルール: メールアドレス形式、許可ドメインのみ

- **所属部署**
  - 内容: 申請者の所属部署またはクライアント企業名
  - 形式: テキスト（100文字以内）
  - 必須/任意: 必須
  - 検証ルール: 空白不可

- **申請理由**
  - 内容: アカウントが必要な理由の具体的説明
  - 形式: テキスト（10文字以上500文字以内）
  - 必須/任意: 必須
  - 検証ルール: 10文字以上、具体的な記述

- **希望ロール**
  - 内容: 申請するアカウントのロール
  - 形式: 選択肢（Consultant, Client）
  - 必須/任意: 必須
  - 初期値: Consultant

### 出力情報
- **申請ID**
  - 内容: 申請を一意に識別する番号
  - 用途: 申請状況の問い合わせ、追跡
  - 形式: REQ-YYYYMMDD-XXXX（例: REQ-20250102-0001）

- **受付確認メール**
  - 内容: 申請ID、受付日時、審査期間の目安、問い合わせ先
  - 用途: 申請者への正式な受付通知
  - 送信先: 申請時に入力されたメールアドレス

- **申請通知メール（管理者宛）**
  - 内容: 申請者情報、申請理由、申請ID、承認・却下リンク
  - 用途: 管理者への審査依頼通知
  - 送信先: 管理者メールアドレス

- **申請レコード（データベース）**
  - 内容: 申請の全情報と状態（承認待ち）
  - 保存期間: 申請日から1年間
  - 用途: 審査プロセス管理、監査証跡

## 非機能要件

- **応答性**:
  - 通常時: 申請送信から受付完了まで3秒以内
  - ピーク時: 5秒以内に受付完了

- **利用可能性**:
  - 利用時間: 24時間365日利用可能
  - 計画停止: システムメンテナンス時のみ（事前通知あり）

- **セキュリティ**:
  - 認証: 申請時は認証不要（公開ページ）
  - データ保護: 申請情報はSSL/TLSで暗号化して送信
  - 監査: すべての申請を記録

- **使いやすさ**:
  - 操作手順: 最大4ステップ（情報入力→確認→送信→完了）
  - 入力支援: リアルタイムバリデーション、記入例の表示
  - エラー復旧: エラー箇所を明示し、修正方法を案内

## 関連ユースケース

- **<<include>>** なし

- **<<extend>>** なし

- **先行**: なし（このユースケースは新規ユーザーの最初のステップ）

- **後続**: アカウント申請を承認する（管理者が実行）
  - 説明: 管理者が申請を審査し、承認または却下を決定する

## ページ遷移概要

```
[アカウント申請ページ] → [入力確認ページ] → [申請完了ページ]
           ↓
    [記入例・ヘルプページ]
```

## テストシナリオ概要

1. **正常系テスト**:
   - 全項目を正しく入力して申請送信
   - 申請IDが発行され、確認メールが届く
   - 管理者に通知メールが届く

2. **代替系テスト**:
   - クライアントロールでの申請（追加情報入力）
   - 担当PMへの確認メール送信確認

3. **異常系テスト**:
   - 許可されていないドメインでの申請（エラー表示）
   - 申請理由が10文字未満（エラーと記入例表示）
   - 既存メールアドレスでの申請（既存アカウント案内）

4. **境界値テスト**:
   - 申請理由10文字（最小）での申請成功
   - 申請理由500文字（最大）での申請成功
   - 501文字で文字数超過エラー

5. **権限テスト**:
   - 認証不要（誰でもアクセス可能）な申請ページ
   - 管理者のみが承認画面にアクセス可能
