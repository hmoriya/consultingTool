import { PrismaClient as ParasolPrismaClient } from '@prisma/parasol-client'

const parasolDb = new ParasolPrismaClient()

// 収益最適化サービスのケーパビリティとビジネスオペレーション定義
export const revenueOptimizationData = {
  capabilities: [
    {
      name: 'revenue-management',
      displayName: '収益を管理する能力',
      description: 'プロジェクトの収益性をリアルタイムに把握し、最大化するための意思決定を支援する能力',
      category: 'Core',
      definition: `# ビジネスケーパビリティ: 収益を管理する能力

## ケーパビリティ概要
プロジェクト単位の収益をきめ細かく管理し、組織全体の収益性を最適化する能力

## ビジネス価値
- **収益性向上**: プロジェクト収益率の改善
- **予測精度**: 将来収益の正確な予測
- **意思決定**: データに基づく経営判断

## 実現する成果
- 収益予測精度: 95%以上
- 収益性改善: 年5%向上
- 請求漏れ: ゼロ
- 月次締め時間: 2営業日以内

## 必要な要素
### 人材・スキル
- 財務アナリスト
- 収益管理スペシャリスト
- ビジネスコントローラー

### プロセス・方法論
- 収益認識基準
- プロジェクト原価計算
- 収益予測モデル

### ツール・システム
- 収益管理システム
- 分析ダッシュボード
- 予測モデリングツール`,
      businessOperations: [
        {
          name: 'revenue-tracking',
          displayName: '収益を追跡する',
          pattern: 'Analytics',
          goal: 'プロジェクト収益のリアルタイム把握',
          design: `# ビジネスオペレーション: 収益を追跡する

## 目的
各プロジェクトの収益状況をリアルタイムに追跡し、経営層に正確な収益情報を提供する

## 関係者とロール
- **収益管理者**: データ収集、分析
- **プロジェクトマネージャー**: 収益報告
- **財務部門**: 会計処理
- **経営層**: 意思決定

## ビジネスプロセス
1. **データ収集**: 売上、原価データ
2. **収益計算**: プロジェクト別収益
3. **進行基準適用**: 進捗に応じた収益認識
4. **異常値検知**: 予算との乖離
5. **レポート作成**: 経営報告書
6. **アクション提案**: 改善施策

## 状態遷移
データ収集中 → 計算中 → 検証中 → 確定 → 報告済み

## KPI
- データ収集完了: 月末+1営業日
- 計算精度: 99.9%以上
- レポート提出: 月末+3営業日`,
          roles: ['収益管理者', 'プロジェクトマネージャー', '財務部門', '経営層'],
          operations: {
            steps: [
              'データ収集',
              '収益計算',
              '進行基準適用',
              '異常値検知',
              'レポート作成',
              'アクション提案'
            ]
          },
          businessStates: {
            initial: 'データ収集中',
            states: ['データ収集中', '計算中', '検証中', '確定', '報告済み'],
            final: '報告済み'
          }
        },
        {
          name: 'billing-management',
          displayName: '請求を管理する',
          pattern: 'Workflow',
          goal: '正確でタイムリーな請求処理',
          design: `# ビジネスオペレーション: 請求を管理する

## 目的
実施した作業に対して適切なタイミングで正確に請求し、キャッシュフローを最適化する

## 関係者とロール
- **請求担当者**: 請求書作成
- **プロジェクトマネージャー**: 請求内容確認
- **経理部門**: 請求書発行
- **クライアント**: 請求書受領、支払い

## ビジネスプロセス
1. **請求対象確定**: 当月の請求範囲
2. **請求額計算**: 契約に基づく金額
3. **請求書作成**: 明細、根拠資料
4. **内部承認**: PM、経理確認
5. **請求書送付**: クライアントへ送付
6. **入金確認**: 支払い状況追跡

## KPI
- 請求精度: 100%
- 請求書発行: 月末+5営業日
- 入金率: 翌月末95%以上`,
          roles: ['請求担当者', 'プロジェクトマネージャー', '経理部門', 'クライアント'],
          operations: {
            steps: [
              '請求対象確定',
              '請求額計算',
              '請求書作成',
              '内部承認',
              '請求書送付',
              '入金確認'
            ]
          },
          businessStates: {
            initial: '準備中',
            states: ['準備中', '作成中', '承認中', '送付済み', '入金待ち', '完了'],
            final: '完了'
          }
        },
        {
          name: 'revenue-forecasting',
          displayName: '収益を予測する',
          pattern: 'Analytics',
          goal: '精度の高い将来収益予測',
          design: `# ビジネスオペレーション: 収益を予測する

## 目的
パイプライン案件と既存プロジェクトから将来の収益を予測し、経営計画を支援する

## 関係者とロール
- **収益アナリスト**: 予測モデル構築
- **営業部門**: パイプライン情報
- **PMO**: プロジェクト情報
- **経営企画**: 計画策定

## ビジネスプロセス
1. **情報収集**: 案件、プロジェクト情報
2. **確度評価**: 成約確率の設定
3. **シナリオ作成**: 楽観/中立/悲観
4. **モデル適用**: 予測計算
5. **リスク評価**: 変動要因分析
6. **予測更新**: 月次ローリング

## KPI
- 予測精度: ±5%以内
- 予測期間: 12ヶ月先まで
- 更新頻度: 月次`,
          roles: ['収益アナリスト', '営業部門', 'PMO', '経営企画'],
          operations: {
            steps: [
              '情報収集',
              '確度評価',
              'シナリオ作成',
              'モデル適用',
              'リスク評価',
              '予測更新'
            ]
          },
          businessStates: {
            initial: '収集中',
            states: ['収集中', '分析中', '予測作成中', 'レビュー中', '確定'],
            final: '確定'
          }
        }
      ]
    },
    {
      name: 'cost-control',
      displayName: 'コストを統制する能力',
      description: 'プロジェクトコストを適切に管理し、収益性を確保するための統制を実施する能力',
      category: 'Core',
      definition: `# ビジネスケーパビリティ: コストを統制する能力

## ケーパビリティ概要
直接・間接コストを詳細に把握し、予算内でプロジェクトを遂行するための統制力

## ビジネス価値
- **利益率向上**: 無駄なコストの削減
- **予算遵守**: 計画的な支出管理
- **競争力**: コスト競争力の確保

## 実現する成果
- コスト削減: 年3%以上
- 予算遵守率: 95%以上
- コスト予測精度: ±3%以内
- 承認処理時間: 24時間以内

## 必要な要素
### 人材・スキル
- コストコントローラー
- 調達スペシャリスト
- 予算管理者

### プロセス・方法論
- コスト分析手法
- 予算統制プロセス
- 調達最適化

### ツール・システム
- コスト管理システム
- 承認ワークフロー
- 分析レポートツール`,
      businessOperations: [
        {
          name: 'budget-planning',
          displayName: '予算を計画する',
          pattern: 'CRUD',
          goal: '現実的で達成可能な予算策定',
          design: `# ビジネスオペレーション: 予算を計画する

## 目的
プロジェクトの要求と制約を考慮し、実現可能で効率的な予算計画を策定する

## 関係者とロール
- **予算管理者**: 予算策定主導
- **プロジェクトマネージャー**: 要求提示
- **財務部門**: 財務方針提供
- **経営層**: 予算承認

## ビジネスプロセス
1. **要求収集**: プロジェクト要件
2. **コスト見積**: 詳細積算
3. **リスクバッファ**: 不確実性への対応
4. **最適化**: コスト削減機会
5. **予算案作成**: 月次配分計画
6. **承認取得**: 経営層承認

## KPI
- 予算精度: 実績との乖離±5%
- 策定期間: 2週間以内
- 承認率: 初回80%以上`,
          roles: ['予算管理者', 'プロジェクトマネージャー', '財務部門', '経営層'],
          operations: {
            steps: [
              '要求収集',
              'コスト見積',
              'リスクバッファ',
              '最適化',
              '予算案作成',
              '承認取得'
            ]
          },
          businessStates: {
            initial: '策定中',
            states: ['策定中', '見積中', '調整中', '承認待ち', '確定'],
            final: '確定'
          }
        },
        {
          name: 'cost-monitoring',
          displayName: 'コストをモニタリングする',
          pattern: 'Analytics',
          goal: 'リアルタイムなコスト把握と統制',
          design: `# ビジネスオペレーション: コストをモニタリングする

## 目的
発生コストをリアルタイムに監視し、予算超過の予兆を早期に発見して対策を講じる

## 関係者とロール
- **コストコントローラー**: 監視、分析
- **プロジェクトマネージャー**: コスト管理
- **調達担当**: 外部コスト管理
- **経理部門**: 実績データ提供

## ビジネスプロセス
1. **データ収集**: 日次コストデータ
2. **予実対比**: 予算との比較
3. **トレンド分析**: 推移パターン
4. **異常検知**: 閾値超過アラート
5. **原因分析**: 差異要因の特定
6. **是正措置**: コスト削減策

## KPI
- モニタリング頻度: 日次
- アラート精度: 90%以上
- 対応時間: 検知から24時間`,
          roles: ['コストコントローラー', 'プロジェクトマネージャー', '調達担当', '経理部門'],
          operations: {
            steps: [
              'データ収集',
              '予実対比',
              'トレンド分析',
              '異常検知',
              '原因分析',
              '是正措置'
            ]
          },
          businessStates: {
            initial: 'モニタリング中',
            states: ['モニタリング中', '異常検出', '分析中', '対策実施中', '正常'],
            final: '正常'
          }
        },
        {
          name: 'vendor-management',
          displayName: '外注を管理する',
          pattern: 'Workflow',
          goal: 'コスト効率的な外部リソース活用',
          design: `# ビジネスオペレーション: 外注を管理する

## 目的
外部ベンダーを効果的に活用し、品質を保ちながらコストを最適化する

## 関係者とロール
- **調達担当**: ベンダー選定、交渉
- **プロジェクトマネージャー**: 要求定義
- **法務**: 契約確認
- **ベンダー**: サービス提供

## ビジネスプロセス
1. **要求定義**: 外注範囲の明確化
2. **ベンダー選定**: 複数社比較
3. **価格交渉**: 最適条件の獲得
4. **契約締結**: 法的確認
5. **パフォーマンス管理**: 品質・納期
6. **支払い処理**: 検収・支払い

## KPI
- コスト削減率: 10%以上
- 品質達成率: 95%以上
- 納期遵守率: 98%以上`,
          roles: ['調達担当', 'プロジェクトマネージャー', '法務', 'ベンダー'],
          operations: {
            steps: [
              '要求定義',
              'ベンダー選定',
              '価格交渉',
              '契約締結',
              'パフォーマンス管理',
              '支払い処理'
            ]
          },
          businessStates: {
            initial: '要求確認',
            states: ['要求確認', '選定中', '交渉中', '契約中', '実施中', '完了'],
            final: '完了'
          }
        }
      ]
    },
    {
      name: 'profitability-optimization',
      displayName: '収益性を最適化する能力',
      description: '収益とコストのバランスを最適化し、持続可能な高収益体質を実現する能力',
      category: 'Core',
      definition: `# ビジネスケーパビリティ: 収益性を最適化する能力

## ケーパビリティ概要
プロジェクトポートフォリオ全体の収益性を分析し、リソース配分と価格戦略を最適化する能力

## ビジネス価値
- **利益最大化**: ポートフォリオ収益性向上
- **リスク分散**: 収益源の多様化
- **持続成長**: 安定的な高収益確保

## 実現する成果
- 営業利益率: 20%以上
- 収益性改善: 年3%向上
- 低収益案件: 10%以下
- 価格適正化: 市場価格±5%

## 必要な要素
### 人材・スキル
- 収益性アナリスト
- プライシングマネージャー
- ポートフォリオマネージャー

### プロセス・方法論
- ポートフォリオ分析
- 価格戦略立案
- 収益性改善手法

### ツール・システム
- 収益性分析ツール
- プライシングモデル
- シミュレーター`,
      businessOperations: [
        {
          name: 'portfolio-analysis',
          displayName: 'ポートフォリオを分析する',
          pattern: 'Analytics',
          goal: '全体最適の視点での収益性評価',
          design: `# ビジネスオペレーション: ポートフォリオを分析する

## 目的
プロジェクトポートフォリオ全体を俯瞰し、収益性の観点から最適な構成を実現する

## 関係者とロール
- **ポートフォリオマネージャー**: 分析主導
- **収益アナリスト**: 詳細分析
- **事業部門長**: 戦略判断
- **経営層**: 意思決定

## ビジネスプロセス
1. **データ統合**: 全プロジェクトデータ
2. **収益性評価**: 個別・全体評価
3. **相関分析**: プロジェクト間関係
4. **リスク評価**: 集中リスク特定
5. **最適化提案**: 構成変更案
6. **シミュレーション**: 影響予測

## KPI
- 分析カバー率: 100%
- 提案採用率: 70%以上
- 収益性向上: 5%以上`,
          roles: ['ポートフォリオマネージャー', '収益アナリスト', '事業部門長', '経営層'],
          operations: {
            steps: [
              'データ統合',
              '収益性評価',
              '相関分析',
              'リスク評価',
              '最適化提案',
              'シミュレーション'
            ]
          },
          businessStates: {
            initial: '収集中',
            states: ['収集中', '分析中', '評価中', '提案作成中', '承認待ち'],
            final: '承認待ち'
          }
        },
        {
          name: 'pricing-strategy',
          displayName: '価格戦略を立案する',
          pattern: 'Analytics',
          goal: '競争力と収益性を両立する価格設定',
          design: `# ビジネスオペレーション: 価格戦略を立案する

## 目的
市場競争力を保ちながら、適正な利益を確保できる価格戦略を立案する

## 関係者とロール
- **プライシングマネージャー**: 戦略立案
- **営業部門**: 市場情報提供
- **財務部門**: 収益性検証
- **経営層**: 戦略承認

## ビジネスプロセス
1. **市場調査**: 競合価格分析
2. **コスト分析**: 原価構造把握
3. **価値評価**: 提供価値の定量化
4. **価格モデル構築**: 料金体系設計
5. **感度分析**: 価格弾力性
6. **戦略決定**: 最終価格決定

## KPI
- 価格競争力: 市場平均±10%
- 利益率確保: 目標利益率達成
- 成約率: 50%以上`,
          roles: ['プライシングマネージャー', '営業部門', '財務部門', '経営層'],
          operations: {
            steps: [
              '市場調査',
              'コスト分析',
              '価値評価',
              '価格モデル構築',
              '感度分析',
              '戦略決定'
            ]
          },
          businessStates: {
            initial: '調査中',
            states: ['調査中', '分析中', 'モデル構築中', '検証中', '決定'],
            final: '決定'
          }
        },
        {
          name: 'value-engineering',
          displayName: '価値を最大化する',
          pattern: 'Workflow',
          goal: 'コストを抑えながら価値向上',
          design: `# ビジネスオペレーション: 価値を最大化する

## 目的
提供サービスの価値を向上させながら、コストを最適化し、収益性を改善する

## 関係者とロール
- **バリューエンジニア**: 改善提案
- **サービス設計者**: 実装検討
- **顧客**: 価値評価
- **財務**: 収益性評価

## ビジネスプロセス
1. **価値分析**: 現状サービス評価
2. **改善機会特定**: VE対象選定
3. **アイデア創出**: 改善案検討
4. **費用対効果分析**: ROI評価
5. **実装計画**: 段階的導入
6. **効果測定**: 成果確認

## KPI
- 価値向上: 顧客評価10%向上
- コスト削減: 15%以上
- ROI: 200%以上`,
          roles: ['バリューエンジニア', 'サービス設計者', '顧客', '財務'],
          operations: {
            steps: [
              '価値分析',
              '改善機会特定',
              'アイデア創出',
              '費用対効果分析',
              '実装計画',
              '効果測定'
            ]
          },
          businessStates: {
            initial: '分析中',
            states: ['分析中', '企画中', '評価中', '実装中', '測定中'],
            final: '測定中'
          }
        }
      ]
    },
    {
      name: 'financial-reporting',
      displayName: '財務報告を行う能力',
      description: '正確でタイムリーな財務情報を提供し、ステークホルダーの意思決定を支援する能力',
      category: 'Supporting',
      definition: `# ビジネスケーパビリティ: 財務報告を行う能力

## ケーパビリティ概要
財務データを適切に集計・分析し、経営層や外部ステークホルダーに有用な情報を提供する能力

## ビジネス価値
- **透明性**: 財務状況の可視化
- **信頼性**: 正確な情報提供
- **迅速性**: タイムリーな報告

## 実現する成果
- 報告精度: 100%
- 報告期限遵守: 100%
- レポート作成時間: 50%削減
- ステークホルダー満足度: 4.5以上

## 必要な要素
### 人材・スキル
- 財務報告スペシャリスト
- 財務アナリスト
- 監査対応担当

### プロセス・方法論
- 財務報告基準
- 内部統制プロセス
- 監査対応手順

### ツール・システム
- 財務報告システム
- 自動化ツール
- 可視化ツール`,
      businessOperations: [
        {
          name: 'financial-closing',
          displayName: '月次決算を行う',
          pattern: 'Workflow',
          goal: '正確で迅速な月次決算',
          design: `# ビジネスオペレーション: 月次決算を行う

## 目的
月次の財務データを正確に締め、経営報告に必要な財務諸表を作成する

## 関係者とロール
- **経理担当**: 仕訳処理、集計
- **財務マネージャー**: 確認、承認
- **監査人**: 内部監査
- **経営層**: 報告受領

## ビジネスプロセス
1. **締め処理**: 当月取引の確定
2. **仕訳作成**: 会計仕訳の計上
3. **照合作業**: 残高照合、検証
4. **財務諸表作成**: BS/PL作成
5. **分析資料作成**: 前年比較等
6. **承認・報告**: 経営層報告

## KPI
- 決算完了: 翌月5営業日
- 正確性: エラー率0.1%以下
- 自動化率: 80%以上`,
          roles: ['経理担当', '財務マネージャー', '監査人', '経営層'],
          operations: {
            steps: [
              '締め処理',
              '仕訳作成',
              '照合作業',
              '財務諸表作成',
              '分析資料作成',
              '承認・報告'
            ]
          },
          businessStates: {
            initial: '締め処理中',
            states: ['締め処理中', '集計中', '確認中', '承認待ち', '完了'],
            final: '完了'
          }
        },
        {
          name: 'management-reporting',
          displayName: '経営報告を作成する',
          pattern: 'Analytics',
          goal: '意思決定に資する経営情報提供',
          design: `# ビジネスオペレーション: 経営報告を作成する

## 目的
経営層の意思決定に必要な財務・非財務情報を統合し、洞察に富んだ報告を行う

## 関係者とロール
- **レポート作成者**: 報告書作成
- **各部門**: データ提供
- **財務部門**: 財務データ提供
- **経営層**: 報告活用

## ビジネスプロセス
1. **要件確認**: 報告ニーズ把握
2. **データ収集**: 多様なデータ統合
3. **分析実施**: トレンド、要因分析
4. **洞察抽出**: 重要な発見
5. **報告書作成**: エグゼクティブサマリー
6. **プレゼンテーション**: 経営会議報告

## KPI
- 納期遵守: 100%
- 洞察価値: 高評価80%以上
- 活用率: 90%以上`,
          roles: ['レポート作成者', '各部門', '財務部門', '経営層'],
          operations: {
            steps: [
              '要件確認',
              'データ収集',
              '分析実施',
              '洞察抽出',
              '報告書作成',
              'プレゼンテーション'
            ]
          },
          businessStates: {
            initial: '準備中',
            states: ['準備中', '作成中', 'レビュー中', '報告中', '完了'],
            final: '完了'
          }
        },
        {
          name: 'compliance-reporting',
          displayName: 'コンプライアンス報告を行う',
          pattern: 'Workflow',
          goal: '規制要件に準拠した報告',
          design: `# ビジネスオペレーション: コンプライアンス報告を行う

## 目的
法令や規制に基づく報告義務を確実に履行し、コンプライアンスリスクを回避する

## 関係者とロール
- **コンプライアンス担当**: 報告書作成
- **法務部門**: 法的確認
- **財務部門**: データ提供
- **規制当局**: 報告受領

## ビジネスプロセス
1. **要件確認**: 規制要件の把握
2. **データ準備**: 必要情報収集
3. **報告書作成**: 指定様式作成
4. **内部確認**: 正確性・完全性
5. **提出**: 当局への提出
6. **記録保存**: 証跡管理

## KPI
- 期限遵守: 100%
- 指摘事項: ゼロ
- 修正提出: ゼロ`,
          roles: ['コンプライアンス担当', '法務部門', '財務部門', '規制当局'],
          operations: {
            steps: [
              '要件確認',
              'データ準備',
              '報告書作成',
              '内部確認',
              '提出',
              '記録保存'
            ]
          },
          businessStates: {
            initial: '準備中',
            states: ['準備中', '作成中', '確認中', '提出済み', '完了'],
            final: '完了'
          }
        }
      ]
    }
  ]
}

export async function createRevenueOptimizationData(serviceId: string) {
  console.log('  Creating Revenue Optimization Service capabilities and operations...')
  
  let totalCapabilities = 0
  let totalOperations = 0
  
  for (const capData of revenueOptimizationData.capabilities) {
    // ケーパビリティの作成
    const capability = await parasolDb.businessCapability.create({
      data: {
        serviceId,
        name: capData.name,
        displayName: capData.displayName,
        description: capData.description,
        definition: capData.definition,
        category: capData.category
      }
    })
    totalCapabilities++
    console.log(`    ✓ Created capability: ${capability.displayName}`)
    
    // ビジネスオペレーションの作成
    for (const opData of capData.businessOperations) {
      const operation = await parasolDb.businessOperation.create({
        data: {
          serviceId,
          capabilityId: capability.id,
          name: opData.name,
          displayName: opData.displayName,
          design: opData.design,
          pattern: opData.pattern,
          goal: opData.goal,
          roles: JSON.stringify(opData.roles),
          operations: JSON.stringify(opData.operations),
          businessStates: JSON.stringify(opData.businessStates),
          useCases: JSON.stringify([]),
          uiDefinitions: JSON.stringify({ pages: [] }),
          testCases: JSON.stringify({ criteria: opData.goal })
        }
      })
      totalOperations++
      console.log(`      ✓ Created operation: ${operation.displayName}`)
    }
  }
  
  return { capabilities: totalCapabilities, operations: totalOperations }
}